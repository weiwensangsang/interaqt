function oi(a){return a!==null&&typeof a=="object"}function Dn(a){if(!oi(a))return!1;let t=Object.getPrototypeOf(a);return t===null?!0:t===Object.prototype||t===null}function S(a){return typeof a=="function"?`func::${a.toString()}`:Array.isArray(a)?a:oi(a)&&!Dn(a)?`uuid::${a.uuid}`:a}var Oa=new Map;function ci(a,t){t&&t.isKlass&&t.displayName&&Oa.set(a,t)}var ui=class{static{this.isKlass=!0}static{this.instances=[]}static createBase(t,e){if(e.find(i=>i.uuid===t.uuid))throw new Error(`duplicate uuid in options ${t.uuid}, ${t._type}`);return e.push(t),t}static isBase(t,e){return t!==null&&typeof t=="object"&&"_type"in t&&t._type===e}static checkBase(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}},Qa=class{constructor(){this.counter=0;this.processId="1234"}generate(){this.counter++;let t=(this.counter&4294967295).toString(16).padStart(8,"0"),e=(this.counter>>32&65535).toString(16).padStart(4,"0"),r=(this.counter>>48&4095|16384).toString(16).padStart(4,"0"),i=(32768|this.counter&16383).toString(16).padStart(4,"0"),n=this.processId.padEnd(12,"0").slice(0,12);return`${t}-${e}-${r}-${i}-${n}`}},Tn=new Qa;function v(a){return a?.uuid?a.uuid:Tn.generate()}var Nn=/^[a-zA-Z0-9_]+$/,Q=class a{constructor(t,e){this._type="Entity";this._options=e,this.uuid=v(e),this.name=t.name,this.properties=t.properties||[],this.computation=t.computation,this.baseEntity=t.baseEntity,this.matchExpression=t.matchExpression,this.inputEntities=t.inputEntities}static{this.isKlass=!0}static{this.displayName="Entity"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0,constraints:{nameFormat:({name:t})=>Nn.test(t)}},properties:{type:"Property",collection:!0,required:!0,constraints:{eachNameUnique:({properties:t})=>new Set(t.map(r=>r.name)).size===t.length},defaultValue:()=>[]},computation:{type:[],collection:!1,required:!1},baseEntity:{type:["Entity","Relation"],collection:!1,required:!1},matchExpression:{type:"object",collection:!1,required:!1},inputEntities:{type:"Entity",collection:!0,required:!1,constraints:{mergedEntityNoProperties:({properties:t,inputEntities:e})=>!(e&&e.length>0&&t&&t.length>0)}}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Entity`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,properties:t.properties,computation:t.computation,baseEntity:t.baseEntity,matchExpression:t.matchExpression,inputEntities:t.inputEntities},r={type:"Entity",options:{uuid:t.uuid},uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name,properties:[...t.properties],computation:t.computation,baseEntity:t.baseEntity,matchExpression:t.matchExpression,inputEntities:t.inputEntities};return this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Entity"}static check(t){return t===null||typeof t!="object"?!1:"_type"in t&&t._type==="Entity"||"id"in t||Object.keys(t).length>0}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Oe=(i=>(i.String="string",i.Number="number",i.Boolean="boolean",i.Timestamp="timestamp",i))(Oe||{}),Pn=/^[a-zA-Z0-9_]+$/,vt=class a{constructor(t,e){this._type="Dictionary";this._options=e,this.uuid=v(e),this.name=t.name,this.type=t.type,this.collection=t.collection??!1,this.args=t.args,this.defaultValue=t.defaultValue,this.computation=t.computation}static{this.isKlass=!0}static{this.displayName="Dictionary"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0,collection:!1,constraints:{format:({name:t})=>Pn.test(t),length:({name:t})=>t.length>1&&t.length<5}},type:{type:"string",required:!0,collection:!1,options:Array.from(Object.values(Oe))},collection:{type:"boolean",required:!0,collection:!1,defaultValue:()=>!1},args:{type:"object",required:!1,collection:!1},defaultValue:{type:"function",required:!1,collection:!1},computation:{collection:!1,type:[],required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Dictionary`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,type:t.type,collection:t.collection};t.args!==void 0&&(e.args=t.args),t.defaultValue!==void 0&&(e.defaultValue=t.defaultValue),t.computation!==void 0&&(e.computation=t.computation);let r={type:"Dictionary",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name,type:t.type,collection:t.collection};return t.args!==void 0&&(r.args=t.args),t.defaultValue!==void 0&&(r.defaultValue=t.defaultValue),t.computation!==void 0&&(r.computation=t.computation),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Dictionary"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Mn=/^[a-zA-Z0-9_]+$/,x=class a{constructor(t,e){this._type="Property";this._options=e,this.uuid=v(e),this.name=t.name,this.type=t.type,this.collection=t.collection,this.defaultValue=t.defaultValue,this.computed=t.computed,this.computation=t.computation}static{this.isKlass=!0}static{this.displayName="Property"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0,constraints:{format:({name:t})=>Mn.test(t),length:({name:t})=>t.length>1&&t.length<5}},type:{type:"string",required:!0,options:()=>Object.values(Oe)},collection:{type:"boolean",required:!1},defaultValue:{type:"function",required:!1},computed:{type:"function",required:!1},computation:{type:[],collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Property`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,type:t.type,collection:t.collection,defaultValue:t.defaultValue?S(t.defaultValue):void 0,computed:t.computed||void 0},r={type:"Property",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name,type:t.type};return t.collection!==void 0&&(r.collection=t.collection),t.defaultValue!==void 0&&(r.defaultValue=t.defaultValue),t.computed!==void 0&&(r.computed=t.computed),t.computation!==void 0&&(r.computation=t.computation),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Property"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.defaultValue&&typeof r.defaultValue=="string"&&r.defaultValue.startsWith("func::")&&(r.defaultValue=new Function("return "+r.defaultValue.substring(6))()),r.computed&&typeof r.computed=="string"&&r.computed.startsWith("func::")&&(r.computed=new Function("return "+r.computed.substring(6))()),this.create(r,e.options)}};var q=class a{constructor(t,e){this._type="Relation";if(this._options=e,this.uuid=v(e),t.inputRelations){if(!t.inputRelations||t.inputRelations.length===0)throw new Error("Merged relation must have at least one inputRelation");if(!t.sourceProperty||!t.targetProperty)throw new Error("Merged relation must have sourceProperty and targetProperty");if(t.source||t.target)throw new Error("Merged relation cannot specify source or target, they are inherited from inputRelations");let r=t.inputRelations[0];for(let i=1;i<t.inputRelations.length;i++){let n=t.inputRelations[i];if(n.source!==r.source)throw new Error("All inputRelations must have the same source");if(n.target!==r.target)throw new Error("All inputRelations must have the same target")}this.inputRelations=t.inputRelations,this.source=r.source,this.target=r.target,this.sourceProperty=t.sourceProperty,this.targetProperty=t.targetProperty,this.type=r.type,this.isTargetReliance=r.isTargetReliance,this._name=t.name}else if(t.baseRelation){if(!t.sourceProperty||!t.targetProperty)throw new Error("Filtered relation must have sourceProperty and targetProperty");this.baseRelation=t.baseRelation,this.matchExpression=t.matchExpression,this.source=t.baseRelation.source,this.sourceProperty=t.sourceProperty,this.target=t.baseRelation.target,this.targetProperty=t.targetProperty,this.isTargetReliance=t.baseRelation.isTargetReliance,this.type=t.baseRelation.type,this._name=t.name}else{if(!t.source||!t.sourceProperty||!t.target||!t.targetProperty||!t.type)throw new Error("Relation requires source, sourceProperty, target, targetProperty, and type");this.source=t.source,this.sourceProperty=t.sourceProperty,this.target=t.target,this.targetProperty=t.targetProperty,this.type=t.type,this._name=t.name}this.isTargetReliance=t.isTargetReliance??!1,this.computation=t.computation,this.properties=t.properties||[]}get name(){return this._name!==void 0?this._name:a.public.name.computed?a.public.name.computed(this):void 0}set name(t){this._name=t}static{this.isKlass=!0}static{this.displayName="Relation"}static{this.instances=[]}static{this.public={name:{type:"string",required:!1,collection:!1,computed:t=>t.source&&t.target?`${t.source.name}_${t.sourceProperty}_${t.targetProperty}_${t.target.name}`:""},source:{type:["Entity","Relation"],required:!0,collection:!1},sourceProperty:{type:"string",required:!0,collection:!1},target:{type:["Entity","Relation"],required:!0,collection:!1},targetProperty:{type:"string",required:!0,collection:!1},isTargetReliance:{type:"boolean",required:!0,collection:!1,defaultValue:()=>!1},type:{type:"string",required:!0,collection:!1},computation:{type:[],collection:!1,required:!1},properties:{type:"Property",collection:!0,required:!0,constraints:{eachNameUnique:t=>new Set(t.properties.map(r=>r.name)).size===t.properties.length},defaultValue:()=>[]},baseRelation:{type:"Relation",collection:!1,required:!1},matchExpression:{type:"object",collection:!1,required:!1},inputRelations:{type:"Relation",collection:!0,required:!1,constraints:{mergedRelationNoProperties:t=>!(t.inputRelations&&t.inputRelations.length>0&&t.properties&&t.properties.length>0),sameSourceTarget:t=>{if(t.inputRelations&&t.inputRelations.length>1){let e=t.inputRelations[0];for(let r=1;r<t.inputRelations.length;r++){let i=t.inputRelations[r];if(i.source!==e.source||i.target!==e.target)return!1}}return!0}}}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Relation`);return this.instances.push(r),r}static stringify(t){let e={sourceProperty:t.sourceProperty,targetProperty:t.targetProperty,isTargetReliance:t.isTargetReliance,type:t.type,properties:t.properties};t.inputRelations||(e.source=t.source,e.target=t.target);let r=t._name??t.name;r!==void 0&&(e.name=r),t.computation!==void 0&&(e.computation=t.computation),t.baseRelation!==void 0&&(e.baseRelation=t.baseRelation),t.matchExpression!==void 0&&(e.matchExpression=t.matchExpression),t.inputRelations!==void 0&&(e.inputRelations=t.inputRelations);let i={type:"Relation",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(i)}static clone(t,e=!1){let r={sourceProperty:t.sourceProperty,targetProperty:t.targetProperty,isTargetReliance:t.isTargetReliance,type:t.type,properties:t.properties?.map(n=>x.clone(n,e))};t.inputRelations||(r.source=t.source,r.target=t.target);let i=t._name??t.name;return i!==void 0&&(r.name=i),t.computation!==void 0&&(r.computation=t.computation),t.baseRelation!==void 0&&(r.baseRelation=t.baseRelation),t.matchExpression!==void 0&&(r.matchExpression=t.matchExpression),t.inputRelations!==void 0&&(r.inputRelations=t.inputRelations),new a(r,t._options)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Relation"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var F=class a{constructor(t,e){this._type="Interaction";this._options=e,this.uuid=v(e),this.name=t.name,this.conditions=t.conditions,this.userAttributives=t.userAttributives,this.userRef=t.userRef,this.action=t.action,this.payload=t.payload,this.sideEffects=t.sideEffects||[],this.data=t.data,this.query=t.query}static{this.isKlass=!0}static{this.displayName="Interaction"}static{this.instances=[]}static{this.public={name:{type:"string",collection:!1,required:!0},conditions:{type:["Conditions","Condition"],required:!1,collection:!1},userAttributives:{type:["Attributives","Attributive"],required:!1,collection:!1},userRef:{type:"Attributive",collection:!1},action:{type:"Action",collection:!1,required:!0},payload:{type:"Payload",collection:!1},sideEffects:{type:"SideEffect",collection:!0,defaultValue:()=>[]},data:{type:["Entity","Relation"],required:!1,collection:!1},query:{type:"Query",required:!1,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Interaction`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,action:t.action};t.conditions!==void 0&&(e.conditions=t.conditions),t.userAttributives!==void 0&&(e.userAttributives=t.userAttributives),t.userRef!==void 0&&(e.userRef=t.userRef),t.payload!==void 0&&(e.payload=t.payload),t.sideEffects&&t.sideEffects.length>0&&(e.sideEffects=t.sideEffects),t.data!==void 0&&(e.data=t.data),t.query!==void 0&&(e.query=t.query);let r={type:"Interaction",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name,action:t.action};return t.conditions!==void 0&&(r.conditions=t.conditions),t.userAttributives!==void 0&&(r.userAttributives=t.userAttributives),t.userRef!==void 0&&(r.userRef=t.userRef),t.payload!==void 0&&(r.payload=t.payload),t.sideEffects&&t.sideEffects.length>0&&(r.sideEffects=t.sideEffects),t.data!==void 0&&(r.data=t.data),t.query!==void 0&&(r.query=t.query),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Interaction"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Qe=class a{constructor(t,e){this._type="Activity";this._options=e,this.uuid=v(e),this.name=t.name,this.interactions=t.interactions||[],this.gateways=t.gateways||[],this.transfers=t.transfers||[],this.groups=t.groups||[],this.events=t.events||[]}static{this.isKlass=!0}static{this.displayName="Activity"}static{this.instances=[]}static{this.public={name:{type:"string",collection:!1,required:!0},interactions:{type:"Interaction",collection:!0,defaultValue:()=>[]},gateways:{type:"Gateway",collection:!0,defaultValue:()=>[]},transfers:{type:"Transfer",collection:!0,defaultValue:()=>[]},groups:{type:"ActivityGroup",collection:!0,defaultValue:()=>[]},events:{type:"Event",collection:!0,defaultValue:()=>[]}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Activity`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,interactions:t.interactions.length>0?t.interactions.map(i=>S(i)):void 0,gateways:t.gateways.length>0?t.gateways.map(i=>S(i)):void 0,transfers:t.transfers.length>0?t.transfers.map(i=>S(i)):void 0,groups:t.groups.length>0?t.groups.map(i=>S(i)):void 0,events:t.events.length>0?t.events.map(i=>S(i)):void 0},r={type:"Activity",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name};return t.interactions&&t.interactions.length>0&&(r.interactions=t.interactions),t.gateways&&t.gateways.length>0&&(r.gateways=t.gateways),t.transfers&&t.transfers.length>0&&(r.transfers=t.transfers),t.groups&&t.groups.length>0&&(r.groups=t.groups),t.events&&t.events.length>0&&(r.events=t.events),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Activity"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}},ie=class a{constructor(t,e){this._type="ActivityGroup";this._options=e,this.uuid=v(e),this.type=t.type,this.activities=t.activities||[]}static{this.isKlass=!0}static{this.displayName="ActivityGroup"}static{this.instances=[]}static{this.public={type:{type:"string",required:!0,collection:!1},activities:{instanceType:{},collection:!0,required:!1,defaultValue:()=>[]}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, ActivityGroup`);return this.instances.push(r),r}static stringify(t){let e={type:t.type,activities:t.activities&&t.activities.length>0?t.activities.map(i=>S(i)):void 0},r={type:"ActivityGroup",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={type:t.type};return t.activities&&t.activities.length>0&&(r.activities=t.activities),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="ActivityGroup"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}},li=class a{constructor(t,e){this._type="Transfer";this._options=e,this.uuid=v(e),this.name=t.name,this.source=t.source,this.target=t.target}static{this.isKlass=!0}static{this.displayName="Transfer"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0,collection:!1},source:{type:["Interaction","ActivityGroup","Gateway"],required:!0,collection:!1},target:{type:["Interaction","ActivityGroup","Gateway"],required:!0,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Transfer`);return this.instances.push(r),r}static stringify(t){let e={type:"Transfer",options:t._options,uuid:t.uuid,public:{name:t.name,source:S(t.source),target:S(t.target)}};return JSON.stringify(e)}static clone(t,e){return this.create({name:t.name,source:t.source,target:t.target})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Transfer"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var _n=[509,0,227,0,150,4,294,9,1368,2,2,1,6,3,41,2,5,0,166,1,574,3,9,9,7,9,32,4,318,1,80,3,71,10,50,3,123,2,54,14,32,10,3,1,11,3,46,10,8,0,46,9,7,2,37,13,2,9,6,1,45,0,13,2,49,13,9,3,2,11,83,11,7,0,3,0,158,11,6,9,7,3,56,1,2,6,3,1,3,2,10,0,11,1,3,6,4,4,68,8,2,0,3,0,2,3,2,4,2,0,15,1,83,17,10,9,5,0,82,19,13,9,214,6,3,8,28,1,83,16,16,9,82,12,9,9,7,19,58,14,5,9,243,14,166,9,71,5,2,1,3,3,2,0,2,1,13,9,120,6,3,6,4,0,29,9,41,6,2,3,9,0,10,10,47,15,343,9,54,7,2,7,17,9,57,21,2,13,123,5,4,0,2,1,2,6,2,0,9,9,49,4,2,1,2,4,9,9,330,3,10,1,2,0,49,6,4,4,14,10,5350,0,7,14,11465,27,2343,9,87,9,39,4,60,6,26,9,535,9,470,0,2,54,8,3,82,0,12,1,19628,1,4178,9,519,45,3,22,543,4,4,5,9,7,3,6,31,3,149,2,1418,49,513,54,5,49,9,0,15,0,23,4,2,14,1361,6,2,16,3,6,2,1,2,4,101,0,161,6,10,9,357,0,62,13,499,13,245,1,2,9,726,6,110,6,6,9,4759,9,787719,239],yi=[0,11,2,25,2,18,2,1,2,14,3,13,35,122,70,52,268,28,4,48,48,31,14,29,6,37,11,29,3,35,5,7,2,4,43,157,19,35,5,35,5,39,9,51,13,10,2,14,2,6,2,1,2,10,2,14,2,6,2,1,4,51,13,310,10,21,11,7,25,5,2,41,2,8,70,5,3,0,2,43,2,1,4,0,3,22,11,22,10,30,66,18,2,1,11,21,11,25,71,55,7,1,65,0,16,3,2,2,2,28,43,28,4,28,36,7,2,27,28,53,11,21,11,18,14,17,111,72,56,50,14,50,14,35,39,27,10,22,251,41,7,1,17,2,60,28,11,0,9,21,43,17,47,20,28,22,13,52,58,1,3,0,14,44,33,24,27,35,30,0,3,0,9,34,4,0,13,47,15,3,22,0,2,0,36,17,2,24,20,1,64,6,2,0,2,3,2,14,2,9,8,46,39,7,3,1,3,21,2,6,2,1,2,4,4,0,19,0,13,4,31,9,2,0,3,0,2,37,2,0,26,0,2,0,45,52,19,3,21,2,31,47,21,1,2,0,185,46,42,3,37,47,21,0,60,42,14,0,72,26,38,6,186,43,117,63,32,7,3,0,3,7,2,1,2,23,16,0,2,0,95,7,3,38,17,0,2,0,29,0,11,39,8,0,22,0,12,45,20,0,19,72,200,32,32,8,2,36,18,0,50,29,113,6,2,1,2,37,22,0,26,5,2,1,2,31,15,0,328,18,16,0,2,12,2,33,125,0,80,921,103,110,18,195,2637,96,16,1071,18,5,26,3994,6,582,6842,29,1763,568,8,30,18,78,18,29,19,47,17,3,32,20,6,18,433,44,212,63,129,74,6,0,67,12,65,1,2,0,29,6135,9,1237,42,9,8936,3,2,6,2,1,2,290,16,0,30,2,3,0,15,3,9,395,2309,106,6,12,4,8,8,9,5991,84,2,70,2,1,3,0,3,1,3,3,2,11,2,0,2,6,2,64,2,3,3,7,2,6,2,27,2,3,2,4,2,0,4,6,2,339,3,24,2,24,2,30,2,24,2,30,2,24,2,30,2,24,2,30,2,24,2,7,1845,30,7,5,262,61,147,44,11,6,17,0,322,29,19,43,485,27,229,29,3,0,496,6,2,3,2,1,2,14,2,196,60,67,8,0,1205,3,2,26,2,1,2,0,3,0,2,9,2,3,2,0,2,0,7,0,5,0,2,0,2,0,2,2,2,1,2,0,3,0,2,0,2,0,2,0,2,0,2,1,2,0,3,3,2,6,2,3,2,3,2,0,2,9,2,16,6,2,2,4,2,16,4421,42719,33,4153,7,221,3,5761,15,7472,16,621,2467,541,1507,4938,6,4191],Bn="\u200C\u200D\xB7\u0300-\u036F\u0387\u0483-\u0487\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u0669\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u06F0-\u06F9\u0711\u0730-\u074A\u07A6-\u07B0\u07C0-\u07C9\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u0897-\u089F\u08CA-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0966-\u096F\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09E6-\u09EF\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A66-\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AE6-\u0AEF\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B55-\u0B57\u0B62\u0B63\u0B66-\u0B6F\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0BE6-\u0BEF\u0C00-\u0C04\u0C3C\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C66-\u0C6F\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0CE6-\u0CEF\u0CF3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D66-\u0D6F\u0D81-\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DE6-\u0DEF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0E50-\u0E59\u0EB1\u0EB4-\u0EBC\u0EC8-\u0ECE\u0ED0-\u0ED9\u0F18\u0F19\u0F20-\u0F29\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1040-\u1049\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F-\u109D\u135D-\u135F\u1369-\u1371\u1712-\u1715\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u17E0-\u17E9\u180B-\u180D\u180F-\u1819\u18A9\u1920-\u192B\u1930-\u193B\u1946-\u194F\u19D0-\u19DA\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AB0-\u1ABD\u1ABF-\u1ACE\u1B00-\u1B04\u1B34-\u1B44\u1B50-\u1B59\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BB0-\u1BB9\u1BE6-\u1BF3\u1C24-\u1C37\u1C40-\u1C49\u1C50-\u1C59\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DFF\u200C\u200D\u203F\u2040\u2054\u20D0-\u20DC\u20E1\u20E5-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\u30FB\uA620-\uA629\uA66F\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA82C\uA880\uA881\uA8B4-\uA8C5\uA8D0-\uA8D9\uA8E0-\uA8F1\uA8FF-\uA909\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9D0-\uA9D9\uA9E5\uA9F0-\uA9F9\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA50-\uAA59\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uABF0-\uABF9\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F\uFE33\uFE34\uFE4D-\uFE4F\uFF10-\uFF19\uFF3F\uFF65",gi="\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u05D0-\u05EA\u05EF-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u0870-\u0887\u0889-\u088E\u08A0-\u08C9\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C5D\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u1711\u171F-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1878\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4C\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C8A\u1C90-\u1CBA\u1CBD-\u1CBF\u1CE9-\u1CEC\u1CEE-\u1CF3\u1CF5\u1CF6\u1CFA\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2118-\u211D\u2124\u2126\u2128\u212A-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2160-\u2188\u2C00-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303C\u3041-\u3096\u309B-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u31A0-\u31BF\u31F0-\u31FF\u3400-\u4DBF\u4E00-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6EF\uA717-\uA71F\uA722-\uA788\uA78B-\uA7CD\uA7D0\uA7D1\uA7D3\uA7D5-\uA7DC\uA7F2-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA8FE\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB69\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC",$a={3:"abstract boolean byte char class double enum export extends final float goto implements import int interface long native package private protected public short static super synchronized throws transient volatile",5:"class enum extends super const export import",6:"enum",strict:"implements interface let package private protected public static yield",strictBind:"eval arguments"},qa="break case catch continue debugger default do else finally for function if return switch throw try var while with null true false instanceof typeof void delete new in this",Vn={5:qa,"5module":qa+" export import",6:qa+" const class extends export import super"},Fn=/^in(stanceof)?$/,Ln=new RegExp("["+gi+"]"),On=new RegExp("["+gi+Bn+"]");function ja(a,t){for(var e=65536,r=0;r<t.length;r+=2){if(e+=t[r],e>a)return!1;if(e+=t[r+1],e>=a)return!0}return!1}function wt(a,t){return a<65?a===36:a<91?!0:a<97?a===95:a<123?!0:a<=65535?a>=170&&Ln.test(String.fromCharCode(a)):t===!1?!1:ja(a,yi)}function Ft(a,t){return a<48?a===36:a<58?!0:a<65?!1:a<91?!0:a<97?a===95:a<123?!0:a<=65535?a>=170&&On.test(String.fromCharCode(a)):t===!1?!1:ja(a,yi)||ja(a,_n)}var $=function(t,e){e===void 0&&(e={}),this.label=t,this.keyword=e.keyword,this.beforeExpr=!!e.beforeExpr,this.startsExpr=!!e.startsExpr,this.isLoop=!!e.isLoop,this.isAssign=!!e.isAssign,this.prefix=!!e.prefix,this.postfix=!!e.postfix,this.binop=e.binop||null,this.updateContext=null};function ut(a,t){return new $(a,{beforeExpr:!0,binop:t})}var lt={beforeExpr:!0},et={startsExpr:!0},Ja={};function B(a,t){return t===void 0&&(t={}),t.keyword=a,Ja[a]=new $(a,t)}var p={num:new $("num",et),regexp:new $("regexp",et),string:new $("string",et),name:new $("name",et),privateId:new $("privateId",et),eof:new $("eof"),bracketL:new $("[",{beforeExpr:!0,startsExpr:!0}),bracketR:new $("]"),braceL:new $("{",{beforeExpr:!0,startsExpr:!0}),braceR:new $("}"),parenL:new $("(",{beforeExpr:!0,startsExpr:!0}),parenR:new $(")"),comma:new $(",",lt),semi:new $(";",lt),colon:new $(":",lt),dot:new $("."),question:new $("?",lt),questionDot:new $("?."),arrow:new $("=>",lt),template:new $("template"),invalidTemplate:new $("invalidTemplate"),ellipsis:new $("...",lt),backQuote:new $("`",et),dollarBraceL:new $("${",{beforeExpr:!0,startsExpr:!0}),eq:new $("=",{beforeExpr:!0,isAssign:!0}),assign:new $("_=",{beforeExpr:!0,isAssign:!0}),incDec:new $("++/--",{prefix:!0,postfix:!0,startsExpr:!0}),prefix:new $("!/~",{beforeExpr:!0,prefix:!0,startsExpr:!0}),logicalOR:ut("||",1),logicalAND:ut("&&",2),bitwiseOR:ut("|",3),bitwiseXOR:ut("^",4),bitwiseAND:ut("&",5),equality:ut("==/!=/===/!==",6),relational:ut("</>/<=/>=",7),bitShift:ut("<</>>/>>>",8),plusMin:new $("+/-",{beforeExpr:!0,binop:9,prefix:!0,startsExpr:!0}),modulo:ut("%",10),star:ut("*",10),slash:ut("/",10),starstar:new $("**",{beforeExpr:!0}),coalesce:ut("??",1),_break:B("break"),_case:B("case",lt),_catch:B("catch"),_continue:B("continue"),_debugger:B("debugger"),_default:B("default",lt),_do:B("do",{isLoop:!0,beforeExpr:!0}),_else:B("else",lt),_finally:B("finally"),_for:B("for",{isLoop:!0}),_function:B("function",et),_if:B("if"),_return:B("return",lt),_switch:B("switch"),_throw:B("throw",lt),_try:B("try"),_var:B("var"),_const:B("const"),_while:B("while",{isLoop:!0}),_with:B("with"),_new:B("new",{beforeExpr:!0,startsExpr:!0}),_this:B("this",et),_super:B("super",et),_class:B("class",et),_extends:B("extends",lt),_export:B("export"),_import:B("import",et),_null:B("null",et),_true:B("true",et),_false:B("false",et),_in:B("in",{beforeExpr:!0,binop:7}),_instanceof:B("instanceof",{beforeExpr:!0,binop:7}),_typeof:B("typeof",{beforeExpr:!0,prefix:!0,startsExpr:!0}),_void:B("void",{beforeExpr:!0,prefix:!0,startsExpr:!0}),_delete:B("delete",{beforeExpr:!0,prefix:!0,startsExpr:!0})},at=/\r\n?|\n|\u2028|\u2029/,Qn=new RegExp(at.source,"g");function ne(a){return a===10||a===13||a===8232||a===8233}function bi(a,t,e){e===void 0&&(e=a.length);for(var r=t;r<e;r++){var i=a.charCodeAt(r);if(ne(i))return r<e-1&&i===13&&a.charCodeAt(r+1)===10?r+2:r+1}return-1}var Ii=/[\u1680\u2000-\u200a\u202f\u205f\u3000\ufeff]/,Y=/(?:\s|\/\/.*|\/\*[^]*?\*\/)*/g,xi=Object.prototype,$n=xi.hasOwnProperty,qn=xi.toString,se=Object.hasOwn||function(a,t){return $n.call(a,t)},pi=Array.isArray||function(a){return qn.call(a)==="[object Array]"},di=Object.create(null);function Vt(a){return di[a]||(di[a]=new RegExp("^(?:"+a.replace(/ /g,"|")+")$"))}function kt(a){return a<=65535?String.fromCharCode(a):(a-=65536,String.fromCharCode((a>>10)+55296,(a&1023)+56320))}var Un=/(?:[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])/,Ae=function(t,e){this.line=t,this.column=e};Ae.prototype.offset=function(t){return new Ae(this.line,this.column+t)};var We=function(t,e,r){this.start=e,this.end=r,t.sourceFile!==null&&(this.source=t.sourceFile)};function Ri(a,t){for(var e=1,r=0;;){var i=bi(a,r,t);if(i<0)return new Ae(e,t-r);++e,r=i}}var Ga={ecmaVersion:null,sourceType:"script",onInsertedSemicolon:null,onTrailingComma:null,allowReserved:null,allowReturnOutsideFunction:!1,allowImportExportEverywhere:!1,allowAwaitOutsideFunction:null,allowSuperOutsideMethod:null,allowHashBang:!1,checkPrivateFields:!0,locations:!1,onToken:null,onComment:null,ranges:!1,program:null,sourceFile:null,directSourceFile:null,preserveParens:!1},hi=!1;function jn(a){var t={};for(var e in Ga)t[e]=a&&se(a,e)?a[e]:Ga[e];if(t.ecmaVersion==="latest"?t.ecmaVersion=1e8:t.ecmaVersion==null?(!hi&&typeof console=="object"&&console.warn&&(hi=!0,console.warn(`Since Acorn 8.0.0, options.ecmaVersion is required.
Defaulting to 2020, but this will stop working in the future.`)),t.ecmaVersion=11):t.ecmaVersion>=2015&&(t.ecmaVersion-=2009),t.allowReserved==null&&(t.allowReserved=t.ecmaVersion<5),(!a||a.allowHashBang==null)&&(t.allowHashBang=t.ecmaVersion>=14),pi(t.onToken)){var r=t.onToken;t.onToken=function(i){return r.push(i)}}return pi(t.onComment)&&(t.onComment=Gn(t,t.onComment)),t}function Gn(a,t){return function(e,r,i,n,s,o){var c={type:e?"Block":"Line",value:r,start:i,end:n};a.locations&&(c.loc=new We(this,s,o)),a.ranges&&(c.range=[i,n]),t.push(c)}}var Ce=1,oe=2,Ha=4,Ei=8,Ka=16,vi=32,ze=64,wi=128,qt=256,Se=512,Je=Ce|oe|qt;function Xa(a,t){return oe|(a?Ha:0)|(t?Ei:0)}var qe=0,Ya=1,Tt=2,Ai=3,Ci=4,Si=5,H=function(t,e,r){this.options=t=jn(t),this.sourceFile=t.sourceFile,this.keywords=Vt(Vn[t.ecmaVersion>=6?6:t.sourceType==="module"?"5module":5]);var i="";t.allowReserved!==!0&&(i=$a[t.ecmaVersion>=6?6:t.ecmaVersion===5?5:3],t.sourceType==="module"&&(i+=" await")),this.reservedWords=Vt(i);var n=(i?i+" ":"")+$a.strict;this.reservedWordsStrict=Vt(n),this.reservedWordsStrictBind=Vt(n+" "+$a.strictBind),this.input=String(e),this.containsEsc=!1,r?(this.pos=r,this.lineStart=this.input.lastIndexOf(`
`,r-1)+1,this.curLine=this.input.slice(0,this.lineStart).split(at).length):(this.pos=this.lineStart=0,this.curLine=1),this.type=p.eof,this.value=null,this.start=this.end=this.pos,this.startLoc=this.endLoc=this.curPosition(),this.lastTokEndLoc=this.lastTokStartLoc=null,this.lastTokStart=this.lastTokEnd=this.pos,this.context=this.initialContext(),this.exprAllowed=!0,this.inModule=t.sourceType==="module",this.strict=this.inModule||this.strictDirective(this.pos),this.potentialArrowAt=-1,this.potentialArrowInForAwait=!1,this.yieldPos=this.awaitPos=this.awaitIdentPos=0,this.labels=[],this.undefinedExports=Object.create(null),this.pos===0&&t.allowHashBang&&this.input.slice(0,2)==="#!"&&this.skipLineComment(2),this.scopeStack=[],this.enterScope(Ce),this.regexpState=null,this.privateNameStack=[]},At={inFunction:{configurable:!0},inGenerator:{configurable:!0},inAsync:{configurable:!0},canAwait:{configurable:!0},allowSuper:{configurable:!0},allowDirectSuper:{configurable:!0},treatFunctionsAsVar:{configurable:!0},allowNewDotTarget:{configurable:!0},inClassStaticBlock:{configurable:!0}};H.prototype.parse=function(){var t=this.options.program||this.startNode();return this.nextToken(),this.parseTopLevel(t)};At.inFunction.get=function(){return(this.currentVarScope().flags&oe)>0};At.inGenerator.get=function(){return(this.currentVarScope().flags&Ei)>0};At.inAsync.get=function(){return(this.currentVarScope().flags&Ha)>0};At.canAwait.get=function(){for(var a=this.scopeStack.length-1;a>=0;a--){var t=this.scopeStack[a],e=t.flags;if(e&(qt|Se))return!1;if(e&oe)return(e&Ha)>0}return this.inModule&&this.options.ecmaVersion>=13||this.options.allowAwaitOutsideFunction};At.allowSuper.get=function(){var a=this.currentThisScope(),t=a.flags;return(t&ze)>0||this.options.allowSuperOutsideMethod};At.allowDirectSuper.get=function(){return(this.currentThisScope().flags&wi)>0};At.treatFunctionsAsVar.get=function(){return this.treatFunctionsAsVarInScope(this.currentScope())};At.allowNewDotTarget.get=function(){for(var a=this.scopeStack.length-1;a>=0;a--){var t=this.scopeStack[a],e=t.flags;if(e&(qt|Se)||e&oe&&!(e&Ka))return!0}return!1};At.inClassStaticBlock.get=function(){return(this.currentVarScope().flags&qt)>0};H.extend=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var r=this,i=0;i<t.length;i++)r=t[i](r);return r};H.parse=function(t,e){return new this(e,t).parse()};H.parseExpressionAt=function(t,e,r){var i=new this(r,t,e);return i.nextToken(),i.parseExpression()};H.tokenizer=function(t,e){return new this(e,t)};Object.defineProperties(H.prototype,At);var Z=H.prototype,Wn=/^(?:'((?:\\[^]|[^'\\])*?)'|"((?:\\[^]|[^"\\])*?)")/;Z.strictDirective=function(a){if(this.options.ecmaVersion<5)return!1;for(;;){Y.lastIndex=a,a+=Y.exec(this.input)[0].length;var t=Wn.exec(this.input.slice(a));if(!t)return!1;if((t[1]||t[2])==="use strict"){Y.lastIndex=a+t[0].length;var e=Y.exec(this.input),r=e.index+e[0].length,i=this.input.charAt(r);return i===";"||i==="}"||at.test(e[0])&&!(/[(`.[+\-/*%<>=,?^&]/.test(i)||i==="!"&&this.input.charAt(r+1)==="=")}a+=t[0].length,Y.lastIndex=a,a+=Y.exec(this.input)[0].length,this.input[a]===";"&&a++}};Z.eat=function(a){return this.type===a?(this.next(),!0):!1};Z.isContextual=function(a){return this.type===p.name&&this.value===a&&!this.containsEsc};Z.eatContextual=function(a){return this.isContextual(a)?(this.next(),!0):!1};Z.expectContextual=function(a){this.eatContextual(a)||this.unexpected()};Z.canInsertSemicolon=function(){return this.type===p.eof||this.type===p.braceR||at.test(this.input.slice(this.lastTokEnd,this.start))};Z.insertSemicolon=function(){if(this.canInsertSemicolon())return this.options.onInsertedSemicolon&&this.options.onInsertedSemicolon(this.lastTokEnd,this.lastTokEndLoc),!0};Z.semicolon=function(){!this.eat(p.semi)&&!this.insertSemicolon()&&this.unexpected()};Z.afterTrailingComma=function(a,t){if(this.type===a)return this.options.onTrailingComma&&this.options.onTrailingComma(this.lastTokStart,this.lastTokStartLoc),t||this.next(),!0};Z.expect=function(a){this.eat(a)||this.unexpected()};Z.unexpected=function(a){this.raise(a??this.start,"Unexpected token")};var He=function(){this.shorthandAssign=this.trailingComma=this.parenthesizedAssign=this.parenthesizedBind=this.doubleProto=-1};Z.checkPatternErrors=function(a,t){if(a){a.trailingComma>-1&&this.raiseRecoverable(a.trailingComma,"Comma is not permitted after the rest element");var e=t?a.parenthesizedAssign:a.parenthesizedBind;e>-1&&this.raiseRecoverable(e,t?"Assigning to rvalue":"Parenthesized pattern")}};Z.checkExpressionErrors=function(a,t){if(!a)return!1;var e=a.shorthandAssign,r=a.doubleProto;if(!t)return e>=0||r>=0;e>=0&&this.raise(e,"Shorthand property assignments are valid only in destructuring patterns"),r>=0&&this.raiseRecoverable(r,"Redefinition of __proto__ property")};Z.checkYieldAwaitInDefaultParams=function(){this.yieldPos&&(!this.awaitPos||this.yieldPos<this.awaitPos)&&this.raise(this.yieldPos,"Yield expression cannot be a default value"),this.awaitPos&&this.raise(this.awaitPos,"Await expression cannot be a default value")};Z.isSimpleAssignTarget=function(a){return a.type==="ParenthesizedExpression"?this.isSimpleAssignTarget(a.expression):a.type==="Identifier"||a.type==="MemberExpression"};var C=H.prototype;C.parseTopLevel=function(a){var t=Object.create(null);for(a.body||(a.body=[]);this.type!==p.eof;){var e=this.parseStatement(null,!0,t);a.body.push(e)}if(this.inModule)for(var r=0,i=Object.keys(this.undefinedExports);r<i.length;r+=1){var n=i[r];this.raiseRecoverable(this.undefinedExports[n].start,"Export '"+n+"' is not defined")}return this.adaptDirectivePrologue(a.body),this.next(),a.sourceType=this.options.sourceType,this.finishNode(a,"Program")};var Za={kind:"loop"},zn={kind:"switch"};C.isLet=function(a){if(this.options.ecmaVersion<6||!this.isContextual("let"))return!1;Y.lastIndex=this.pos;var t=Y.exec(this.input),e=this.pos+t[0].length,r=this.input.charCodeAt(e);if(r===91||r===92)return!0;if(a)return!1;if(r===123||r>55295&&r<56320)return!0;if(wt(r,!0)){for(var i=e+1;Ft(r=this.input.charCodeAt(i),!0);)++i;if(r===92||r>55295&&r<56320)return!0;var n=this.input.slice(e,i);if(!Fn.test(n))return!0}return!1};C.isAsyncFunction=function(){if(this.options.ecmaVersion<8||!this.isContextual("async"))return!1;Y.lastIndex=this.pos;var a=Y.exec(this.input),t=this.pos+a[0].length,e;return!at.test(this.input.slice(this.pos,t))&&this.input.slice(t,t+8)==="function"&&(t+8===this.input.length||!(Ft(e=this.input.charCodeAt(t+8))||e>55295&&e<56320))};C.isUsingKeyword=function(a,t){if(this.options.ecmaVersion<17||!this.isContextual(a?"await":"using"))return!1;Y.lastIndex=this.pos;var e=Y.exec(this.input),r=this.pos+e[0].length;if(at.test(this.input.slice(this.pos,r)))return!1;if(a){var i=r+5,n;if(this.input.slice(r,i)!=="using"||i===this.input.length||Ft(n=this.input.charCodeAt(i))||n>55295&&n<56320)return!1;Y.lastIndex=i;var s=Y.exec(this.input);if(s&&at.test(this.input.slice(i,i+s[0].length)))return!1}if(t){var o=r+2,c;if(this.input.slice(r,o)==="of"&&(o===this.input.length||!Ft(c=this.input.charCodeAt(o))&&!(c>55295&&c<56320)))return!1}var u=this.input.charCodeAt(r);return wt(u,!0)||u===92};C.isAwaitUsing=function(a){return this.isUsingKeyword(!0,a)};C.isUsing=function(a){return this.isUsingKeyword(!1,a)};C.parseStatement=function(a,t,e){var r=this.type,i=this.startNode(),n;switch(this.isLet(a)&&(r=p._var,n="let"),r){case p._break:case p._continue:return this.parseBreakContinueStatement(i,r.keyword);case p._debugger:return this.parseDebuggerStatement(i);case p._do:return this.parseDoStatement(i);case p._for:return this.parseForStatement(i);case p._function:return a&&(this.strict||a!=="if"&&a!=="label")&&this.options.ecmaVersion>=6&&this.unexpected(),this.parseFunctionStatement(i,!1,!a);case p._class:return a&&this.unexpected(),this.parseClass(i,!0);case p._if:return this.parseIfStatement(i);case p._return:return this.parseReturnStatement(i);case p._switch:return this.parseSwitchStatement(i);case p._throw:return this.parseThrowStatement(i);case p._try:return this.parseTryStatement(i);case p._const:case p._var:return n=n||this.value,a&&n!=="var"&&this.unexpected(),this.parseVarStatement(i,n);case p._while:return this.parseWhileStatement(i);case p._with:return this.parseWithStatement(i);case p.braceL:return this.parseBlock(!0,i);case p.semi:return this.parseEmptyStatement(i);case p._export:case p._import:if(this.options.ecmaVersion>10&&r===p._import){Y.lastIndex=this.pos;var s=Y.exec(this.input),o=this.pos+s[0].length,c=this.input.charCodeAt(o);if(c===40||c===46)return this.parseExpressionStatement(i,this.parseExpression())}return this.options.allowImportExportEverywhere||(t||this.raise(this.start,"'import' and 'export' may only appear at the top level"),this.inModule||this.raise(this.start,"'import' and 'export' may appear only with 'sourceType: module'")),r===p._import?this.parseImport(i):this.parseExport(i,e);default:if(this.isAsyncFunction())return a&&this.unexpected(),this.next(),this.parseFunctionStatement(i,!0,!a);var u=this.isAwaitUsing(!1)?"await using":this.isUsing(!1)?"using":null;if(u)return t&&this.options.sourceType==="script"&&this.raise(this.start,"Using declaration cannot appear in the top level when source type is `script`"),u==="await using"&&(this.canAwait||this.raise(this.start,"Await using cannot appear outside of async function"),this.next()),this.next(),this.parseVar(i,!1,u),this.semicolon(),this.finishNode(i,"VariableDeclaration");var l=this.value,d=this.parseExpression();return r===p.name&&d.type==="Identifier"&&this.eat(p.colon)?this.parseLabeledStatement(i,l,d,a):this.parseExpressionStatement(i,d)}};C.parseBreakContinueStatement=function(a,t){var e=t==="break";this.next(),this.eat(p.semi)||this.insertSemicolon()?a.label=null:this.type!==p.name?this.unexpected():(a.label=this.parseIdent(),this.semicolon());for(var r=0;r<this.labels.length;++r){var i=this.labels[r];if((a.label==null||i.name===a.label.name)&&(i.kind!=null&&(e||i.kind==="loop")||a.label&&e))break}return r===this.labels.length&&this.raise(a.start,"Unsyntactic "+t),this.finishNode(a,e?"BreakStatement":"ContinueStatement")};C.parseDebuggerStatement=function(a){return this.next(),this.semicolon(),this.finishNode(a,"DebuggerStatement")};C.parseDoStatement=function(a){return this.next(),this.labels.push(Za),a.body=this.parseStatement("do"),this.labels.pop(),this.expect(p._while),a.test=this.parseParenExpression(),this.options.ecmaVersion>=6?this.eat(p.semi):this.semicolon(),this.finishNode(a,"DoWhileStatement")};C.parseForStatement=function(a){this.next();var t=this.options.ecmaVersion>=9&&this.canAwait&&this.eatContextual("await")?this.lastTokStart:-1;if(this.labels.push(Za),this.enterScope(0),this.expect(p.parenL),this.type===p.semi)return t>-1&&this.unexpected(t),this.parseFor(a,null);var e=this.isLet();if(this.type===p._var||this.type===p._const||e){var r=this.startNode(),i=e?"let":this.value;return this.next(),this.parseVar(r,!0,i),this.finishNode(r,"VariableDeclaration"),this.parseForAfterInit(a,r,t)}var n=this.isContextual("let"),s=!1,o=this.isUsing(!0)?"using":this.isAwaitUsing(!0)?"await using":null;if(o){var c=this.startNode();return this.next(),o==="await using"&&this.next(),this.parseVar(c,!0,o),this.finishNode(c,"VariableDeclaration"),this.parseForAfterInit(a,c,t)}var u=this.containsEsc,l=new He,d=this.start,h=t>-1?this.parseExprSubscripts(l,"await"):this.parseExpression(!0,l);return this.type===p._in||(s=this.options.ecmaVersion>=6&&this.isContextual("of"))?(t>-1?(this.type===p._in&&this.unexpected(t),a.await=!0):s&&this.options.ecmaVersion>=8&&(h.start===d&&!u&&h.type==="Identifier"&&h.name==="async"?this.unexpected():this.options.ecmaVersion>=9&&(a.await=!1)),n&&s&&this.raise(h.start,"The left-hand side of a for-of loop may not start with 'let'."),this.toAssignable(h,!1,l),this.checkLValPattern(h),this.parseForIn(a,h)):(this.checkExpressionErrors(l,!0),t>-1&&this.unexpected(t),this.parseFor(a,h))};C.parseForAfterInit=function(a,t,e){return(this.type===p._in||this.options.ecmaVersion>=6&&this.isContextual("of"))&&t.declarations.length===1?(this.options.ecmaVersion>=9&&(this.type===p._in?e>-1&&this.unexpected(e):a.await=e>-1),this.parseForIn(a,t)):(e>-1&&this.unexpected(e),this.parseFor(a,t))};C.parseFunctionStatement=function(a,t,e){return this.next(),this.parseFunction(a,we|(e?0:Wa),!1,t)};C.parseIfStatement=function(a){return this.next(),a.test=this.parseParenExpression(),a.consequent=this.parseStatement("if"),a.alternate=this.eat(p._else)?this.parseStatement("if"):null,this.finishNode(a,"IfStatement")};C.parseReturnStatement=function(a){return!this.inFunction&&!this.options.allowReturnOutsideFunction&&this.raise(this.start,"'return' outside of function"),this.next(),this.eat(p.semi)||this.insertSemicolon()?a.argument=null:(a.argument=this.parseExpression(),this.semicolon()),this.finishNode(a,"ReturnStatement")};C.parseSwitchStatement=function(a){this.next(),a.discriminant=this.parseParenExpression(),a.cases=[],this.expect(p.braceL),this.labels.push(zn),this.enterScope(0);for(var t,e=!1;this.type!==p.braceR;)if(this.type===p._case||this.type===p._default){var r=this.type===p._case;t&&this.finishNode(t,"SwitchCase"),a.cases.push(t=this.startNode()),t.consequent=[],this.next(),r?t.test=this.parseExpression():(e&&this.raiseRecoverable(this.lastTokStart,"Multiple default clauses"),e=!0,t.test=null),this.expect(p.colon)}else t||this.unexpected(),t.consequent.push(this.parseStatement(null));return this.exitScope(),t&&this.finishNode(t,"SwitchCase"),this.next(),this.labels.pop(),this.finishNode(a,"SwitchStatement")};C.parseThrowStatement=function(a){return this.next(),at.test(this.input.slice(this.lastTokEnd,this.start))&&this.raise(this.lastTokEnd,"Illegal newline after throw"),a.argument=this.parseExpression(),this.semicolon(),this.finishNode(a,"ThrowStatement")};var Jn=[];C.parseCatchClauseParam=function(){var a=this.parseBindingAtom(),t=a.type==="Identifier";return this.enterScope(t?vi:0),this.checkLValPattern(a,t?Ci:Tt),this.expect(p.parenR),a};C.parseTryStatement=function(a){if(this.next(),a.block=this.parseBlock(),a.handler=null,this.type===p._catch){var t=this.startNode();this.next(),this.eat(p.parenL)?t.param=this.parseCatchClauseParam():(this.options.ecmaVersion<10&&this.unexpected(),t.param=null,this.enterScope(0)),t.body=this.parseBlock(!1),this.exitScope(),a.handler=this.finishNode(t,"CatchClause")}return a.finalizer=this.eat(p._finally)?this.parseBlock():null,!a.handler&&!a.finalizer&&this.raise(a.start,"Missing catch or finally clause"),this.finishNode(a,"TryStatement")};C.parseVarStatement=function(a,t,e){return this.next(),this.parseVar(a,!1,t,e),this.semicolon(),this.finishNode(a,"VariableDeclaration")};C.parseWhileStatement=function(a){return this.next(),a.test=this.parseParenExpression(),this.labels.push(Za),a.body=this.parseStatement("while"),this.labels.pop(),this.finishNode(a,"WhileStatement")};C.parseWithStatement=function(a){return this.strict&&this.raise(this.start,"'with' in strict mode"),this.next(),a.object=this.parseParenExpression(),a.body=this.parseStatement("with"),this.finishNode(a,"WithStatement")};C.parseEmptyStatement=function(a){return this.next(),this.finishNode(a,"EmptyStatement")};C.parseLabeledStatement=function(a,t,e,r){for(var i=0,n=this.labels;i<n.length;i+=1){var s=n[i];s.name===t&&this.raise(e.start,"Label '"+t+"' is already declared")}for(var o=this.type.isLoop?"loop":this.type===p._switch?"switch":null,c=this.labels.length-1;c>=0;c--){var u=this.labels[c];if(u.statementStart===a.start)u.statementStart=this.start,u.kind=o;else break}return this.labels.push({name:t,kind:o,statementStart:this.start}),a.body=this.parseStatement(r?r.indexOf("label")===-1?r+"label":r:"label"),this.labels.pop(),a.label=e,this.finishNode(a,"LabeledStatement")};C.parseExpressionStatement=function(a,t){return a.expression=t,this.semicolon(),this.finishNode(a,"ExpressionStatement")};C.parseBlock=function(a,t,e){for(a===void 0&&(a=!0),t===void 0&&(t=this.startNode()),t.body=[],this.expect(p.braceL),a&&this.enterScope(0);this.type!==p.braceR;){var r=this.parseStatement(null);t.body.push(r)}return e&&(this.strict=!1),this.next(),a&&this.exitScope(),this.finishNode(t,"BlockStatement")};C.parseFor=function(a,t){return a.init=t,this.expect(p.semi),a.test=this.type===p.semi?null:this.parseExpression(),this.expect(p.semi),a.update=this.type===p.parenR?null:this.parseExpression(),this.expect(p.parenR),a.body=this.parseStatement("for"),this.exitScope(),this.labels.pop(),this.finishNode(a,"ForStatement")};C.parseForIn=function(a,t){var e=this.type===p._in;return this.next(),t.type==="VariableDeclaration"&&t.declarations[0].init!=null&&(!e||this.options.ecmaVersion<8||this.strict||t.kind!=="var"||t.declarations[0].id.type!=="Identifier")&&this.raise(t.start,(e?"for-in":"for-of")+" loop variable declaration may not have an initializer"),a.left=t,a.right=e?this.parseExpression():this.parseMaybeAssign(),this.expect(p.parenR),a.body=this.parseStatement("for"),this.exitScope(),this.labels.pop(),this.finishNode(a,e?"ForInStatement":"ForOfStatement")};C.parseVar=function(a,t,e,r){for(a.declarations=[],a.kind=e;;){var i=this.startNode();if(this.parseVarId(i,e),this.eat(p.eq)?i.init=this.parseMaybeAssign(t):!r&&e==="const"&&!(this.type===p._in||this.options.ecmaVersion>=6&&this.isContextual("of"))?this.unexpected():!r&&(e==="using"||e==="await using")&&this.options.ecmaVersion>=17&&this.type!==p._in&&!this.isContextual("of")?this.raise(this.lastTokEnd,"Missing initializer in "+e+" declaration"):!r&&i.id.type!=="Identifier"&&!(t&&(this.type===p._in||this.isContextual("of")))?this.raise(this.lastTokEnd,"Complex binding patterns require an initialization value"):i.init=null,a.declarations.push(this.finishNode(i,"VariableDeclarator")),!this.eat(p.comma))break}return a};C.parseVarId=function(a,t){a.id=t==="using"||t==="await using"?this.parseIdent():this.parseBindingAtom(),this.checkLValPattern(a.id,t==="var"?Ya:Tt,!1)};var we=1,Wa=2,ki=4;C.parseFunction=function(a,t,e,r,i){this.initFunction(a),(this.options.ecmaVersion>=9||this.options.ecmaVersion>=6&&!r)&&(this.type===p.star&&t&Wa&&this.unexpected(),a.generator=this.eat(p.star)),this.options.ecmaVersion>=8&&(a.async=!!r),t&we&&(a.id=t&ki&&this.type!==p.name?null:this.parseIdent(),a.id&&!(t&Wa)&&this.checkLValSimple(a.id,this.strict||a.generator||a.async?this.treatFunctionsAsVar?Ya:Tt:Ai));var n=this.yieldPos,s=this.awaitPos,o=this.awaitIdentPos;return this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0,this.enterScope(Xa(a.async,a.generator)),t&we||(a.id=this.type===p.name?this.parseIdent():null),this.parseFunctionParams(a),this.parseFunctionBody(a,e,!1,i),this.yieldPos=n,this.awaitPos=s,this.awaitIdentPos=o,this.finishNode(a,t&we?"FunctionDeclaration":"FunctionExpression")};C.parseFunctionParams=function(a){this.expect(p.parenL),a.params=this.parseBindingList(p.parenR,!1,this.options.ecmaVersion>=8),this.checkYieldAwaitInDefaultParams()};C.parseClass=function(a,t){this.next();var e=this.strict;this.strict=!0,this.parseClassId(a,t),this.parseClassSuper(a);var r=this.enterClassBody(),i=this.startNode(),n=!1;for(i.body=[],this.expect(p.braceL);this.type!==p.braceR;){var s=this.parseClassElement(a.superClass!==null);s&&(i.body.push(s),s.type==="MethodDefinition"&&s.kind==="constructor"?(n&&this.raiseRecoverable(s.start,"Duplicate constructor in the same class"),n=!0):s.key&&s.key.type==="PrivateIdentifier"&&Hn(r,s)&&this.raiseRecoverable(s.key.start,"Identifier '#"+s.key.name+"' has already been declared"))}return this.strict=e,this.next(),a.body=this.finishNode(i,"ClassBody"),this.exitClassBody(),this.finishNode(a,t?"ClassDeclaration":"ClassExpression")};C.parseClassElement=function(a){if(this.eat(p.semi))return null;var t=this.options.ecmaVersion,e=this.startNode(),r="",i=!1,n=!1,s="method",o=!1;if(this.eatContextual("static")){if(t>=13&&this.eat(p.braceL))return this.parseClassStaticBlock(e),e;this.isClassElementNameStart()||this.type===p.star?o=!0:r="static"}if(e.static=o,!r&&t>=8&&this.eatContextual("async")&&((this.isClassElementNameStart()||this.type===p.star)&&!this.canInsertSemicolon()?n=!0:r="async"),!r&&(t>=9||!n)&&this.eat(p.star)&&(i=!0),!r&&!n&&!i){var c=this.value;(this.eatContextual("get")||this.eatContextual("set"))&&(this.isClassElementNameStart()?s=c:r=c)}if(r?(e.computed=!1,e.key=this.startNodeAt(this.lastTokStart,this.lastTokStartLoc),e.key.name=r,this.finishNode(e.key,"Identifier")):this.parseClassElementName(e),t<13||this.type===p.parenL||s!=="method"||i||n){var u=!e.static&&Ue(e,"constructor"),l=u&&a;u&&s!=="method"&&this.raise(e.key.start,"Constructor can't have get/set modifier"),e.kind=u?"constructor":s,this.parseClassMethod(e,i,n,l)}else this.parseClassField(e);return e};C.isClassElementNameStart=function(){return this.type===p.name||this.type===p.privateId||this.type===p.num||this.type===p.string||this.type===p.bracketL||this.type.keyword};C.parseClassElementName=function(a){this.type===p.privateId?(this.value==="constructor"&&this.raise(this.start,"Classes can't have an element named '#constructor'"),a.computed=!1,a.key=this.parsePrivateIdent()):this.parsePropertyName(a)};C.parseClassMethod=function(a,t,e,r){var i=a.key;a.kind==="constructor"?(t&&this.raise(i.start,"Constructor can't be a generator"),e&&this.raise(i.start,"Constructor can't be an async method")):a.static&&Ue(a,"prototype")&&this.raise(i.start,"Classes may not have a static property named prototype");var n=a.value=this.parseMethod(t,e,r);return a.kind==="get"&&n.params.length!==0&&this.raiseRecoverable(n.start,"getter should have no params"),a.kind==="set"&&n.params.length!==1&&this.raiseRecoverable(n.start,"setter should have exactly one param"),a.kind==="set"&&n.params[0].type==="RestElement"&&this.raiseRecoverable(n.params[0].start,"Setter cannot use rest params"),this.finishNode(a,"MethodDefinition")};C.parseClassField=function(a){return Ue(a,"constructor")?this.raise(a.key.start,"Classes can't have a field named 'constructor'"):a.static&&Ue(a,"prototype")&&this.raise(a.key.start,"Classes can't have a static field named 'prototype'"),this.eat(p.eq)?(this.enterScope(Se|ze),a.value=this.parseMaybeAssign(),this.exitScope()):a.value=null,this.semicolon(),this.finishNode(a,"PropertyDefinition")};C.parseClassStaticBlock=function(a){a.body=[];var t=this.labels;for(this.labels=[],this.enterScope(qt|ze);this.type!==p.braceR;){var e=this.parseStatement(null);a.body.push(e)}return this.next(),this.exitScope(),this.labels=t,this.finishNode(a,"StaticBlock")};C.parseClassId=function(a,t){this.type===p.name?(a.id=this.parseIdent(),t&&this.checkLValSimple(a.id,Tt,!1)):(t===!0&&this.unexpected(),a.id=null)};C.parseClassSuper=function(a){a.superClass=this.eat(p._extends)?this.parseExprSubscripts(null,!1):null};C.enterClassBody=function(){var a={declared:Object.create(null),used:[]};return this.privateNameStack.push(a),a.declared};C.exitClassBody=function(){var a=this.privateNameStack.pop(),t=a.declared,e=a.used;if(this.options.checkPrivateFields)for(var r=this.privateNameStack.length,i=r===0?null:this.privateNameStack[r-1],n=0;n<e.length;++n){var s=e[n];se(t,s.name)||(i?i.used.push(s):this.raiseRecoverable(s.start,"Private field '#"+s.name+"' must be declared in an enclosing class"))}};function Hn(a,t){var e=t.key.name,r=a[e],i="true";return t.type==="MethodDefinition"&&(t.kind==="get"||t.kind==="set")&&(i=(t.static?"s":"i")+t.kind),r==="iget"&&i==="iset"||r==="iset"&&i==="iget"||r==="sget"&&i==="sset"||r==="sset"&&i==="sget"?(a[e]="true",!1):r?!0:(a[e]=i,!1)}function Ue(a,t){var e=a.computed,r=a.key;return!e&&(r.type==="Identifier"&&r.name===t||r.type==="Literal"&&r.value===t)}C.parseExportAllDeclaration=function(a,t){return this.options.ecmaVersion>=11&&(this.eatContextual("as")?(a.exported=this.parseModuleExportName(),this.checkExport(t,a.exported,this.lastTokStart)):a.exported=null),this.expectContextual("from"),this.type!==p.string&&this.unexpected(),a.source=this.parseExprAtom(),this.options.ecmaVersion>=16&&(a.attributes=this.parseWithClause()),this.semicolon(),this.finishNode(a,"ExportAllDeclaration")};C.parseExport=function(a,t){if(this.next(),this.eat(p.star))return this.parseExportAllDeclaration(a,t);if(this.eat(p._default))return this.checkExport(t,"default",this.lastTokStart),a.declaration=this.parseExportDefaultDeclaration(),this.finishNode(a,"ExportDefaultDeclaration");if(this.shouldParseExportStatement())a.declaration=this.parseExportDeclaration(a),a.declaration.type==="VariableDeclaration"?this.checkVariableExport(t,a.declaration.declarations):this.checkExport(t,a.declaration.id,a.declaration.id.start),a.specifiers=[],a.source=null,this.options.ecmaVersion>=16&&(a.attributes=[]);else{if(a.declaration=null,a.specifiers=this.parseExportSpecifiers(t),this.eatContextual("from"))this.type!==p.string&&this.unexpected(),a.source=this.parseExprAtom(),this.options.ecmaVersion>=16&&(a.attributes=this.parseWithClause());else{for(var e=0,r=a.specifiers;e<r.length;e+=1){var i=r[e];this.checkUnreserved(i.local),this.checkLocalExport(i.local),i.local.type==="Literal"&&this.raise(i.local.start,"A string literal cannot be used as an exported binding without `from`.")}a.source=null,this.options.ecmaVersion>=16&&(a.attributes=[])}this.semicolon()}return this.finishNode(a,"ExportNamedDeclaration")};C.parseExportDeclaration=function(a){return this.parseStatement(null)};C.parseExportDefaultDeclaration=function(){var a;if(this.type===p._function||(a=this.isAsyncFunction())){var t=this.startNode();return this.next(),a&&this.next(),this.parseFunction(t,we|ki,!1,a)}else if(this.type===p._class){var e=this.startNode();return this.parseClass(e,"nullableID")}else{var r=this.parseMaybeAssign();return this.semicolon(),r}};C.checkExport=function(a,t,e){a&&(typeof t!="string"&&(t=t.type==="Identifier"?t.name:t.value),se(a,t)&&this.raiseRecoverable(e,"Duplicate export '"+t+"'"),a[t]=!0)};C.checkPatternExport=function(a,t){var e=t.type;if(e==="Identifier")this.checkExport(a,t,t.start);else if(e==="ObjectPattern")for(var r=0,i=t.properties;r<i.length;r+=1){var n=i[r];this.checkPatternExport(a,n)}else if(e==="ArrayPattern")for(var s=0,o=t.elements;s<o.length;s+=1){var c=o[s];c&&this.checkPatternExport(a,c)}else e==="Property"?this.checkPatternExport(a,t.value):e==="AssignmentPattern"?this.checkPatternExport(a,t.left):e==="RestElement"&&this.checkPatternExport(a,t.argument)};C.checkVariableExport=function(a,t){if(a)for(var e=0,r=t;e<r.length;e+=1){var i=r[e];this.checkPatternExport(a,i.id)}};C.shouldParseExportStatement=function(){return this.type.keyword==="var"||this.type.keyword==="const"||this.type.keyword==="class"||this.type.keyword==="function"||this.isLet()||this.isAsyncFunction()};C.parseExportSpecifier=function(a){var t=this.startNode();return t.local=this.parseModuleExportName(),t.exported=this.eatContextual("as")?this.parseModuleExportName():t.local,this.checkExport(a,t.exported,t.exported.start),this.finishNode(t,"ExportSpecifier")};C.parseExportSpecifiers=function(a){var t=[],e=!0;for(this.expect(p.braceL);!this.eat(p.braceR);){if(e)e=!1;else if(this.expect(p.comma),this.afterTrailingComma(p.braceR))break;t.push(this.parseExportSpecifier(a))}return t};C.parseImport=function(a){return this.next(),this.type===p.string?(a.specifiers=Jn,a.source=this.parseExprAtom()):(a.specifiers=this.parseImportSpecifiers(),this.expectContextual("from"),a.source=this.type===p.string?this.parseExprAtom():this.unexpected()),this.options.ecmaVersion>=16&&(a.attributes=this.parseWithClause()),this.semicolon(),this.finishNode(a,"ImportDeclaration")};C.parseImportSpecifier=function(){var a=this.startNode();return a.imported=this.parseModuleExportName(),this.eatContextual("as")?a.local=this.parseIdent():(this.checkUnreserved(a.imported),a.local=a.imported),this.checkLValSimple(a.local,Tt),this.finishNode(a,"ImportSpecifier")};C.parseImportDefaultSpecifier=function(){var a=this.startNode();return a.local=this.parseIdent(),this.checkLValSimple(a.local,Tt),this.finishNode(a,"ImportDefaultSpecifier")};C.parseImportNamespaceSpecifier=function(){var a=this.startNode();return this.next(),this.expectContextual("as"),a.local=this.parseIdent(),this.checkLValSimple(a.local,Tt),this.finishNode(a,"ImportNamespaceSpecifier")};C.parseImportSpecifiers=function(){var a=[],t=!0;if(this.type===p.name&&(a.push(this.parseImportDefaultSpecifier()),!this.eat(p.comma)))return a;if(this.type===p.star)return a.push(this.parseImportNamespaceSpecifier()),a;for(this.expect(p.braceL);!this.eat(p.braceR);){if(t)t=!1;else if(this.expect(p.comma),this.afterTrailingComma(p.braceR))break;a.push(this.parseImportSpecifier())}return a};C.parseWithClause=function(){var a=[];if(!this.eat(p._with))return a;this.expect(p.braceL);for(var t={},e=!0;!this.eat(p.braceR);){if(e)e=!1;else if(this.expect(p.comma),this.afterTrailingComma(p.braceR))break;var r=this.parseImportAttribute(),i=r.key.type==="Identifier"?r.key.name:r.key.value;se(t,i)&&this.raiseRecoverable(r.key.start,"Duplicate attribute key '"+i+"'"),t[i]=!0,a.push(r)}return a};C.parseImportAttribute=function(){var a=this.startNode();return a.key=this.type===p.string?this.parseExprAtom():this.parseIdent(this.options.allowReserved!=="never"),this.expect(p.colon),this.type!==p.string&&this.unexpected(),a.value=this.parseExprAtom(),this.finishNode(a,"ImportAttribute")};C.parseModuleExportName=function(){if(this.options.ecmaVersion>=13&&this.type===p.string){var a=this.parseLiteral(this.value);return Un.test(a.value)&&this.raise(a.start,"An export name cannot include a lone surrogate."),a}return this.parseIdent(!0)};C.adaptDirectivePrologue=function(a){for(var t=0;t<a.length&&this.isDirectiveCandidate(a[t]);++t)a[t].directive=a[t].expression.raw.slice(1,-1)};C.isDirectiveCandidate=function(a){return this.options.ecmaVersion>=5&&a.type==="ExpressionStatement"&&a.expression.type==="Literal"&&typeof a.expression.value=="string"&&(this.input[a.start]==='"'||this.input[a.start]==="'")};var dt=H.prototype;dt.toAssignable=function(a,t,e){if(this.options.ecmaVersion>=6&&a)switch(a.type){case"Identifier":this.inAsync&&a.name==="await"&&this.raise(a.start,"Cannot use 'await' as identifier inside an async function");break;case"ObjectPattern":case"ArrayPattern":case"AssignmentPattern":case"RestElement":break;case"ObjectExpression":a.type="ObjectPattern",e&&this.checkPatternErrors(e,!0);for(var r=0,i=a.properties;r<i.length;r+=1){var n=i[r];this.toAssignable(n,t),n.type==="RestElement"&&(n.argument.type==="ArrayPattern"||n.argument.type==="ObjectPattern")&&this.raise(n.argument.start,"Unexpected token")}break;case"Property":a.kind!=="init"&&this.raise(a.key.start,"Object pattern can't contain getter or setter"),this.toAssignable(a.value,t);break;case"ArrayExpression":a.type="ArrayPattern",e&&this.checkPatternErrors(e,!0),this.toAssignableList(a.elements,t);break;case"SpreadElement":a.type="RestElement",this.toAssignable(a.argument,t),a.argument.type==="AssignmentPattern"&&this.raise(a.argument.start,"Rest elements cannot have a default value");break;case"AssignmentExpression":a.operator!=="="&&this.raise(a.left.end,"Only '=' operator can be used for specifying default value."),a.type="AssignmentPattern",delete a.operator,this.toAssignable(a.left,t);break;case"ParenthesizedExpression":this.toAssignable(a.expression,t,e);break;case"ChainExpression":this.raiseRecoverable(a.start,"Optional chaining cannot appear in left-hand side");break;case"MemberExpression":if(!t)break;default:this.raise(a.start,"Assigning to rvalue")}else e&&this.checkPatternErrors(e,!0);return a};dt.toAssignableList=function(a,t){for(var e=a.length,r=0;r<e;r++){var i=a[r];i&&this.toAssignable(i,t)}if(e){var n=a[e-1];this.options.ecmaVersion===6&&t&&n&&n.type==="RestElement"&&n.argument.type!=="Identifier"&&this.unexpected(n.argument.start)}return a};dt.parseSpread=function(a){var t=this.startNode();return this.next(),t.argument=this.parseMaybeAssign(!1,a),this.finishNode(t,"SpreadElement")};dt.parseRestBinding=function(){var a=this.startNode();return this.next(),this.options.ecmaVersion===6&&this.type!==p.name&&this.unexpected(),a.argument=this.parseBindingAtom(),this.finishNode(a,"RestElement")};dt.parseBindingAtom=function(){if(this.options.ecmaVersion>=6)switch(this.type){case p.bracketL:var a=this.startNode();return this.next(),a.elements=this.parseBindingList(p.bracketR,!0,!0),this.finishNode(a,"ArrayPattern");case p.braceL:return this.parseObj(!0)}return this.parseIdent()};dt.parseBindingList=function(a,t,e,r){for(var i=[],n=!0;!this.eat(a);)if(n?n=!1:this.expect(p.comma),t&&this.type===p.comma)i.push(null);else{if(e&&this.afterTrailingComma(a))break;if(this.type===p.ellipsis){var s=this.parseRestBinding();this.parseBindingListItem(s),i.push(s),this.type===p.comma&&this.raiseRecoverable(this.start,"Comma is not permitted after the rest element"),this.expect(a);break}else i.push(this.parseAssignableListItem(r))}return i};dt.parseAssignableListItem=function(a){var t=this.parseMaybeDefault(this.start,this.startLoc);return this.parseBindingListItem(t),t};dt.parseBindingListItem=function(a){return a};dt.parseMaybeDefault=function(a,t,e){if(e=e||this.parseBindingAtom(),this.options.ecmaVersion<6||!this.eat(p.eq))return e;var r=this.startNodeAt(a,t);return r.left=e,r.right=this.parseMaybeAssign(),this.finishNode(r,"AssignmentPattern")};dt.checkLValSimple=function(a,t,e){t===void 0&&(t=qe);var r=t!==qe;switch(a.type){case"Identifier":this.strict&&this.reservedWordsStrictBind.test(a.name)&&this.raiseRecoverable(a.start,(r?"Binding ":"Assigning to ")+a.name+" in strict mode"),r&&(t===Tt&&a.name==="let"&&this.raiseRecoverable(a.start,"let is disallowed as a lexically bound name"),e&&(se(e,a.name)&&this.raiseRecoverable(a.start,"Argument name clash"),e[a.name]=!0),t!==Si&&this.declareName(a.name,t,a.start));break;case"ChainExpression":this.raiseRecoverable(a.start,"Optional chaining cannot appear in left-hand side");break;case"MemberExpression":r&&this.raiseRecoverable(a.start,"Binding member expression");break;case"ParenthesizedExpression":return r&&this.raiseRecoverable(a.start,"Binding parenthesized expression"),this.checkLValSimple(a.expression,t,e);default:this.raise(a.start,(r?"Binding":"Assigning to")+" rvalue")}};dt.checkLValPattern=function(a,t,e){switch(t===void 0&&(t=qe),a.type){case"ObjectPattern":for(var r=0,i=a.properties;r<i.length;r+=1){var n=i[r];this.checkLValInnerPattern(n,t,e)}break;case"ArrayPattern":for(var s=0,o=a.elements;s<o.length;s+=1){var c=o[s];c&&this.checkLValInnerPattern(c,t,e)}break;default:this.checkLValSimple(a,t,e)}};dt.checkLValInnerPattern=function(a,t,e){switch(t===void 0&&(t=qe),a.type){case"Property":this.checkLValInnerPattern(a.value,t,e);break;case"AssignmentPattern":this.checkLValPattern(a.left,t,e);break;case"RestElement":this.checkLValPattern(a.argument,t,e);break;default:this.checkLValPattern(a,t,e)}};var yt=function(t,e,r,i,n){this.token=t,this.isExpr=!!e,this.preserveSpace=!!r,this.override=i,this.generator=!!n},W={b_stat:new yt("{",!1),b_expr:new yt("{",!0),b_tmpl:new yt("${",!1),p_stat:new yt("(",!1),p_expr:new yt("(",!0),q_tmpl:new yt("`",!0,!0,function(a){return a.tryReadTemplateToken()}),f_stat:new yt("function",!1),f_expr:new yt("function",!0),f_expr_gen:new yt("function",!0,!1,null,!0),f_gen:new yt("function",!1,!1,null,!0)},ce=H.prototype;ce.initialContext=function(){return[W.b_stat]};ce.curContext=function(){return this.context[this.context.length-1]};ce.braceIsBlock=function(a){var t=this.curContext();return t===W.f_expr||t===W.f_stat?!0:a===p.colon&&(t===W.b_stat||t===W.b_expr)?!t.isExpr:a===p._return||a===p.name&&this.exprAllowed?at.test(this.input.slice(this.lastTokEnd,this.start)):a===p._else||a===p.semi||a===p.eof||a===p.parenR||a===p.arrow?!0:a===p.braceL?t===W.b_stat:a===p._var||a===p._const||a===p.name?!1:!this.exprAllowed};ce.inGeneratorContext=function(){for(var a=this.context.length-1;a>=1;a--){var t=this.context[a];if(t.token==="function")return t.generator}return!1};ce.updateContext=function(a){var t,e=this.type;e.keyword&&a===p.dot?this.exprAllowed=!1:(t=e.updateContext)?t.call(this,a):this.exprAllowed=e.beforeExpr};ce.overrideContext=function(a){this.curContext()!==a&&(this.context[this.context.length-1]=a)};p.parenR.updateContext=p.braceR.updateContext=function(){if(this.context.length===1){this.exprAllowed=!0;return}var a=this.context.pop();a===W.b_stat&&this.curContext().token==="function"&&(a=this.context.pop()),this.exprAllowed=!a.isExpr};p.braceL.updateContext=function(a){this.context.push(this.braceIsBlock(a)?W.b_stat:W.b_expr),this.exprAllowed=!0};p.dollarBraceL.updateContext=function(){this.context.push(W.b_tmpl),this.exprAllowed=!0};p.parenL.updateContext=function(a){var t=a===p._if||a===p._for||a===p._with||a===p._while;this.context.push(t?W.p_stat:W.p_expr),this.exprAllowed=!0};p.incDec.updateContext=function(){};p._function.updateContext=p._class.updateContext=function(a){a.beforeExpr&&a!==p._else&&!(a===p.semi&&this.curContext()!==W.p_stat)&&!(a===p._return&&at.test(this.input.slice(this.lastTokEnd,this.start)))&&!((a===p.colon||a===p.braceL)&&this.curContext()===W.b_stat)?this.context.push(W.f_expr):this.context.push(W.f_stat),this.exprAllowed=!1};p.colon.updateContext=function(){this.curContext().token==="function"&&this.context.pop(),this.exprAllowed=!0};p.backQuote.updateContext=function(){this.curContext()===W.q_tmpl?this.context.pop():this.context.push(W.q_tmpl),this.exprAllowed=!1};p.star.updateContext=function(a){if(a===p._function){var t=this.context.length-1;this.context[t]===W.f_expr?this.context[t]=W.f_expr_gen:this.context[t]=W.f_gen}this.exprAllowed=!0};p.name.updateContext=function(a){var t=!1;this.options.ecmaVersion>=6&&a!==p.dot&&(this.value==="of"&&!this.exprAllowed||this.value==="yield"&&this.inGeneratorContext())&&(t=!0),this.exprAllowed=t};var D=H.prototype;D.checkPropClash=function(a,t,e){if(!(this.options.ecmaVersion>=9&&a.type==="SpreadElement")&&!(this.options.ecmaVersion>=6&&(a.computed||a.method||a.shorthand))){var r=a.key,i;switch(r.type){case"Identifier":i=r.name;break;case"Literal":i=String(r.value);break;default:return}var n=a.kind;if(this.options.ecmaVersion>=6){i==="__proto__"&&n==="init"&&(t.proto&&(e?e.doubleProto<0&&(e.doubleProto=r.start):this.raiseRecoverable(r.start,"Redefinition of __proto__ property")),t.proto=!0);return}i="$"+i;var s=t[i];if(s){var o;n==="init"?o=this.strict&&s.init||s.get||s.set:o=s.init||s[n],o&&this.raiseRecoverable(r.start,"Redefinition of property")}else s=t[i]={init:!1,get:!1,set:!1};s[n]=!0}};D.parseExpression=function(a,t){var e=this.start,r=this.startLoc,i=this.parseMaybeAssign(a,t);if(this.type===p.comma){var n=this.startNodeAt(e,r);for(n.expressions=[i];this.eat(p.comma);)n.expressions.push(this.parseMaybeAssign(a,t));return this.finishNode(n,"SequenceExpression")}return i};D.parseMaybeAssign=function(a,t,e){if(this.isContextual("yield")){if(this.inGenerator)return this.parseYield(a);this.exprAllowed=!1}var r=!1,i=-1,n=-1,s=-1;t?(i=t.parenthesizedAssign,n=t.trailingComma,s=t.doubleProto,t.parenthesizedAssign=t.trailingComma=-1):(t=new He,r=!0);var o=this.start,c=this.startLoc;(this.type===p.parenL||this.type===p.name)&&(this.potentialArrowAt=this.start,this.potentialArrowInForAwait=a==="await");var u=this.parseMaybeConditional(a,t);if(e&&(u=e.call(this,u,o,c)),this.type.isAssign){var l=this.startNodeAt(o,c);return l.operator=this.value,this.type===p.eq&&(u=this.toAssignable(u,!1,t)),r||(t.parenthesizedAssign=t.trailingComma=t.doubleProto=-1),t.shorthandAssign>=u.start&&(t.shorthandAssign=-1),this.type===p.eq?this.checkLValPattern(u):this.checkLValSimple(u),l.left=u,this.next(),l.right=this.parseMaybeAssign(a),s>-1&&(t.doubleProto=s),this.finishNode(l,"AssignmentExpression")}else r&&this.checkExpressionErrors(t,!0);return i>-1&&(t.parenthesizedAssign=i),n>-1&&(t.trailingComma=n),u};D.parseMaybeConditional=function(a,t){var e=this.start,r=this.startLoc,i=this.parseExprOps(a,t);if(this.checkExpressionErrors(t))return i;if(this.eat(p.question)){var n=this.startNodeAt(e,r);return n.test=i,n.consequent=this.parseMaybeAssign(),this.expect(p.colon),n.alternate=this.parseMaybeAssign(a),this.finishNode(n,"ConditionalExpression")}return i};D.parseExprOps=function(a,t){var e=this.start,r=this.startLoc,i=this.parseMaybeUnary(t,!1,!1,a);return this.checkExpressionErrors(t)||i.start===e&&i.type==="ArrowFunctionExpression"?i:this.parseExprOp(i,e,r,-1,a)};D.parseExprOp=function(a,t,e,r,i){var n=this.type.binop;if(n!=null&&(!i||this.type!==p._in)&&n>r){var s=this.type===p.logicalOR||this.type===p.logicalAND,o=this.type===p.coalesce;o&&(n=p.logicalAND.binop);var c=this.value;this.next();var u=this.start,l=this.startLoc,d=this.parseExprOp(this.parseMaybeUnary(null,!1,!1,i),u,l,n,i),h=this.buildBinary(t,e,a,d,c,s||o);return(s&&this.type===p.coalesce||o&&(this.type===p.logicalOR||this.type===p.logicalAND))&&this.raiseRecoverable(this.start,"Logical expressions and coalesce expressions cannot be mixed. Wrap either by parentheses"),this.parseExprOp(h,t,e,r,i)}return a};D.buildBinary=function(a,t,e,r,i,n){r.type==="PrivateIdentifier"&&this.raise(r.start,"Private identifier can only be left side of binary expression");var s=this.startNodeAt(a,t);return s.left=e,s.operator=i,s.right=r,this.finishNode(s,n?"LogicalExpression":"BinaryExpression")};D.parseMaybeUnary=function(a,t,e,r){var i=this.start,n=this.startLoc,s;if(this.isContextual("await")&&this.canAwait)s=this.parseAwait(r),t=!0;else if(this.type.prefix){var o=this.startNode(),c=this.type===p.incDec;o.operator=this.value,o.prefix=!0,this.next(),o.argument=this.parseMaybeUnary(null,!0,c,r),this.checkExpressionErrors(a,!0),c?this.checkLValSimple(o.argument):this.strict&&o.operator==="delete"&&Di(o.argument)?this.raiseRecoverable(o.start,"Deleting local variable in strict mode"):o.operator==="delete"&&za(o.argument)?this.raiseRecoverable(o.start,"Private fields can not be deleted"):t=!0,s=this.finishNode(o,c?"UpdateExpression":"UnaryExpression")}else if(!t&&this.type===p.privateId)(r||this.privateNameStack.length===0)&&this.options.checkPrivateFields&&this.unexpected(),s=this.parsePrivateIdent(),this.type!==p._in&&this.unexpected();else{if(s=this.parseExprSubscripts(a,r),this.checkExpressionErrors(a))return s;for(;this.type.postfix&&!this.canInsertSemicolon();){var u=this.startNodeAt(i,n);u.operator=this.value,u.prefix=!1,u.argument=s,this.checkLValSimple(s),this.next(),s=this.finishNode(u,"UpdateExpression")}}if(!e&&this.eat(p.starstar))if(t)this.unexpected(this.lastTokStart);else return this.buildBinary(i,n,s,this.parseMaybeUnary(null,!1,!1,r),"**",!1);else return s};function Di(a){return a.type==="Identifier"||a.type==="ParenthesizedExpression"&&Di(a.expression)}function za(a){return a.type==="MemberExpression"&&a.property.type==="PrivateIdentifier"||a.type==="ChainExpression"&&za(a.expression)||a.type==="ParenthesizedExpression"&&za(a.expression)}D.parseExprSubscripts=function(a,t){var e=this.start,r=this.startLoc,i=this.parseExprAtom(a,t);if(i.type==="ArrowFunctionExpression"&&this.input.slice(this.lastTokStart,this.lastTokEnd)!==")")return i;var n=this.parseSubscripts(i,e,r,!1,t);return a&&n.type==="MemberExpression"&&(a.parenthesizedAssign>=n.start&&(a.parenthesizedAssign=-1),a.parenthesizedBind>=n.start&&(a.parenthesizedBind=-1),a.trailingComma>=n.start&&(a.trailingComma=-1)),n};D.parseSubscripts=function(a,t,e,r,i){for(var n=this.options.ecmaVersion>=8&&a.type==="Identifier"&&a.name==="async"&&this.lastTokEnd===a.end&&!this.canInsertSemicolon()&&a.end-a.start===5&&this.potentialArrowAt===a.start,s=!1;;){var o=this.parseSubscript(a,t,e,r,n,s,i);if(o.optional&&(s=!0),o===a||o.type==="ArrowFunctionExpression"){if(s){var c=this.startNodeAt(t,e);c.expression=o,o=this.finishNode(c,"ChainExpression")}return o}a=o}};D.shouldParseAsyncArrow=function(){return!this.canInsertSemicolon()&&this.eat(p.arrow)};D.parseSubscriptAsyncArrow=function(a,t,e,r){return this.parseArrowExpression(this.startNodeAt(a,t),e,!0,r)};D.parseSubscript=function(a,t,e,r,i,n,s){var o=this.options.ecmaVersion>=11,c=o&&this.eat(p.questionDot);r&&c&&this.raise(this.lastTokStart,"Optional chaining cannot appear in the callee of new expressions");var u=this.eat(p.bracketL);if(u||c&&this.type!==p.parenL&&this.type!==p.backQuote||this.eat(p.dot)){var l=this.startNodeAt(t,e);l.object=a,u?(l.property=this.parseExpression(),this.expect(p.bracketR)):this.type===p.privateId&&a.type!=="Super"?l.property=this.parsePrivateIdent():l.property=this.parseIdent(this.options.allowReserved!=="never"),l.computed=!!u,o&&(l.optional=c),a=this.finishNode(l,"MemberExpression")}else if(!r&&this.eat(p.parenL)){var d=new He,h=this.yieldPos,f=this.awaitPos,I=this.awaitIdentPos;this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0;var k=this.parseExprList(p.parenR,this.options.ecmaVersion>=8,!1,d);if(i&&!c&&this.shouldParseAsyncArrow())return this.checkPatternErrors(d,!1),this.checkYieldAwaitInDefaultParams(),this.awaitIdentPos>0&&this.raise(this.awaitIdentPos,"Cannot use 'await' as identifier inside an async function"),this.yieldPos=h,this.awaitPos=f,this.awaitIdentPos=I,this.parseSubscriptAsyncArrow(t,e,k,s);this.checkExpressionErrors(d,!0),this.yieldPos=h||this.yieldPos,this.awaitPos=f||this.awaitPos,this.awaitIdentPos=I||this.awaitIdentPos;var E=this.startNodeAt(t,e);E.callee=a,E.arguments=k,o&&(E.optional=c),a=this.finishNode(E,"CallExpression")}else if(this.type===p.backQuote){(c||n)&&this.raise(this.start,"Optional chaining cannot appear in the tag of tagged template expressions");var N=this.startNodeAt(t,e);N.tag=a,N.quasi=this.parseTemplate({isTagged:!0}),a=this.finishNode(N,"TaggedTemplateExpression")}return a};D.parseExprAtom=function(a,t,e){this.type===p.slash&&this.readRegexp();var r,i=this.potentialArrowAt===this.start;switch(this.type){case p._super:return this.allowSuper||this.raise(this.start,"'super' keyword outside a method"),r=this.startNode(),this.next(),this.type===p.parenL&&!this.allowDirectSuper&&this.raise(r.start,"super() call outside constructor of a subclass"),this.type!==p.dot&&this.type!==p.bracketL&&this.type!==p.parenL&&this.unexpected(),this.finishNode(r,"Super");case p._this:return r=this.startNode(),this.next(),this.finishNode(r,"ThisExpression");case p.name:var n=this.start,s=this.startLoc,o=this.containsEsc,c=this.parseIdent(!1);if(this.options.ecmaVersion>=8&&!o&&c.name==="async"&&!this.canInsertSemicolon()&&this.eat(p._function))return this.overrideContext(W.f_expr),this.parseFunction(this.startNodeAt(n,s),0,!1,!0,t);if(i&&!this.canInsertSemicolon()){if(this.eat(p.arrow))return this.parseArrowExpression(this.startNodeAt(n,s),[c],!1,t);if(this.options.ecmaVersion>=8&&c.name==="async"&&this.type===p.name&&!o&&(!this.potentialArrowInForAwait||this.value!=="of"||this.containsEsc))return c=this.parseIdent(!1),(this.canInsertSemicolon()||!this.eat(p.arrow))&&this.unexpected(),this.parseArrowExpression(this.startNodeAt(n,s),[c],!0,t)}return c;case p.regexp:var u=this.value;return r=this.parseLiteral(u.value),r.regex={pattern:u.pattern,flags:u.flags},r;case p.num:case p.string:return this.parseLiteral(this.value);case p._null:case p._true:case p._false:return r=this.startNode(),r.value=this.type===p._null?null:this.type===p._true,r.raw=this.type.keyword,this.next(),this.finishNode(r,"Literal");case p.parenL:var l=this.start,d=this.parseParenAndDistinguishExpression(i,t);return a&&(a.parenthesizedAssign<0&&!this.isSimpleAssignTarget(d)&&(a.parenthesizedAssign=l),a.parenthesizedBind<0&&(a.parenthesizedBind=l)),d;case p.bracketL:return r=this.startNode(),this.next(),r.elements=this.parseExprList(p.bracketR,!0,!0,a),this.finishNode(r,"ArrayExpression");case p.braceL:return this.overrideContext(W.b_expr),this.parseObj(!1,a);case p._function:return r=this.startNode(),this.next(),this.parseFunction(r,0);case p._class:return this.parseClass(this.startNode(),!1);case p._new:return this.parseNew();case p.backQuote:return this.parseTemplate();case p._import:return this.options.ecmaVersion>=11?this.parseExprImport(e):this.unexpected();default:return this.parseExprAtomDefault()}};D.parseExprAtomDefault=function(){this.unexpected()};D.parseExprImport=function(a){var t=this.startNode();if(this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword import"),this.next(),this.type===p.parenL&&!a)return this.parseDynamicImport(t);if(this.type===p.dot){var e=this.startNodeAt(t.start,t.loc&&t.loc.start);return e.name="import",t.meta=this.finishNode(e,"Identifier"),this.parseImportMeta(t)}else this.unexpected()};D.parseDynamicImport=function(a){if(this.next(),a.source=this.parseMaybeAssign(),this.options.ecmaVersion>=16)this.eat(p.parenR)?a.options=null:(this.expect(p.comma),this.afterTrailingComma(p.parenR)?a.options=null:(a.options=this.parseMaybeAssign(),this.eat(p.parenR)||(this.expect(p.comma),this.afterTrailingComma(p.parenR)||this.unexpected())));else if(!this.eat(p.parenR)){var t=this.start;this.eat(p.comma)&&this.eat(p.parenR)?this.raiseRecoverable(t,"Trailing comma is not allowed in import()"):this.unexpected(t)}return this.finishNode(a,"ImportExpression")};D.parseImportMeta=function(a){this.next();var t=this.containsEsc;return a.property=this.parseIdent(!0),a.property.name!=="meta"&&this.raiseRecoverable(a.property.start,"The only valid meta property for import is 'import.meta'"),t&&this.raiseRecoverable(a.start,"'import.meta' must not contain escaped characters"),this.options.sourceType!=="module"&&!this.options.allowImportExportEverywhere&&this.raiseRecoverable(a.start,"Cannot use 'import.meta' outside a module"),this.finishNode(a,"MetaProperty")};D.parseLiteral=function(a){var t=this.startNode();return t.value=a,t.raw=this.input.slice(this.start,this.end),t.raw.charCodeAt(t.raw.length-1)===110&&(t.bigint=t.value!=null?t.value.toString():t.raw.slice(0,-1).replace(/_/g,"")),this.next(),this.finishNode(t,"Literal")};D.parseParenExpression=function(){this.expect(p.parenL);var a=this.parseExpression();return this.expect(p.parenR),a};D.shouldParseArrow=function(a){return!this.canInsertSemicolon()};D.parseParenAndDistinguishExpression=function(a,t){var e=this.start,r=this.startLoc,i,n=this.options.ecmaVersion>=8;if(this.options.ecmaVersion>=6){this.next();var s=this.start,o=this.startLoc,c=[],u=!0,l=!1,d=new He,h=this.yieldPos,f=this.awaitPos,I;for(this.yieldPos=0,this.awaitPos=0;this.type!==p.parenR;)if(u?u=!1:this.expect(p.comma),n&&this.afterTrailingComma(p.parenR,!0)){l=!0;break}else if(this.type===p.ellipsis){I=this.start,c.push(this.parseParenItem(this.parseRestBinding())),this.type===p.comma&&this.raiseRecoverable(this.start,"Comma is not permitted after the rest element");break}else c.push(this.parseMaybeAssign(!1,d,this.parseParenItem));var k=this.lastTokEnd,E=this.lastTokEndLoc;if(this.expect(p.parenR),a&&this.shouldParseArrow(c)&&this.eat(p.arrow))return this.checkPatternErrors(d,!1),this.checkYieldAwaitInDefaultParams(),this.yieldPos=h,this.awaitPos=f,this.parseParenArrowList(e,r,c,t);(!c.length||l)&&this.unexpected(this.lastTokStart),I&&this.unexpected(I),this.checkExpressionErrors(d,!0),this.yieldPos=h||this.yieldPos,this.awaitPos=f||this.awaitPos,c.length>1?(i=this.startNodeAt(s,o),i.expressions=c,this.finishNodeAt(i,"SequenceExpression",k,E)):i=c[0]}else i=this.parseParenExpression();if(this.options.preserveParens){var N=this.startNodeAt(e,r);return N.expression=i,this.finishNode(N,"ParenthesizedExpression")}else return i};D.parseParenItem=function(a){return a};D.parseParenArrowList=function(a,t,e,r){return this.parseArrowExpression(this.startNodeAt(a,t),e,!1,r)};var Kn=[];D.parseNew=function(){this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword new");var a=this.startNode();if(this.next(),this.options.ecmaVersion>=6&&this.type===p.dot){var t=this.startNodeAt(a.start,a.loc&&a.loc.start);t.name="new",a.meta=this.finishNode(t,"Identifier"),this.next();var e=this.containsEsc;return a.property=this.parseIdent(!0),a.property.name!=="target"&&this.raiseRecoverable(a.property.start,"The only valid meta property for new is 'new.target'"),e&&this.raiseRecoverable(a.start,"'new.target' must not contain escaped characters"),this.allowNewDotTarget||this.raiseRecoverable(a.start,"'new.target' can only be used in functions and class static block"),this.finishNode(a,"MetaProperty")}var r=this.start,i=this.startLoc;return a.callee=this.parseSubscripts(this.parseExprAtom(null,!1,!0),r,i,!0,!1),this.eat(p.parenL)?a.arguments=this.parseExprList(p.parenR,this.options.ecmaVersion>=8,!1):a.arguments=Kn,this.finishNode(a,"NewExpression")};D.parseTemplateElement=function(a){var t=a.isTagged,e=this.startNode();return this.type===p.invalidTemplate?(t||this.raiseRecoverable(this.start,"Bad escape sequence in untagged template literal"),e.value={raw:this.value.replace(/\r\n?/g,`
`),cooked:null}):e.value={raw:this.input.slice(this.start,this.end).replace(/\r\n?/g,`
`),cooked:this.value},this.next(),e.tail=this.type===p.backQuote,this.finishNode(e,"TemplateElement")};D.parseTemplate=function(a){a===void 0&&(a={});var t=a.isTagged;t===void 0&&(t=!1);var e=this.startNode();this.next(),e.expressions=[];var r=this.parseTemplateElement({isTagged:t});for(e.quasis=[r];!r.tail;)this.type===p.eof&&this.raise(this.pos,"Unterminated template literal"),this.expect(p.dollarBraceL),e.expressions.push(this.parseExpression()),this.expect(p.braceR),e.quasis.push(r=this.parseTemplateElement({isTagged:t}));return this.next(),this.finishNode(e,"TemplateLiteral")};D.isAsyncProp=function(a){return!a.computed&&a.key.type==="Identifier"&&a.key.name==="async"&&(this.type===p.name||this.type===p.num||this.type===p.string||this.type===p.bracketL||this.type.keyword||this.options.ecmaVersion>=9&&this.type===p.star)&&!at.test(this.input.slice(this.lastTokEnd,this.start))};D.parseObj=function(a,t){var e=this.startNode(),r=!0,i={};for(e.properties=[],this.next();!this.eat(p.braceR);){if(r)r=!1;else if(this.expect(p.comma),this.options.ecmaVersion>=5&&this.afterTrailingComma(p.braceR))break;var n=this.parseProperty(a,t);a||this.checkPropClash(n,i,t),e.properties.push(n)}return this.finishNode(e,a?"ObjectPattern":"ObjectExpression")};D.parseProperty=function(a,t){var e=this.startNode(),r,i,n,s;if(this.options.ecmaVersion>=9&&this.eat(p.ellipsis))return a?(e.argument=this.parseIdent(!1),this.type===p.comma&&this.raiseRecoverable(this.start,"Comma is not permitted after the rest element"),this.finishNode(e,"RestElement")):(e.argument=this.parseMaybeAssign(!1,t),this.type===p.comma&&t&&t.trailingComma<0&&(t.trailingComma=this.start),this.finishNode(e,"SpreadElement"));this.options.ecmaVersion>=6&&(e.method=!1,e.shorthand=!1,(a||t)&&(n=this.start,s=this.startLoc),a||(r=this.eat(p.star)));var o=this.containsEsc;return this.parsePropertyName(e),!a&&!o&&this.options.ecmaVersion>=8&&!r&&this.isAsyncProp(e)?(i=!0,r=this.options.ecmaVersion>=9&&this.eat(p.star),this.parsePropertyName(e)):i=!1,this.parsePropertyValue(e,a,r,i,n,s,t,o),this.finishNode(e,"Property")};D.parseGetterSetter=function(a){var t=a.key.name;this.parsePropertyName(a),a.value=this.parseMethod(!1),a.kind=t;var e=a.kind==="get"?0:1;if(a.value.params.length!==e){var r=a.value.start;a.kind==="get"?this.raiseRecoverable(r,"getter should have no params"):this.raiseRecoverable(r,"setter should have exactly one param")}else a.kind==="set"&&a.value.params[0].type==="RestElement"&&this.raiseRecoverable(a.value.params[0].start,"Setter cannot use rest params")};D.parsePropertyValue=function(a,t,e,r,i,n,s,o){(e||r)&&this.type===p.colon&&this.unexpected(),this.eat(p.colon)?(a.value=t?this.parseMaybeDefault(this.start,this.startLoc):this.parseMaybeAssign(!1,s),a.kind="init"):this.options.ecmaVersion>=6&&this.type===p.parenL?(t&&this.unexpected(),a.method=!0,a.value=this.parseMethod(e,r),a.kind="init"):!t&&!o&&this.options.ecmaVersion>=5&&!a.computed&&a.key.type==="Identifier"&&(a.key.name==="get"||a.key.name==="set")&&this.type!==p.comma&&this.type!==p.braceR&&this.type!==p.eq?((e||r)&&this.unexpected(),this.parseGetterSetter(a)):this.options.ecmaVersion>=6&&!a.computed&&a.key.type==="Identifier"?((e||r)&&this.unexpected(),this.checkUnreserved(a.key),a.key.name==="await"&&!this.awaitIdentPos&&(this.awaitIdentPos=i),t?a.value=this.parseMaybeDefault(i,n,this.copyNode(a.key)):this.type===p.eq&&s?(s.shorthandAssign<0&&(s.shorthandAssign=this.start),a.value=this.parseMaybeDefault(i,n,this.copyNode(a.key))):a.value=this.copyNode(a.key),a.kind="init",a.shorthand=!0):this.unexpected()};D.parsePropertyName=function(a){if(this.options.ecmaVersion>=6){if(this.eat(p.bracketL))return a.computed=!0,a.key=this.parseMaybeAssign(),this.expect(p.bracketR),a.key;a.computed=!1}return a.key=this.type===p.num||this.type===p.string?this.parseExprAtom():this.parseIdent(this.options.allowReserved!=="never")};D.initFunction=function(a){a.id=null,this.options.ecmaVersion>=6&&(a.generator=a.expression=!1),this.options.ecmaVersion>=8&&(a.async=!1)};D.parseMethod=function(a,t,e){var r=this.startNode(),i=this.yieldPos,n=this.awaitPos,s=this.awaitIdentPos;return this.initFunction(r),this.options.ecmaVersion>=6&&(r.generator=a),this.options.ecmaVersion>=8&&(r.async=!!t),this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0,this.enterScope(Xa(t,r.generator)|ze|(e?wi:0)),this.expect(p.parenL),r.params=this.parseBindingList(p.parenR,!1,this.options.ecmaVersion>=8),this.checkYieldAwaitInDefaultParams(),this.parseFunctionBody(r,!1,!0,!1),this.yieldPos=i,this.awaitPos=n,this.awaitIdentPos=s,this.finishNode(r,"FunctionExpression")};D.parseArrowExpression=function(a,t,e,r){var i=this.yieldPos,n=this.awaitPos,s=this.awaitIdentPos;return this.enterScope(Xa(e,!1)|Ka),this.initFunction(a),this.options.ecmaVersion>=8&&(a.async=!!e),this.yieldPos=0,this.awaitPos=0,this.awaitIdentPos=0,a.params=this.toAssignableList(t,!0),this.parseFunctionBody(a,!0,!1,r),this.yieldPos=i,this.awaitPos=n,this.awaitIdentPos=s,this.finishNode(a,"ArrowFunctionExpression")};D.parseFunctionBody=function(a,t,e,r){var i=t&&this.type!==p.braceL,n=this.strict,s=!1;if(i)a.body=this.parseMaybeAssign(r),a.expression=!0,this.checkParams(a,!1);else{var o=this.options.ecmaVersion>=7&&!this.isSimpleParamList(a.params);(!n||o)&&(s=this.strictDirective(this.end),s&&o&&this.raiseRecoverable(a.start,"Illegal 'use strict' directive in function with non-simple parameter list"));var c=this.labels;this.labels=[],s&&(this.strict=!0),this.checkParams(a,!n&&!s&&!t&&!e&&this.isSimpleParamList(a.params)),this.strict&&a.id&&this.checkLValSimple(a.id,Si),a.body=this.parseBlock(!1,void 0,s&&!n),a.expression=!1,this.adaptDirectivePrologue(a.body.body),this.labels=c}this.exitScope()};D.isSimpleParamList=function(a){for(var t=0,e=a;t<e.length;t+=1){var r=e[t];if(r.type!=="Identifier")return!1}return!0};D.checkParams=function(a,t){for(var e=Object.create(null),r=0,i=a.params;r<i.length;r+=1){var n=i[r];this.checkLValInnerPattern(n,Ya,t?null:e)}};D.parseExprList=function(a,t,e,r){for(var i=[],n=!0;!this.eat(a);){if(n)n=!1;else if(this.expect(p.comma),t&&this.afterTrailingComma(a))break;var s=void 0;e&&this.type===p.comma?s=null:this.type===p.ellipsis?(s=this.parseSpread(r),r&&this.type===p.comma&&r.trailingComma<0&&(r.trailingComma=this.start)):s=this.parseMaybeAssign(!1,r),i.push(s)}return i};D.checkUnreserved=function(a){var t=a.start,e=a.end,r=a.name;if(this.inGenerator&&r==="yield"&&this.raiseRecoverable(t,"Cannot use 'yield' as identifier inside a generator"),this.inAsync&&r==="await"&&this.raiseRecoverable(t,"Cannot use 'await' as identifier inside an async function"),!(this.currentThisScope().flags&Je)&&r==="arguments"&&this.raiseRecoverable(t,"Cannot use 'arguments' in class field initializer"),this.inClassStaticBlock&&(r==="arguments"||r==="await")&&this.raise(t,"Cannot use "+r+" in class static initialization block"),this.keywords.test(r)&&this.raise(t,"Unexpected keyword '"+r+"'"),!(this.options.ecmaVersion<6&&this.input.slice(t,e).indexOf("\\")!==-1)){var i=this.strict?this.reservedWordsStrict:this.reservedWords;i.test(r)&&(!this.inAsync&&r==="await"&&this.raiseRecoverable(t,"Cannot use keyword 'await' outside an async function"),this.raiseRecoverable(t,"The keyword '"+r+"' is reserved"))}};D.parseIdent=function(a){var t=this.parseIdentNode();return this.next(!!a),this.finishNode(t,"Identifier"),a||(this.checkUnreserved(t),t.name==="await"&&!this.awaitIdentPos&&(this.awaitIdentPos=t.start)),t};D.parseIdentNode=function(){var a=this.startNode();return this.type===p.name?a.name=this.value:this.type.keyword?(a.name=this.type.keyword,(a.name==="class"||a.name==="function")&&(this.lastTokEnd!==this.lastTokStart+1||this.input.charCodeAt(this.lastTokStart)!==46)&&this.context.pop(),this.type=p.name):this.unexpected(),a};D.parsePrivateIdent=function(){var a=this.startNode();return this.type===p.privateId?a.name=this.value:this.unexpected(),this.next(),this.finishNode(a,"PrivateIdentifier"),this.options.checkPrivateFields&&(this.privateNameStack.length===0?this.raise(a.start,"Private field '#"+a.name+"' must be declared in an enclosing class"):this.privateNameStack[this.privateNameStack.length-1].used.push(a)),a};D.parseYield=function(a){this.yieldPos||(this.yieldPos=this.start);var t=this.startNode();return this.next(),this.type===p.semi||this.canInsertSemicolon()||this.type!==p.star&&!this.type.startsExpr?(t.delegate=!1,t.argument=null):(t.delegate=this.eat(p.star),t.argument=this.parseMaybeAssign(a)),this.finishNode(t,"YieldExpression")};D.parseAwait=function(a){this.awaitPos||(this.awaitPos=this.start);var t=this.startNode();return this.next(),t.argument=this.parseMaybeUnary(null,!0,!1,a),this.finishNode(t,"AwaitExpression")};var je=H.prototype;je.raise=function(a,t){var e=Ri(this.input,a);t+=" ("+e.line+":"+e.column+")",this.sourceFile&&(t+=" in "+this.sourceFile);var r=new SyntaxError(t);throw r.pos=a,r.loc=e,r.raisedAt=this.pos,r};je.raiseRecoverable=je.raise;je.curPosition=function(){if(this.options.locations)return new Ae(this.curLine,this.pos-this.lineStart)};var Lt=H.prototype,Xn=function(t){this.flags=t,this.var=[],this.lexical=[],this.functions=[]};Lt.enterScope=function(a){this.scopeStack.push(new Xn(a))};Lt.exitScope=function(){this.scopeStack.pop()};Lt.treatFunctionsAsVarInScope=function(a){return a.flags&oe||!this.inModule&&a.flags&Ce};Lt.declareName=function(a,t,e){var r=!1;if(t===Tt){var i=this.currentScope();r=i.lexical.indexOf(a)>-1||i.functions.indexOf(a)>-1||i.var.indexOf(a)>-1,i.lexical.push(a),this.inModule&&i.flags&Ce&&delete this.undefinedExports[a]}else if(t===Ci){var n=this.currentScope();n.lexical.push(a)}else if(t===Ai){var s=this.currentScope();this.treatFunctionsAsVar?r=s.lexical.indexOf(a)>-1:r=s.lexical.indexOf(a)>-1||s.var.indexOf(a)>-1,s.functions.push(a)}else for(var o=this.scopeStack.length-1;o>=0;--o){var c=this.scopeStack[o];if(c.lexical.indexOf(a)>-1&&!(c.flags&vi&&c.lexical[0]===a)||!this.treatFunctionsAsVarInScope(c)&&c.functions.indexOf(a)>-1){r=!0;break}if(c.var.push(a),this.inModule&&c.flags&Ce&&delete this.undefinedExports[a],c.flags&Je)break}r&&this.raiseRecoverable(e,"Identifier '"+a+"' has already been declared")};Lt.checkLocalExport=function(a){this.scopeStack[0].lexical.indexOf(a.name)===-1&&this.scopeStack[0].var.indexOf(a.name)===-1&&(this.undefinedExports[a.name]=a)};Lt.currentScope=function(){return this.scopeStack[this.scopeStack.length-1]};Lt.currentVarScope=function(){for(var a=this.scopeStack.length-1;;a--){var t=this.scopeStack[a];if(t.flags&(Je|Se|qt))return t}};Lt.currentThisScope=function(){for(var a=this.scopeStack.length-1;;a--){var t=this.scopeStack[a];if(t.flags&(Je|Se|qt)&&!(t.flags&Ka))return t}};var Ke=function(t,e,r){this.type="",this.start=e,this.end=0,t.options.locations&&(this.loc=new We(t,r)),t.options.directSourceFile&&(this.sourceFile=t.options.directSourceFile),t.options.ranges&&(this.range=[e,0])},ke=H.prototype;ke.startNode=function(){return new Ke(this,this.start,this.startLoc)};ke.startNodeAt=function(a,t){return new Ke(this,a,t)};function Ti(a,t,e,r){return a.type=t,a.end=e,this.options.locations&&(a.loc.end=r),this.options.ranges&&(a.range[1]=e),a}ke.finishNode=function(a,t){return Ti.call(this,a,t,this.lastTokEnd,this.lastTokEndLoc)};ke.finishNodeAt=function(a,t,e,r){return Ti.call(this,a,t,e,r)};ke.copyNode=function(a){var t=new Ke(this,a.start,this.startLoc);for(var e in a)t[e]=a[e];return t};var Yn="Gara Garay Gukh Gurung_Khema Hrkt Katakana_Or_Hiragana Kawi Kirat_Rai Krai Nag_Mundari Nagm Ol_Onal Onao Sunu Sunuwar Todhri Todr Tulu_Tigalari Tutg Unknown Zzzz",Ni="ASCII ASCII_Hex_Digit AHex Alphabetic Alpha Any Assigned Bidi_Control Bidi_C Bidi_Mirrored Bidi_M Case_Ignorable CI Cased Changes_When_Casefolded CWCF Changes_When_Casemapped CWCM Changes_When_Lowercased CWL Changes_When_NFKC_Casefolded CWKCF Changes_When_Titlecased CWT Changes_When_Uppercased CWU Dash Default_Ignorable_Code_Point DI Deprecated Dep Diacritic Dia Emoji Emoji_Component Emoji_Modifier Emoji_Modifier_Base Emoji_Presentation Extender Ext Grapheme_Base Gr_Base Grapheme_Extend Gr_Ext Hex_Digit Hex IDS_Binary_Operator IDSB IDS_Trinary_Operator IDST ID_Continue IDC ID_Start IDS Ideographic Ideo Join_Control Join_C Logical_Order_Exception LOE Lowercase Lower Math Noncharacter_Code_Point NChar Pattern_Syntax Pat_Syn Pattern_White_Space Pat_WS Quotation_Mark QMark Radical Regional_Indicator RI Sentence_Terminal STerm Soft_Dotted SD Terminal_Punctuation Term Unified_Ideograph UIdeo Uppercase Upper Variation_Selector VS White_Space space XID_Continue XIDC XID_Start XIDS",Pi=Ni+" Extended_Pictographic",Mi=Pi,_i=Mi+" EBase EComp EMod EPres ExtPict",Bi=_i,Zn=Bi,ts={9:Ni,10:Pi,11:Mi,12:_i,13:Bi,14:Zn},es="Basic_Emoji Emoji_Keycap_Sequence RGI_Emoji_Modifier_Sequence RGI_Emoji_Flag_Sequence RGI_Emoji_Tag_Sequence RGI_Emoji_ZWJ_Sequence RGI_Emoji",as={9:"",10:"",11:"",12:"",13:"",14:es},fi="Cased_Letter LC Close_Punctuation Pe Connector_Punctuation Pc Control Cc cntrl Currency_Symbol Sc Dash_Punctuation Pd Decimal_Number Nd digit Enclosing_Mark Me Final_Punctuation Pf Format Cf Initial_Punctuation Pi Letter L Letter_Number Nl Line_Separator Zl Lowercase_Letter Ll Mark M Combining_Mark Math_Symbol Sm Modifier_Letter Lm Modifier_Symbol Sk Nonspacing_Mark Mn Number N Open_Punctuation Ps Other C Other_Letter Lo Other_Number No Other_Punctuation Po Other_Symbol So Paragraph_Separator Zp Private_Use Co Punctuation P punct Separator Z Space_Separator Zs Spacing_Mark Mc Surrogate Cs Symbol S Titlecase_Letter Lt Unassigned Cn Uppercase_Letter Lu",Vi="Adlam Adlm Ahom Anatolian_Hieroglyphs Hluw Arabic Arab Armenian Armn Avestan Avst Balinese Bali Bamum Bamu Bassa_Vah Bass Batak Batk Bengali Beng Bhaiksuki Bhks Bopomofo Bopo Brahmi Brah Braille Brai Buginese Bugi Buhid Buhd Canadian_Aboriginal Cans Carian Cari Caucasian_Albanian Aghb Chakma Cakm Cham Cham Cherokee Cher Common Zyyy Coptic Copt Qaac Cuneiform Xsux Cypriot Cprt Cyrillic Cyrl Deseret Dsrt Devanagari Deva Duployan Dupl Egyptian_Hieroglyphs Egyp Elbasan Elba Ethiopic Ethi Georgian Geor Glagolitic Glag Gothic Goth Grantha Gran Greek Grek Gujarati Gujr Gurmukhi Guru Han Hani Hangul Hang Hanunoo Hano Hatran Hatr Hebrew Hebr Hiragana Hira Imperial_Aramaic Armi Inherited Zinh Qaai Inscriptional_Pahlavi Phli Inscriptional_Parthian Prti Javanese Java Kaithi Kthi Kannada Knda Katakana Kana Kayah_Li Kali Kharoshthi Khar Khmer Khmr Khojki Khoj Khudawadi Sind Lao Laoo Latin Latn Lepcha Lepc Limbu Limb Linear_A Lina Linear_B Linb Lisu Lisu Lycian Lyci Lydian Lydi Mahajani Mahj Malayalam Mlym Mandaic Mand Manichaean Mani Marchen Marc Masaram_Gondi Gonm Meetei_Mayek Mtei Mende_Kikakui Mend Meroitic_Cursive Merc Meroitic_Hieroglyphs Mero Miao Plrd Modi Mongolian Mong Mro Mroo Multani Mult Myanmar Mymr Nabataean Nbat New_Tai_Lue Talu Newa Newa Nko Nkoo Nushu Nshu Ogham Ogam Ol_Chiki Olck Old_Hungarian Hung Old_Italic Ital Old_North_Arabian Narb Old_Permic Perm Old_Persian Xpeo Old_South_Arabian Sarb Old_Turkic Orkh Oriya Orya Osage Osge Osmanya Osma Pahawh_Hmong Hmng Palmyrene Palm Pau_Cin_Hau Pauc Phags_Pa Phag Phoenician Phnx Psalter_Pahlavi Phlp Rejang Rjng Runic Runr Samaritan Samr Saurashtra Saur Sharada Shrd Shavian Shaw Siddham Sidd SignWriting Sgnw Sinhala Sinh Sora_Sompeng Sora Soyombo Soyo Sundanese Sund Syloti_Nagri Sylo Syriac Syrc Tagalog Tglg Tagbanwa Tagb Tai_Le Tale Tai_Tham Lana Tai_Viet Tavt Takri Takr Tamil Taml Tangut Tang Telugu Telu Thaana Thaa Thai Thai Tibetan Tibt Tifinagh Tfng Tirhuta Tirh Ugaritic Ugar Vai Vaii Warang_Citi Wara Yi Yiii Zanabazar_Square Zanb",Fi=Vi+" Dogra Dogr Gunjala_Gondi Gong Hanifi_Rohingya Rohg Makasar Maka Medefaidrin Medf Old_Sogdian Sogo Sogdian Sogd",Li=Fi+" Elymaic Elym Nandinagari Nand Nyiakeng_Puachue_Hmong Hmnp Wancho Wcho",Oi=Li+" Chorasmian Chrs Diak Dives_Akuru Khitan_Small_Script Kits Yezi Yezidi",Qi=Oi+" Cypro_Minoan Cpmn Old_Uyghur Ougr Tangsa Tnsa Toto Vithkuqi Vith",rs=Qi+" "+Yn,is={9:Vi,10:Fi,11:Li,12:Oi,13:Qi,14:rs},$i={};function ns(a){var t=$i[a]={binary:Vt(ts[a]+" "+fi),binaryOfStrings:Vt(as[a]),nonBinary:{General_Category:Vt(fi),Script:Vt(is[a])}};t.nonBinary.Script_Extensions=t.nonBinary.Script,t.nonBinary.gc=t.nonBinary.General_Category,t.nonBinary.sc=t.nonBinary.Script,t.nonBinary.scx=t.nonBinary.Script_Extensions}for($e=0,Ua=[9,10,11,12,13,14];$e<Ua.length;$e+=1)mi=Ua[$e],ns(mi);var mi,$e,Ua,A=H.prototype,Ge=function(t,e){this.parent=t,this.base=e||this};Ge.prototype.separatedFrom=function(t){for(var e=this;e;e=e.parent)for(var r=t;r;r=r.parent)if(e.base===r.base&&e!==r)return!0;return!1};Ge.prototype.sibling=function(){return new Ge(this.parent,this.base)};var Ct=function(t){this.parser=t,this.validFlags="gim"+(t.options.ecmaVersion>=6?"uy":"")+(t.options.ecmaVersion>=9?"s":"")+(t.options.ecmaVersion>=13?"d":"")+(t.options.ecmaVersion>=15?"v":""),this.unicodeProperties=$i[t.options.ecmaVersion>=14?14:t.options.ecmaVersion],this.source="",this.flags="",this.start=0,this.switchU=!1,this.switchV=!1,this.switchN=!1,this.pos=0,this.lastIntValue=0,this.lastStringValue="",this.lastAssertionIsQuantifiable=!1,this.numCapturingParens=0,this.maxBackReference=0,this.groupNames=Object.create(null),this.backReferenceNames=[],this.branchID=null};Ct.prototype.reset=function(t,e,r){var i=r.indexOf("v")!==-1,n=r.indexOf("u")!==-1;this.start=t|0,this.source=e+"",this.flags=r,i&&this.parser.options.ecmaVersion>=15?(this.switchU=!0,this.switchV=!0,this.switchN=!0):(this.switchU=n&&this.parser.options.ecmaVersion>=6,this.switchV=!1,this.switchN=n&&this.parser.options.ecmaVersion>=9)};Ct.prototype.raise=function(t){this.parser.raiseRecoverable(this.start,"Invalid regular expression: /"+this.source+"/: "+t)};Ct.prototype.at=function(t,e){e===void 0&&(e=!1);var r=this.source,i=r.length;if(t>=i)return-1;var n=r.charCodeAt(t);if(!(e||this.switchU)||n<=55295||n>=57344||t+1>=i)return n;var s=r.charCodeAt(t+1);return s>=56320&&s<=57343?(n<<10)+s-56613888:n};Ct.prototype.nextIndex=function(t,e){e===void 0&&(e=!1);var r=this.source,i=r.length;if(t>=i)return i;var n=r.charCodeAt(t),s;return!(e||this.switchU)||n<=55295||n>=57344||t+1>=i||(s=r.charCodeAt(t+1))<56320||s>57343?t+1:t+2};Ct.prototype.current=function(t){return t===void 0&&(t=!1),this.at(this.pos,t)};Ct.prototype.lookahead=function(t){return t===void 0&&(t=!1),this.at(this.nextIndex(this.pos,t),t)};Ct.prototype.advance=function(t){t===void 0&&(t=!1),this.pos=this.nextIndex(this.pos,t)};Ct.prototype.eat=function(t,e){return e===void 0&&(e=!1),this.current(e)===t?(this.advance(e),!0):!1};Ct.prototype.eatChars=function(t,e){e===void 0&&(e=!1);for(var r=this.pos,i=0,n=t;i<n.length;i+=1){var s=n[i],o=this.at(r,e);if(o===-1||o!==s)return!1;r=this.nextIndex(r,e)}return this.pos=r,!0};A.validateRegExpFlags=function(a){for(var t=a.validFlags,e=a.flags,r=!1,i=!1,n=0;n<e.length;n++){var s=e.charAt(n);t.indexOf(s)===-1&&this.raise(a.start,"Invalid regular expression flag"),e.indexOf(s,n+1)>-1&&this.raise(a.start,"Duplicate regular expression flag"),s==="u"&&(r=!0),s==="v"&&(i=!0)}this.options.ecmaVersion>=15&&r&&i&&this.raise(a.start,"Invalid regular expression flag")};function ss(a){for(var t in a)return!0;return!1}A.validateRegExpPattern=function(a){this.regexp_pattern(a),!a.switchN&&this.options.ecmaVersion>=9&&ss(a.groupNames)&&(a.switchN=!0,this.regexp_pattern(a))};A.regexp_pattern=function(a){a.pos=0,a.lastIntValue=0,a.lastStringValue="",a.lastAssertionIsQuantifiable=!1,a.numCapturingParens=0,a.maxBackReference=0,a.groupNames=Object.create(null),a.backReferenceNames.length=0,a.branchID=null,this.regexp_disjunction(a),a.pos!==a.source.length&&(a.eat(41)&&a.raise("Unmatched ')'"),(a.eat(93)||a.eat(125))&&a.raise("Lone quantifier brackets")),a.maxBackReference>a.numCapturingParens&&a.raise("Invalid escape");for(var t=0,e=a.backReferenceNames;t<e.length;t+=1){var r=e[t];a.groupNames[r]||a.raise("Invalid named capture referenced")}};A.regexp_disjunction=function(a){var t=this.options.ecmaVersion>=16;for(t&&(a.branchID=new Ge(a.branchID,null)),this.regexp_alternative(a);a.eat(124);)t&&(a.branchID=a.branchID.sibling()),this.regexp_alternative(a);t&&(a.branchID=a.branchID.parent),this.regexp_eatQuantifier(a,!0)&&a.raise("Nothing to repeat"),a.eat(123)&&a.raise("Lone quantifier brackets")};A.regexp_alternative=function(a){for(;a.pos<a.source.length&&this.regexp_eatTerm(a););};A.regexp_eatTerm=function(a){return this.regexp_eatAssertion(a)?(a.lastAssertionIsQuantifiable&&this.regexp_eatQuantifier(a)&&a.switchU&&a.raise("Invalid quantifier"),!0):(a.switchU?this.regexp_eatAtom(a):this.regexp_eatExtendedAtom(a))?(this.regexp_eatQuantifier(a),!0):!1};A.regexp_eatAssertion=function(a){var t=a.pos;if(a.lastAssertionIsQuantifiable=!1,a.eat(94)||a.eat(36))return!0;if(a.eat(92)){if(a.eat(66)||a.eat(98))return!0;a.pos=t}if(a.eat(40)&&a.eat(63)){var e=!1;if(this.options.ecmaVersion>=9&&(e=a.eat(60)),a.eat(61)||a.eat(33))return this.regexp_disjunction(a),a.eat(41)||a.raise("Unterminated group"),a.lastAssertionIsQuantifiable=!e,!0}return a.pos=t,!1};A.regexp_eatQuantifier=function(a,t){return t===void 0&&(t=!1),this.regexp_eatQuantifierPrefix(a,t)?(a.eat(63),!0):!1};A.regexp_eatQuantifierPrefix=function(a,t){return a.eat(42)||a.eat(43)||a.eat(63)||this.regexp_eatBracedQuantifier(a,t)};A.regexp_eatBracedQuantifier=function(a,t){var e=a.pos;if(a.eat(123)){var r=0,i=-1;if(this.regexp_eatDecimalDigits(a)&&(r=a.lastIntValue,a.eat(44)&&this.regexp_eatDecimalDigits(a)&&(i=a.lastIntValue),a.eat(125)))return i!==-1&&i<r&&!t&&a.raise("numbers out of order in {} quantifier"),!0;a.switchU&&!t&&a.raise("Incomplete quantifier"),a.pos=e}return!1};A.regexp_eatAtom=function(a){return this.regexp_eatPatternCharacters(a)||a.eat(46)||this.regexp_eatReverseSolidusAtomEscape(a)||this.regexp_eatCharacterClass(a)||this.regexp_eatUncapturingGroup(a)||this.regexp_eatCapturingGroup(a)};A.regexp_eatReverseSolidusAtomEscape=function(a){var t=a.pos;if(a.eat(92)){if(this.regexp_eatAtomEscape(a))return!0;a.pos=t}return!1};A.regexp_eatUncapturingGroup=function(a){var t=a.pos;if(a.eat(40)){if(a.eat(63)){if(this.options.ecmaVersion>=16){var e=this.regexp_eatModifiers(a),r=a.eat(45);if(e||r){for(var i=0;i<e.length;i++){var n=e.charAt(i);e.indexOf(n,i+1)>-1&&a.raise("Duplicate regular expression modifiers")}if(r){var s=this.regexp_eatModifiers(a);!e&&!s&&a.current()===58&&a.raise("Invalid regular expression modifiers");for(var o=0;o<s.length;o++){var c=s.charAt(o);(s.indexOf(c,o+1)>-1||e.indexOf(c)>-1)&&a.raise("Duplicate regular expression modifiers")}}}}if(a.eat(58)){if(this.regexp_disjunction(a),a.eat(41))return!0;a.raise("Unterminated group")}}a.pos=t}return!1};A.regexp_eatCapturingGroup=function(a){if(a.eat(40)){if(this.options.ecmaVersion>=9?this.regexp_groupSpecifier(a):a.current()===63&&a.raise("Invalid group"),this.regexp_disjunction(a),a.eat(41))return a.numCapturingParens+=1,!0;a.raise("Unterminated group")}return!1};A.regexp_eatModifiers=function(a){for(var t="",e=0;(e=a.current())!==-1&&os(e);)t+=kt(e),a.advance();return t};function os(a){return a===105||a===109||a===115}A.regexp_eatExtendedAtom=function(a){return a.eat(46)||this.regexp_eatReverseSolidusAtomEscape(a)||this.regexp_eatCharacterClass(a)||this.regexp_eatUncapturingGroup(a)||this.regexp_eatCapturingGroup(a)||this.regexp_eatInvalidBracedQuantifier(a)||this.regexp_eatExtendedPatternCharacter(a)};A.regexp_eatInvalidBracedQuantifier=function(a){return this.regexp_eatBracedQuantifier(a,!0)&&a.raise("Nothing to repeat"),!1};A.regexp_eatSyntaxCharacter=function(a){var t=a.current();return qi(t)?(a.lastIntValue=t,a.advance(),!0):!1};function qi(a){return a===36||a>=40&&a<=43||a===46||a===63||a>=91&&a<=94||a>=123&&a<=125}A.regexp_eatPatternCharacters=function(a){for(var t=a.pos,e=0;(e=a.current())!==-1&&!qi(e);)a.advance();return a.pos!==t};A.regexp_eatExtendedPatternCharacter=function(a){var t=a.current();return t!==-1&&t!==36&&!(t>=40&&t<=43)&&t!==46&&t!==63&&t!==91&&t!==94&&t!==124?(a.advance(),!0):!1};A.regexp_groupSpecifier=function(a){if(a.eat(63)){this.regexp_eatGroupName(a)||a.raise("Invalid group");var t=this.options.ecmaVersion>=16,e=a.groupNames[a.lastStringValue];if(e)if(t)for(var r=0,i=e;r<i.length;r+=1){var n=i[r];n.separatedFrom(a.branchID)||a.raise("Duplicate capture group name")}else a.raise("Duplicate capture group name");t?(e||(a.groupNames[a.lastStringValue]=[])).push(a.branchID):a.groupNames[a.lastStringValue]=!0}};A.regexp_eatGroupName=function(a){if(a.lastStringValue="",a.eat(60)){if(this.regexp_eatRegExpIdentifierName(a)&&a.eat(62))return!0;a.raise("Invalid capture group name")}return!1};A.regexp_eatRegExpIdentifierName=function(a){if(a.lastStringValue="",this.regexp_eatRegExpIdentifierStart(a)){for(a.lastStringValue+=kt(a.lastIntValue);this.regexp_eatRegExpIdentifierPart(a);)a.lastStringValue+=kt(a.lastIntValue);return!0}return!1};A.regexp_eatRegExpIdentifierStart=function(a){var t=a.pos,e=this.options.ecmaVersion>=11,r=a.current(e);return a.advance(e),r===92&&this.regexp_eatRegExpUnicodeEscapeSequence(a,e)&&(r=a.lastIntValue),cs(r)?(a.lastIntValue=r,!0):(a.pos=t,!1)};function cs(a){return wt(a,!0)||a===36||a===95}A.regexp_eatRegExpIdentifierPart=function(a){var t=a.pos,e=this.options.ecmaVersion>=11,r=a.current(e);return a.advance(e),r===92&&this.regexp_eatRegExpUnicodeEscapeSequence(a,e)&&(r=a.lastIntValue),us(r)?(a.lastIntValue=r,!0):(a.pos=t,!1)};function us(a){return Ft(a,!0)||a===36||a===95||a===8204||a===8205}A.regexp_eatAtomEscape=function(a){return this.regexp_eatBackReference(a)||this.regexp_eatCharacterClassEscape(a)||this.regexp_eatCharacterEscape(a)||a.switchN&&this.regexp_eatKGroupName(a)?!0:(a.switchU&&(a.current()===99&&a.raise("Invalid unicode escape"),a.raise("Invalid escape")),!1)};A.regexp_eatBackReference=function(a){var t=a.pos;if(this.regexp_eatDecimalEscape(a)){var e=a.lastIntValue;if(a.switchU)return e>a.maxBackReference&&(a.maxBackReference=e),!0;if(e<=a.numCapturingParens)return!0;a.pos=t}return!1};A.regexp_eatKGroupName=function(a){if(a.eat(107)){if(this.regexp_eatGroupName(a))return a.backReferenceNames.push(a.lastStringValue),!0;a.raise("Invalid named reference")}return!1};A.regexp_eatCharacterEscape=function(a){return this.regexp_eatControlEscape(a)||this.regexp_eatCControlLetter(a)||this.regexp_eatZero(a)||this.regexp_eatHexEscapeSequence(a)||this.regexp_eatRegExpUnicodeEscapeSequence(a,!1)||!a.switchU&&this.regexp_eatLegacyOctalEscapeSequence(a)||this.regexp_eatIdentityEscape(a)};A.regexp_eatCControlLetter=function(a){var t=a.pos;if(a.eat(99)){if(this.regexp_eatControlLetter(a))return!0;a.pos=t}return!1};A.regexp_eatZero=function(a){return a.current()===48&&!Xe(a.lookahead())?(a.lastIntValue=0,a.advance(),!0):!1};A.regexp_eatControlEscape=function(a){var t=a.current();return t===116?(a.lastIntValue=9,a.advance(),!0):t===110?(a.lastIntValue=10,a.advance(),!0):t===118?(a.lastIntValue=11,a.advance(),!0):t===102?(a.lastIntValue=12,a.advance(),!0):t===114?(a.lastIntValue=13,a.advance(),!0):!1};A.regexp_eatControlLetter=function(a){var t=a.current();return Ui(t)?(a.lastIntValue=t%32,a.advance(),!0):!1};function Ui(a){return a>=65&&a<=90||a>=97&&a<=122}A.regexp_eatRegExpUnicodeEscapeSequence=function(a,t){t===void 0&&(t=!1);var e=a.pos,r=t||a.switchU;if(a.eat(117)){if(this.regexp_eatFixedHexDigits(a,4)){var i=a.lastIntValue;if(r&&i>=55296&&i<=56319){var n=a.pos;if(a.eat(92)&&a.eat(117)&&this.regexp_eatFixedHexDigits(a,4)){var s=a.lastIntValue;if(s>=56320&&s<=57343)return a.lastIntValue=(i-55296)*1024+(s-56320)+65536,!0}a.pos=n,a.lastIntValue=i}return!0}if(r&&a.eat(123)&&this.regexp_eatHexDigits(a)&&a.eat(125)&&ls(a.lastIntValue))return!0;r&&a.raise("Invalid unicode escape"),a.pos=e}return!1};function ls(a){return a>=0&&a<=1114111}A.regexp_eatIdentityEscape=function(a){if(a.switchU)return this.regexp_eatSyntaxCharacter(a)?!0:a.eat(47)?(a.lastIntValue=47,!0):!1;var t=a.current();return t!==99&&(!a.switchN||t!==107)?(a.lastIntValue=t,a.advance(),!0):!1};A.regexp_eatDecimalEscape=function(a){a.lastIntValue=0;var t=a.current();if(t>=49&&t<=57){do a.lastIntValue=10*a.lastIntValue+(t-48),a.advance();while((t=a.current())>=48&&t<=57);return!0}return!1};var ji=0,Dt=1,pt=2;A.regexp_eatCharacterClassEscape=function(a){var t=a.current();if(ps(t))return a.lastIntValue=-1,a.advance(),Dt;var e=!1;if(a.switchU&&this.options.ecmaVersion>=9&&((e=t===80)||t===112)){a.lastIntValue=-1,a.advance();var r;if(a.eat(123)&&(r=this.regexp_eatUnicodePropertyValueExpression(a))&&a.eat(125))return e&&r===pt&&a.raise("Invalid property name"),r;a.raise("Invalid property name")}return ji};function ps(a){return a===100||a===68||a===115||a===83||a===119||a===87}A.regexp_eatUnicodePropertyValueExpression=function(a){var t=a.pos;if(this.regexp_eatUnicodePropertyName(a)&&a.eat(61)){var e=a.lastStringValue;if(this.regexp_eatUnicodePropertyValue(a)){var r=a.lastStringValue;return this.regexp_validateUnicodePropertyNameAndValue(a,e,r),Dt}}if(a.pos=t,this.regexp_eatLoneUnicodePropertyNameOrValue(a)){var i=a.lastStringValue;return this.regexp_validateUnicodePropertyNameOrValue(a,i)}return ji};A.regexp_validateUnicodePropertyNameAndValue=function(a,t,e){se(a.unicodeProperties.nonBinary,t)||a.raise("Invalid property name"),a.unicodeProperties.nonBinary[t].test(e)||a.raise("Invalid property value")};A.regexp_validateUnicodePropertyNameOrValue=function(a,t){if(a.unicodeProperties.binary.test(t))return Dt;if(a.switchV&&a.unicodeProperties.binaryOfStrings.test(t))return pt;a.raise("Invalid property name")};A.regexp_eatUnicodePropertyName=function(a){var t=0;for(a.lastStringValue="";Gi(t=a.current());)a.lastStringValue+=kt(t),a.advance();return a.lastStringValue!==""};function Gi(a){return Ui(a)||a===95}A.regexp_eatUnicodePropertyValue=function(a){var t=0;for(a.lastStringValue="";ds(t=a.current());)a.lastStringValue+=kt(t),a.advance();return a.lastStringValue!==""};function ds(a){return Gi(a)||Xe(a)}A.regexp_eatLoneUnicodePropertyNameOrValue=function(a){return this.regexp_eatUnicodePropertyValue(a)};A.regexp_eatCharacterClass=function(a){if(a.eat(91)){var t=a.eat(94),e=this.regexp_classContents(a);return a.eat(93)||a.raise("Unterminated character class"),t&&e===pt&&a.raise("Negated character class may contain strings"),!0}return!1};A.regexp_classContents=function(a){return a.current()===93?Dt:a.switchV?this.regexp_classSetExpression(a):(this.regexp_nonEmptyClassRanges(a),Dt)};A.regexp_nonEmptyClassRanges=function(a){for(;this.regexp_eatClassAtom(a);){var t=a.lastIntValue;if(a.eat(45)&&this.regexp_eatClassAtom(a)){var e=a.lastIntValue;a.switchU&&(t===-1||e===-1)&&a.raise("Invalid character class"),t!==-1&&e!==-1&&t>e&&a.raise("Range out of order in character class")}}};A.regexp_eatClassAtom=function(a){var t=a.pos;if(a.eat(92)){if(this.regexp_eatClassEscape(a))return!0;if(a.switchU){var e=a.current();(e===99||Ji(e))&&a.raise("Invalid class escape"),a.raise("Invalid escape")}a.pos=t}var r=a.current();return r!==93?(a.lastIntValue=r,a.advance(),!0):!1};A.regexp_eatClassEscape=function(a){var t=a.pos;if(a.eat(98))return a.lastIntValue=8,!0;if(a.switchU&&a.eat(45))return a.lastIntValue=45,!0;if(!a.switchU&&a.eat(99)){if(this.regexp_eatClassControlLetter(a))return!0;a.pos=t}return this.regexp_eatCharacterClassEscape(a)||this.regexp_eatCharacterEscape(a)};A.regexp_classSetExpression=function(a){var t=Dt,e;if(!this.regexp_eatClassSetRange(a))if(e=this.regexp_eatClassSetOperand(a)){e===pt&&(t=pt);for(var r=a.pos;a.eatChars([38,38]);){if(a.current()!==38&&(e=this.regexp_eatClassSetOperand(a))){e!==pt&&(t=Dt);continue}a.raise("Invalid character in character class")}if(r!==a.pos)return t;for(;a.eatChars([45,45]);)this.regexp_eatClassSetOperand(a)||a.raise("Invalid character in character class");if(r!==a.pos)return t}else a.raise("Invalid character in character class");for(;;)if(!this.regexp_eatClassSetRange(a)){if(e=this.regexp_eatClassSetOperand(a),!e)return t;e===pt&&(t=pt)}};A.regexp_eatClassSetRange=function(a){var t=a.pos;if(this.regexp_eatClassSetCharacter(a)){var e=a.lastIntValue;if(a.eat(45)&&this.regexp_eatClassSetCharacter(a)){var r=a.lastIntValue;return e!==-1&&r!==-1&&e>r&&a.raise("Range out of order in character class"),!0}a.pos=t}return!1};A.regexp_eatClassSetOperand=function(a){return this.regexp_eatClassSetCharacter(a)?Dt:this.regexp_eatClassStringDisjunction(a)||this.regexp_eatNestedClass(a)};A.regexp_eatNestedClass=function(a){var t=a.pos;if(a.eat(91)){var e=a.eat(94),r=this.regexp_classContents(a);if(a.eat(93))return e&&r===pt&&a.raise("Negated character class may contain strings"),r;a.pos=t}if(a.eat(92)){var i=this.regexp_eatCharacterClassEscape(a);if(i)return i;a.pos=t}return null};A.regexp_eatClassStringDisjunction=function(a){var t=a.pos;if(a.eatChars([92,113])){if(a.eat(123)){var e=this.regexp_classStringDisjunctionContents(a);if(a.eat(125))return e}else a.raise("Invalid escape");a.pos=t}return null};A.regexp_classStringDisjunctionContents=function(a){for(var t=this.regexp_classString(a);a.eat(124);)this.regexp_classString(a)===pt&&(t=pt);return t};A.regexp_classString=function(a){for(var t=0;this.regexp_eatClassSetCharacter(a);)t++;return t===1?Dt:pt};A.regexp_eatClassSetCharacter=function(a){var t=a.pos;if(a.eat(92))return this.regexp_eatCharacterEscape(a)||this.regexp_eatClassSetReservedPunctuator(a)?!0:a.eat(98)?(a.lastIntValue=8,!0):(a.pos=t,!1);var e=a.current();return e<0||e===a.lookahead()&&hs(e)||fs(e)?!1:(a.advance(),a.lastIntValue=e,!0)};function hs(a){return a===33||a>=35&&a<=38||a>=42&&a<=44||a===46||a>=58&&a<=64||a===94||a===96||a===126}function fs(a){return a===40||a===41||a===45||a===47||a>=91&&a<=93||a>=123&&a<=125}A.regexp_eatClassSetReservedPunctuator=function(a){var t=a.current();return ms(t)?(a.lastIntValue=t,a.advance(),!0):!1};function ms(a){return a===33||a===35||a===37||a===38||a===44||a===45||a>=58&&a<=62||a===64||a===96||a===126}A.regexp_eatClassControlLetter=function(a){var t=a.current();return Xe(t)||t===95?(a.lastIntValue=t%32,a.advance(),!0):!1};A.regexp_eatHexEscapeSequence=function(a){var t=a.pos;if(a.eat(120)){if(this.regexp_eatFixedHexDigits(a,2))return!0;a.switchU&&a.raise("Invalid escape"),a.pos=t}return!1};A.regexp_eatDecimalDigits=function(a){var t=a.pos,e=0;for(a.lastIntValue=0;Xe(e=a.current());)a.lastIntValue=10*a.lastIntValue+(e-48),a.advance();return a.pos!==t};function Xe(a){return a>=48&&a<=57}A.regexp_eatHexDigits=function(a){var t=a.pos,e=0;for(a.lastIntValue=0;Wi(e=a.current());)a.lastIntValue=16*a.lastIntValue+zi(e),a.advance();return a.pos!==t};function Wi(a){return a>=48&&a<=57||a>=65&&a<=70||a>=97&&a<=102}function zi(a){return a>=65&&a<=70?10+(a-65):a>=97&&a<=102?10+(a-97):a-48}A.regexp_eatLegacyOctalEscapeSequence=function(a){if(this.regexp_eatOctalDigit(a)){var t=a.lastIntValue;if(this.regexp_eatOctalDigit(a)){var e=a.lastIntValue;t<=3&&this.regexp_eatOctalDigit(a)?a.lastIntValue=t*64+e*8+a.lastIntValue:a.lastIntValue=t*8+e}else a.lastIntValue=t;return!0}return!1};A.regexp_eatOctalDigit=function(a){var t=a.current();return Ji(t)?(a.lastIntValue=t-48,a.advance(),!0):(a.lastIntValue=0,!1)};function Ji(a){return a>=48&&a<=55}A.regexp_eatFixedHexDigits=function(a,t){var e=a.pos;a.lastIntValue=0;for(var r=0;r<t;++r){var i=a.current();if(!Wi(i))return a.pos=e,!1;a.lastIntValue=16*a.lastIntValue+zi(i),a.advance()}return!0};var tr=function(t){this.type=t.type,this.value=t.value,this.start=t.start,this.end=t.end,t.options.locations&&(this.loc=new We(t,t.startLoc,t.endLoc)),t.options.ranges&&(this.range=[t.start,t.end])},M=H.prototype;M.next=function(a){!a&&this.type.keyword&&this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword "+this.type.keyword),this.options.onToken&&this.options.onToken(new tr(this)),this.lastTokEnd=this.end,this.lastTokStart=this.start,this.lastTokEndLoc=this.endLoc,this.lastTokStartLoc=this.startLoc,this.nextToken()};M.getToken=function(){return this.next(),new tr(this)};typeof Symbol<"u"&&(M[Symbol.iterator]=function(){var a=this;return{next:function(){var t=a.getToken();return{done:t.type===p.eof,value:t}}}});M.nextToken=function(){var a=this.curContext();if((!a||!a.preserveSpace)&&this.skipSpace(),this.start=this.pos,this.options.locations&&(this.startLoc=this.curPosition()),this.pos>=this.input.length)return this.finishToken(p.eof);if(a.override)return a.override(this);this.readToken(this.fullCharCodeAtPos())};M.readToken=function(a){return wt(a,this.options.ecmaVersion>=6)||a===92?this.readWord():this.getTokenFromCode(a)};M.fullCharCodeAtPos=function(){var a=this.input.charCodeAt(this.pos);if(a<=55295||a>=56320)return a;var t=this.input.charCodeAt(this.pos+1);return t<=56319||t>=57344?a:(a<<10)+t-56613888};M.skipBlockComment=function(){var a=this.options.onComment&&this.curPosition(),t=this.pos,e=this.input.indexOf("*/",this.pos+=2);if(e===-1&&this.raise(this.pos-2,"Unterminated comment"),this.pos=e+2,this.options.locations)for(var r=void 0,i=t;(r=bi(this.input,i,this.pos))>-1;)++this.curLine,i=this.lineStart=r;this.options.onComment&&this.options.onComment(!0,this.input.slice(t+2,e),t,this.pos,a,this.curPosition())};M.skipLineComment=function(a){for(var t=this.pos,e=this.options.onComment&&this.curPosition(),r=this.input.charCodeAt(this.pos+=a);this.pos<this.input.length&&!ne(r);)r=this.input.charCodeAt(++this.pos);this.options.onComment&&this.options.onComment(!1,this.input.slice(t+a,this.pos),t,this.pos,e,this.curPosition())};M.skipSpace=function(){t:for(;this.pos<this.input.length;){var a=this.input.charCodeAt(this.pos);switch(a){case 32:case 160:++this.pos;break;case 13:this.input.charCodeAt(this.pos+1)===10&&++this.pos;case 10:case 8232:case 8233:++this.pos,this.options.locations&&(++this.curLine,this.lineStart=this.pos);break;case 47:switch(this.input.charCodeAt(this.pos+1)){case 42:this.skipBlockComment();break;case 47:this.skipLineComment(2);break;default:break t}break;default:if(a>8&&a<14||a>=5760&&Ii.test(String.fromCharCode(a)))++this.pos;else break t}}};M.finishToken=function(a,t){this.end=this.pos,this.options.locations&&(this.endLoc=this.curPosition());var e=this.type;this.type=a,this.value=t,this.updateContext(e)};M.readToken_dot=function(){var a=this.input.charCodeAt(this.pos+1);if(a>=48&&a<=57)return this.readNumber(!0);var t=this.input.charCodeAt(this.pos+2);return this.options.ecmaVersion>=6&&a===46&&t===46?(this.pos+=3,this.finishToken(p.ellipsis)):(++this.pos,this.finishToken(p.dot))};M.readToken_slash=function(){var a=this.input.charCodeAt(this.pos+1);return this.exprAllowed?(++this.pos,this.readRegexp()):a===61?this.finishOp(p.assign,2):this.finishOp(p.slash,1)};M.readToken_mult_modulo_exp=function(a){var t=this.input.charCodeAt(this.pos+1),e=1,r=a===42?p.star:p.modulo;return this.options.ecmaVersion>=7&&a===42&&t===42&&(++e,r=p.starstar,t=this.input.charCodeAt(this.pos+2)),t===61?this.finishOp(p.assign,e+1):this.finishOp(r,e)};M.readToken_pipe_amp=function(a){var t=this.input.charCodeAt(this.pos+1);if(t===a){if(this.options.ecmaVersion>=12){var e=this.input.charCodeAt(this.pos+2);if(e===61)return this.finishOp(p.assign,3)}return this.finishOp(a===124?p.logicalOR:p.logicalAND,2)}return t===61?this.finishOp(p.assign,2):this.finishOp(a===124?p.bitwiseOR:p.bitwiseAND,1)};M.readToken_caret=function(){var a=this.input.charCodeAt(this.pos+1);return a===61?this.finishOp(p.assign,2):this.finishOp(p.bitwiseXOR,1)};M.readToken_plus_min=function(a){var t=this.input.charCodeAt(this.pos+1);return t===a?t===45&&!this.inModule&&this.input.charCodeAt(this.pos+2)===62&&(this.lastTokEnd===0||at.test(this.input.slice(this.lastTokEnd,this.pos)))?(this.skipLineComment(3),this.skipSpace(),this.nextToken()):this.finishOp(p.incDec,2):t===61?this.finishOp(p.assign,2):this.finishOp(p.plusMin,1)};M.readToken_lt_gt=function(a){var t=this.input.charCodeAt(this.pos+1),e=1;return t===a?(e=a===62&&this.input.charCodeAt(this.pos+2)===62?3:2,this.input.charCodeAt(this.pos+e)===61?this.finishOp(p.assign,e+1):this.finishOp(p.bitShift,e)):t===33&&a===60&&!this.inModule&&this.input.charCodeAt(this.pos+2)===45&&this.input.charCodeAt(this.pos+3)===45?(this.skipLineComment(4),this.skipSpace(),this.nextToken()):(t===61&&(e=2),this.finishOp(p.relational,e))};M.readToken_eq_excl=function(a){var t=this.input.charCodeAt(this.pos+1);return t===61?this.finishOp(p.equality,this.input.charCodeAt(this.pos+2)===61?3:2):a===61&&t===62&&this.options.ecmaVersion>=6?(this.pos+=2,this.finishToken(p.arrow)):this.finishOp(a===61?p.eq:p.prefix,1)};M.readToken_question=function(){var a=this.options.ecmaVersion;if(a>=11){var t=this.input.charCodeAt(this.pos+1);if(t===46){var e=this.input.charCodeAt(this.pos+2);if(e<48||e>57)return this.finishOp(p.questionDot,2)}if(t===63){if(a>=12){var r=this.input.charCodeAt(this.pos+2);if(r===61)return this.finishOp(p.assign,3)}return this.finishOp(p.coalesce,2)}}return this.finishOp(p.question,1)};M.readToken_numberSign=function(){var a=this.options.ecmaVersion,t=35;if(a>=13&&(++this.pos,t=this.fullCharCodeAtPos(),wt(t,!0)||t===92))return this.finishToken(p.privateId,this.readWord1());this.raise(this.pos,"Unexpected character '"+kt(t)+"'")};M.getTokenFromCode=function(a){switch(a){case 46:return this.readToken_dot();case 40:return++this.pos,this.finishToken(p.parenL);case 41:return++this.pos,this.finishToken(p.parenR);case 59:return++this.pos,this.finishToken(p.semi);case 44:return++this.pos,this.finishToken(p.comma);case 91:return++this.pos,this.finishToken(p.bracketL);case 93:return++this.pos,this.finishToken(p.bracketR);case 123:return++this.pos,this.finishToken(p.braceL);case 125:return++this.pos,this.finishToken(p.braceR);case 58:return++this.pos,this.finishToken(p.colon);case 96:if(this.options.ecmaVersion<6)break;return++this.pos,this.finishToken(p.backQuote);case 48:var t=this.input.charCodeAt(this.pos+1);if(t===120||t===88)return this.readRadixNumber(16);if(this.options.ecmaVersion>=6){if(t===111||t===79)return this.readRadixNumber(8);if(t===98||t===66)return this.readRadixNumber(2)}case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.readNumber(!1);case 34:case 39:return this.readString(a);case 47:return this.readToken_slash();case 37:case 42:return this.readToken_mult_modulo_exp(a);case 124:case 38:return this.readToken_pipe_amp(a);case 94:return this.readToken_caret();case 43:case 45:return this.readToken_plus_min(a);case 60:case 62:return this.readToken_lt_gt(a);case 61:case 33:return this.readToken_eq_excl(a);case 63:return this.readToken_question();case 126:return this.finishOp(p.prefix,1);case 35:return this.readToken_numberSign()}this.raise(this.pos,"Unexpected character '"+kt(a)+"'")};M.finishOp=function(a,t){var e=this.input.slice(this.pos,this.pos+t);return this.pos+=t,this.finishToken(a,e)};M.readRegexp=function(){for(var a,t,e=this.pos;;){this.pos>=this.input.length&&this.raise(e,"Unterminated regular expression");var r=this.input.charAt(this.pos);if(at.test(r)&&this.raise(e,"Unterminated regular expression"),a)a=!1;else{if(r==="[")t=!0;else if(r==="]"&&t)t=!1;else if(r==="/"&&!t)break;a=r==="\\"}++this.pos}var i=this.input.slice(e,this.pos);++this.pos;var n=this.pos,s=this.readWord1();this.containsEsc&&this.unexpected(n);var o=this.regexpState||(this.regexpState=new Ct(this));o.reset(e,i,s),this.validateRegExpFlags(o),this.validateRegExpPattern(o);var c=null;try{c=new RegExp(i,s)}catch{}return this.finishToken(p.regexp,{pattern:i,flags:s,value:c})};M.readInt=function(a,t,e){for(var r=this.options.ecmaVersion>=12&&t===void 0,i=e&&this.input.charCodeAt(this.pos)===48,n=this.pos,s=0,o=0,c=0,u=t??1/0;c<u;++c,++this.pos){var l=this.input.charCodeAt(this.pos),d=void 0;if(r&&l===95){i&&this.raiseRecoverable(this.pos,"Numeric separator is not allowed in legacy octal numeric literals"),o===95&&this.raiseRecoverable(this.pos,"Numeric separator must be exactly one underscore"),c===0&&this.raiseRecoverable(this.pos,"Numeric separator is not allowed at the first of digits"),o=l;continue}if(l>=97?d=l-97+10:l>=65?d=l-65+10:l>=48&&l<=57?d=l-48:d=1/0,d>=a)break;o=l,s=s*a+d}return r&&o===95&&this.raiseRecoverable(this.pos-1,"Numeric separator is not allowed at the last of digits"),this.pos===n||t!=null&&this.pos-n!==t?null:s};function ys(a,t){return t?parseInt(a,8):parseFloat(a.replace(/_/g,""))}function Hi(a){return typeof BigInt!="function"?null:BigInt(a.replace(/_/g,""))}M.readRadixNumber=function(a){var t=this.pos;this.pos+=2;var e=this.readInt(a);return e==null&&this.raise(this.start+2,"Expected number in radix "+a),this.options.ecmaVersion>=11&&this.input.charCodeAt(this.pos)===110?(e=Hi(this.input.slice(t,this.pos)),++this.pos):wt(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number"),this.finishToken(p.num,e)};M.readNumber=function(a){var t=this.pos;!a&&this.readInt(10,void 0,!0)===null&&this.raise(t,"Invalid number");var e=this.pos-t>=2&&this.input.charCodeAt(t)===48;e&&this.strict&&this.raise(t,"Invalid number");var r=this.input.charCodeAt(this.pos);if(!e&&!a&&this.options.ecmaVersion>=11&&r===110){var i=Hi(this.input.slice(t,this.pos));return++this.pos,wt(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number"),this.finishToken(p.num,i)}e&&/[89]/.test(this.input.slice(t,this.pos))&&(e=!1),r===46&&!e&&(++this.pos,this.readInt(10),r=this.input.charCodeAt(this.pos)),(r===69||r===101)&&!e&&(r=this.input.charCodeAt(++this.pos),(r===43||r===45)&&++this.pos,this.readInt(10)===null&&this.raise(t,"Invalid number")),wt(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number");var n=ys(this.input.slice(t,this.pos),e);return this.finishToken(p.num,n)};M.readCodePoint=function(){var a=this.input.charCodeAt(this.pos),t;if(a===123){this.options.ecmaVersion<6&&this.unexpected();var e=++this.pos;t=this.readHexChar(this.input.indexOf("}",this.pos)-this.pos),++this.pos,t>1114111&&this.invalidStringToken(e,"Code point out of bounds")}else t=this.readHexChar(4);return t};M.readString=function(a){for(var t="",e=++this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated string constant");var r=this.input.charCodeAt(this.pos);if(r===a)break;r===92?(t+=this.input.slice(e,this.pos),t+=this.readEscapedChar(!1),e=this.pos):r===8232||r===8233?(this.options.ecmaVersion<10&&this.raise(this.start,"Unterminated string constant"),++this.pos,this.options.locations&&(this.curLine++,this.lineStart=this.pos)):(ne(r)&&this.raise(this.start,"Unterminated string constant"),++this.pos)}return t+=this.input.slice(e,this.pos++),this.finishToken(p.string,t)};var Ki={};M.tryReadTemplateToken=function(){this.inTemplateElement=!0;try{this.readTmplToken()}catch(a){if(a===Ki)this.readInvalidTemplateToken();else throw a}this.inTemplateElement=!1};M.invalidStringToken=function(a,t){if(this.inTemplateElement&&this.options.ecmaVersion>=9)throw Ki;this.raise(a,t)};M.readTmplToken=function(){for(var a="",t=this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated template");var e=this.input.charCodeAt(this.pos);if(e===96||e===36&&this.input.charCodeAt(this.pos+1)===123)return this.pos===this.start&&(this.type===p.template||this.type===p.invalidTemplate)?e===36?(this.pos+=2,this.finishToken(p.dollarBraceL)):(++this.pos,this.finishToken(p.backQuote)):(a+=this.input.slice(t,this.pos),this.finishToken(p.template,a));if(e===92)a+=this.input.slice(t,this.pos),a+=this.readEscapedChar(!0),t=this.pos;else if(ne(e)){switch(a+=this.input.slice(t,this.pos),++this.pos,e){case 13:this.input.charCodeAt(this.pos)===10&&++this.pos;case 10:a+=`
`;break;default:a+=String.fromCharCode(e);break}this.options.locations&&(++this.curLine,this.lineStart=this.pos),t=this.pos}else++this.pos}};M.readInvalidTemplateToken=function(){for(;this.pos<this.input.length;this.pos++)switch(this.input[this.pos]){case"\\":++this.pos;break;case"$":if(this.input[this.pos+1]!=="{")break;case"`":return this.finishToken(p.invalidTemplate,this.input.slice(this.start,this.pos));case"\r":this.input[this.pos+1]===`
`&&++this.pos;case`
`:case"\u2028":case"\u2029":++this.curLine,this.lineStart=this.pos+1;break}this.raise(this.start,"Unterminated template")};M.readEscapedChar=function(a){var t=this.input.charCodeAt(++this.pos);switch(++this.pos,t){case 110:return`
`;case 114:return"\r";case 120:return String.fromCharCode(this.readHexChar(2));case 117:return kt(this.readCodePoint());case 116:return"	";case 98:return"\b";case 118:return"\v";case 102:return"\f";case 13:this.input.charCodeAt(this.pos)===10&&++this.pos;case 10:return this.options.locations&&(this.lineStart=this.pos,++this.curLine),"";case 56:case 57:if(this.strict&&this.invalidStringToken(this.pos-1,"Invalid escape sequence"),a){var e=this.pos-1;this.invalidStringToken(e,"Invalid escape sequence in template string")}default:if(t>=48&&t<=55){var r=this.input.substr(this.pos-1,3).match(/^[0-7]+/)[0],i=parseInt(r,8);return i>255&&(r=r.slice(0,-1),i=parseInt(r,8)),this.pos+=r.length-1,t=this.input.charCodeAt(this.pos),(r!=="0"||t===56||t===57)&&(this.strict||a)&&this.invalidStringToken(this.pos-1-r.length,a?"Octal literal in template string":"Octal literal in strict mode"),String.fromCharCode(i)}return ne(t)?(this.options.locations&&(this.lineStart=this.pos,++this.curLine),""):String.fromCharCode(t)}};M.readHexChar=function(a){var t=this.pos,e=this.readInt(16,a);return e===null&&this.invalidStringToken(t,"Bad character escape sequence"),e};M.readWord1=function(){this.containsEsc=!1;for(var a="",t=!0,e=this.pos,r=this.options.ecmaVersion>=6;this.pos<this.input.length;){var i=this.fullCharCodeAtPos();if(Ft(i,r))this.pos+=i<=65535?1:2;else if(i===92){this.containsEsc=!0,a+=this.input.slice(e,this.pos);var n=this.pos;this.input.charCodeAt(++this.pos)!==117&&this.invalidStringToken(this.pos,"Expecting Unicode escape sequence \\uXXXX"),++this.pos;var s=this.readCodePoint();(t?wt:Ft)(s,r)||this.invalidStringToken(n,"Invalid Unicode escape"),a+=kt(s),e=this.pos}else break;t=!1}return a+this.input.slice(e,this.pos)};M.readWord=function(){var a=this.readWord1(),t=p.name;return this.keywords.test(a)&&(t=Ja[a]),this.finishToken(t,a)};var gs="8.15.0";H.acorn={Parser:H,version:gs,defaultOptions:Ga,Position:Ae,SourceLocation:We,getLineInfo:Ri,Node:Ke,TokenType:$,tokTypes:p,keywordTypes:Ja,TokContext:yt,tokContexts:W,isIdentifierChar:Ft,isIdentifierStart:wt,Token:tr,isNewLine:ne,lineBreak:at,lineBreakG:Qn,nonASCIIwhitespace:Ii};var Ut=class a{constructor(t,e){this._type="BoolAtomData";this._options=e,this.uuid=v(e),this.type=t.type||"atom",this.data=t.data}static{this.isKlass=!0}static{this.displayName="BoolAtomData"}static{this.instances=[]}static{this.public={type:{type:"string",required:!0,collection:!1,defaultValue:()=>"atom"},data:{instanceType:{},required:!0,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, BoolAtomData`);return this.instances.push(r),r}static stringify(t){let e={type:t.type,data:S(t.data)},r={type:"BoolAtomData",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={data:t.data};return t.type!=="atom"&&(r.type=t.type),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="BoolAtomData"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}},jt=class a{constructor(t,e){this._type="BoolExpressionData";this._options=e,this.uuid=v(e),this.type=t.type||"expression",this.operator=t.operator||"and",this.left=t.left,this.right=t.right}static{this.isKlass=!0}static{this.displayName="BoolExpressionData"}static{this.instances=[]}static{this.public={type:{type:"string",required:!1,collection:!1,defaultValue:()=>"expression"},operator:{type:"string",required:!0,collection:!1,options:["and","or","not"],defaultValue:()=>"and"},left:{instanceType:{},required:!0,collection:!1},right:{instanceType:{},required:!1,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, BoolExpressionData`);return this.instances.push(r),r}static stringify(t){let e={type:t.type,operator:t.operator,left:S(t.left),right:t.right?S(t.right):void 0},r={type:"BoolExpressionData",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={left:t.left};return t.type!=="expression"&&(r.type=t.type),t.operator!=="and"&&(r.operator=t.operator),t.right!==void 0&&(r.right=t.right),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="BoolExpressionData"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}},L=class a{constructor(t){this.raw=t;if(!t)throw new Error("BoolExp raw data cannot be undefined")}static atom(t){return new a({type:"atom",data:t})}static and(...t){let e=t.filter(n=>!!n),[r,...i]=e;return i.reduce((n,s)=>n.and(s),a.atom(r))}static or(...t){let e=t.filter(n=>!!n),[r,...i]=e;return i.reduce((n,s)=>n.or(s),a.atom(r))}isAtom(){return this.raw.type==="atom"}get type(){return this.raw.type}get left(){return new a(this.raw.left)}get right(){return this.raw.right?new a(this.raw.right):void 0}get data(){return this.raw.data}toValue(){return this.raw}static fromValue(t){return new a(t)}isExpression(){return this.raw.type==="expression"}and(t){return new a({type:"expression",operator:"and",left:this.raw,right:t instanceof a?t.raw:t&&typeof t=="object"&&t.type==="atom"||t.type==="expression"?t:{type:"atom",data:t}})}isAnd(){return this.raw.operator==="and"}isOr(){return this.raw.operator==="or"}isNot(){return this.raw.operator==="not"}or(t){return new a({type:"expression",operator:"or",left:this.raw,right:t instanceof a?t.raw:{type:"atom",data:t}})}not(){return new a({type:"expression",operator:"not",left:this.raw})}map(t,e=[]){if(this.isExpression()){let r=this.left.map(t,["left"]);if(this.isNot())return r.not();{let i=this.right.map(t,["right"]);return this.isAnd()?r.and(i):r.or(i)}}else{let r=t(this,e);return r instanceof a?r:a.atom(r)}}find(t,e){if(this.isAtom()){if(t(this.data,e))return this.data}else{let r=this.left.find(t,e.concat(this));if(r)return r;if(this.right)return this.right.find(t,e.concat(this))}}evaluate(t,e=[],r=!1){let i=e.concat(this.raw);if(this.isAtom()){let n=this.raw.data,s=t(n);return s&&!r||!s&&r?!0:{data:n,inverse:r,stack:e,error:"atom evaluate error"}}if(this.isOr())return this.left.evaluate(t,i)===!0?!0:this.right.evaluate(t,i);if(this.isAnd()){let n=this.left.evaluate(t,i);return n!==!0?n:this.right.evaluate(t,i)}if(this.isNot())return this.left.evaluate(t,i,!r);throw new Error(`invalid bool expression type: ${JSON.stringify(this.raw)}`)}async evaluateAsync(t,e=[],r=!1){let i=e.concat(this.raw);if(this.isAtom()){let n=this.raw.data,s=await t(n);return s&&!r||!s&&r?!0:{data:n,inverse:r,stack:e,error:"atom evaluate error"}}if(this.isOr())return await this.left.evaluateAsync(t,i)===!0?!0:this.right.evaluateAsync(t,i);if(this.isAnd()){let n=await this.left.evaluateAsync(t,i);return n!==!0?n:this.right.evaluateAsync(t,i)}if(this.isNot())return this.left.evaluateAsync(t,i,!r);throw new Error(`invalid bool expression type: ${JSON.stringify(this.raw)}`)}};var gt=class a{constructor(t,e){this._type="Attributive";this._options=e,this.uuid=v(e),this.stringContent=t.stringContent,this.content=t.content,this.name=t.name,this.isRef=t.isRef}static{this.isKlass=!0}static{this.displayName="Attributive"}static{this.instances=[]}static{this.public={stringContent:{type:"string"},content:{type:"function",required:!0,collection:!1},name:{type:"string"},isRef:{type:"boolean"}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Attributive`);return this.instances.push(r),r}static stringify(t){let e={content:S(t.content),stringContent:t.stringContent,name:t.name,isRef:t.isRef},r={type:"Attributive",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={content:t.content};return t.stringContent!==void 0&&(r.stringContent=t.stringContent),t.name!==void 0&&(r.name=t.name),t.isRef!==void 0&&(r.isRef=t.isRef),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Attributive"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.content&&typeof r.content=="string"&&r.content.startsWith("func::")&&(r.content=new Function("return "+r.content.substring(6))()),this.create(r,e.options)}},De=class a{constructor(t,e){this._type="Attributives";this._options=e,this.uuid=v(e),this.content=t.content}static{this.isKlass=!0}static{this.displayName="Attributives"}static{this.instances=[]}static{this.public={content:{type:["BoolExpressionData","BoolAtomData"],collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Attributives`);return this.instances.push(r),r}static stringify(t){let e={};t.content!==void 0&&(e.content=S(t.content));let r={type:"Attributives",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={};return t.content!==void 0&&(r.content=t.content),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Attributives"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Ye=class a{constructor(t,e){this._type="Condition";this._options=e,this.uuid=v(e),this.content=t.content,this.name=t.name}static{this.isKlass=!0}static{this.displayName="Condition"}static{this.instances=[]}static{this.public={content:{type:"function",required:!0,collection:!1},name:{type:"string"}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Condition`);return this.instances.push(r),r}static stringify(t){let e={content:S(t.content),name:t.name},r={type:"Condition",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={content:t.content};return t.name!==void 0&&(r.name=t.name),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Condition"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.content&&typeof r.content=="string"&&r.content.startsWith("func::")&&(r.content=new Function("return "+r.content.substring(6))()),this.create(r,e.options)}};var Ze=class a{constructor(t,e){this._type="DataAttributive";this._options=e,this.uuid=v(e),this.content=t.content,this.name=t.name}static{this.isKlass=!0}static{this.displayName="DataAttributive"}static{this.instances=[]}static{this.public={content:{type:"function",required:!0,collection:!1},name:{type:"string"}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, DataAttributive`);return this.instances.push(r),r}static stringify(t){let e={content:S(t.content),name:t.name},r={type:"DataAttributive",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={content:t.content};return t.name!==void 0&&(r.name=t.name),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="DataAttributive"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.content&&typeof r.content=="string"&&r.content.startsWith("func::")&&(r.content=new Function("return "+r.content.substring(6))()),this.create(r,e.options)}},Xi=class a{constructor(t,e){this._type="QueryItem";this._options=e,this.uuid=v(e),this.name=t.name,this.value=t.value}static{this.isKlass=!0}static{this.displayName="QueryItem"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0,collection:!1},value:{type:"string",required:!0,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, QueryItem`);return this.instances.push(r),r}static stringify(t){let e={type:"QueryItem",options:t._options,uuid:t.uuid,public:{name:t.name,value:t.value}};return JSON.stringify(e)}static clone(t,e){return this.create({name:t.name,value:t.value})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="QueryItem"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}},Yi=class a{constructor(t,e){this._type="Query";this._options=e,this.uuid=v(e),this.items=t.items}static{this.isKlass=!0}static{this.displayName="Query"}static{this.instances=[]}static{this.public={items:{type:"QueryItem",required:!0,collection:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Query`);return this.instances.push(r),r}static stringify(t){let e={type:"Query",options:t._options,uuid:t.uuid,public:{items:t.items}};return JSON.stringify(e)}static clone(t,e){return this.create({items:t.items})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Query"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var V=class a{constructor(t,e){this._type="Action";this._options=e,this.uuid=v(e),this.name=t.name}static{this.isKlass=!0}static{this.displayName="Action"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Action`);return this.instances.push(r),r}static stringify(t){let e={type:"Action",options:t._options,uuid:t.uuid,public:{name:t.name}};return JSON.stringify(e)}static clone(t,e){return this.create({name:t.name})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Action"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}},Zi=V.create({name:"get"});var Gt=class a{constructor(t,e){this._type="Gateway";this._options=e,this.uuid=v(e),this.name=t.name}static{this.isKlass=!0}static{this.displayName="Gateway"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Gateway`);return this.instances.push(r),r}static stringify(t){let e={type:"Gateway",options:t._options,uuid:t.uuid,public:{name:t.name}};return JSON.stringify(e)}static clone(t,e){return this.create({name:t.name})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Gateway"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var ta=class a{constructor(t,e){this._type="Event";this._options=e,this.uuid=v(e),this.name=t.name}static{this.isKlass=!0}static{this.displayName="Event"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Event`);return this.instances.push(r),r}static stringify(t){let e={type:"Event",options:t._options,uuid:t.uuid,public:{name:t.name}};return JSON.stringify(e)}static clone(t,e){return this.create({name:t.name})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Event"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var G=class a{constructor(t,e){this._type="StateNode";this._options=e,this.uuid=v(e),this.name=t.name,this.computeValue=t.computeValue}static{this.isKlass=!0}static{this.displayName="StateNode"}static{this.instances=[]}static{this.public={name:{type:"string",collection:!1,required:!0},computeValue:{type:"function",required:!1,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, StateNode`);return this.instances.push(r),r}static stringify(t){let e={name:t.name};t.computeValue!==void 0&&(e.computeValue=t.computeValue);let r={type:"StateNode",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name};return t.computeValue!==void 0&&(r.computeValue=t.computeValue),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="StateNode"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var U=class a{constructor(t,e){this._type="StateTransfer";this._options=e,this.uuid=v(e),this.trigger=t.trigger,this.current=t.current,this.next=t.next,this.computeTarget=t.computeTarget}static{this.isKlass=!0}static{this.displayName="StateTransfer"}static{this.instances=[]}static{this.public={trigger:{instanceType:{},collection:!1,required:!0},current:{type:"StateNode",collection:!1,required:!0},next:{type:"StateNode",collection:!1,required:!0},computeTarget:{type:"function",collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, StateTransfer`);return this.instances.push(r),r}static stringify(t){let e={trigger:t.trigger,current:t.current,next:t.next};t.computeTarget!==void 0&&(e.computeTarget=t.computeTarget);let r={type:"StateTransfer",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({trigger:t.trigger,current:t.current,next:t.next,computeTarget:t.computeTarget})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="StateTransfer"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var j=class a{constructor(t,e){this._type="StateMachine";this._options=e,this.uuid=v(e),this.states=t.states,this.transfers=t.transfers,this.defaultState=t.defaultState}static{this.isKlass=!0}static{this.displayName="StateMachine"}static{this.instances=[]}static{this.public={states:{type:"StateNode",collection:!0,required:!0},transfers:{type:"StateTransfer",collection:!0,required:!0},defaultState:{type:"StateNode",collection:!1,required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, StateMachine`);return this.instances.push(r),r}static stringify(t){let e={type:"StateMachine",options:t._options,uuid:t.uuid,public:{states:t.states,transfers:t.transfers,defaultState:t.defaultState}};return JSON.stringify(e)}static clone(t,e){return this.create({states:t.states,transfers:t.transfers,defaultState:t.defaultState})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="StateMachine"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Wt=class a{constructor(t,e){this._type="WeightedSummation";this._options=e,this.uuid=v(e),this.record=t.record,this.property=t.property,this.direction=t.direction,this.callback=t.callback,this.attributeQuery=t.attributeQuery,this.dataDeps=t.dataDeps}static{this.isKlass=!0}static{this.displayName="WeightedSummation"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation"],collection:!1,required:!1},property:{type:"string",collection:!1,required:!1},direction:{type:"string",collection:!1,required:!1},callback:{type:"function",collection:!1,required:!0},attributeQuery:{instanceType:{},collection:!1,required:!1},dataDeps:{instanceType:{},collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, WeightedSummation`);return this.instances.push(r),r}static stringify(t){let e={record:t.record,property:t.property,direction:t.direction,attributeQuery:t.attributeQuery?S(t.attributeQuery):void 0,dataDeps:t.dataDeps,callback:t.callback?S(t.callback):()=>1},r={type:"WeightedSummation",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({record:t.record,property:t.property,direction:t.direction,callback:t.callback,attributeQuery:t.attributeQuery,dataDeps:t.dataDeps})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="WeightedSummation"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.callback&&typeof r.callback=="string"&&r.callback.startsWith("func::")&&(r.callback=new Function("return "+r.callback.substring(6))()),this.create(r,e.options)}};var Nt=class a{constructor(t,e){this._type="Count";this._options=e,this.uuid=v(e),this.record=t.record,this.property=t.property,this.direction=t.direction,this.callback=t.callback,this.attributeQuery=t.attributeQuery,this.dataDeps=t.dataDeps}static{this.isKlass=!0}static{this.displayName="Count"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation"],collection:!1,required:!0},direction:{type:"string",collection:!1,required:!1},callback:{type:"function",collection:!1,required:!1},attributeQuery:{instanceType:{},collection:!1,required:!1},dataDeps:{instanceType:{},collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Count`);return this.instances.push(r),r}static stringify(t){let e={record:t.record,direction:t.direction,attributeQuery:t.attributeQuery?S(t.attributeQuery):void 0,dataDeps:t.dataDeps,callback:t.callback?S(t.callback):void 0},r={type:"Count",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r=t.record;return e&&(Q.is(t.record)?r=Q.clone(t.record,e):q.is(t.record)&&(r=q.clone(t.record,e))),this.create({record:r,direction:t.direction,callback:t.callback,attributeQuery:t.attributeQuery,dataDeps:t.dataDeps})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Count"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.callback&&typeof r.callback=="string"&&r.callback.startsWith("func::")&&(r.callback=new Function("return "+r.callback.substring(6))()),this.create(r,e.options)}};var zt=class a{constructor(t,e){this._type="Summation";this._options=e,this.uuid=v(e),this.record=t.record,this.property=t.property,this.direction=t.direction,this.attributeQuery=t.attributeQuery}static{this.isKlass=!0}static{this.displayName="Summation"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation"],collection:!1,required:!0},direction:{type:"string",collection:!1,required:!1},attributeQuery:{instanceType:{},collection:!1,required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Summation`);return this.instances.push(r),r}static stringify(t){let e={record:t.record,attributeQuery:S(t.attributeQuery)},r={type:"Summation",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({record:t.record,direction:t.direction,attributeQuery:t.attributeQuery})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Summation"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Jt=class a{constructor(t,e){this._type="Average";this._options=e,this.uuid=v(e),this.record=t.record,this.property=t.property,this.direction=t.direction,this.attributeQuery=t.attributeQuery}static{this.isKlass=!0}static{this.displayName="Average"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation"],collection:!1,required:!0},direction:{type:"string",collection:!1,required:!1},attributeQuery:{instanceType:{},collection:!1,required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Average`);return this.instances.push(r),r}static stringify(t){let e={record:t.record,attributeQuery:S(t.attributeQuery)},r={type:"Average",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({record:t.record,direction:t.direction,attributeQuery:t.attributeQuery})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Average"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var Ht=class a{constructor(t,e){this._type="Every";this._options=e,this.uuid=v(e),this.record=t.record,this.property=t.property,this.direction=t.direction,this.callback=t.callback,this.attributeQuery=t.attributeQuery,this.dataDeps=t.dataDeps,this.notEmpty=t.notEmpty}static{this.isKlass=!0}static{this.displayName="Every"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation"],collection:!1,required:!0},direction:{type:"string",collection:!1,required:!1},callback:{type:"function",collection:!1,required:!0},attributeQuery:{instanceType:{},collection:!1,required:!1},dataDeps:{instanceType:{},collection:!1,required:!1},notEmpty:{type:"boolean",collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Every`);return this.instances.push(r),r}static stringify(t){let e={record:t.record,attributeQuery:t.attributeQuery?S(t.attributeQuery):void 0,dataDeps:t.dataDeps,callback:t.callback?S(t.callback):()=>!0},r={type:"Every",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={record:t.record,callback:t.callback};return t.direction!==void 0&&(r.direction=t.direction),t.attributeQuery!==void 0&&(r.attributeQuery=t.attributeQuery),t.dataDeps!==void 0&&(r.dataDeps=t.dataDeps),t.notEmpty!==void 0&&(r.notEmpty=t.notEmpty),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Every"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.callback&&typeof r.callback=="string"&&r.callback.startsWith("func::")&&(r.callback=new Function("return "+r.callback.substring(6))()),this.create(r,e.options)}};var Kt=class a{constructor(t,e){this._type="Any";this._options=e,this.uuid=v(e),this.record=t.record,this.property=t.property,this.direction=t.direction,this.callback=t.callback,this.attributeQuery=t.attributeQuery,this.dataDeps=t.dataDeps}static{this.isKlass=!0}static{this.displayName="Any"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation"],collection:!1,required:!1},property:{type:"string",collection:!1,required:!1},direction:{type:"string",collection:!1,required:!1},callback:{type:"function",collection:!1,required:!0},attributeQuery:{instanceType:{},collection:!1,required:!1},dataDeps:{instanceType:{},collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Any`);return this.instances.push(r),r}static stringify(t){let e={record:t.record,property:t.property,attributeQuery:t.attributeQuery,dataDeps:t.dataDeps,callback:t.callback?S(t.callback):()=>{}},r={type:"Any",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({record:t.record,property:t.property,direction:t.direction,callback:t.callback,attributeQuery:t.attributeQuery,dataDeps:t.dataDeps})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Any"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.callback&&typeof r.callback=="string"&&r.callback.startsWith("func::")&&(r.callback=new Function("return "+r.callback.substring(6))()),this.create(r,e.options)}};var bt=class a{constructor(t,e){this._type="Transform";this._options=e,this.uuid=v(e),this.record=t.record,this.attributeQuery=t.attributeQuery,this.callback=t.callback}static{this.isKlass=!0}static{this.displayName="Transform"}static{this.instances=[]}static{this.public={record:{type:["Entity","Relation","Activity","Interaction"],collection:!1,required:!0},attributeQuery:{instanceType:{},collection:!1,required:!1},callback:{type:"function",collection:!1,required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Transform`);return this.instances.push(r),r}static stringify(t){let e={record:S(t.record),callback:S(t.callback)};t.attributeQuery!==void 0&&(e.attributeQuery=S(t.attributeQuery));let r={type:"Transform",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({record:t.record,attributeQuery:t.attributeQuery,callback:t.callback})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Transform"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r={...e.public};return typeof r.callback=="string"&&r.callback.startsWith("func::")&&(r.callback=new Function("return "+r.callback.substring(6))()),this.create(r,e.options)}};var Xt=class a{constructor(t,e){this._type="RealTimeValue";this._options=e,this.uuid=v(e),this.attributeQuery=t.attributeQuery,this.dataDeps=t.dataDeps,this.nextRecomputeTime=t.nextRecomputeTime,this.callback=t.callback}static{this.isKlass=!0}static{this.displayName="RealTimeValue"}static{this.instances=[]}static{this.public={attributeQuery:{instanceType:{},collection:!1,required:!1},dataDeps:{instanceType:{},collection:!1,required:!1},nextRecomputeTime:{type:"function",collection:!1,required:!1},callback:{type:"function",collection:!1,required:!0}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, RealTimeValue`);return this.instances.push(r),r}static stringify(t){let e={callback:S(t.callback)};t.attributeQuery!==void 0&&(e.attributeQuery=S(t.attributeQuery)),t.dataDeps!==void 0&&(e.dataDeps=t.dataDeps),t.nextRecomputeTime!==void 0&&(e.nextRecomputeTime=S(t.nextRecomputeTime));let r={type:"RealTimeValue",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={callback:t.callback};return t.attributeQuery!==void 0&&(r.attributeQuery=t.attributeQuery),t.dataDeps!==void 0&&(r.dataDeps=t.dataDeps),t.nextRecomputeTime!==void 0&&(r.nextRecomputeTime=t.nextRecomputeTime),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="RealTime"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r={...e.public};return typeof r.callback=="string"&&r.callback.startsWith("func::")&&(r.callback=new Function("return "+r.callback.substring(6))()),typeof r.nextRecomputeTime=="string"&&r.nextRecomputeTime.startsWith("func::")&&(r.nextRecomputeTime=new Function("return "+r.nextRecomputeTime.substring(6))()),this.create(r,e.options)}};var w=class a{constructor(t,e){this._type="PayloadItem";this._options=e,this.uuid=v(e),this.name=t.name,this.attributives=t.attributives,this.base=t.base,this.isRef=t.isRef??!1,this.required=t.required??!1,this.isCollection=t.isCollection??!1,this.itemRef=t.itemRef}static{this.isKlass=!0}static{this.displayName="PayloadItem"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0},attributives:{type:["Attributives","Attributive"],collection:!1},base:{type:"Entity",required:!1,collection:!1},isRef:{type:"boolean",collection:!1,defaultValue:()=>!1},required:{type:"boolean",collection:!1,defaultValue:()=>!1},isCollection:{type:"boolean",collection:!1,defaultValue:()=>!1},itemRef:{collection:!1,required:!1,type:["Attributive","Entity"]}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, PayloadItem`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,base:t.base,isCollection:t.isCollection,required:t.required,isRef:t.isRef,attributives:t.attributives},r={type:"PayloadItem",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={name:t.name};return t.attributives!==void 0&&(r.attributives=t.attributives),t.base!==void 0&&(r.base=t.base),t.isRef!==!1&&(r.isRef=t.isRef),t.required!==!1&&(r.required=t.required),t.isCollection!==!1&&(r.isCollection=t.isCollection),t.itemRef!==void 0&&(r.itemRef=t.itemRef),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="PayloadItem"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var O=class a{constructor(t,e){this._type="Payload";this._options=e,this.uuid=v(e),this.items=t.items||[]}static{this.isKlass=!0}static{this.displayName="Payload"}static{this.instances=[]}static{this.public={items:{type:"PayloadItem",collection:!0,required:!0,defaultValue:()=>[]}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Payload`);return this.instances.push(r),r}static stringify(t){let e={type:"Payload",options:t._options,uuid:t.uuid,public:{items:t.items}};return JSON.stringify(e)}static clone(t,e){return this.create({items:t.items})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Payload"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var ea=class a{constructor(t,e){this._type="SideEffect";this._options=e,this.uuid=v(e),this.name=t.name,this.handle=t.handle}static{this.isKlass=!0}static{this.displayName="SideEffect"}static{this.instances=[]}static{this.public={name:{type:"string",required:!0,collection:!1},handle:{type:"function",required:!0,collection:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, SideEffect`);return this.instances.push(r),r}static stringify(t){let e={name:t.name,handle:S(t.handle)},r={type:"SideEffect",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({name:t.name,handle:t.handle})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="SideEffect"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r=e.public;return r.handle&&typeof r.handle=="string"&&r.handle.startsWith("func::")&&(r.handle=new Function("return "+r.handle.substring(6))()),this.create(r,e.options)}};function er(a){if(!a)return;if(a.raw.type==="atom")return Ut.create({type:"atom",data:a.raw.data});let t=a.raw;return jt.create({type:"expression",operator:t.operator,left:er(a.left),right:er(a.right)})}var ue=class a{constructor(t,e){this._type="Conditions";this._options=e,this.uuid=v(e),t.content&&t.content instanceof L?this.content=er(t.content):this.content=t.content}static{this.isKlass=!0}static{this.displayName="Conditions"}static{this.instances=[]}static{this.public={content:{type:["BoolExpressionData","BoolAtomData"],collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Conditions`);return this.instances.push(r),r}static stringify(t){let e={};t.content!==void 0&&(e.content=S(t.content));let r={type:"Conditions",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={};return t.content!==void 0&&(r.content=t.content),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Conditions"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var aa=class a{constructor(t,e){this._type="DataAttributives";this._options=e,this.uuid=v(e),this.content=t.content}static{this.isKlass=!0}static{this.displayName="DataAttributives"}static{this.instances=[]}static{this.public={content:{type:["BoolExpressionData","BoolAtomData"],collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, DataAttributives`);return this.instances.push(r),r}static stringify(t){let e={};t.content!==void 0&&(e.content=S(t.content));let r={type:"DataAttributives",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){let r={};return t.content!==void 0&&(r.content=t.content),this.create(r)}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="DataAttributives"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t);return this.create(e.public,e.options)}};var bs=[Q,q,x,F,Qe,gt,Ye,Ze,V,Gt,ta,G,U,j,Wt,Nt,zt,Jt,Ht,Kt,bt,Xt,w,O,ea,vt,Ut,jt,ue,aa];bs.forEach(a=>{a&&a.displayName&&ci(a.displayName,a)});var le=class a{constructor(t,e){this._type="Custom";this._options=e,this.uuid=v(e),this.name=t.name,this.dataDeps=t.dataDeps,this.compute=t.compute,this.incrementalCompute=t.incrementalCompute,this.incrementalPatchCompute=t.incrementalPatchCompute,this.createState=t.createState,this.getDefaultValue=t.getDefaultValue,this.asyncReturn=t.asyncReturn,this.useLastValue=t.useLastValue}static{this.isKlass=!0}static{this.displayName="Custom"}static{this.instances=[]}static{this.public={name:{type:"string",collection:!1,required:!0},dataDeps:{type:"object",collection:!1,required:!1},compute:{type:"function",collection:!1,required:!1},incrementalCompute:{type:"function",collection:!1,required:!1},incrementalPatchCompute:{type:"function",collection:!1,required:!1},createState:{type:"function",collection:!1,required:!1},getDefaultValue:{type:"function",collection:!1,required:!1},asyncReturn:{type:"function",collection:!1,required:!1},useLastValue:{type:"boolean",collection:!1,required:!1}}}static create(t,e){let r=new a(t,e);if(this.instances.find(n=>n.uuid===r.uuid))throw new Error(`duplicate uuid in options ${r.uuid}, Custom`);return this.instances.push(r),r}static stringify(t){let e={name:t.name};t.dataDeps!==void 0&&(e.dataDeps=S(t.dataDeps)),t.compute!==void 0&&(e.compute=S(t.compute)),t.incrementalCompute!==void 0&&(e.incrementalCompute=S(t.incrementalCompute)),t.incrementalPatchCompute!==void 0&&(e.incrementalPatchCompute=S(t.incrementalPatchCompute)),t.createState!==void 0&&(e.createState=S(t.createState)),t.getDefaultValue!==void 0&&(e.getDefaultValue=S(t.getDefaultValue)),t.asyncReturn!==void 0&&(e.asyncReturn=S(t.asyncReturn)),t.useLastValue!==void 0&&(e.useLastValue=t.useLastValue);let r={type:"Custom",options:t._options,uuid:t.uuid,public:e};return JSON.stringify(r)}static clone(t,e){return this.create({name:t.name,dataDeps:t.dataDeps,compute:t.compute,incrementalCompute:t.incrementalCompute,incrementalPatchCompute:t.incrementalPatchCompute,createState:t.createState,getDefaultValue:t.getDefaultValue,asyncReturn:t.asyncReturn,useLastValue:t.useLastValue})}static is(t){return t!==null&&typeof t=="object"&&"_type"in t&&t._type==="Custom"}static check(t){return t!==null&&typeof t=="object"&&typeof t.uuid=="string"}static parse(t){let e=JSON.parse(t),r={...e.public};return["compute","incrementalCompute","incrementalPatchCompute","createState","getDefaultValue","asyncReturn"].forEach(n=>{typeof r[n]=="string"&&r[n].startsWith("func::")&&(r[n]=new Function("return "+r[n].substring(6))())}),this.create(r,e.options)}};var pe=class{constructor(t=[],e=[]){this.clonedEntities=new Map,this.clonedRelations=new Map,this.reverseEntityMap=new Map,this.reverseRelationMap=new Map,this.originalEntities=[...t],this.originalRelations=[...e],(t.length>0||e.length>0)&&this.initializeClones()}initializeClones(){for(let t of this.originalEntities){let e=Q.clone(t,!1);this.clonedEntities.set(t,e),this.reverseEntityMap.set(e,t)}for(let t of this.originalRelations){let e=q.clone(t,!1);this.clonedRelations.set(t,e),this.reverseRelationMap.set(e,t)}this.updateAllReferences()}addEntity(t){for(let[r]of this.clonedEntities)if(r===t||r.uuid===t.uuid)throw new Error(`Entity already exists in container: ${t.name}`);this.originalEntities.push(t);let e=Q.clone(t,!1);return this.clonedEntities.set(t,e),this.reverseEntityMap.set(e,t),this.updateReferencesInObject(e),e}addRelation(t){for(let[r]of this.clonedRelations)if(r===t||r.uuid===t.uuid)throw new Error(`Relation already exists in container: ${t.name}`);this.originalRelations.push(t);let e=q.clone(t,!1);return this.clonedRelations.set(t,e),this.reverseRelationMap.set(e,t),this.updateReferencesInObject(e),e}updateReferencesInObject(t){if("baseEntity"in t&&t.baseEntity){let e=this.findReplacement(t.baseEntity);e&&(t.baseEntity=e)}if("inputEntities"in t&&t.inputEntities&&(t.inputEntities=t.inputEntities.map(e=>this.findReplacement(e)||e)),"source"in t&&t.source){let e=this.findReplacement(t.source);e&&(t.source=e)}if("target"in t&&t.target){let e=this.findReplacement(t.target);e&&(t.target=e)}if("baseRelation"in t&&t.baseRelation){let e=this.findReplacement(t.baseRelation);e&&(t.baseRelation=e)}"inputRelations"in t&&t.inputRelations&&(t.inputRelations=t.inputRelations.map(e=>this.findReplacement(e)||e))}updateAllReferences(){for(let t of this.clonedEntities.values()){if(t.baseEntity){let e=this.findReplacement(t.baseEntity);e&&(t.baseEntity=e)}t.inputEntities&&(t.inputEntities=t.inputEntities.map(e=>this.findReplacement(e)||e))}for(let t of this.clonedRelations.values()){if(t.source){let e=this.findReplacement(t.source);e&&(t.source=e)}if(t.target){let e=this.findReplacement(t.target);e&&(t.target=e)}if(t.baseRelation){let e=this.findReplacement(t.baseRelation);e&&(t.baseRelation=e)}t.inputRelations&&(t.inputRelations=t.inputRelations.map(e=>this.findReplacement(e)||e))}}replaceEntity(t,e){let r;if(this.clonedEntities.has(e))r=e;else if(r=this.reverseEntityMap.get(e),!r){for(let[s,o]of this.clonedEntities)if(o===e||o.uuid===e.uuid){r=s;break}}if(!r)throw new Error(`Entity to be replaced not found in container: ${e.name}`);let i=this.clonedEntities.get(r),n=t;this.clonedEntities.set(r,n),i&&this.reverseEntityMap.delete(i),this.reverseEntityMap.set(n,r),i&&this.updateSpecificReferences(i,n)}replaceRelation(t,e){let r;if(this.clonedRelations.has(e)?r=e:r=this.reverseRelationMap.get(e),!r)throw new Error(`Relation to be replaced not found in container: ${e.name}`);let i=this.clonedRelations.get(r),n=t;this.clonedRelations.set(r,n),i&&this.reverseRelationMap.delete(i),this.reverseRelationMap.set(n,r),i&&this.updateSpecificReferences(i,n)}updateSpecificReferences(t,e){for(let r of this.clonedEntities.values())r.baseEntity===t&&(r.baseEntity=e),r.inputEntities&&(r.inputEntities=r.inputEntities.map(i=>i===t?e:i));for(let r of this.clonedRelations.values())r.source===t&&(r.source=e),r.target===t&&(r.target=e),r.baseRelation===t&&(r.baseRelation=e),r.inputRelations&&(r.inputRelations=r.inputRelations.map(i=>i===t?e:i))}getEntityByName(t){for(let e of this.clonedEntities.values())if(e.name===t)return e}getRelationByName(t){for(let e of this.clonedRelations.values())if((e.name||`${e.source.name}_${e.sourceProperty}_${e.targetProperty}_${e.target.name}`)===t)return e}getAll(){return{entities:Array.from(this.clonedEntities.values()),relations:Array.from(this.clonedRelations.values())}}replace(t,e){if(this.isEntity(t)&&this.isEntity(e))this.replaceEntity(t,e);else if(this.isRelation(t)&&this.isRelation(e))this.replaceRelation(t,e);else throw new Error("Type mismatch: both items must be either entities or relations")}getByName(t){let e=this.getEntityByName(t);return e||this.getRelationByName(t)}add(t){return this.isEntity(t)?this.addEntity(t):this.addRelation(t)}isEntity(t){return!("sourceProperty"in t)}isRelation(t){return"sourceProperty"in t}findReplacement(t){for(let e of this.clonedEntities.values())if(e===t||e.uuid===t.uuid)return e;for(let e of this.clonedRelations.values())if(e===t||e.uuid===t.uuid)return e;for(let[e,r]of this.clonedEntities)if(e===t||e.uuid===t.uuid)return r;for(let[e,r]of this.clonedRelations)if(e===t||e.uuid===t.uuid)return r;return null}};var rt="_System_",ct="_Dictionary_",Yt="id",Pt="_rowId",tn=Q.create({name:rt,properties:[x.create({name:"concept",type:"string",collection:!1}),x.create({name:"key",type:"string",collection:!1}),x.create({name:"value",type:"string",collection:!1})]});function T(a,t){if(!a)throw new Error(t)}async function ar(a,t){for(let e of a)if(await t(e))return!0;return!1}async function ra(a,t){for(let e of a){let r=await t(e);if(r!==!0)return r}return!0}function R(a,t){if(!a)throw new Error(t)}function ia(a,t,e){let r=[...t],i=a,n,s=r.pop();for(;n=r.shift();)i[n]||(i[n]={}),i=i[n];return i[s]=e,!0}var St=class a{constructor(t,e,r,i){this.parentEntityName=t;this.attributeName=e;this.map=r;this.symmetricDirection=i;this.data=this.map.getAttributeData(t,e),R(!!this.data,`${t} has no attribute: ${e}`)}get isRecord(){return this.data.isRecord}get isValue(){return!this.data.isRecord}get isCollection(){return this.isValue&&this.data.collection}get isComputed(){return this.isValue&&this.data.computed}get fieldType(){if(this.isRecord)throw new Error("not a value attribute");return this.data.fieldType}get computed(){if(!this.isComputed)throw new Error("not a computed attribute");return this.data.computed}get isManyToOne(){if(!this.isRecord)throw new Error("not a entity");let t=this.data;return t.relType[0]==="n"&&t.relType[1]==="1"}get isManyToMany(){if(!this.isRecord)throw new Error("not a entity");let t=this.data;return t.relType[0]==="n"&&t.relType[1]==="n"}get isOneToOne(){if(!this.isRecord)throw new Error("not a entity");let t=this.data;return t.relType[0]==="1"&&t.relType[1]==="1"}get isOneToMany(){if(!this.isRecord)throw new Error("not a entity");let t=this.data;return t.relType[0]==="1"&&t.relType[1]==="n"}get isXToOne(){return this.isManyToOne||this.isOneToOne}get isOneToX(){return this.isOneToMany||this.isOneToOne}get isXToMany(){return this.isManyToMany||this.isOneToMany}get isReliance(){return this.data.isReliance}get recordName(){return R(this.isRecord,`${this.attributeName} is not a entity`),this.data.recordName}get table(){return R(this.isRecord,`${this.attributeName} is not a entity`),this.map.getRecord(this.data.recordName).table}get field(){if(this.isValue)return this.data.field;if(this.isManyToOne&&this.isLinkMergedWithParent()){if(this.data.field)return this.data.field;let t=this.getLinkInfo().record;return this.isRecordSource()?t.attributes.target.field:t.attributes.source.field}}get linkField(){if(this.isRecord&&this.isLinkMergedWithParent()){if(this.data.field)return this.data.field;let t=this.getLinkInfo().record;return this.isRecordSource()?t?.attributes.target.field:t?.attributes.source.field}}get linkName(){return this.data.linkName}isMergedWithParent(){return this.getLinkInfo().isCombined()}isLinkMergedWithParent(){let t=this.getLinkInfo();return t.isRelationSource(this.parentEntityName,this.attributeName)?t.isMergedToSource():t.isMergedToTarget()}isLinkMergedWithAttribute(){let t=this.getLinkInfo();return t.isRelationSource(this.parentEntityName,this.attributeName)?t.isMergedToTarget():t.isMergedToSource()}isLinkIsolated(){return this.getLinkInfo().isIsolated()}isRecordSource(){return this.getLinkInfo().isRelationSource(this.parentEntityName,this.attributeName)}isLinkManyToManySymmetric(){let t=this.getLinkInfo();return t.isManyToMany&&t.isSymmetric()}isLinkSourceRelation(){return this.getLinkInfo().isSourceRelation()}getReverseInfo(){let t=this.map.getReverseAttribute(this.parentEntityName,this.attributeName);if(t)return this.map.getInfo(this.recordName,t)}getLinkInfo(){return R(this.isRecord,"only record attribute can get linkInfo"),this.map.getLinkInfo(this.parentEntityName,this.attributeName)}getRecordInfo(){return R(this.isRecord,"only record attribute can get linkInfo"),this.map.getRecordInfo(this.recordName)}getAttribute(t){return this.map.getInfo(this.recordName,t)}isLinkFiltered(){return this.data.isFilteredRelation}getMatchExpression(){return R(this.isLinkFiltered(),"only filtered relation can get match expression"),this.data.matchExpression}getBaseAttributeInfo(){return R(this.isLinkFiltered(),"only filtered relation can get base attribute info"),new a(this.parentEntityName,this.data.baseRelationAttributeName,this.map,this.symmetricDirection)}};var g=class a{constructor(t,e,r,i,n){this.map=e;this.contextRootEntity=i;this.fromRelation=n;R(!r||r instanceof L,`match data is not a BoolExpression instance, you passed: ${this.data}`);let s=this.map.getRecordInfo(t);this.entityName=s.isFilteredEntity||s.isFilteredRelation?s.baseRecordName:t;let o=s.isFilteredEntity||s.isFilteredRelation;this.xToOneQueryTree=new Zt(this.entityName,this.map);let c=r;o&&(c=r?s.matchExpression.and(r):s.matchExpression),c&&(this.data=this.convertFilteredRelation(c),this.buildQueryTree(this.data,this.xToOneQueryTree))}static atom(t){return R(t.key!==void 0,"key cannot be undefined"),R(Array.isArray(t.value)&&t.value.length===2,"value must be array"),R(t.value[1]!==void 0,`${t.key} value cannot be undefined`),L.atom(t)}static fromObject(t){let e;return Object.entries(t).forEach(([r,i])=>{e?e=e.and({key:r,value:["=",i]}):e=a.atom({key:r,value:["=",i]})}),e}static fromArray(t){let e=t[0];return t.slice(1).reduce((i,n)=>i.or(n),a.atom(e))}static extractPaths(t){let e=[],r=t instanceof L?t:L.fromValue(t);if(r.isExpression())r.left&&e.push(...a.extractPaths(r.left.raw)),r.right&&e.push(...a.extractPaths(r.right.raw));else if(r.isAtom()){let s=r.data.key.split(".");s.length>1&&e.push(s)}return e}convertFilteredRelation(t){if(t.isExpression()){let e=this.convertFilteredRelation(t.left),r=t.right?this.convertFilteredRelation(t.right):void 0,i=t.raw;return new L({type:"expression",operator:i.operator,left:e.raw,right:r?.raw})}else{let e=t.data.key.split("."),{resolvedPath:r,matchExpression:i}=e.reduce((s,o)=>{let c=[...s.resolvedPath,o],u=this.map.getInfoByPath(c),l=s.resolvedPath.concat(u?.isLinkFiltered()?u.getBaseAttributeInfo().attributeName:o),d=s.matchExpression;if(u?.isLinkFiltered()){let h=u.getLinkInfo(),f=new a(h.getResolvedBaseRecordName(),this.map,h.getResolvedMatchExpression()),I=this.map.getReversePath(l),E=[u.isRecordSource()?"source":"target",...I.slice(2)],N=f.rebase(E.join("."));d=d?d.and(N):N}return{path:[...s.path,o],resolvedPath:l,matchExpression:d}},{path:[this.entityName],resolvedPath:[this.entityName],matchExpression:void 0});return i?a.atom({key:r.slice(1).join("."),value:t.data.value}).and(i.data):t}}buildQueryTree(t,e){if(t.isExpression())t.left&&this.buildQueryTree(t.left,e),t.right&&this.buildQueryTree(t.right,e);else{let r=t.data.key.split("."),i=[this.entityName].concat(r),n=this.map.getInfoByPath(i);if(r.length===1&&n.isValue)return;let s=this.map.spawnManyToManySymmetricPath(i);n.isRecord?s?(e.addRecord(s[0].slice(1,1/0)),e.addRecord(s[1].slice(1,1/0))):e.addRecord(r):s?(e.addField(s[0].slice(1,1/0)),e.addField(s[1].slice(1,1/0))):e.addField(r)}}getFinalFieldName(t){let e=[this.entityName].concat(t.slice(0,-1));return this.map.getTableAliasAndFieldName(e,t.at(-1)).slice(0,2)}getReferenceFieldValue(t){let e=t.split("."),[r,i]=this.map.getTableAliasAndFieldName([this.contextRootEntity||this.entityName].concat(e.slice(0,-1)),e.at(-1));return`${r}.${i}`}getFinalFieldValue(t,e,r,i,n,s,o){let c="",u=[];if(["=",">","<","<=",">=","like","!="].includes(r[0])||r[0]==="not"&&r[1]!==null)c=`${r[0]} ${s()}`,u=[t?this.getReferenceFieldValue(r[1]):r[1]];else if(r[0]==="not"&&r[1]===null)c="IS NOT NULL";else if(r[0].toLowerCase()==="in")R(!t,"reference value cannot use IN to match"),c=`IN (${r[1].map(d=>s()).join(",")})`,u=r[1];else if(r[0].toLowerCase()==="between")c=`BETWEEN ${s()} AND ${s()}`,u=[t?this.getReferenceFieldValue(r[1][0]):r[1][0],t?this.getReferenceFieldValue(r[1][1]):r[1][1]];else{let d;o&&(d=o.parseMatchExpression?.(e,r,i,n,t,this.getReferenceFieldValue.bind(this),s)),d?(c=d.fieldValue,u=d.fieldParams||[]):R(d,`unknown value expression ${JSON.stringify(r)}`)}return[c,u]}buildFieldMatchExpression(t,e){return this.data?this.data.map(r=>{let i=r.data.key.split("."),n=this.map.getInfoByPath([this.entityName].concat(i)),s=[this.entityName].concat(i),o=this.map.spawnManyToManySymmetricPath(s),c,u;if(o&&(c=o[0].slice(1,1/0),u=o[1].slice(1,1/0)),n.isValue){let l=this.getFinalFieldName(i),[d,h]=this.getFinalFieldValue(r.data.isReferenceValue,r.data.key,r.data.value,l.join("."),n.fieldType,t,e);if(!o)return{...r.data,fieldName:l,fieldValue:d,fieldParams:h};let[f,I]=this.getFinalFieldValue(r.data.isReferenceValue,r.data.key,r.data.value,l.join("."),n.fieldType,t,e);return L.atom({...r.data,fieldName:this.getFinalFieldName(c),fieldValue:d,fieldParams:h}).or({...r.data,fieldName:this.getFinalFieldName(u),fieldValue:f,fieldParams:I})}else{if(!o)return{...r.data,namePath:s,isFunctionMatch:!0};let l=[this.entityName].concat(c),d=[this.entityName].concat(u);return R(l.length===s.length,`symmetric entity match can only be last, ${l} ${s}`),L.atom({...r.data,namePath:l,isFunctionMatch:!0}).or({...r.data,namePath:d,isFunctionMatch:!0})}}):null}and(t){return t instanceof a?(R(this.entityName===t.entityName,`cannot and match exp of different entity: ${this.entityName} and ${t.entityName}`),new a(this.entityName,this.map,this.data?this.data.and(t.data):t.data,this.contextRootEntity)):(R(t.key!==void 0,"key cannot be undefined"),R(Array.isArray(t.value)&&t.value.length===2,"value must be array"),R(t.value[1]!==void 0,`${t.key} value cannot be undefined`),new a(this.entityName,this.map,this.data?this.data.and(t):L.atom(t),this.contextRootEntity))}rebase(t){let e=this.map.getInfo(this.entityName,t);R(e.isRecord,`attribute ${t} is not an entity relation`);let r=e.recordName,i=this.map.getReverseAttribute(this.entityName,t),n=o=>{if(o){if(o.isExpression()){let c=n(o.left),u=n(o.right);if(!c&&!u)return;if(!c)return u;if(!u)return c;let l=o.raw.operator;if(l==="and")return c.and(u);if(l==="or")return c.or(u);if(l==="not")return c.not()}else if(o.isAtom()){let c=o.data,u=c.key.split(".");if(u[0]===t){let d=u.slice(1).join(".");return L.atom({key:d,value:c.value,isReferenceValue:c.isReferenceValue})}let l=this.map.getShrinkedAttribute(r,`${i}.${c.key}`);return L.atom({key:l,value:c.value,isReferenceValue:c.isReferenceValue})}}},s=this.data?n(this.data):void 0;return new a(r,this.map,s,this.contextRootEntity,this.fromRelation)}};var na=class{constructor(t,e,r,i){this.recordName=t;this.map=e;this.data=r;this.fromRelation=i}get limit(){return this.data?.limit}get offset(){return this.data?.offset}get orderBy(){return Object.entries(this.data?.orderBy||{}).map(([t,e])=>({attribute:t,recordName:this.recordName,order:e}))}};var z=class a{constructor(t,e,r,i,n,s,o,c,u,l=!1,d,h,f,I){this.recordName=t;this.map=e;this.matchExpression=r;this.attributeQuery=i;this.modifier=n;this.contextRootEntity=s;this.parentRecord=o;this.attributeName=c;this.onlyRelationData=u;this.allowNull=l;this.label=d;this.goto=h;this.exit=f;this.alias=I}static create(t,e,r,i,n,s,o,c=!1,u){let l=e.getRecordInfo(t),d=l.isFilteredEntity||l.isFilteredRelation,h=t;d&&(h=l.data.resolvedBaseRecordName);let f=new g(h,e,r.matchExpression,i),I=c?f:f.and({key:"id",value:["not",null]}),k=I;return d&&(k=I.and(new g(h,e,l.data.resolvedMatchExpression))),new a(h,e,k,new It(h,e,r.attributeQuery||[],n,s),new na(h,e,r.modifier),i,n,s,o,c,r.label,r.goto,r.exit,u)}getData(){return{matchExpression:this.matchExpression.data,attributeQuery:this.attributeQuery.data,modifier:this.modifier.data}}derive({matchExpression:t,attributeQuery:e,modifier:r}){return new a(this.recordName,this.map,t||this.matchExpression,e||this.attributeQuery,r||this.modifier,this.contextRootEntity,this.parentRecord,this.attributeName,this.onlyRelationData,this.allowNull,this.label,this.goto,this.exit)}},Zt=class a{constructor(t,e,r,i,n,s,o){this.recordName=t;this.map=e;this.parentRecord=r;this.attributeName=i;this.data=n;this.parent=s;this.parentLinkQueryTree=o;this.fields=[];R(!!t,"recordName cannot be empty"),this.fields=n?.fields||[],this.records=n?.records||{},r&&(this.info=this.map.getInfo(this.parentRecord,this.attributeName))}addField(t){let[e,...r]=t;if(t.length===1)this.fields.push(e);else if(e===b)this.parentLinkQueryTree||(this.parentLinkQueryTree=new a(this.info.linkName,this.map)),this.parentLinkQueryTree.addField(r);else{let i=this.map.getInfo(this.recordName,e);this.records[e]||(this.records[e]=new a(i.recordName,this.map,this.recordName,e,void 0,this)),this.records[e].addField(r)}}addRecord(t,e){let[r,...i]=t;if(t.length===1)if(r===b)this.parentLinkQueryTree||(this.parentLinkQueryTree=new a(this.info.linkName,this.map)),e&&(this.parentLinkQueryTree=this.parentLinkQueryTree.merge(e));else{let n=this.map.getInfo(this.recordName,r),s=e||new a(n.recordName,this.map,this.recordName,r,void 0,this);this.records[r]=this.records[r]?this.records[r].merge(s):s}else if(r===b)this.parentLinkQueryTree||(this.parentLinkQueryTree=new a(this.info.linkName,this.map)),this.parentLinkQueryTree.addRecord(i,e);else{let n=this.map.getInfo(this.recordName,r);this.records[r]=new a(n.recordName,this.map,this.recordName,r,void 0,this),this.records[r].addRecord(i,e)}}forEachRecords(t){Object.values(this.records).forEach(e=>t(e))}onlyIdField(){return this.fields.length===1&&this.fields[0]==="id"&&!Object.keys(this.records).length}merge(t){let e=Array.from(new Set([...this.fields,...t.fields])),r=Array.from(new Set([...Object.keys(this.records),...Object.keys(t.records)])),i={};r.forEach(s=>{this.records[s]&&t.records[s]?i[s]=this.records[s].merge(t.records[s]):this.records[s]?i[s]=this.records[s]:i[s]=t.records[s]});let n;return this.parentLinkQueryTree&&t.parentLinkQueryTree?n=this.parentLinkQueryTree.merge(t.parentLinkQueryTree):n=this.parentLinkQueryTree||t.parentLinkQueryTree,new a(this.recordName,this.map,this.parentRecord,this.attributeName,{fields:e,records:i},this.parent,n)}getData(){let t={__fields:this.fields};return this.forEachRecords(e=>{t[e.attributeName]=e.getData()}),this.parentLinkQueryTree&&(t[b]=this.parentLinkQueryTree.getData()),t}},b="&",en="*";var It=class a{constructor(t,e,r=[],i,n,s){this.recordName=t;this.map=e;this.data=r;this.parentRecord=i;this.attributeName=n;this.shouldQueryParentLinkData=s;this.relatedRecords=[];this.xToManyRecords=[];this.xToOneRecords=[];this.valueAttributes=[];this.id=Math.random();let o=new Set;r.forEach(c=>{let u=typeof c=="string"?[c,{},!1]:c,[l,d,h]=u;if(l===b){R(!!(this.parentRecord&&this.attributeName),`parent record and attribute name cannot be empty when query link data, you passed ${this.parentRecord} ${this.attributeName}`);let I=this.map.getInfo(this.parentRecord,this.attributeName);this.parentLinkRecordQuery=z.create(I.linkName,this.map,d,void 0);return}if(l===en){o=new Set(this.map.getRecordInfo(this.recordName).valueAttributes.map(I=>I.attributeName));return}let f=this.map.getInfo(this.recordName,l);if(f.isRecord){let I=l,k=d;if(f.isLinkFiltered()){I=f.getBaseAttributeInfo().attributeName;let N=d.matchExpression,X=f.getLinkInfo().getBaseLinkInfo(),re=new g(X.name,this.map,f.getMatchExpression()).rebase(f.isRecordSource()?"target":"source"),La=N?re.and(N.data):re;k={...d,matchExpression:La.data}}let E=z.create(f.recordName,this.map,k,void 0,this.recordName,I,h,!1,l);this.relatedRecords.push(E),f.isXToMany?this.xToManyRecords.push(E):f.isXToOne&&this.xToOneRecords.push(E)}else o.add(l)}),this.valueAttributes=Array.from(o),this.fullQueryTree=this.buildFullQueryTree()}static mergeAttributeQueryData(t,e){let r=[...t,...e],i=new Set(r.filter(o=>typeof o=="string")),s=r.filter(o=>typeof o!="string").reduce((o,c)=>{let[u,l]=c;return o[u]?o[u]={attributeQuery:a.mergeAttributeQueryData(o[u].attributeQuery,l.attributeQuery)}:o[u]=l,o},{});return[...i,...Object.entries(s)]}static getAttributeQueryDataForRecord(t,e,r,i,n,s){let o=e.getRecordInfo(t),c=o.resolvedBaseRecordName?e.getRecordInfo(o.resolvedBaseRecordName):o,u=c.valueAttributes.map(l=>l.attributeName);return r&&c.sameTableReliance.forEach(l=>{let d=a.getAttributeQueryDataForRecord(l.recordName,e,!0,i),h=[l.attributeName,{attributeQuery:[...d]}];if(!c.isRelation){let f=a.getAttributeQueryDataForRecord(l.linkName,e,!0,i);h[1].attributeQuery.push([b,{attributeQuery:f}])}u=a.mergeAttributeQueryData(u,[h])}),s&&c.notRelianceCombined.forEach(l=>{let d=a.getAttributeQueryDataForRecord(l.recordName,e,!0,i),h=[l.attributeName,{attributeQuery:[...d]}];if(!c.isRelation){let f=a.getAttributeQueryDataForRecord(l.linkName,e,!0,i);h[1].attributeQuery.push([b,{attributeQuery:f}])}u=a.mergeAttributeQueryData(u,[h])}),i&&c.mergedRecordAttributes.forEach(l=>{let d=a.getAttributeQueryDataForRecord(l.linkName,e,r,!0);u=a.mergeAttributeQueryData(u,[[l.attributeName,{attributeQuery:["id",[b,{attributeQuery:d}]]}]])}),n&&c.managedRecordAttributes.forEach(l=>{u=a.mergeAttributeQueryData(u,[[l.attributeName,{attributeQuery:["id"]}]])}),u}getValueAndXToOneRecordFields(t=[this.recordName],e=[this.recordName]){let i=(this.valueAttributes.includes("id")?this.valueAttributes:["id"].concat(this.valueAttributes)).map(n=>({tableAliasAndField:this.map.getTableAliasAndFieldName(t,n).slice(0,2),nameContext:e,attribute:n}));if(this.xToOneRecords.forEach(n=>{let s=t.concat(n.attributeName),o=e.concat(n.alias||n.attributeName);i.push(...n.attributeQuery.getValueAndXToOneRecordFields(s,o));let c=s.concat(b),u=o.concat(b);n.attributeQuery.parentLinkRecordQuery&&i.push(...n.attributeQuery.parentLinkRecordQuery.attributeQuery.getValueAndXToOneRecordFields(c,u))}),this.shouldQueryParentLinkData&&this.parentLinkRecordQuery){let n=this.map.getInfo(this.parentRecord,this.attributeName).getReverseInfo()?.attributeName,s=t.concat(n,b),o=e.concat(n,b),c=this.map.spawnManyToManySymmetricPath(s),u=this.map.spawnManyToManySymmetricPath(o);c?i.push(...this.parentLinkRecordQuery.attributeQuery.getValueAndXToOneRecordFields(c[0],u[0]),...this.parentLinkRecordQuery.attributeQuery.getValueAndXToOneRecordFields(c[1],u[1])):i.push(...this.parentLinkRecordQuery.attributeQuery.getValueAndXToOneRecordFields(s,o))}return i}get xToOneQueryTree(){return this.buildXToOneQueryTree()}buildXToOneQueryTree(){let t=new Zt(this.recordName,this.map,this.parentRecord,this.attributeName);if(this.data.forEach(e=>{Array.isArray(e)||t.addField([e])}),this.xToOneRecords.forEach(e=>{e.goto||t.addRecord([e.attributeName],e.attributeQuery.xToOneQueryTree)}),this.shouldQueryParentLinkData&&this.parentLinkRecordQuery&&!this.parentLinkRecordQuery.goto){let e=this.map.getInfo(this.parentRecord,this.attributeName).getReverseInfo();t.addRecord([e?.attributeName,b],this.parentLinkRecordQuery.attributeQuery.xToOneQueryTree)}return t}buildFullQueryTree(){let t=new Zt(this.recordName,this.map,this.parentRecord,this.attributeName);return this.relatedRecords.forEach(e=>{t.addRecord([e.attributeName],e.attributeQuery.fullQueryTree)}),t}withParentLinkData(){return this.parentLinkRecordQuery?new a(this.recordName,this.map,this.data,this.parentRecord,this.attributeName,!0):this}};function an(a){let t=[];return a.forEach(e=>t.push(...Array.isArray(e)?e:[e])),t}var ht=class a{constructor(t,e,r,i){this.map=t;this.originalRecordName=e;this.rawData=r;this.info=i;this.mergedLinkTargetNewRecords=[];this.mergedLinkTargetRecordIdRefs=[];this.mergedLinkTargetNullRecords=[];this.combinedNewRecords=[];this.combinedRecordIdRefs=[];this.combinedNullRecords=[];this.differentTableMergedLinkNewRecords=[];this.differentTableMergedLinkRecordIdRefs=[];this.differentTableMergedLinkNullRecords=[];this.isolatedNewRecords=[];this.isolatedRecordIdRefs=[];this.isolatedNullRecords=[];this.entityIdAttributes=[];this.relatedEntitiesData=[];this.valueAttributes=[];this.sameRowEntityIdRefs=[];this.defaultValues={};let n=this.map.getRecordInfo(e);this.recordName=n.isFilteredEntity||n.isFilteredRelation?n.resolvedBaseRecordName:e;let[s,o,c]=this.map.groupAttributes(this.recordName,r?Object.keys(r):[]);this.relatedEntitiesData=an(o.map(l=>Array.isArray(r[l.attributeName])?r[l.attributeName].map(d=>new a(this.map,l.recordName,d,l)):new a(this.map,l.recordName,r[l.attributeName],l))),this.valueAttributes=s,this.entityIdAttributes=c;let u=this.map.getRecordInfo(this.recordName);this.defaultValues=u.valueAttributes.reduce((l,d)=>{let h=d.data;return!this.rawData?.hasOwnProperty(d.attributeName)&&h.defaultValue&&typeof h.defaultValue=="function"&&(l[d.attributeName]=h.defaultValue(r,this.originalRecordName)),l},{}),this.relatedEntitiesData.forEach(l=>{l.info.isMergedWithParent()?l.isNull()?this.combinedNullRecords.push(l):l.isRef()?this.combinedRecordIdRefs.push(l):this.combinedNewRecords.push(l):l.info.isLinkMergedWithParent()?l.isNull()?this.mergedLinkTargetNullRecords.push(l):l.isRef()?this.mergedLinkTargetRecordIdRefs.push(l):this.mergedLinkTargetNewRecords.push(l):l.info.isLinkMergedWithAttribute()?l.isNull()?this.differentTableMergedLinkNullRecords.push(l):l.isRef()?this.differentTableMergedLinkRecordIdRefs.push(l):this.differentTableMergedLinkNewRecords.push(l):l.isNull()?this.isolatedNullRecords.push(l):l.isRef()?this.isolatedRecordIdRefs.push(l):this.isolatedNewRecords.push(l)}),this.rawData?.[b]&&(this.linkRecordData=new a(this.map,i?.linkName,this.rawData[b]))}merge(t){let e=new a(this.map,this.originalRecordName,{...this.rawData,...t},this.info);return this.recordName!==this.originalRecordName&&(e.recordName=this.recordName),e}getRef(){return{id:this.rawData.id}}isRef(){return this.rawData?.id!==void 0}isNull(){return this.rawData===null}getData(){return{...this.rawData}}getSameRowFieldAndValue(t={}){let e={...t,...this.rawData},r=[],i=new Set,n=this.map.getRecordInfo(this.recordName),s=new Set;return this.valueAttributes.forEach(o=>{s.add(o.attributeName);let c=o.isComputed?o.computed(e):this.rawData[o.attributeName],u=o.data;c===void 0&&u.defaultValue&&typeof u.defaultValue=="function"&&(c=u.defaultValue(this.rawData,this.originalRecordName)),r.push({name:o.attributeName,field:o.field,value:c,fieldType:o.fieldType}),o.isComputed&&i.add(o.attributeName)}),n.valueAttributes.forEach(o=>{let c=o.data;if(!s.has(o.attributeName)&&c.defaultValue&&typeof c.defaultValue=="function"&&this.rawData[o.attributeName]===void 0&&t[o.attributeName]===void 0){let u=this.defaultValues[o.attributeName];r.push({name:o.attributeName,field:o.field,value:u,fieldType:o.fieldType})}}),n.valueAttributes.forEach(o=>{if(o.isComputed&&!i.has(o.attributeName)){let c=o.computed(e);c!==t[o.attributeName]&&r.push({name:o.attributeName,field:o.field,value:c,fieldType:o.fieldType})}}),this.entityIdAttributes.forEach(o=>{r.push({name:o.attributeName,field:o.linkField,value:this.rawData[o.attributeName].id})}),this.mergedLinkTargetRecordIdRefs.forEach(o=>{r.push({name:o.info?.attributeName,field:o.info?.linkField,value:o.getRef().id}),o.linkRecordData&&r.push(...o.linkRecordData.getSameRowFieldAndValue())}),this.info&&this.linkRecordData&&this.info.isLinkMergedWithAttribute()&&r.push(...this.linkRecordData.getSameRowFieldAndValue()),this.combinedNewRecords.concat(this.combinedRecordIdRefs).forEach(o=>{r.push(...o.getSameRowFieldAndValue(t[o.info?.attributeName])),o.linkRecordData&&r.push(...o.linkRecordData.getSameRowFieldAndValue(t[o.info?.attributeName]?.[b]))}),r}};var sa=class{constructor(t,e){this.map=t;this.queryAgent=e;this.dependencies=new Map}analyzeDependencies(t,e,r){let i=[];this.extractDependenciesFromExpression(e,r,i);let n={filteredEntityName:t,baseEntityName:e,matchExpression:r,dependencies:i};for(let s of i)this.dependencies.has(s.entityName)||this.dependencies.set(s.entityName,[]),this.dependencies.get(s.entityName).push(n);return this.dependencies.has(e)||this.dependencies.set(e,[]),this.dependencies.get(e).push(n),n}extractDependenciesFromExpression(t,e,r){let i=L.fromValue(e);if(i.isExpression())i.left&&this.extractDependenciesFromExpression(t,i.left.raw,r),i.right&&this.extractDependenciesFromExpression(t,i.right.raw,r);else if(i.isAtom()){let o=i.data.key.split(".");if(o.length===1){let c=r.find(u=>u.entityName===t&&u.path.length===0);c?c.attributes.includes(o[0])||c.attributes.push(o[0]):r.push({entityName:t,path:[],attributes:[o[0]]})}else{let c=[t].concat(o);for(let u=1;u<c.length-1;u++){let l=c.slice(0,u+1),d=this.map.getInfoByPath(l);if(d&&d.isRecord){let h=d.recordName,f=o.slice(0,u),I=o[o.length-1],k=r.find(E=>E.entityName===h&&JSON.stringify(E.path)===JSON.stringify(f));k?k.attributes.includes(I)||k.attributes.push(I):r.push({entityName:h,path:f,attributes:[I]})}}}}}getAffectedFilteredEntities(t){return this.dependencies.get(t)||[]}clear(){this.dependencies.clear()}async findAffectedSourceRecords(t,e,r,i){let n=t.dependencies.find(l=>l.entityName===e);if(!n)return[];if(i.filter(l=>n.attributes.includes(l)).length===0)return[];if(n.path.length===0)return[{id:r}];let o=n.path.concat("id").join("."),c=g.atom({key:o,value:["=",r]}),u=z.create(t.baseEntityName,this.map,{matchExpression:c,attributeQuery:["id"]});return this.queryAgent.findRecords(u,`find affected source records for ${t.baseEntityName}`)}async checkRecordMatchesFilter(t,e,r){if(!this.queryAgent)throw new Error("QueryAgent not set in FilteredEntityManager");let i=z.create(e,this.map,{matchExpression:r.and({key:"id",value:["=",t]}),modifier:{limit:1}});return(await this.queryAgent.findRecords(i,`check if record ${t} matches filter condition`)).length>0}getFilteredEntitiesForBase(t){let e=[],r=new Set,i=new Set,n=s=>{if(i.has(s))return;i.add(s);let c=this.map.getRecordInfo(s).filteredBy||[];for(let u of c){if(!r.has(u.name)){r.add(u.name);let d=this.map.getRecordInfo(u.name).data.resolvedMatchExpression;e.push({name:u.name,matchExpression:d})}n(u.name)}};return n(t),e}async updateFilteredEntityFlags(t,e,r=[],i,n,s){if(n&&i){let u=this.getFilteredEntitiesForBase(t),l={};for(let d of u)await this.checkRecordMatchesFilter(e,t,d.matchExpression)&&(l[d.name]=!0,r.push({type:"create",recordName:d.name,record:{...i,id:e}}));if(Object.keys(l).length>0){let h=this.map.getRecordInfo(t).data.attributes.__filtered_entities;if(h&&h.field){let f=h.field;await this.queryAgent.updateRecordDataById(t,{id:e},[{field:f,value:JSON.stringify(l)}])}}return}let o=this.getAffectedFilteredEntities(t);if(o.length===0)return;let c=s||(n&&i?Object.keys(i):[]);for(let u of o){let l=await this.findAffectedSourceRecords(u,t,e,c);for(let d of l)await this.updateSingleFilteredEntityFlag(u,d.id,r)}}isFlagEqual(t,e){let r=Object.keys(t).filter(n=>t[n]===!0),i=Object.keys(e).filter(n=>e[n]===!0);return r.length===i.length&&r.every(n=>e[n]===!0)}async updateSingleFilteredEntityFlag(t,e,r){let i=this.map.getRecordInfo(t.baseEntityName),n=await this.queryAgent.findRecords(z.create(t.baseEntityName,this.map,{matchExpression:g.atom({key:"id",value:["=",e]}),attributeQuery:i.isRelation?["*",["target",{attributeQuery:["*"]}],["source",{attributeQuery:["*"]}]]:["*"]}),`get current filtered entity flags for ${t.baseEntityName}:${e}`);if(n.length===0)return;let s=n[0],o=s.__filtered_entities,c=await this.checkRecordMatchesFilter(e,t.baseEntityName,t.matchExpression),u=o[t.filteredEntityName]===!0;if(c&&!u?(r.push({type:"create",recordName:t.filteredEntityName,record:{...s}}),o[t.filteredEntityName]=!0):!c&&u&&(r.push({type:"delete",recordName:t.filteredEntityName,record:{...s}}),o[t.filteredEntityName]=!1),u!==c){let d=this.map.getRecordInfo(t.baseEntityName).data.attributes.__filtered_entities;if(d&&d.field){let h=d.field;await this.queryAgent.updateRecordDataById(t.baseEntityName,{id:e},[{field:h,value:JSON.stringify(o)}])}}}};var rr=class{constructor(){this.aliasToPath=new Map;this.pathStrToAlias=new Map;this.aliasPlaceholder=0}getAlias(t,e=!1){let r=t.join("."),i=this.pathStrToAlias.get(r);if(i||!e)return i;let n=`FIELD_${this.aliasPlaceholder++}`;return this.pathStrToAlias.set(r,n),this.aliasToPath.set(n,t),n}getPath(t){return this.aliasToPath.get(t)}},rn=":root",ir=class a{constructor(t,e,r=[]){this.label=t;this.parent=e;this.stack=r}concat(t){return new a(this.label,this.parent,[...this.stack,t])}getStack(t){return[...this.stack]}spawn(t){return new a(t,this)}},nr=class{constructor(t){this.recordQuery=t;this.recordQueryByName=new Map;this.set(rn,t),this.recursiveSaveLabelledRecordQuery(t)}recursiveSaveLabelledRecordQuery(t){t.attributeQuery?.relatedRecords.forEach(e=>{e.label&&(this.set(e.label,e),this.recursiveSaveLabelledRecordQuery(e))})}set(t,e){this.recordQueryByName.set(t,e)}get(t){return this.recordQueryByName.get(t)}},oa=class{constructor(t,e){this.map=t;this.database=e;this.getPlaceholder=e.getPlaceholder||(()=>r=>"?"),this.filteredEntityManager=new sa(t,this),this.initializeFilteredEntityDependencies()}initializeFilteredEntityDependencies(){let t=this.map.data.records;for(let[e,r]of Object.entries(t))if(r.baseRecordName&&r.matchExpression){let i=r.resolvedBaseRecordName||r.baseRecordName,n=r.resolvedMatchExpression||r.matchExpression;this.filteredEntityManager.analyzeDependencies(e,i,n)}}buildXToOneFindQuery(t,e="",r){let i=t.attributeQuery.xToOneQueryTree,n=t.matchExpression.xToOneQueryTree,s=i.merge(n),o=this.getJoinTables(s,[t.recordName]),c=r||this.getPlaceholder(),u=t.matchExpression.buildFieldMatchExpression(c,this.database),[l,d]=this.buildWhereClause(this.parseMatchExpressionValue(t.recordName,u,t.contextRootEntity,c),e,c),[h,f]=this.buildSelectClause(t.attributeQuery.getValueAndXToOneRecordFields(),e),I=this.buildFromClause(t.recordName,e),k=this.buildJoinClause(o,e),E=this.buildModifierClause(t.modifier,e,f);return[`
SELECT
${h}
FROM
${I}
${k}
WHERE
${l}

${E}
`,d,f]}buildModifierClause(t,e="",r){let{limit:i,offset:n,orderBy:s}=t,o=[];return s.length&&o.push(`ORDER BY ${s.map(({attribute:c,recordName:u,order:l})=>{let d=[`${this.withPrefix(e)}${u}`,c];return`"${r.getAlias(d)||d.join(".")}" ${l}`}).join(",")}`),i&&o.push(`LIMIT ${i}`),n&&o.push(`OFFSET ${n}`),o.join(`
`)}structureRawReturns(t,e,r){return t.map(i=>{let n={};return Object.entries(i).forEach(([s,o])=>{let c=r.getPath(s).slice(1,1/0);c.length===1&&e.includes(c[0])&&typeof o=="string"&&(o=JSON.parse(o)),o!==null&&ia(n,c,o)}),n})}async findRecords(t,e="",r,i=new ir(rn)){if(r||(r=new nr(t)),t.goto){if(t.exit&&await t.exit(i))return[];let l=r.get(t.goto);R(l,`goto ${t.goto} not found`);let d=t.matchExpression.and(l.matchExpression),h=l.derive({matchExpression:d});return this.findRecords(h,e,r,i)}if(t.label&&i.label===t.label&&i.stack.length>1&&i.stack[0].id===i.stack.at(-1).id)return[];let[n,s,o]=this.buildXToOneFindQuery(t,""),c=this.structureRawReturns(await this.database.query(n,s,e),this.map.getRecordInfo(t.recordName).JSONFields,o),u=t.label&&t.label!==i.label?i.spawn(t.label):i;this.completeXToOneLeftoverRecords(t,c,r,u);for(let l of t.attributeQuery.xToOneRecords)if(l.goto){let h=this.map.getInfo(l.parentRecord,l.attributeName).getReverseInfo()?.attributeName;for(let f of c){let I=l.matchExpression.and({key:`${h}.id`,value:["=",f.id]}),k=l.derive({matchExpression:I}),E=t.label?u.concat(f):u;f[l.alias||l.attributeName]=await this.findRecords(k,e,r,E)}}for(let l of t.attributeQuery.xToOneRecords){let d=l.attributeQuery.parentLinkRecordQuery;if(d)for(let h of d.attributeQuery.xToManyRecords){let I=this.map.getInfo(h.parentRecord,h.attributeName).getReverseInfo()?.attributeName;for(let k of c){let E=k[l.attributeName][b].id,N=h.derive({matchExpression:h.matchExpression.and({key:`${I}.id`,value:["=",E]})}),X=t.label?u.concat(k):u;ia(k,[l.alias||l.attributeName,b,h.attributeName],await this.findRecords(N,`finding relation data: ${t.recordName}.${l.attributeName}.&.${h.attributeName}`,r,X))}}}for(let l of t.attributeQuery.xToManyRecords)if(!l.onlyRelationData)for(let d of c){let h=t.label?u.concat(d):u;d[l.alias||l.attributeName]=await this.findXToManyRelatedRecords(t.recordName,l.attributeName,d.id,l,r,h)}return c}async completeXToOneLeftoverRecords(t,e,r,i){if(t.attributeQuery.parentLinkRecordQuery){let s=this.map.getInfo(t.parentRecord,t.attributeName).getReverseInfo()?.attributeName;for(let o of t.attributeQuery.parentLinkRecordQuery.attributeQuery.xToOneRecords)for(let c of o.attributeQuery.xToManyRecords)for(let u of e){let l=t.label?i.concat(u):i;u[s][b][o.attributeName][c.attributeName]=await this.findXToManyRelatedRecords(c.parentRecord,c.attributeName,u[s][b][o.attributeName].id,c,r,l)}}for(let n of t.attributeQuery.xToOneRecords){for(let s of n.attributeQuery.xToManyRecords)for(let o of e){let c=t.label?i.concat(o):i;o[n.attributeName][s.attributeName]=await this.findXToManyRelatedRecords(s.parentRecord,s.attributeName,o[n.attributeName].id,s,r,c)}for(let s of n.attributeQuery.xToOneRecords)for(let o of e){let c=t.label?i.concat(o):i;await this.completeXToOneLeftoverRecords(s,[].concat(o[n.attributeName]),r,c)}}}async findXToManyRelatedRecords(t,e,r,i,n,s){let o=this.map.getInfo(t,e),c=o.getReverseInfo()?.attributeName,u=i.matchExpression.and({key:`${c}.id`,value:["=",r]}),l=i.attributeQuery.parentLinkRecordQuery?i.attributeQuery.withParentLinkData():i.attributeQuery,d=i.derive({matchExpression:u,attributeQuery:l}),h=await this.findRecords(d,`finding related record: ${i.parentRecord}.${i.attributeName}`,n,s),f=i.attributeQuery.parentLinkRecordQuery?h.map(E=>{let N;return o.isLinkManyToManySymmetric()?(N={...E,[b]:E[`${c}:source`]?.[b]?.id?E[`${c}:source`]?.[b]:E[`${c}:target`]?.[b]},delete N[`${c}:source`],delete N[`${c}:target`]):(N={...E,[b]:E[c][b]},delete N[c]),N}):h,I=d.label&&d.label!==s.label?s.spawn(d.label):s,k=i.attributeQuery.parentLinkRecordQuery;if(k)for(let E of k.attributeQuery.xToManyRecords)for(let N of f){let X=N[b].id,Bt=d.label?I.concat(N):I;ia(N,[b,E.attributeName],await this.findXToManyRelatedRecords(E.parentRecord,E.attributeName,X,E,n,Bt))}return f}getJoinTables(t,e=[],r){let i=[];if(!r){let o=[e[0]],[c,u,l]=this.map.getTableAliasAndFieldName(o,"id");r=[u,l,c]}let[n,...s]=r;return t.forEachRecords(o=>{let c=o.attributeName,u=o.info;R(u.isRecord,`${e.concat(c).join(".")} is not a record`);let l=e.concat(c),{table:d,alias:h,linkTable:f,linkAlias:I}=this.map.getTableAndAliasStack(l).at(-1),[,k]=this.map.getTableAliasAndFieldName(l,"id",!0);if(!u.isMergedWithParent())if(u.isLinkMergedWithParent()){if(o.onlyIdField())return;i.push({for:l,joinSource:s,joinIdField:[u.linkField,k],joinTarget:[d,h]})}else if(u.isLinkMergedWithAttribute()){let E=u.getReverseInfo();R(!!E.linkField,`${E.parentEntityName}.${E.attributeName} has no field`),i.push({for:l,joinSource:s,joinIdField:[n,E.linkField],joinTarget:[d,h]})}else{let E=u.getLinkInfo(),N=u.isLinkManyToManySymmetric()?u.symmetricDirection==="source":E.isRelationSource(u.parentEntityName,u.attributeName);i.push({for:l,joinSource:s,joinIdField:[n,N?E.record.attributes.source.field:E.record.attributes.target.field],joinTarget:[f,I]}),o.onlyIdField()||i.push({for:l,joinSource:[f,I],joinIdField:[N?E.record.attributes.target.field:E.record.attributes.source.field,k],joinTarget:[d,h]})}if(i.push(...this.getJoinTables(o,l,[k,d,h])),o.parentLinkQueryTree,o.parentLinkQueryTree&&!o.parentLinkQueryTree.onlyIdField()){let E=l.concat(b),[,N]=this.map.getTableAliasAndFieldName(E,"id",!0),X=[N,f,I];i.push(...this.getJoinTables(o.parentLinkQueryTree,E,X))}}),i}withPrefix(t=""){return t?`${t}___`:""}buildSelectClause(t,e=""){let r=new rr;if(!t.length)return["1",r];let i=0;return[t.map(({tableAliasAndField:s,attribute:o,nameContext:c})=>{let u=[`${this.withPrefix(e)}${c[0]}`,...c.slice(1,1/0),o],l=r.getAlias(u,!0);return`"${this.withPrefix(e)}${s[0]}"."${s[1]}" AS "${l}"`}).join(`,
`),r]}buildFromClause(t,e=""){return`"${this.map.getRecordInfo(t).table}" AS "${this.withPrefix(e)}${t}"`}buildJoinClause(t,e=""){return t.map(({joinSource:r,joinIdField:i,joinTarget:n})=>`LEFT JOIN "${n[0]}" AS 
"${this.withPrefix(e)}${n[1]}" ON 
"${this.withPrefix(e)}${r[1]}"."${i[0]}" = "${this.withPrefix(e)}${n[1]}"."${i[1]}"
`).join(`
`)}buildWhereClause(t,e="",r){let i="",n=[];if(!t)return[`1=${r()}`,[1]];if(t.isAtom())t.data.isInnerQuery?(i=t.data.fieldValue,n.push(...t.data.fieldParams)):(i=`"${this.withPrefix(e)}${t.data.fieldName[0]}"."${t.data.fieldName[1]}" ${t.data.fieldValue}`,n.push(...t.data.fieldParams));else if(t.isAnd()){let[s,o]=this.buildWhereClause(t.left,e,r),[c,u]=this.buildWhereClause(t.right,e,r);i=`(${s} AND ${c})`,n.push(...o,...u)}else if(t.isOr()){let[s,o]=this.buildWhereClause(t.left,e,r),[c,u]=this.buildWhereClause(t.right,e,r);i=`(${s} OR ${c})`,n.push(...o,...u)}else{let[s,o]=this.buildWhereClause(t.left,e,r);i=`NOT (${s})`,n.push(...o)}return[i,n]}parseMatchExpressionValue(t,e,r,i){return e?e.map((n,s)=>{if(R(Array.isArray(n.data.value),`match value is not a array ${s.join(".")}`),!n.data.isFunctionMatch)return{...n.data};R(n.data.value[0].toLowerCase()==="exist",`we only support Exist function match on entity for now. yours: ${n.data.key} ${n.data.value[0]} ${n.data.value[1]}`);let o=this.map.getInfoByPath(n.data.namePath),{alias:c}=this.map.getTableAndAliasStack(n.data.namePath).at(-1),u=this.map.getReverseAttribute(o.parentEntityName,o.attributeName),l=n.data.namePath.slice(1,-1),d=z.create(o.recordName,this.map,{matchExpression:g.atom({key:`${u}.id`,value:["=",l.concat("id").join(".")],isReferenceValue:!0}).and(n.data.value[1])},r||t),[h,f]=this.buildXToOneFindQuery(d,c,i);return{...n.data,isInnerQuery:!0,fieldValue:`
EXISTS (
${h}
)
`,fieldParams:f}}):null}async createRecordDependency(t,e){let r={};for(let i of t.mergedLinkTargetNewRecords.concat(t.mergedLinkTargetRecordIdRefs)){let n;if(i.isRef()?n=i.getRef():n=await this.createRecord(i,`create merged link dep record ${t.recordName}.${i.info?.attributeName}`,e),r[i.info.attributeName]=n,i.linkRecordData){let s=i.linkRecordData.merge({[i.info.isRecordSource()?"target":"source"]:n}),o=await this.createRecordDependency(s);r[i.info.attributeName][b]=o.getData()}}for(let i of t.combinedNewRecords.concat(t.combinedRecordIdRefs))if(i.linkRecordData){let n=await this.createRecordDependency(i.linkRecordData,e);r[i.info.attributeName]={...i.getData(),[b]:n.getData()}}return t.merge(r)}async createRecord(t,e,r){let i=await this.createRecordDependency(t,r),n=await this.insertSameRowData(i,e,r),s=await this.handleCreationReliance(i.merge(n),r),o=Object.assign({},t.getData(),n,s);return await this.filteredEntityManager.updateFilteredEntityFlags(t.recordName,n.id,r,o,!0),Object.assign(n,s)}async preprocessSameRowData(t,e=!1,r,i){let n=t.getData();!e&&!n.id?n.id=await this.database.getAutoId(t.recordName):e&&!n.id&&(n.id=i.id),e?t.valueAttributes.length&&r?.push({type:"update",recordName:t.recordName,record:{...t.getData(),id:i.id},oldRecord:i}):r?.push({type:"create",recordName:t.recordName,record:{...t.defaultValues,...n}});for(let c of t.combinedNewRecords)n[c.info.attributeName]={...n[c.info.attributeName],id:await this.database.getAutoId(c.info.recordName)},r?.push({type:"create",recordName:c.recordName,record:n[c.info.attributeName]});for(let c of t.mergedLinkTargetNewRecords.concat(t.mergedLinkTargetRecordIdRefs,t.combinedNewRecords))if(n[c.info.attributeName].id!==i?.[c.info.attributeName]?.id){n[c.info.attributeName][b]={...n[c.info.attributeName][b]||{},id:await this.database.getAutoId(c.info.linkName)};let u={...n[c.info.attributeName][b]};u[c.info.isRecordSource()?"target":"source"]=c.getData(),u[c.info.isRecordSource()?"source":"target"]={...n},delete u.target[b],delete u.source[b],r?.push({type:"create",recordName:c.info.linkName,record:u})}let s=t.merge(n),o=await this.flashOutCombinedRecordsAndMergedLinks(t,r,`finding combined records for ${t.recordName} to flash out, for ${e?"updating":"creation"} with data ${JSON.stringify(s.getData())}`);return s.merge(o)}async flashOutCombinedRecordsAndMergedLinks(t,e,r=""){let i={},n,s=It.getAttributeQueryDataForRecord(t.recordName,this.map,!0,!0,!1,!0);for(let u of t.combinedRecordIdRefs){let l={key:`${u.info.attributeName}.id`,value:["=",u.getRef().id]};n?n=n.or(l):n=g.atom(l)}let o=z.create(t.recordName,this.map,{matchExpression:n,attributeQuery:s},void 0,void 0,void 0,!1,!0),c=await this.findRecords(o,r,void 0);for(let u of c)for(let l of t.combinedRecordIdRefs)u[l.info?.attributeName]&&(await this.deleteRecordSameRowData(l.recordName,[{id:u[l.info?.attributeName].id}]),u.id&&e?.push({type:"delete",recordName:l.info.linkName,record:u[l.info?.attributeName][b]}),R(!i[l.info?.attributeName],`should not have same combined record, conflict attribute: ${l.info?.attributeName}`),i[l.info?.attributeName]={...u[l.info?.attributeName]},l.info.isLinkSourceRelation()||(i[l.info?.attributeName][b]={id:await this.database.getAutoId(l.info.linkName)},e?.push({type:"create",recordName:l.info.linkName,record:i[l.info?.attributeName][b]})));return i}async relocateCombinedRecordDataForLink(t,e,r=!1,i){let n=It.getAttributeQueryDataForRecord(t,this.map,!0,!0,!0,!0),s=r?"source":"target",o=await this.findRecords(z.create(t,this.map,{matchExpression:e,attributeQuery:n}),`finding combined records for relocate ${t}.${s}`,void 0),c=this.map.getLinkInfoByName(t)[r?"sourceRecordInfo":"targetRecordInfo"];await this.deleteRecordSameRowData(c.name,o.map(u=>u[s]));for(let u of o){let l=new ht(this.map,c.name,u[s]);await this.insertSameRowData(l,void 0),i?.push({type:"delete",recordName:t,record:u})}}async insertSameRowData(t,e,r){let i=await this.preprocessSameRowData(t,!1,r),n=i.getSameRowFieldAndValue(),s=this.getPlaceholder(),o=this.map.getRecordInfo(t.recordName),c=await this.database.insert(`
INSERT INTO "${o.table}"
(${n.map(u=>`"${u.field}"`).join(",")})
VALUES
(${n.map(u=>s()).join(",")}) 
`,n.map(u=>this.prepareFieldValue(u.value,u.fieldType)),e);return Object.assign(c,i.getData())}prepareFieldValue(t,e){return e?.toLowerCase()==="json"?JSON.stringify(t):t}async handleCreationReliance(t,e){let r=t.getRef(),i={};for(let n of t.differentTableMergedLinkNewRecords){let s=n.info?.getReverseInfo()?.attributeName,o=n.merge({[s]:r}),c=await this.createRecord(o,`create record ${t.recordName}.${n.info?.attributeName}`,e);n.info.isXToMany?(i[n.info.attributeName]||(i[n.info.attributeName]=[]),i[n.info.attributeName].push({...c,[b]:c[s][b]})):i[n.info.attributeName]={...c,[b]:c[s][b]}}for(let n of t.differentTableMergedLinkRecordIdRefs){let s=n.info.getReverseInfo(),o=g.atom({key:"id",value:["=",n.getRef().id]}),c={[s.attributeName]:r,[b]:n.getData()[b]},[u]=await this.updateRecord(s.parentEntityName,o,new ht(this.map,s.parentEntityName,c),e);n.info.isXToMany?(i[n.info.attributeName]||(i[n.info.attributeName]=[]),i[n.info.attributeName].push({...u,[b]:u[s.attributeName][b]})):i[n.info.attributeName]={...u,[b]:u[s.attributeName][b]}}for(let n of t.isolatedNewRecords){let s=await this.createRecord(n,`create isolated related record ${t.recordName}.${n.info?.attributeName}`,e),o=n.linkRecordData?.getData()||{};Object.assign(o,{source:n.info.isRecordSource()?r:s,target:n.info.isRecordSource()?s:r});let c=new ht(this.map,n.info.linkName,o),u=await this.createRecord(c,`create isolated related link record ${t.recordName}.${n.info?.attributeName}`,e);n.info.isXToMany?(i[n.info.attributeName]||(i[n.info.attributeName]=[]),i[n.info.attributeName].push({...s,[b]:u})):i[n.info.attributeName]={...s,[b]:u}}for(let n in t.isolatedRecordIdRefs){let s=t.isolatedRecordIdRefs[n];if(s.info.isXToOne){let l=g.atom({key:s.info?.isRecordSource()?"target.id":"source.id",value:["=",s.getRef().id]});await this.unlink(s.info.linkName,l,!1,"unlink xToOne old link",e)}let o=s.linkRecordData?.getData()||{};Object.assign(o,{source:s.info.isRecordSource()?r:s.getRef(),target:s.info.isRecordSource()?s.getRef():r});let c=new ht(this.map,s.info.linkName,o),u=await this.createRecord(c,`create isolated related link record of old related ${t.recordName}.${s.info?.attributeName}`,e);s.info.isXToMany?(i[s.info.attributeName]||(i[s.info.attributeName]=[]),i[s.info.attributeName][n]={...s.getData(),[b]:u}):i[s.info.attributeName]={...s.getData(),[b]:u}}return i}async updateRecordDataById(t,e,r){if(!r.length)return e;let i=this.getPlaceholder(),n=this.map.getRecordInfo(t);return await this.database.update(`
UPDATE "${n.table}"
SET ${r.map(({field:s})=>`"${s}" = ${i()}`).join(",")}
WHERE "${n.idField}" = (${i()})
        `,[...r.map(({field:s,value:o})=>o),e.id],n.idField,`update record ${t} by id`),e}async updateSameRowData(t,e,r,i){let n=r.combinedRecordIdRefs.concat(r.combinedNewRecords,r.combinedNullRecords,r.mergedLinkTargetNullRecords,r.mergedLinkTargetRecordIdRefs);for(let u of n){let l=u.info.getLinkInfo(),d=l.isRelationSource(t,u.info.attributeName)?"source":"target";u.isRef()&&e[u.info?.attributeName]?.id===u.getData().id||await this.unlink(l.name,g.atom({key:`${d}.id`,value:["=",e.id]}),!l.isRelationSource(t,u.info.attributeName),`unlink ${u.info?.parentEntityName} ${u.info?.attributeName} for update ${t}`,i)}let s=await this.preprocessSameRowData(r,!0,i,e),c=s.getSameRowFieldAndValue(e).map(({field:u,value:l})=>({field:u,value:l}));return await this.updateRecordDataById(t,e,c),s}async handleUpdateReliance(t,e,r,i){let n=r.differentTableMergedLinkRecordIdRefs.concat(r.differentTableMergedLinkNewRecords,r.differentTableMergedLinkNullRecords,r.isolatedRecordIdRefs,r.isolatedNewRecords,r.isolatedNullRecords),s=new Set;for(let c of n){let u=c.info.getLinkInfo();if(s.has(u.name))continue;s.add(u.name);let l=u.isRelationSource(t,c.info.attributeName)?"source":"target";await this.unlink(u.name,g.atom({key:`${l}.id`,value:["=",e.id]}),!u.isRelationSource(t,c.info.attributeName),"unlink old reliance for update",i)}let o={id:e.id};for(let c of n){if(r.rawData[c.info?.attributeName]===null)continue;let u;c.isRef()?u=c.getRef():u=await this.createRecord(c,`create new related record for update ${r.recordName}.${c.info?.attributeName}`,i);let l=await this.addLinkFromRecord(t,c.info?.attributeName,e.id,u.id,void 0,i);c.info.isXToMany?(o[c.info.attributeName]||(o[c.info.attributeName]=[]),o[c.info.attributeName].push({...u,[b]:l})):o[c.info.attributeName]={...u,[b]:l}}return o}async updateRecord(t,e,r,i){let n=z.create(t,this.map,{matchExpression:e,attributeQuery:It.getAttributeQueryDataForRecord(t,this.map,!0,!0,!0,!0)}),s=await this.findRecords(n,`find record for updating ${t}`,void 0),o=[];for(let c of s){let u=await this.createRecordDependency(r,i),l=await this.updateSameRowData(n.recordName,c,u,i),d=await this.handleUpdateReliance(n.recordName,c,r,i),h=Object.keys(r.getData());await this.filteredEntityManager.updateFilteredEntityFlags(n.recordName,c.id,i,c,!1,h),o.push({...r.getData(),...l.getData(),...d})}return o}async deleteRecord(t,e,r,i=!1){let n=z.create(t,this.map,{matchExpression:e,attributeQuery:It.getAttributeQueryDataForRecord(t,this.map,!0,!0,!0,!0)}),s=await this.findRecords(n,`find record for deleting ${t}`,void 0);if(s.length){await this.deleteNotReliantSeparateLinkRecords(n.recordName,s,r);let o=[];await this.deleteDifferentTableReliance(n.recordName,s,o);let c=[];await this.deleteRecordSameRowData(n.recordName,s,c,i);let u=c.slice(0,c.length-s.length),l=c.slice(c.length-s.length);r?.push(...u,...o,...l)}return s}async deleteRecordSameRowData(t,e,r,i=!1){let n=this.map.getRecordInfo(t);for(let s of e){if(!i){let o=z.create(t,this.map,{matchExpression:g.atom({key:"id",value:["=",s.id]}),attributeQuery:It.getAttributeQueryDataForRecord(t,this.map,!0,!0,!0,!0),modifier:{limit:1}}),c=await this.findRecords(o,`find record with same row data for delete ${t}`,void 0);if(n.notRelianceCombined.some(l=>!!c[0]?.[l.attributeName]?.id)){let l=this.getPlaceholder(),d=n.sameRowFields;await this.database.update(`
UPDATE "${n.table}"
SET ${d.map(h=>`"${h}" = ${l()}`).join(",")}
WHERE "${n.idField}" = ${l()}
`,[...d.map(h=>null),s.id],n.idField,`use update to delete ${t} because of sameRowData`)}else{let l=this.getPlaceholder();await this.database.delete(`
DELETE FROM "${n.table}"
WHERE "${n.idField}" = ${l()}
`,[s.id],`delete record ${n.name} as row`)}}for(let o of n.sameTableReliance)s[o.attributeName]?.id&&(r?.push({type:"delete",recordName:o.linkName,record:{...s[o.attributeName][b],[o.isRecordSource()?"source":"target"]:{id:s.id},[o.isRecordSource()?"target":"source"]:{id:s[o.attributeName].id}}}),await this.handleDeletedRecordReliance(o.recordName,s[o.attributeName],r));n.mergedRecordAttributes.forEach(o=>{s[o.attributeName]?.id&&r?.push({type:"delete",recordName:o.linkName,record:{...s[o.attributeName][b],[o.isRecordSource()?"source":"target"]:{id:s.id},[o.isRecordSource()?"target":"source"]:{id:s[o.attributeName].id}}})}),n.notRelianceCombined.forEach(o=>{n.isRelation&&(o.attributeName==="target"||o.attributeName==="source")||s[o.attributeName]?.id!==void 0&&r?.push({type:"delete",recordName:o.linkName,record:{...s[o.attributeName][b],[o.isRecordSource()?"source":"target"]:{id:s.id},[o.isRecordSource()?"target":"source"]:{id:s[o.attributeName].id}}})})}for(let s of e){let o=this.filteredEntityManager.getFilteredEntitiesForBase(t);if(o.length>0&&s.__filtered_entities){let c=typeof s.__filtered_entities=="string"?JSON.parse(s.__filtered_entities):s.__filtered_entities;for(let u of o)c[u.name]===!0&&r?.push({type:"delete",recordName:u.name,record:{...s}})}}r?.push(...e.map(s=>({type:"delete",recordName:t,record:s})))}async handleDeletedRecordReliance(t,e,r){return await this.deleteNotReliantSeparateLinkRecords(t,[e],r),await this.deleteDifferentTableReliance(t,[e],r),await this.deleteRecordSameRowData(t,[e],r,!0),e}async deleteNotReliantSeparateLinkRecords(t,e,r){let i=this.map.getRecordInfo(t);for(let n of i.differentTableRecordAttributes)if(!n.isReliance){let s=n.isRecordSource()?"source.id":"target.id",o=g.atom({key:s,value:["in",e.map(c=>c.id)]});await this.deleteRecord(n.linkName,o,r)}}async deleteDifferentTableReliance(t,e,r){let i=this.map.getRecordInfo(t),n=r?new Map(e.map(s=>[s.id,s])):void 0;for(let s of i.differentTableReliance){let o=g.atom({key:`${s.getReverseInfo()?.attributeName}.id`,value:["in",e.map(c=>c.id)]});await this.deleteRecord(s.recordName,o,r),r&&r.forEach(c=>{if(c.recordName===s.linkName){let u=n.get(c.record[s.isRecordSource()?"source":"target"].id);u&&(c.record[s.isRecordSource()?"source":"target"]=u)}})}}addLinkFromRecord(t,e,r,i,n={},s){let o=this.map.getLinkInfo(t,e),c=o.isRelationSource(t,e),u=c?r:i,l=c?i:r;return this.addLink(o.name,u,l,n,!o.isRelationSource(t,e),s)}async addLink(t,e,r,i={},n=!1,s){let o=(await this.findRecords(z.create(t,this.map,{matchExpression:g.atom({key:"source.id",value:["=",e]}).and({key:"target.id",value:["=",r]}),modifier:{limit:1}}),`check if link exist for add link ${t}`,void 0))[0];R(!o,`cannot create ${t} for ${e} ${r}, link already exist`);let c=this.map.getLinkInfoByName(t);if(!c.isCombined()&&!c.isMerged()&&(c.isManyToOne||c.isOneToMany)){let l=c.isManyToOne?"source.id":"target.id",d=c.isManyToOne?e:r,h=g.atom({key:l,value:["=",d]});await this.unlink(t,h,!1,"unlink combined record for add new link",s)}let u=new ht(this.map,c.name,{source:{id:e},target:{id:r},...i});return this.createRecord(u,`create link record ${c.name}`,s)}async unlink(t,e,r=!1,i="",n){let s=this.map.getLinkInfoByName(t);return R(!s.isTargetReliance,`cannot unlink reliance data, you can only delete record, ${t}`),s.isCombined()?this.relocateCombinedRecordDataForLink(t,e,r,n):this.deleteRecord(t,e,n)}async findPath(t,e,r,i,n){let s=e.split("."),o=s.at(-1),c=s.slice(0,-1),u=g.atom({key:"id",value:["=",r]}),l=It.getAttributeQueryDataForRecord(t,this.map,!0,!0,!1,!0),d=e,h=l;for(let E of c)h.push([E,{attributeQuery:["*"]}]),h=h.at(-1)[1].attributeQuery;h.push([o,{label:d,attributeQuery:["*"]}]),h=h.at(-1)[1].attributeQuery;for(let E of c)h.push([E,{attributeQuery:["*"]}]),h=h.at(-1)[1].attributeQuery;let f,I=async E=>{if(f)return!0;if(E.stack.at(-1)?.id===i)return f=[...E.stack],!0};h.push([o,{goto:d,exit:I}]);let k=(await this.findRecords(z.create(t,this.map,{matchExpression:u,attributeQuery:l}),`find records for path ${t}.${e}`))[0];return f?[k,...f]:void 0}};var ca=class{constructor(t,e){this.map=t;this.database=e;this.agent=new oa(t,e)}async findOne(t,e,r={},i){let n={...r,limit:1};return(await this.find(t,e,n,i))[0]}async find(t,e,r,i=[]){R(this.map.getRecord(t),`cannot find entity ${t}`);let n=z.create(t,this.map,{matchExpression:e,attributeQuery:i,modifier:r});return this.agent.findRecords(n,`finding ${t} from handle`)}async create(t,e,r){R(e[Yt]===null||e[Yt]===void 0,`${Yt} should be null or undefined when creating new record`);let i=new ht(this.map,t,e);return this.agent.createRecord(i,`create record ${t} from handle`,r)}async update(t,e,r,i){let n=new ht(this.map,t,r);return this.agent.updateRecord(t,e,n,i)}async delete(t,e,r){return this.agent.deleteRecord(t,e,r)}async addRelationByNameById(t,e,r,i={},n){return R(!!t&&!!e&&r,`relationName: ${t} sourceEntityId:${e} targetEntityId:${r} all cannot be empty`),this.agent.addLink(t,e,r,i,!1,n)}async addRelationById(t,e,r,i,n,s){return this.agent.addLinkFromRecord(t,e,r,i,n,s)}async updateRelationByName(t,e,r,i){return R(!r.source&&!r.target,"Relation can only update attributes. Use addRelation/removeRelation to update source/target."),this.agent.updateRecord(t,e,new ht(this.map,t,r),i)}async removeRelationByName(t,e,r){return this.agent.unlink(t,e,!1,`remove relation ${t}`,r)}async findRelationByName(t,e,r,i=[]){return this.find(t,e,r,i)}async findOneRelationByName(t,e,r={},i=[]){let n={...r,limit:1};return(await this.findRelationByName(t,e,n,i))[0]}async findPath(t,e,r,i){return this.agent.findPath(t,e,r,i)}createMatchFromAtom(...t){return g.atom(...t)}getRelationName(t,e){return this.map.getInfo(t,e).linkName}getEntityName(t,e){return this.map.getInfo(t,e).recordName}};var te=class a{constructor(t,e){this.name=t;this.map=e;this.data=this.map.data.records[t]}get isRelation(){return this.data.isRelation}get combinedRecords(){return this.strictRecordAttributes.filter(t=>t.isMergedWithParent())}get table(){return this.data.table}get idField(){return this.data.attributes.id.field}get JSONFields(){return Object.entries(this.data.attributes).filter(([,t])=>!t.isRecord&&(t.collection||t.type==="object"||t.type==="json")).map(([t])=>t)}get sameRowFields(){let t=this.valueAttributes.map(n=>n.field),e=this.strictRecordAttributes.filter(n=>n.isLinkMergedWithParent()).map(n=>n.getLinkInfo().recordInfo.sameRowFields),r=this.managedRecordAttributes.map(n=>n.linkField),i=this.sameTableReliance.map(n=>n.getRecordInfo().sameRowFields);return t.concat(...e,...r,...i)}get mergedRecordAttributes(){return this.strictRecordAttributes.filter(t=>t.isLinkMergedWithParent())}get allFields(){return Object.values(this.data.attributes).map(t=>t.field).filter(t=>t)}get managedRecordAttributes(){return Object.keys(this.data.attributes).filter(t=>{let e=this.data.attributes[t];return e.isRecord&&e.field}).map(t=>new St(this.name,t,this.map))}get strictRecordAttributes(){return Object.keys(this.data.attributes).filter(t=>{let e=this.data.attributes[t];return e.isRecord&&!e.field&&!e.isFilteredRelation}).map(t=>new St(this.name,t,this.map))}get differentTableRecordAttributes(){return this.strictRecordAttributes.filter(t=>!(t.isMergedWithParent()||t.isLinkMergedWithParent()))}get reliance(){return Object.keys(this.data.attributes).filter(t=>this.data.attributes[t].isReliance).map(t=>new St(this.name,t,this.map))}get notRelianceCombined(){return this.combinedRecords.filter(t=>!t.isReliance)}get differentTableReliance(){return this.reliance.filter(t=>t.table!==this.table)}get sameTableReliance(){return this.reliance.filter(t=>t.table===this.table)}get valueAttributes(){return Object.entries(this.data.attributes).filter(([,t])=>!t.isRecord).map(([t])=>new St(this.name,t,this.map))}getAttributeInfo(t){return new St(this.name,t,this.map)}get baseRecordName(){return this.data.baseRecordName}get matchExpression(){return this.data.matchExpression}get filteredBy(){return this.data.filteredBy?.map(t=>new a(t,this.map))}get isFilteredEntity(){return this.data?.isFilteredEntity}get isFilteredRelation(){return this.data?.isFilteredRelation}get baseRelationName(){return this.data?.baseRelationName}get resolvedBaseRecordName(){return this.data?.resolvedBaseRecordName}get resolvedMatchExpression(){return this.data?.resolvedMatchExpression}};var Te=class a{constructor(t,e,r,i=!0){this.name=t;this.data=e;this.map=r;this.isFromSource=i}get isManyToOne(){return this.data.relType[0]==="n"&&this.data.relType[1]==="1"}get isManyToMany(){return this.data.relType[0]==="n"&&this.data.relType[1]==="n"}get isOneToOne(){return this.data.relType[0]==="1"&&this.data.relType[1]==="1"}get isOneToMany(){return this.data.relType[0]==="1"&&this.data.relType[1]==="n"}get isXToOne(){return this.isManyToOne||this.isOneToOne}get isOneToX(){return this.isOneToMany||this.isOneToOne}get isXToMany(){return this.isManyToMany||this.isOneToMany}get sourceRecord(){return this.data.sourceRecord}get sourceRecordInfo(){return new te(this.data.sourceRecord,this.map)}get targetRecordInfo(){return new te(this.data.targetRecord,this.map)}get targetRecord(){return this.data.targetRecord}get sourceProperty(){return this.data.sourceProperty}get targetProperty(){return this.data.targetProperty}get record(){return this.map.getRecord(this.name)}get recordInfo(){return this.map.getRecordInfo(this.name)}get table(){return this.record?.table}get isTargetReliance(){return this.data.isTargetReliance}isMerged(){return!!this.data.mergedTo}isSourceRelation(){return!!this.data.isSourceRelation}isMergedToSource(){return this.data.mergedTo==="source"}isMergedToTarget(){return this.data.mergedTo==="target"}isCombined(){return this.data.mergedTo==="combined"}isIsolated(){return!this.data.mergedTo}isSymmetric(){return this.data.sourceRecord===this.data.targetRecord&&this.data.sourceProperty===this.data.targetProperty}isRelationSource(t,e){return this.data.sourceRecord===t&&this.data.sourceProperty===e}getAttributeName(t,e){return R(!!t&&!!e,`${t}, ${e} cannot be empty`),this.isRelationSource(t,e)?["source","target"]:["target","source"]}isFilteredRelation(){return this.data.isFilteredRelation}getBaseLinkInfo(){R(this.isFilteredRelation(),"only filtered relation can get base link info");let t=this.data.baseLinkName;return new a(t,this.map.data.links[t],this.map)}getMatchExpression(){if(this.isFilteredRelation())return this.data.matchExpression;throw new Error(`${this.name} is not a filtered relation`)}getResolvedMatchExpression(){return R(this.isFilteredRelation(),"only filtered relation can get resolved match expression"),this.data.resolvedMatchExpression}getResolvedBaseRecordName(){return R(this.isFilteredRelation(),"only filtered relation can get resolved record name"),this.data.resolvedBaseRecordName}};var ua=class{constructor(t){this.data=t}getRecord(t){return this.data.records[t]}getAttributeAndSymmetricDirection(t){return t.includes(":")?t.split(":"):[t,void 0]}getAttributeData(t,e){return this.data.records[t].attributes[this.getAttributeAndSymmetricDirection(e)[0]]}getRecordInfo(t){return new te(t,this)}getInfo(t,e){let r=this.getInfoByPath([t,...e.split(".")]);return R(!!r,`cannot find attribute "${e}" in "${t}". attributes: ${this.data.records[t]&&Object.keys(this.data.records[t]?.attributes)}`),r}getLinkInfo(t,e){let r=this.getAttributeAndSymmetricDirection(e)[0],{linkName:i,isSource:n}=this.data.records[t].attributes[r];return R(!!i,`cannot find relation ${t} ${r}`),new Te(i,this.data.links[i],this,!!n)}getLinkInfoByName(t){return R(!!this.data.links[t],`cannot find link ${t}`),new Te(t,this.data.links[t],this)}getInfoByPath(t){let[e,...r]=t;R(this.data.records[e],`entity ${e} not found`),R(r.length>0,"getInfoByPath should have a name path.");let i=e,n,s,o,c,u,l=[];for(;c=r.shift();){l.push(c);let[d,h]=this.getAttributeAndSymmetricDirection(c);if(u=h,d===b)R(!!n&&!!s,`reading link in wrong path ${l.join(".")}`),n=this.data.records[n].attributes[s].linkName,s=void 0,i=o.linkName,o=void 0;else{let f=this.data.records[i];for(;f.isFilteredRelation||f.isFilteredEntity;)f.isFilteredRelation?f=this.data.records[f.baseRelationName]:f.isFilteredEntity&&(f=this.data.records[f.baseRecordName]);o=f.attributes[d],R(!!o,`attribute ${d} not found in ${i}. namePath: ${t.join(".")}`),n=i,i=o.isRecord?o.recordName:"",s=d}}if(!(!n||!s))return new St(n,s,this,u)}getTableAndAliasStack(t){let[e,...r]=t,i=this.data.records[e],n=i.table,s=e,o,c,u=!1,l,d=[{table:n,alias:s,record:i,isLinkRecord:u,path:[e]}];for(let h=0;h<r.length;h++){let[f,I]=this.getAttributeAndSymmetricDirection(r[h]),k=[e,...r.slice(0,h+1)];if(f===b){let{linkTable:E,linkAlias:N,path:X}=d.pop();R(!u,`last attribute in path is a link, cannot read link of a link ${X.join(".")}`),n=E,s=N,i=this.data.records[l.linkName],u=!0,o="",c="",l=void 0}else{l=this.getInfoByPath(k);let E=i.attributes[f];R(l.isRecord,`${r.slice(0,h+1).join(".")} is not a entity attribute`);let N=this.data.records[E.recordName],X=`${s}_${f}${I?`_${I.toUpperCase()}`:""}`;l.isMergedWithParent()||l.isLinkMergedWithParent()?c=s:l.isLinkIsolated()?c=`REL_${X}`:c=X,l.isMergedWithParent()||(s=X),n=l.table,i=N,o=l.getLinkInfo()?.table,u=!1}d.push({table:n,alias:s,record:i,isLinkRecord:u,linkTable:o,linkAlias:c,path:k})}return d}getTableAliasAndFieldName(t,e,r=!1){let i=this.getTableAndAliasStack(t),{table:n,alias:s,record:o,path:c,linkAlias:u,linkTable:l,isLinkRecord:d}=i.at(-1),h=!d&&i.length>1?this.getInfoByPath(c):null;if(!r&&e==="id"&&!d&&t.length>1&&(h?.isLinkMergedWithParent()||h?.isLinkIsolated()))if(h?.isLinkMergedWithParent()){let{alias:I,table:k}=i.at(-2);return[I,h.linkField,k]}else{let I=h.getLinkInfo().record,k=h?.isLinkManyToManySymmetric()?h?.symmetricDirection==="source"?I?.attributes.target.field:I?.attributes.source.field:h.isRecordSource()?I?.attributes.target.field:I?.attributes.source.field;return[u,k,l]}else{let I=o.attributes[this.getAttributeAndSymmetricDirection(e)[0]].field;return[s,I,n]}}findManyToManySymmetricPath(t){let e=[t[0]],r=!1;for(let i=1;i<t.length;i++){e.push(t[i]);let n=this.getInfoByPath(t.slice(0,i+1));if(n?.isRecord&&n.isLinkManyToManySymmetric()){r=!0;break}}return r?e:void 0}spawnManyToManySymmetricPath(t){let e=this.findManyToManySymmetricPath(t);if(!e)return;let r=e.slice(0,-1),i=e.at(-1),n=t.slice(e.length,1/0);return[[...r,`${i}:source`,...n],[...r,`${i}:target`,...n]]}getReverseAttribute(t,e){if(R(this.data.records[t],`entity ${t} not found`),this.data.records[t].isRelation){R(e==="source"||e==="target",`wrong attribute ${e} for relation ${t}`);let i=this.data.links[t];return e==="source"?`${i.sourceProperty}.&`:`${i.targetProperty}.&`}else{let i=this.data.records[t].attributes[e].linkName,n=this.data.links[i];return n.sourceRecord===t&&n.sourceProperty===e?n.targetProperty:n.targetRecord===t&&n.targetProperty===e?n.sourceProperty:(R(!1,`wrong relation data ${t}.${e}`),"")}}getReversePath(t){let r=new Array(t.length-1).fill(0).map((s,o)=>t.slice(0,o+2)).map(s=>this.getInfoByPath(s)).reverse();R(r[0]?.isRecord,`last attribute in path is not a record ${t.join(".")}`);let i=[r[0].recordName],n=!1;for(let s of r)n?(i.push(s.isRecordSource()?"source":"target"),n=!1):s?i.push(s.getReverseInfo().attributeName):n=!0;return i}groupAttributes(t,e){R(this.data.records[t],`entity ${t} not found`);let r=[],i=[],n=[];return e.forEach(s=>{if(this.data.records[t].attributes[s]){let o=this.getInfo(t,s);o.isValue?r.push(o):this.data.records[t].attributes[s].field?i.push(o):n.push(o)}}),[r,n,i]}getShrinkedAttribute(t,e){let r=e.split("."),i=[],n=t,s=t,o=0;for(;o<r.length;){let c=r[o];if(c===b&&o>0&&o<r.length-1){let u=i[i.length-1],l=r[o+1];if(l==="source"||l==="target"){let d=this.getInfo(s,u);if(d.isRecord){let h=d.getLinkInfo().data,f;d.isRecordSource()?f=h.targetRecord:f=h.sourceRecord;let I;if(l==="source"?I=h.sourceRecord:I=h.targetRecord,f===I){o+=2;continue}else{n=I,s=n,n="",s="",i.push(c),i.push(l),o+=2;continue}}}else n="",s="";i.push(c),o++}else if(c!==b){if(s=n,n){let u=this.getInfo(n,c);u.isRecord&&(n=u.recordName)}i.push(c),o++}else i.push(c),o++}return i.join(".")}};function Is(a){let t=new Map;for(let e of a)if(e.inputEntities)t.set(e.name,e.inputEntities.map(r=>r.name));else if(e.baseEntity){let r=t.get(e.baseEntity.name)||[];r.push(e.name),t.set(e.baseEntity.name,r)}return t}function xs(a){let t=new Map;for(let e of a){let r=e.name||`${e.source.name}_${e.sourceProperty}_${e.targetProperty}_${e.target.name}`;if(e.inputRelations){let i=e.inputRelations.map(n=>n.name);t.set(r,i)}else if(e.baseRelation){let i=e.baseRelation.name||`${e.baseRelation.source.name}_${e.baseRelation.sourceProperty}_${e.baseRelation.targetProperty}_${e.baseRelation.target.name}`,n=t.get(i)||[];n.push(r),t.set(i,n)}}return t}function sn(a,t){let e=new pe(a,t),r=Is(a),i=xs(t);return nn(a,e,r,"entity"),nn(t,e,i,"relation"),e.getAll()}function nn(a,t,e,r){let i=a.filter(n=>{let s=Pe(n);return s&&s.length>0});if(i.length!==0)for(let n of i)Rs(n,t,r,e)}function Rs(a,t,e,r){let i=e==="entity",s=`__${de(a)}_input_${e}`,o=i?t.getEntityByName(a.name):t.getRelationByName(a.name),[c,u]=Cs(o,s,r,t);t.replace(c,a),u!==c&&t.add(u);let l=Pe(a);if(l)for(let d of l)Es(d,u,s,t,i)}function Es(a,t,e,r,i){let[n,s]=Ss(a,t,e);if(!i&&n===a)return;let o=de(s),c=i?r.getEntityByName(o):r.getRelationByName(o);c&&r.replace(n,c)}function vs(a,t){let e=new Map,r=Pe(a);if(r&&r.length>0)for(let i of r){let n=de(i),s=[...t.get(n)||[]],o=e.get(n)||[];for(o.push(n),e.set(n,o);s.length;){let c=s.shift(),u=e.get(c)||[];u.push(...o),e.set(c,u);let l=t.get(c)||[];s.push(...l)}}return e}function ws(a,t,e){let r=vs(t,e);return x.create({name:a,type:"json",defaultValue:(i,n)=>{let s=Pe(t),c=(r.get(n)||[]).filter(u=>s.some(l=>de(l)===u));return c.length>0?c:[n]}})}function As(a,t,e){let r=Pe(a),i=[],n=new Map,s={};for(let o of r){let c=o;if(Ne(c))for(;c.baseEntity&&c.properties.length===0;)c=c.baseEntity;else if(Ds(c))for(;c.baseRelation&&c.properties.length===0;)c=c.baseRelation;let u=Object.fromEntries(c.properties.map(h=>[h.name,h]));n.set(o.name,u),Object.assign(s,u);let l=o.inputEntities||o.inputRelations,d=[...t.get(o.name)||[]];for(;d.length;){let h=d.shift();if(!l)n.set(h,u);else{let f=e.getEntityByName(h)||e.getRelationByName(h);if(!(f.inputEntities||f.inputRelations)){let k=Object.fromEntries(f.properties.map(E=>[E.name,E]));n.set(h,k),Object.assign(s,k)}}d.push(...t.get(h)||[])}}for(let o of Object.keys(s)){let c=x.clone(s[o],!0);c.defaultValue=(u,l)=>{let d=n.get(l)?.[o];if(d?.defaultValue)return d.defaultValue(u,l)},i.push(c)}return i}function Cs(a,t,e,r){let i=ws(t,a,e),n=[...As(a,e,r),i,...a.properties];if(Ne(a)){let s=r.getEntityByName(a.name),o=Q.create({name:s.name}),c;return s.inputEntities?.some(u=>u.baseEntity)?(c=Q.create({name:`${s.name}_base`,properties:n}),o.baseEntity=c,o.matchExpression=g.fromArray(s.inputEntities.map(u=>({key:t,value:["contains",u.name]})))):o.properties=n,[o,c||o]}else{let s=r.getRelationByName(a.name),o=q.create({name:s.name,source:s.source,sourceProperty:s.sourceProperty,target:s.target,targetProperty:s.targetProperty,type:s.type,isTargetReliance:s.isTargetReliance}),c;if(s.inputRelations?.some(u=>u.baseRelation)){let u=s.name||`${s.source.name}_${s.sourceProperty}_${s.targetProperty}_${s.target.name}`;c=q.create({name:`__${u}_base`,source:s.source,sourceProperty:`__${s.sourceProperty}_base`,target:s.target,targetProperty:`__${s.targetProperty}_base`,type:s.type,isTargetReliance:s.isTargetReliance,properties:n}),o.baseRelation=c,o.sourceProperty=s.sourceProperty,o.targetProperty=s.targetProperty,o.matchExpression=g.fromArray(s.inputRelations.map(l=>{let d=de(l);return{key:t,value:["contains",d]}}))}else o.properties=n;return[o,c||o]}}function Ss(a,t,e){if(Ne(a)){let r=a,i=t,n=r;if(r.baseEntity)for(;n.baseEntity;)n=n.baseEntity;let s=Q.clone(n,!0);return s.baseEntity=i,s.matchExpression=g.atom({key:e,value:["contains",r.name]}),[s,n]}else{let r=a,i=t,n=de(r);return r.baseRelation?[r,ks(r)]:[q.create({name:n,baseRelation:i,sourceProperty:r.sourceProperty,targetProperty:r.targetProperty,matchExpression:g.atom({key:e,value:["contains",n]})}),r]}}function ks(a){let t=a;for(;t.baseRelation;)t=t.baseRelation;return t}function Ne(a){return"inputEntities"in a||!("sourceProperty"in a)}function Ds(a){return"sourceProperty"in a}function Pe(a){return Ne(a)?a.inputEntities||[]:a.inputRelations||[]}function de(a){return Ne(a),a.name}var la=class{constructor(t,e,r,i=[]){this.entities=t;this.relations=e;this.database=r;this.mergeLinks=i;this.fieldNameMap=new Map;this.usedFieldNames=new Set;this.fieldCounter=1;this.recordToTableMap=new Map;this.tableToRecordsMap=new Map;this.mergeLog=[];this.tables={};this.map={links:{},records:{}};this.buildMap(),this.buildTables()}createRecordToTable(t,e){this.recordToTableMap.set(t,e),R(!this.tableToRecordsMap.get(e),`create table for ${t} ${e} failed, ${e} already exist.`),this.tableToRecordsMap.set(e,new Set([t]))}joinTables(t,e,r){R(t!==e,`join entity should not equal, ${e}`);let i=this.recordToTableMap.get(e),n=this.recordToTableMap.get(t),s=this.tableToRecordsMap.get(n);if(R(!!i&&!!n,`table not exists for ${e} ${i} to join ${t} ${n}`),i==n)return;let o=this.tableToRecordsMap.get(i),c=[];if(o.forEach(u=>{s.has(u)&&c.push(u)}),c.length)return this.mergeLog.push({joinTargetRecord:t,record:e,link:r,conflicts:c}),c;this.tableToRecordsMap.set(i,new Set),o.forEach(u=>this.recordToTableMap.set(u,n)),this.tableToRecordsMap.set(n,new Set(Array.from(s).concat(Array.from(o)))),this.mergeLog.push({joinTargetRecord:t,record:e,link:r})}combineRecordTable(t,e,r){let i,n=this.map.records[r].attributes.source.linkName;return i=this.joinTables(t,r,n),i||this.joinTables(t,e,r)}renameTableWithJoinedEntities(t){let e=Array.from(this.tableToRecordsMap.get(t));if(!e.length)return;let r=e.filter(n=>!this.map.records[n].isRelation),i=r.length?r.join("_"):t;this.tableToRecordsMap.delete(t),this.tableToRecordsMap.set(i,new Set(e)),e.forEach(n=>{this.recordToTableMap.set(n,i)})}resolveBaseSourceEntityAndFilter(t){let e=t,r=e.baseEntity,i=e.matchExpression;if(R(r&&i||!r&&!i,`matchExpression is required for ${e.name}`),!!(r&&i)){for(;r.baseEntity;)r=r.baseEntity,i=i.and(r.filter);return{baseEntity:r,matchExpression:i}}}validateFilteredEntityPaths(t,e){let r=g.extractPaths(e);for(let i of r)this.validateSinglePath(t,i)}validateSinglePath(t,e){let r=t;for(let i=0;i<e.length-1;i++){let n=e[i],s=this.map.records[r];if(!s)throw new Error(`Entity ${r} not found in map`);let o=s.attributes[n];if(!o||!o.isRecord)throw new Error(`Attribute ${n} is not a relation in entity ${r}`);let c=o.relType;if(c&&c[1]==="n")throw new Error(`Filtered entity '${this.currentFilteredEntityName}' contains an invalid path: '${e.join(".")}'. The relation '${r}.${n}' is a ${c[0]}:${c[1]} relation. Filtered entities do not support paths with 'x:n' relationships for performance reasons.`);r=o.recordName}}collectAllFilteredEntities(t){let e=[...this.entities,...this.relations].filter(i=>i.baseEntity===t||i.baseRelation===t),r=[...e];for(let i of e)r.push(...this.collectAllFilteredEntities(i));return r}createRecord(t,e){let r=Object.fromEntries(t.properties.map(n=>{let s=n;return[s.name,{name:s.name,type:s.type,computed:s.computed,collection:s.collection,defaultValue:s.defaultValue,fieldType:this.database.mapToDBFieldType(s.type,s.collection)}]}));e&&R(!r.source&&!r.target,"source and target is reserved name for relation attributes"),r[Yt]={name:Yt,type:"id",fieldType:this.database.mapToDBFieldType("pk")};let i=this.collectAllFilteredEntities(t);return i.length&&(r.__filtered_entities={name:"__filtered_entities",type:"json",fieldType:this.database.mapToDBFieldType("json")||"JSON",collection:!1,computed:void 0,defaultValue:()=>({})}),{table:t.name,attributes:r,isRelation:e,filteredBy:i.length?i.map(n=>n.name):void 0}}createFilteredEntityRecord(t){let e=this.collectAllFilteredEntities(t),{baseEntity:r,matchExpression:i}=t,{resolvedBaseRecordName:n,resolvedMatchExpression:s}=this.resolveRootBaseRecordNameAndMatchExpression(t),o=n;return n&&this.map.records[n]&&(o=this.map.records[n].table||n),{table:o,isFilteredEntity:!!r,attributes:{},baseRecordName:r?.name,matchExpression:i,resolvedBaseRecordName:n,resolvedMatchExpression:s,filteredBy:e.length?e.map(c=>c.name):void 0}}createFilteredRelationRecord(t){let e=Object.fromEntries(t.properties.map(c=>{let u=c;return[u.name,{name:u.name,type:u.type,computed:u.computed,collection:u.collection,defaultValue:u.defaultValue,fieldType:this.database.mapToDBFieldType(u.type,u.collection)}]}));R(!e.source&&!e.target,"source and target is reserved name for relation attributes");let r=this.collectAllFilteredEntities(t),{matchExpression:i,baseRelation:n}=t,{resolvedBaseRecordName:s,resolvedMatchExpression:o}=this.resolveRootBaseRecordNameAndMatchExpression(t);return{table:s,attributes:e,baseRecordName:n.name,matchExpression:i,resolvedBaseRecordName:s,resolvedMatchExpression:o,filteredBy:r.length?r.map(c=>c.name):void 0,isFilteredRelation:!0,baseRelationName:n.name}}resolveRootBaseRecordNameAndMatchExpression(t){let{baseEntity:e,baseRelation:r,matchExpression:i}=t,n,s,o=e||r,u=[i||t.matchExpression];for(;o.baseEntity||o.baseRelation;){let l=o.baseEntity||o.baseRelation,d=o.matchExpression;d&&u.push(d),o=l}if(n=o.name,u.length>0){s=u[0];for(let l=1;l<u.length;l++)s=s.and(u[l])}return{resolvedBaseRecordName:n,resolvedMatchExpression:s}}createLink(t,e){return{table:t,relType:e.type.split(":"),sourceRecord:e.source.name,sourceProperty:e.sourceProperty,targetRecord:e.target.name,targetProperty:e.targetProperty,recordName:t,isTargetReliance:e.isTargetReliance,matchExpression:e.matchExpression}}createFilteredLink(t,e){let{resolvedBaseRecordName:r,resolvedMatchExpression:i}=this.resolveRootBaseRecordNameAndMatchExpression(e);return{table:t,relType:e.type.split(":"),sourceRecord:e.source.name,sourceProperty:e.sourceProperty,targetRecord:e.target.name,targetProperty:e.targetProperty,recordName:t,isTargetReliance:e.isTargetReliance,isFilteredRelation:!!e.baseRelation,matchExpression:e.matchExpression,baseLinkName:e.baseRelation?.name,resolvedBaseRecordName:r,resolvedMatchExpression:i}}createLinkOfRelationAndEntity(t,e,r,i){let n=r,[s,o]=n.type.split(":");return{table:void 0,attributes:{},sourceRecord:t,sourceProperty:i?"source":"target",targetRecord:i?n.source.name:n.target.name,targetProperty:void 0,relType:[i?o:s,"1"],isSourceRelation:!0,mergedTo:"combined"}}getRelationNameOfRelationAndEntity(t,e){return`${t}_${e?"source":"target"}`}buildMap(){this.processMergedItems(),this.entities.forEach(t=>{R(!this.map.records[t.name],`entity name ${t.name} is duplicated`),this.map.records[t.name]=t.baseEntity?this.createFilteredEntityRecord(t):this.createRecord(t),t.baseEntity||this.createRecordToTable(t.name,this.map.records[t.name].table)}),this.relations.forEach(t=>{let e=t.source.name,r=t.target.name,i=t.name||`${e}_${t.sourceProperty}_${t.targetProperty}_${r}`;R(!this.map.records[i],`relation name ${i} is duplicated`),this.map.records[i]=t.baseRelation?this.createFilteredRelationRecord(t):this.createRecord(t,!0),this.map.links[i]=t.baseRelation?this.createFilteredLink(i,t):this.createLink(i,t);let n=this.getRelationNameOfRelationAndEntity(i,!0);this.map.links[n]=this.createLinkOfRelationAndEntity(i,n,t,!0);let s=this.getRelationNameOfRelationAndEntity(i,!1);this.map.links[s]=this.createLinkOfRelationAndEntity(i,s,t,!1),t.baseRelation||this.createRecordToTable(i,this.map.records[i].table)}),Object.entries(this.map.links).forEach(([t,e])=>{R(!e.isSourceRelation||e.sourceProperty==="source"||e.sourceProperty==="target","virtual relation sourceProperty should only be source/target");let r=this.map.records[t],i=r&&!!r.baseRelationName,n=i?this.map.links[r.baseRelationName]:void 0;this.map.records[e.sourceRecord].attributes[e.sourceProperty]={type:"id",isRecord:!0,relType:e.relType,recordName:e.targetRecord,linkName:t,attributeName:e.sourceProperty,isSource:!0,isReliance:e.isTargetReliance,isFilteredRelation:i,matchExpression:i?e.matchExpression:void 0,baseRelationAttributeName:i?n?.sourceProperty:void 0,resolvedMatchExpression:i?r.resolvedMatchExpression:void 0,resolvedBaseRecordName:i?r?.resolvedBaseRecordName:void 0},R(!(e.isSourceRelation&&e.targetProperty),"virtual relation should not have targetProperty"),e.targetProperty&&(this.map.records[e.targetRecord].attributes[e.targetProperty]={type:"id",isRecord:!0,relType:[e.relType[1],e.relType[0]],recordName:e.sourceRecord,linkName:t,attributeName:e.targetProperty,isSource:!1,isFilteredRelation:i,matchExpression:i?e.matchExpression:void 0,baseRelationAttributeName:i?n?.targetProperty:void 0})}),this.entities.forEach(t=>{let e=t;e.baseEntity&&e.matchExpression&&(this.currentFilteredEntityName=e.name,this.validateFilteredEntityPaths(e.baseEntity.name,e.matchExpression))}),this.mergeRecords(),this.assignTableAndField()}processMergedItems(){let t=sn(this.entities,this.relations);this.entities=t.entities,this.relations=t.relations}mergeRecords(){let t=Object.fromEntries(Object.entries(this.map.links).filter(([,i])=>!i.isSourceRelation&&i.relType[0]==="1"&&i.relType[1]==="1"&&i.isTargetReliance)),e=Object.fromEntries(Object.entries(this.map.links).filter(([,i])=>!i.isSourceRelation&&!i.isTargetReliance&&(i.relType[0]==="1"&&i.relType[1]==="1"||i.relType[0]==="n"&&i.relType[1]==="1"||i.relType[0]==="1"&&i.relType[1]==="n"))),r=[];this.mergeLinks.forEach(i=>{let[n,...s]=i.split("."),o=n;for(let c=0;c<s.length;c++){let u=s[c],l=this.map.records[o].attributes[u],d=l.linkName,h=this.map.links[d],{relType:f,sourceRecord:I,targetRecord:k}=h;R(f[0]==="1"&&f[1]==="1"&&I!==k,`only 1:1 can merge: ${n}.${s.slice(0,c+1).join(".")}`);let E=I===o?k:I,N=this.combineRecordTable(o,E,d);if(N)throw new Error(`conflict found when join ${d}, ${N.join(",")} already merged with ${o}`);h.mergedTo="combined",r.push(h),o=l.recordName,delete t[d],delete e[d]}}),Object.values(t).forEach(i=>{if(i.isFilteredRelation)return;let{sourceRecord:n,targetRecord:s,recordName:o}=i,c=this.combineRecordTable(n,s,o);if(!c)i.mergedTo="combined",r.push(i);else{let u=this.map.records[o].attributes.source.linkName;this.joinTables(n,o,u)||(this.mergeLog.push(c),i.mergedTo="source",r.push(i))}}),Object.values(e).forEach(i=>{if(i.isFilteredRelation)return;let{relType:n,sourceRecord:s,targetRecord:o,recordName:c}=i,u=n[1]!=="n",l=u?s:o,d=this.map.records[c].attributes[u?"source":"target"].linkName;this.joinTables(l,c,d)||(i.mergedTo=u?"source":"target",r.push(i))}),Object.values(this.map.links).forEach(i=>{i.isFilteredRelation||i.isSourceRelation&&(i.mergedTo="source")}),r.forEach(i=>{if(i.mergedTo==="combined"||i.mergedTo==="source"){let n=this.map.records[i.recordName].attributes.source.linkName;this.map.links[n].mergedTo="combined"}if(i.mergedTo==="combined"||i.mergedTo==="target"){let n=this.map.records[i.recordName].attributes.target.linkName;this.map.links[n].mergedTo="combined"}})}assignTableAndField(){let t=Array.from(this.tableToRecordsMap.keys());for(let e of t)this.renameTableWithJoinedEntities(e);Object.entries(this.map.records).forEach(([e,r])=>{!r.isFilteredEntity&&!r.isFilteredRelation&&(r.table=this.recordToTableMap.get(e)),Object.entries(r.attributes).forEach(([i,n])=>{if(n.isRecord)return;let s=n;s.field=this.generateShortFieldName(`${e}_${i}`),s.fieldType=this.database.mapToDBFieldType(s.type,s.collection)})}),Object.entries(this.map.links).forEach(([e,r])=>{r.isSourceRelation||(r.table=this.recordToTableMap.get(e))}),Object.entries(this.map.records).forEach(([e,r])=>{if(!r.isRelation)return;let i=this.map.links[e],n=r.attributes.source,s=r.attributes.target;i.mergedTo?i.mergedTo==="source"?(s.field=this.generateShortFieldName(`${i.sourceRecord}_${i.sourceProperty}`),s.fieldType=this.database.mapToDBFieldType(s.type,!1)):i.mergedTo==="target"&&(n.field=this.generateShortFieldName(`${i.targetRecord}_${i.targetProperty}`),n.fieldType=this.database.mapToDBFieldType(n.type,!1)):(n.field=this.generateShortFieldName(`${e}_source`),n.fieldType=this.database.mapToDBFieldType(n.type,!1),s.field=this.generateShortFieldName(`${e}_target`),s.fieldType=this.database.mapToDBFieldType(s.type,!1))})}buildTables(){Object.entries(this.map.records).forEach(([t,e])=>{this.tables[e.table]||(this.tables[e.table]={columns:{[Pt]:{name:Pt,type:"pk",fieldType:this.database.mapToDBFieldType("pk")}}}),Object.entries(e.attributes).forEach(([r,i])=>{if(!i.field||this.tables[e.table].columns[i.field])return;if(!i.fieldType)throw new Error(`fieldType not found for ${i.field} ${i.type}`);let n=i;this.tables[e.table].columns[n.field]={name:n.field,type:n.type,fieldType:n.fieldType,defaultValue:n.defaultValue,attribute:n}})})}createTableSQL(){return Object.keys(this.tables).map(t=>`
CREATE TABLE "${t}" (
${Object.values(this.tables[t].columns).map(r=>`    "${r.name}" ${r.fieldType}`).join(",")}
)
`)}createTables(){return Promise.all(this.createTableSQL().map(t=>this.database.scheme(t)))}generateShortFieldName(t){if(this.fieldNameMap.has(t))return this.fieldNameMap.get(t);let e=t.split("_"),r="";e.length>=2?r=e.slice(0,2).map(n=>n.substring(0,3).toLowerCase()).join("_"):r=t.substring(0,6).toLowerCase();let i=`${r}_${this.fieldCounter}`;return this.fieldCounter++,this.fieldNameMap.set(t,i),this.usedFieldNames.add(i),i}};var it=class a extends Error{constructor(t,e={}){super(`${t}. Caused by: ${e.causedBy?.message}`),this.name=this.constructor.name,this.timestamp=new Date,this.errorId=this.generateErrorId(),this.errorType=e.errorType||this.constructor.name,this.context=e.context||{},this.causedBy=e.causedBy,this.stackTrace=this.stack,Object.setPrototypeOf(this,new.target.prototype)}generateErrorId(){return`${this.constructor.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getErrorChain(){let t=[this],e=this.causedBy;for(;e&&(t.push(e),e instanceof a);)e=e.causedBy;return t}getDetailedMessage(){let t=`[${this.errorType}] ${this.message}`;return Object.keys(this.context).length>0&&(t+=`
Context: ${JSON.stringify(this.context,null,2)}`),this.causedBy&&(t+=`
Caused by: ${this.causedBy.message}`),t}toJSON(){return{name:this.name,message:this.message,errorType:this.errorType,errorId:this.errorId,timestamp:this.timestamp.toISOString(),context:this.context,causedBy:this.causedBy?{name:this.causedBy.name,message:this.causedBy.message,stack:this.causedBy.stack}:void 0,stack:this.stackTrace,formattedError:this.getFormattedError()}}getFormattedError(){let t=this.getErrorChain(),e=`[${this.errorType}] ${this.message}`,r=["entityName","propertyName","interactionName","computationName","handleName","depName"].filter(n=>this.context[n]).map(n=>`${n}: ${this.context[n]}`).join(", ");if(r&&(e+=` (${r})`),t.length>1){e+=`

Caused by:`;for(let n=1;n<t.length;n++){let s=t[n];e+=`
  ${"  ".repeat(n-1)}\u2192 ${s.constructor.name}: ${s.message}`}}let i=t[t.length-1];return i.stack&&(e+=`

Stack trace:`,i.stack.split(`
`).slice(0,6).forEach(s=>{e+=`
  `+s}),i.stack.split(`
`).length>6&&(e+=`
  ... (truncated)`)),e}toString(){return this.getFormattedError()}[Symbol.toStringTag](){return JSON.stringify(this.toJSON(),null,2)}[Symbol.for("nodejs.util.inspect.custom")](){return this.getFormattedError()}valueOf(){return this.getFormattedError()}static isType(t,e){return t instanceof e}findInChain(t){let e=this.getErrorChain();for(let r of e)if(r instanceof t)return r;return null}};var xt=class extends it{constructor(t,e={}){super(t,{errorType:e.context?.errorType||"InteractionExecutionError",context:{category:"interaction",interactionName:e.interactionName,userId:e.userId,payload:e.payload,executionPhase:e.executionPhase,...e.context},causedBy:e.causedBy}),this.interactionName=e.interactionName,this.userId=e.userId,this.payload=e.payload,this.executionPhase=e.executionPhase,this.severity=e.severity||"high"}};var fe=class extends it{constructor(t,e={}){super(t,{errorType:e.context?.errorType||"ActivityError",context:{category:"activity",activityName:e.activityName,activityId:e.activityId,activityInstanceId:e.activityInstanceId,currentState:e.currentState,...e.context},causedBy:e.causedBy}),this.activityName=e.activityName,this.activityId=e.activityId,this.activityInstanceId=e.activityInstanceId,this.currentState=e.currentState,this.severity=e.severity||"medium"}};var K=class extends it{constructor(t,e={}){super(t,{errorType:e.context?.errorType||"ComputationError",context:{category:"computation",handleName:e.handleName,computationName:e.computationName,dataContext:e.dataContext,computationPhase:e.computationPhase,...e.context},causedBy:e.causedBy}),this.handleName=e.handleName,this.computationName=e.computationName,this.dataContext=e.dataContext,this.computationPhase=e.computationPhase,this.severity=e.severity||"medium"}},me=class extends K{constructor(t,e={}){super(t,{...e,severity:"high",context:{errorType:"ComputationStateError",stateKey:e.stateKey,stateValue:e.stateValue,expectedStateType:e.expectedStateType,actualStateType:e.actualStateType}}),this.stateKey=e.stateKey,this.stateValue=e.stateValue,this.expectedStateType=e.expectedStateType,this.actualStateType=e.actualStateType}},Rt=class extends K{constructor(t,e={}){super(t,{...e,severity:"medium",context:{errorType:"ComputationDataDepError",depName:e.depName,depType:e.depType,missingData:e.missingData,invalidData:e.invalidData}}),this.depName=e.depName,this.depType=e.depType,this.missingData=e.missingData,this.invalidData=e.invalidData}};var Et=class extends it{constructor(t,e={}){super(t,{errorType:e.context?.errorType||"SchedulerError",context:{category:"system",schedulingPhase:e.schedulingPhase,failedComputations:e.failedComputations,...e.context},causedBy:e.causedBy}),this.schedulingPhase=e.schedulingPhase,this.failedComputations=e.failedComputations,this.severity="high"}};var tt=class a extends it{constructor(t,e){super(t,{errorType:e.context?.errorType||"ConditionError",context:{category:"permission",checkType:e.checkType,fieldName:e.fieldName,payload:e.payload,evaluationError:e.evaluationError,...e.context},causedBy:e.causedBy}),this.checkType=e.checkType,this.fieldName=e.fieldName,this.payload=e.payload,this.evaluationError=e.evaluationError,this.error=e.evaluationError,this.type=e.type||t,this.severity=e.severity||"high"}static userCheckFailed(t,e){return new a("User check failed",{checkType:"user",evaluationError:t,severity:"high",context:e,type:"check user failed"})}static payloadValidationFailed(t,e,r,i){let n=`${t} ${e}`;return new a(`Payload validation failed for field '${t}': ${e}`,{checkType:"payload",fieldName:t,payload:r,evaluationError:i,severity:"medium",type:n})}static conditionCheckFailed(t,e){return new a("Condition check failed",{checkType:"condition",evaluationError:t,severity:"high",context:e,type:"condition check failed"})}static attributiveCheckFailed(t,e,r,i){let n=`${t} ${e}`;return new a(`Attributive check failed for field '${t}': ${e}`,{checkType:"attributive",fieldName:t,payload:r,evaluationError:i,severity:"medium",type:n})}static conceptCheckFailed(t,e){return new a(`Concept check failed for field '${t}'`,{checkType:"concept",fieldName:t,evaluationError:e,severity:"medium",type:`${t} check concept failed`})}};var ye=class{constructor(t,e,r){this.interaction=t;this.controller=e;this.activitySeqCall=r;this.system=e.system}async checkAttributive(t,e,r){let i=t;if(i.content){let n=i.content,s;try{s=await n.call(this.controller,r,e)}catch{s=!1}return s===void 0?(console.warn(`attributive ${i.name} returned undefined, maybe not implemented, we will return true for now`),!0):s}else console.warn(`${i.name} not implemented`);return!0}async checkMixedAttributive(t,e){return Promise.resolve(!0)}createHandleAttributive(t,e,r){return i=>this.checkAttributive(i,e,r)}async checkUser(t,e,r){let i;if(!this.interaction.userAttributives)return!0;let n=De.is(this.interaction.userAttributives)?L.fromValue(this.interaction.userAttributives.content):L.atom(this.interaction.userAttributives),s=o=>o.isRef?r(o,t.user,e):this.checkAttributive(o,t,t.user);if(i=await this.checkAttributives(n,s,[]),i===!0)return i;throw tt.userCheckFailed(i)}async checkConcept(t,e,r,i=[]){let n=i.concat({type:"concept",values:{attributives:r,concept:e}}),s=await this.isConcept(t,e,n);if(s!==!0)return s;if(r){let o=u=>this.checkMixedAttributive(u,t),c=await this.checkAttributives(L.fromValue(r),o,n);if(c!==!0)return c}return!0}async isConcept(t,e,r=[]){let i=r.concat({type:"isConcept",values:{concept:e}});if(this.isDerivedConcept(e)){let n=e;return n.attributive?this.checkConcept(t,n.base,n.attributive,i):this.isConcept(t,n.base,i)}if(this.isConceptAlias(e)){let n=[];return await ar(e.for,async o=>{let c=await this.isConcept(t,o);return c===!0?!0:(n.push(c),!1)})?!0:{name:e.name,type:"conceptAlias",stack:i,error:n}}else{if(gt.is(e))return await this.checkAttributive(e,void 0,t)?!0:{name:e.name,type:"conceptCheck",stack:i,error:"role check error"};let n=e.constructor?.check;return n?n(t)?!0:{name:e.name,type:"conceptCheck",stack:i,error:"constructor check error"}:e.constructor&&typeof e.constructor.check=="function"?e.constructor.check(t)?!0:{name:e.name||"",type:"conceptCheck",stack:i,error:"constructor check error"}:Q.is(e)?t&&typeof t=="object"&&"id"in t||t&&typeof t=="object"?!0:{name:e.name||"",type:"conceptCheck",stack:i,error:"invalid entity data"}:t&&typeof t=="object"?!0:typeof e=="function"?t instanceof e?!0:{name:e.name,type:"conceptCheck",stack:i,error:"instanceof check error"}:(console.warn(`unknown concept ${e}, cannot check ${t}. pass.`),!0)}}isDerivedConcept(t){return!!t.base}isConceptAlias(t){return!!t.for}async checkAttributives(t,e,r=[]){let i=await t.evaluateAsync(e);return i===!0?!0:{name:"",type:"matchAttributives",stack:r,error:i}}async checkPayload(t){let e=this.interaction.payload?.items||[],r=Object.keys(t.payload||{});for(let i of r)if(!e.some(n=>n.name===i))throw new Error(`${i} in payload is not defined in interaction ${this.interaction.name}`);for(let i of e){let n=t.payload[i.name];if(i.required&&!n)throw tt.payloadValidationFailed(i.name,"missing",t.payload);if(!n)return;if(i.isCollection&&!Array.isArray(n))throw tt.payloadValidationFailed(i.name,"data is not array",n);if(i.isCollection){if(i.isRef&&!n.every(o=>!!o.id))throw tt.payloadValidationFailed(i.name,"data not every is ref",n)}else if(i.isRef&&!n.id)throw tt.payloadValidationFailed(i.name,"data is not a ref",n);if(i.base)if(i.isCollection){let o=await ra(n,c=>this.checkConcept(c,i.base));if(o!==!0)throw tt.conceptCheckFailed(i.name,o)}else{let o=await this.checkConcept(n,i.base);if(o!==!0)throw tt.conceptCheckFailed(i.name,o)}let s=n;if(i.isRef){let o=i.isCollection?g.atom({key:"id",value:["in",n.map(c=>c.id)]}):g.atom({key:"id",value:["=",n.id]});s=i.isCollection?await this.system.storage.find(i.base.name,o,void 0,["*"]):await this.system.storage.findOne(i.base.name,o,void 0,["*"])}if(i.attributives){let o=De.is(i.attributives)?new L(i.attributives.content):L.atom(i.attributives);if(i.isCollection){let c=await ra(s,u=>{let l=this.createHandleAttributive(gt,t,u);return this.checkAttributives(o,l)});if(c!==!0)throw tt.attributiveCheckFailed(i.name,"not every item match attribute",s,c)}else{let c=this.createHandleAttributive(gt,t,s),u=await this.checkAttributives(o,c);if(u!==!0)throw tt.attributiveCheckFailed(i.name,"not match attributive",s,u)}}}}async checkCondition(t){if(this.interaction.conditions){let e=ue.is(this.interaction.conditions)?new L(this.interaction.conditions.content):L.atom(this.interaction.conditions),r=async n=>{if(!n)return!0;if(n.content){let s=n.content,o;try{o=await s.call(this.controller,t)}catch(c){console.warn("check function throw",c),o=!1}return o===void 0?(console.warn(`condition ${n.name} returned undefined, maybe not implemented, we will return true for now`),!0):o}else console.warn(`${n.name} not implemented`);return!0},i=await e.evaluateAsync(r);if(i!==!0)throw tt.conditionCheckFailed(i)}}async runEffects(t,e,r){let n=(this.interaction.sideEffects||[]).map(o=>(async()=>{let c,u;try{c=await o.handle.call(this.controller,t,e)}catch(l){u=l}return[o.name,{result:c,error:u}]})()),s=await Promise.all(n);for(let[o,{result:c,error:u}]of s)T(!r.sideEffects[o],`sideEffect ${o} already exists`),r.sideEffects[o]={result:c,error:u}}isGetInteraction(){return this.interaction.action===Zi}async saveEvent(t,e){return await this.controller.activityManager.saveEvent(t,e)}async retrieveData(t){let e;if(Q.is(this.interaction.data)||q.is(this.interaction.data)){let r=this.interaction.data.name,{modifier:i,attributeQuery:n}=Object.fromEntries(this.interaction.query?.items?.map(c=>[c.name,c.value])||[]),s={...t.query?.modifier||{},...i||{}},o=t.query?.attributeQuery||[];e=await this.system.storage.find(r,t.query?.match,s,o)}else T(!1,`unknown data type ${this.interaction.data}`);return e}async check(t,e,r,i){let n;try{this.controller.ignorePermission||await this.checkCondition(t),await this.checkUser(t,e,r),await this.checkPayload(t)}catch(s){n=s}return n}async call(t,e,r,i){let n={sideEffects:{},effects:[]};if(n.error=await this.check(t,e,r,i),!n.error){let s={interactionName:this.interaction.name,interactionId:this.interaction.uuid,user:t.user,query:t.query||{},payload:t.payload||{},args:t,activity:{id:e}};await this.saveEvent(s,n.effects),n.event=s,await this.runEffects(t,e,n),this.isGetInteraction()&&(n.data=await this.retrieveData(t))}return n}};var ge=class a{constructor(t,e){this.graph=t;this.parent=e}static createInitialState(t){return{current:nt.createInitialState(t)}}static create(t,e,r){let i=new a(e,r);return t.current&&(i.current=nt.create(t.current,e,i)),i}isInteractionAvailable(t){return this.current?this.current?.children?Object.values(this.current.children).some(e=>e.isInteractionAvailable(t)):this.current.node.uuid===t:!1}findStateNode(t){if(this.current)return this.current?.node.uuid===t?this.current:this.current.children?.find(e=>e.findStateNode(t))?.current}transferToNext(t){let e=this.graph.getNodeByUUID(t);if(delete this.current,e.next){let r=nt.createInitialState(e.next);this.current=nt.create(r,this.graph,this)}this.parent?.onChange(t,e.next?.uuid)}toJSON(){return{current:this.current?.toJSON()}}},nt=class a{constructor(t,e,r){this.node=t;this.graph=e;this.parent=r}static{this.GroupStateNodeType=new Map}static createInitialState(t){let e={uuid:t.uuid};return ie.is(t.content)&&(e.children=t.childSeqs.map(r=>ge.createInitialState(r.head))),e}static create(t,e,r){let i=e.getNodeByUUID(t.uuid);if(ie.is(i.content)){let s=a.GroupStateNodeType.get(i.content.type),o=new s(i,e,r);return o.isGroup=!0,o.children=t?.children?.map(c=>ge.create(c,e,o)),o}else return new a(i,e,r)}toJSON(){return{uuid:this.node.uuid,children:this.children?.map(t=>t.toJSON())}}onChange(t,e){}isGroupCompleted(){return this.children?.every(t=>!t.current)}complete(){this.parent.transferToNext(this.node.uuid)}},pa=class{constructor(t,e){this.graph=e;this.root=ge.create(t,this.graph)}static createInitialState(t){return ge.createInitialState(t)}isInteractionAvailable(t){return this.root.isInteractionAvailable(t)}completeInteraction(t){return this.root.findStateNode(t).complete(),!0}toJSON(){return this.root.toJSON()}},da=class a{constructor(t,e){this.activity=t;this.controller=e;this.uuidToNode=new Map;this.uuidToInteractionCall=new Map;this.interactionCallByName=new Map;this.rawToNode=new Map;this.checkUserRef=async(t,e,r)=>(T(t.isRef,"attributive must be ref"),((await this.getActivity(r))?.refs)[t.name]===e.id);this.system=e.system,this.graph=this.buildGraph(t)}static{this.cache=new Map}static{this.from=(t,e)=>{let r=a.cache.get(t);return r||(r=new a(t,e),a.cache.set(t,r)),r}}buildGraph(t,e){let r=new Map,i={};for(let o of t.interactions){let c={content:o,next:null,uuid:o.uuid,parentGroup:e,parentSeq:i};this.uuidToNode.set(o.uuid,c),this.rawToNode.set(o,c);let u=new ye(o,this.controller,this);this.uuidToInteractionCall.set(o.uuid,u),o.name&&this.interactionCallByName.set(o.name,u)}for(let o of t.gateways){let c={content:o,next:[],prev:[],uuid:o.uuid};this.uuidToNode.set(o.uuid,c),this.rawToNode.set(o,c)}for(let o of t.groups){let c={uuid:o.uuid,content:o,next:null,parentSeq:i,parentGroup:e};c.childSeqs=o.activities?.map(u=>this.buildGraph(u,c)),this.uuidToNode.set(o.uuid,c),this.rawToNode.set(o,c)}let n=new Set([...Object.values(t.interactions),...Object.values(t.groups)]),s=new Set([...Object.values(t.interactions),...Object.values(t.groups)]);if(t.transfers?.forEach(o=>{let c=this.rawToNode.get(o.source)||r.get(o.source),u=this.rawToNode.get(o.target)||r.get(o.target);T(!!c,`cannot find source ${o.source.name}`),T(!!u,`cannot find target ${o.source.name}`),Gt.is(c)?c.next.push(u):c.next=u,Gt.is(u)?u.prev.push(c):u.prev=c,s.delete(o.source),n.delete(o.target)}),n.size!==1)throw new Error(`start node must one, current: ${n.size}`);if(s.size!==1)throw new Error(`end node must be one, current: ${s.size}`);return Object.assign(i,{head:this.rawToNode.get([...n.values()][0]),tail:this.rawToNode.get([...s.values()][0])}),i}async create(){let t=pa.createInitialState(this.graph.head);return{activityId:(await this.controller.activityManager.createActivity({name:this.activity.name,uuid:this.activity.uuid,state:t,refs:{}})).id,state:t}}getNodeByUUID(t){return this.uuidToNode.get(t)}async getState(t){return(await this.getActivity(t))?.state}async getActivity(t){let e=g.atom({key:"id",value:["=",t]});return(await this.controller.activityManager.getActivity(e))[0]}async setActivity(t,e){let r=g.atom({key:"id",value:["=",t]});return await this.controller.activityManager.updateActivity(r,e)}async setState(t,e){let r=g.atom({key:"id",value:["=",t]});return await this.controller.activityManager.updateActivity(r,{state:e})}isStartNode(t){let e=this.uuidToNode.get(t);return e.parentSeq.head===e}isEndNode(t){let e=this.uuidToNode.get(t);return e.parentSeq.tail===e}isActivityHead(t,e=this.graph.head){return ie.is(this.graph.head.content)?!!this.graph.head.childSeqs?.some(r=>this.isActivityHead(t,r.head)):t===this.graph.head.content}async callInteraction(t,e,r){let i=this.uuidToInteractionCall.get(e),n=t;if(this.isActivityHead(i.interaction)){if(!n){let l=await i.check(r,t,this.checkUserRef);if(l)return{error:l};n=(await this.create()).activityId}}else if(!t)return{error:"activityId must be provided for non-head interaction of an activity"};let s=new pa(await this.getState(n),this);if(!s.isInteractionAvailable(e))return{error:`interaction ${e} not available`};let o=await i.call(r,n,this.checkUserRef);if(o.error)return o;await this.saveUserRefs(n,i,r);let c=s.completeInteraction(e);T(c,"change activity state failed");let u=s.toJSON();return await this.setActivity(n,{state:u}),{...o,context:{activityId:n,nextState:u}}}async saveUserRefs(t,e,r){let i=(await this.getActivity(t))?.refs||{};e.interaction.userRef?.name&&(i[e.interaction.userRef?.name]=r.user.id),e.interaction.payload?.items.forEach(n=>{if(gt.is(n.itemRef)&&n.itemRef?.name&&r.payload[n.name]){let s=r.payload[n.name];n.isCollection?(i[n.itemRef.name]||(i[n.itemRef.name]=[]),i[n.itemRef.name].push(s.id)):i[n.itemRef.name]=s.id}}),await this.setActivity(t,{refs:i})}},sr=class extends nt{onChange(t,e){if(this.graph.isStartNode(t)){if(e)return{children:this.children.filter(r=>r.current?.node.uuid===e)};this.complete()}}};nt.GroupStateNodeType.set("any",sr);var or=class extends nt{onChange(t,e){this.isGroupCompleted()&&this.complete()}};nt.GroupStateNodeType.set("every",or);var cr=class extends nt{onChange(t,e){this.graph.isEndNode(t)&&this.complete()}};nt.GroupStateNodeType.set("race",cr);var ur=class extends nt{};nt.GroupStateNodeType.set("program",ur);import{AsyncLocalStorage as Ts}from"async_hooks";var st=new Ts;var ft="_Interaction_",ha="_Activity_",Mt=Q.create({name:ft,properties:[x.create({name:"interactionId",type:"string",collection:!1}),x.create({name:"interactionName",type:"string",collection:!1}),x.create({name:"payload",type:"object",collection:!1}),x.create({name:"user",type:"object",collection:!1}),x.create({name:"query",type:"object",collection:!1})]}),on=Q.create({name:ha,properties:[x.create({name:"name",type:"string",collection:!1}),x.create({name:"uuid",type:"string",collection:!1}),x.create({name:"state",type:"object",collection:!1}),x.create({name:"refs",type:"object",collection:!1})]}),Ns=q.create({name:"activityInteraction",source:on,sourceProperty:"interaction",target:Mt,targetProperty:"activity",type:"1:n"}),fa=class{constructor(t,e,r){this.controller=t;this.activityCalls=new Map;this.activityCallsByName=new Map;this.interactionCallsByName=new Map;this.interactionCalls=new Map;this.controller.entities.push(on,Mt),this.controller.relations.push(Ns),e.forEach(i=>{let n=new da(i,t);this.activityCalls.set(i.uuid,n),i.name&&(T(!this.activityCallsByName.has(i.name),`activity name ${i.name} is duplicated`),this.activityCallsByName.set(i.name,n))}),r.forEach(i=>{let n=new ye(i,t);this.interactionCalls.set(i.uuid,n),i.name&&(T(!this.interactionCallsByName.has(i.name),`interaction name ${i.name} is duplicated`),this.interactionCallsByName.set(i.name,n))})}async callInteraction(t,e){let r=st.getStore(),i=this.controller.system.logger.child(r?.logContext||{});try{let n=this.interactionCallsByName.get(t);if(!n)throw new xt(`Cannot find interaction for ${t}`,{interactionName:t,userId:e.user?.id,payload:e.payload,executionPhase:"interaction-lookup"});i.info({label:"interaction",message:n.interaction.name}),await this.controller.system.storage.beginTransaction(n.interaction.name);let s,o;try{o=await n.call(e)}catch(c){s=c,o={error:new xt("Interaction execution failed",{interactionName:t,userId:e.user?.id,payload:e.payload,executionPhase:"interaction-execution",causedBy:c instanceof Error?c:new Error(String(c))}),effects:[],sideEffects:{},data:void 0,event:void 0}}finally{s||o.error?(s&&(console.error(s),i.error({label:"systemError",message:"unknownError",error:s})),i.error({label:"interaction",message:n.interaction.name,error:o.error}),await this.controller.system.storage.rollbackTransaction(n.interaction.name)):(await this.controller.system.storage.commitTransaction(n.interaction.name),await this.runRecordChangeSideEffects(o,i))}return o}catch(n){throw new xt("Unexpected error during interaction call",{interactionName:t,userId:e.user?.id,payload:e.payload,executionPhase:"top-level",causedBy:n instanceof Error?n:new Error(String(n))})}}async callActivityInteraction(t,e,r,i){let n=st.getStore(),s=this.controller.system.logger.child(n?.logContext||{});try{let o=this.activityCallsByName.get(t);if(!o)throw new fe(`Cannot find activity for ${t}`,{activityName:t,context:{interactionName:e,activityId:r,userId:i.user?.id}});s.info({label:"activity",message:o.activity.name}),await this.controller.system.storage.beginTransaction(o.activity.name);let c=o.interactionCallByName.get(e);if(!c){let l=new xt(`Cannot find interaction ${e} in activity ${t}`,{interactionName:e,userId:i.user?.id,payload:i.payload,executionPhase:"activity-interaction-lookup",context:{activityName:t,activityId:r}});throw await this.controller.system.storage.rollbackTransaction(o.activity.name),l}let u=await o.callInteraction(r,c.interaction.uuid,i);return u.error?(s.error({label:"activity",message:o.activity.name}),await this.controller.system.storage.rollbackTransaction(o.activity.name)):(await this.controller.system.storage.commitTransaction(o.activity.name),await this.runRecordChangeSideEffects(u,s)),u}catch(o){throw new fe("Unexpected error during activity interaction call",{activityName:t,context:{interactionName:e,activityId:r,userId:i.user?.id},causedBy:o instanceof Error?o:new Error(String(o))})}}async runRecordChangeSideEffects(t,e){let r=t.effects;for(let i of r||[]){let n=this.controller.recordNameToSideEffects.get(i.recordName);if(n){t.sideEffects||(t.sideEffects={});for(let s of n)try{if(s instanceof ee)t.sideEffects[s.name]={result:await s.content(i)};else{let o=s;o.name&&typeof o.content=="function"&&(t.sideEffects[o.name]={result:await o.content(i)})}}catch(o){let c="unknown";s instanceof ee?c=s.name:c=s.name||"unknown",e.error({label:"recordMutationSideEffect",message:c}),t.sideEffects[c]={error:o}}}}}async createActivity(t){return this.controller.system.storage.create(ha,{...t,state:t.state,refs:t.refs})}async updateActivity(t,e){let r={...e};return delete r.state,delete r.refs,e.state&&(r.state=e.state),e.refs&&(r.refs=e.refs),this.controller.system.storage.update(ha,t,r)}async getActivity(t){return(await this.controller.system.storage.find(ha,t,void 0,["*"])).map(e=>({...e,state:e.state,refs:e.refs}))}async saveEvent(t,e=[]){return this.controller.system.storage.create(ft,t,e)}async getEvent(t){return(await this.controller.system.storage.find(ft,t,void 0,["*"])).map(e=>({...e}))}getActivityCall(t){return this.activityCalls.get(t)}getActivityCallByName(t){return this.activityCallsByName.get(t)}getInteractionCall(t){return this.interactionCalls.get(t)}getInteractionCallByName(t){return this.interactionCallsByName.get(t)}};var _=class{static{this.skip=()=>new Ot}static{this.resolved=(t,e)=>new Ve(t,e)}static{this.async=t=>new Be(t)}static{this.fullRecompute=t=>new _e(t)}},Ot=class extends _{},_e=class extends _{constructor(e){super();this.reason=e}},Be=class extends _{constructor(e){super();this.args=e}},Ve=class extends _{constructor(e,r){super();this.result=e;this.args=r}},P=class{constructor(t,e){this.defaultValue=t;this.record=e}async set(t,e){return await this.controller.system.storage.update(this.record,g.atom({key:"id",value:["=",t.id]}),{[this.key]:e}),e}async get(t){if(t[this.key]===void 0){let r=(await this.controller.system.storage.findOne(this.record,g.atom({key:"id",value:["=",t.id]}),void 0,[this.key]))?.[this.key];return r!==void 0?r:this.defaultValue}return t[this.key]}},J=class{constructor(t){this.defaultValue=t}async set(t){return await this.controller.system.storage.set(ct,this.key,t),t}async get(){return await this.controller.system.storage.get(ct,this.key)}};function cn(a,t){if(a===t)return!0;for(let e in t)if(a[e]!==t[e])return!1;return!0}var be=class{constructor(t){this.data=t;this.map={};for(let e of t.transfers)this.map[e.current.name]||(this.map[e.current.name]=[]),this.map[e.current.name].push({trigger:e.trigger,next:e.next})}findNextState(t,e){let r=this.map[t];if(r){for(let i of r)if(cn(i.trigger,e))return i.next}return null}findTransfers(t){return this.data.transfers.filter(e=>cn(e.trigger,t))}};var lr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.eventDeps={};this.transitionFinder=new be(this.args),this.defaultState=this.args.defaultState}static{this.computationType=j}static{this.contextType="global"}createState(){return{currentState:new J(this.defaultState.name)}}getDefaultValue(t){return this.defaultState.computeValue?this.defaultState.computeValue.call(this.controller,void 0,t):this.defaultState.name}mutationEventToTrigger(t){if(t.recordName===ft){let e=t.record.interactionName;return this.controller.interactions.find(i=>i.name===e)}else return{type:"data",eventType:t.type}}async incrementalCompute(t,e,r){T(e.recordName===ft,"Record StateMachine only supports interaction record");let i=await this.state.currentState.get(),n=this.mutationEventToTrigger(e),s=this.transitionFinder?.findNextState(i,n);if(!s)return _.skip();await this.state.currentState.set(s.name);let o=e.record;return s.computeValue?await s.computeValue.call(this.controller,t,o):s.name}},pr=class{constructor(t,e,r){this.controller=t;this.args=e;this.useLastValue=!0;this.eventDeps={};this.transitionFinder=new be(this.args),this.defaultState=this.args.defaultState,this.dataContext=r}static{this.computationType=j}static{this.contextType="property"}createState(){return{currentState:new P(this.defaultState.name)}}getDefaultValue(t){let e=t[this.dataContext.id.name];return T(!(e!==void 0&&!this.defaultState.computeValue),`${this.dataContext.host.name}.${this.dataContext.id.name} have been set when ${this.dataContext.host.name} created, 
if you want to save the use the initial value, you need to define computeValue in defaultState to save it.
Or if you want to use state name as value, you should not set ${this.dataContext.host.name}.${this.dataContext.id.name} when ${this.dataContext.host.name} created.
`),e!==void 0||this.defaultState.computeValue?this.defaultState.computeValue.call(this.controller,e,void 0):this.defaultState.name}mutationEventToTrigger(t){if(t.recordName===ft){let e=t.record.interactionName;return this.controller.interactions.find(i=>i.name===e)}}async computeDirtyRecords(t){let e=this.mutationEventToTrigger(t);if(e){let r=this.transitionFinder.findTransfers(e);return(await Promise.all(r.map(i=>{let n=t.recordName===ft?t.record:t;return i.computeTarget.call(this.controller,n)}))).flat().filter(Boolean)}}async incrementalCompute(t,e,r){T(e.recordName===ft,"Record StateMachine only supports interaction record");let i=await this.state.currentState.get(r),n=this.mutationEventToTrigger(e),s=this.transitionFinder?.findNextState(i,n);if(!s)return _.skip();await this.state.currentState.set(r,s.name);let o=e.record;return s.computeValue?await s.computeValue.call(this.controller,t,o):s.name}},dr=class{constructor(t,e,r){this.controller=t;this.args=e;this.useLastValue=!1;this.eventDeps={};this.transitionFinder=new be(this.args),this.defaultState=this.args.defaultState,this.dataContext=r,this.isRelation=this.dataContext.id instanceof q}static{this.computationType=j}static{this.contextType=["entity","relation"]}createState(){return{currentState:new P(this.defaultState.name)}}getDefaultValue(t){return this.defaultState.computeValue?this.defaultState.computeValue.call(this.controller,void 0,t):this.defaultState.name}mutationEventToTrigger(t){if(t.recordName===ft){let e=t.record.interactionName;return this.controller.interactions.find(i=>i.name===e)}}async computeDirtyRecords(t){let e=this.mutationEventToTrigger(t);if(e){let r=this.transitionFinder.findTransfers(e);return(await Promise.all(r.map(i=>{let n=t.recordName===ft?t.record:t;return i.computeTarget.call(this.controller,n)}))).flat().filter(Boolean)}}async incrementalPatchCompute(t,e,r){T(e.recordName===ft,"Record StateMachine only supports interaction record");let i=r.id?await this.state.currentState.get(r):this.defaultState.name,n=this.mutationEventToTrigger(e),s=this.transitionFinder?.findNextState(i,n);if(!s)return _.skip();let o=e.record,c=s.computeValue?await s.computeValue.call(this.controller,t,o):s.name;if(r.id)return c===null?{type:"delete",affectedId:[r.id]}:{type:"update",affectedId:[r.id],data:{...s,[this.state.currentState.key]:s.name}};if(c)return T(!(this.isRelation&&(r.source?.id===void 0||r.target?.id===void 0)),`
${this.dataContext.id.name} StateMachine transfer from ${i} to ${s.name} will create new relation, 
it requires both source and target id, but your computeTarget function returned ${JSON.stringify(r)}`),{type:"insert",data:{...r,...c,[this.state.currentState.key]:s.name}}}},hr=[lr,pr,dr];var fr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.matchRecordToWeight=this.args.callback.bind(this.controller),this.record=this.args.record,this.dataDeps={main:{type:"records",source:this.record,attributeQuery:this.args.attributeQuery},...this.args.dataDeps||{}}}static{this.computationType=Wt}static{this.contextType="global"}getDefaultValue(){return 0}createState(){return{itemResult:new P(0,this.record.name)}}async compute({main:t}){let e=0;for(let r of t){let i=this.matchRecordToWeight.call(this.controller,r);e+=await this.state.itemResult.set(r,i.weight*i.value)}return e}async incrementalCompute(t,e){if(e.recordName!==this.dataDeps.main.source.name||e.relatedAttribute?.length)return _.fullRecompute("mutationEvent.recordName not match");let r=t;if(e.type==="create"){let i=e.record,n=this.matchRecordToWeight.call(this.controller,i);r=t+await this.state.itemResult.set(i,n.weight*n.value)}else if(e.type==="delete"){let i=await this.state.itemResult.get(e.record);r=t-i}else if(e.type==="update"){let i=await this.state.itemResult.get(e.oldRecord),n=await this.controller.system.storage.findOne(this.record.name,g.atom({key:"id",value:["=",e.record.id]}),void 0,this.dataDeps.main.attributeQuery),s=this.matchRecordToWeight.call(this.controller,n),o=s.weight*s.value;r=t-i+await this.state.itemResult.set(n,o)}return r}},mr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.matchRecordToWeight=this.args.callback.bind(this.controller),this.relation=this.controller.relations.find(s=>s.source===r.host&&s.sourceProperty===this.args.property||s.target===r.host&&s.targetProperty===this.args.property),T(this.relation,"weighted summation computation must specify property"),this.isSource=this.args.direction?this.args.direction==="source":this.relation.source.name===r.host.name,T(this.isSource?this.relation.source===r.host:this.relation.target===r.host,"weighted summation computation relation direction error"),this.relationAttr=this.isSource?this.relation.sourceProperty:this.relation.targetProperty,this.relatedRecordName=this.isSource?this.relation.target.name:this.relation.source.name,this.property=this.args.property||this.relationAttr,this.reverseProperty=this.isSource?this.relation.targetProperty:this.relation.sourceProperty;let i=this.args.attributeQuery||[];this.relatedAttributeQuery=this.args.attributeQuery?.filter(s=>s[0]!==b)||[];let n=(i.find(s=>s[0]===b)||[])[1]?.attributeQuery;this.relationAttributeQuery=[[this.isSource?"target":"source",{attributeQuery:this.relatedAttributeQuery}],...n||[]],this.dataDeps={_current:{type:"property",attributeQuery:[[this.relationAttr,{attributeQuery:this.args.attributeQuery}]]},...this.args.dataDeps||{}}}static{this.computationType=Wt}static{this.contextType="property"}createState(){return{itemResult:new P(0,this.relation.name)}}getDefaultValue(){return 0}async compute({_current:t,...e}){let r=t[this.relationAttr]||[],i=0;for(let n of r){let s=this.matchRecordToWeight.call(this.controller,n,e),o=s.weight*s.value;await this.state.itemResult.set(n,o),i+=o}return i}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataContext.host.name||!e.relatedAttribute||e.relatedAttribute.length===0||e.relatedAttribute.length>3||e.relatedAttribute[0]!==this.relationAttr||e.relatedAttribute[1]&&e.relatedAttribute[1]!=="&"||e.relatedAttribute[2]&&e.relatedAttribute[2]!==(this.isSource?"target":"source"))return _.fullRecompute("mutationEvent.recordName not match");let n=t,s=e.relatedMutationEvent;if(s.type==="create"&&s.recordName===this.relation.name){let o=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:"id",value:["=",s.record.id]}),void 0,this.relationAttributeQuery),c=o[this.isSource?"target":"source"];c["&"]=o;let u=this.matchRecordToWeight.call(this.controller,c,i),l=u.weight*u.value;await this.state.itemResult.set(o,l),n=n+l}else if(s.type==="delete"&&s.recordName===this.relation.name){let o=await this.state.itemResult.get(s.record);n=n-o}else if(s.type==="update"){let o=e.relatedAttribute[1]===b?e.relatedAttribute.slice(2).concat("id").join("."):e.relatedAttribute.length===1?`${this.isSource?"target":"source"}.id`:`${this.isSource?"target":"source"}.${e.relatedAttribute.slice(1).concat("id").join(".")}`,c=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:o,value:["=",s.oldRecord.id]}),void 0,this.relationAttributeQuery),u=c[this.isSource?"target":"source"];u["&"]=c;let l=await this.state.itemResult.get(c),d=this.matchRecordToWeight.call(this.controller,u,i),h=d.weight*d.value;await this.state.itemResult.set(c,h),n=n-l+h}return n}},yr=[fr,mr];var gr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.callback=this.args.callback.bind(this.controller),this.dataDeps={main:{type:"records",source:this.args.record,attributeQuery:this.args.attributeQuery},...this.args.dataDeps||{}},this.defaultValue=!this.args.notEmpty}static{this.computationType=Ht}static{this.contextType="global"}createState(){return{matchCount:new J(0),totalCount:new J(0),isItemMatch:new P(!1,this.args.record.name)}}getDefaultValue(){return this.defaultValue}async compute({main:t,...e}){let r=await this.state.totalCount.set(t.length),i=0;for(let n of t){let s=this.callback.call(this.controller,n,e);s&&i++,await this.state.isItemMatch.set(n,s)}return await this.state.matchCount.set(i),i===r}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataDeps.main.source.name||e.relatedAttribute?.length)return _.fullRecompute("mutationEvent.recordName not match");let n=await this.state.totalCount.get(),s=await this.state.matchCount.get();if(e.type==="create"){n=await this.state.totalCount.set(n+1);let o=!!this.callback.call(this.controller,e.record,i);o===!0&&(s=await this.state.matchCount.set(s+1)),await this.state.isItemMatch.set(e.record,o)}else if(e.type==="delete")n=await this.state.totalCount.set(n-1),await this.state.isItemMatch.get(e.record)&&(s=await this.state.matchCount.set(s-1));else if(e.type==="update"){let o=await this.state.isItemMatch.get(e.oldRecord),c=!!this.callback.call(this.controller,e.record,i),u=!!o;u===!0&&c===!1?s=await this.state.matchCount.set(s-1):u===!1&&c===!0&&(s=await this.state.matchCount.set(s+1)),await this.state.isItemMatch.set(e.record,c)}return s===n}},br=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.callback=this.args.callback.bind(this.controller),this.relation=this.controller.relations.find(s=>s.source===r.host&&s.sourceProperty===this.args.property||s.target===r.host&&s.targetProperty===this.args.property),this.isSource=this.args.direction?this.args.direction==="source":this.relation.source.name===r.host.name,T(this.isSource?this.relation.source===r.host:this.relation.target===r.host,"every computation relation direction error"),this.relationAttr=this.isSource?this.relation.sourceProperty:this.relation.targetProperty,this.relatedRecordName=this.isSource?this.relation.target.name:this.relation.source.name,this.property=this.args.property,this.reverseProperty=this.isSource?this.relation.targetProperty:this.relation.sourceProperty;let i=this.args.attributeQuery||[];this.relatedAttributeQuery=this.args.attributeQuery?.filter(s=>s[0]!==b)||[];let n=(i.find(s=>s[0]===b)||[])[1]?.attributeQuery;this.relationAttributeQuery=[[this.isSource?"target":"source",{attributeQuery:this.relatedAttributeQuery}],...n||[]],this.dataDeps={_current:{type:"property",attributeQuery:[[this.property,{attributeQuery:this.args.attributeQuery}]]},...this.args.dataDeps||{}}}static{this.computationType=Ht}static{this.contextType="property"}createState(){return{matchCount:new P(0),totalCount:new P(0),isItemMatch:new P(!1,this.relation.name)}}getDefaultValue(){return!this.args.notEmpty}async compute({_current:t,...e}){let r=await this.state.totalCount.set(t,t[this.relationAttr].length),i=0;for(let n of t[this.relationAttr])this.callback.call(this.controller,n,e)&&(i++,await this.state.isItemMatch.set(n,!0));return i===r}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataContext.host.name||!e.relatedAttribute||e.relatedAttribute.length===0||e.relatedAttribute.length>3||e.relatedAttribute[0]!==this.relationAttr||e.relatedAttribute[1]&&e.relatedAttribute[1]!=="&"||e.relatedAttribute[2]&&e.relatedAttribute[2]!==(this.isSource?"target":"source"))return _.fullRecompute("mutationEvent.recordName not match");let n=e.relatedMutationEvent,s=await this.state.matchCount.get(e.record),o=await this.state.totalCount.get(e.record);if(n.type==="create"&&n.recordName===this.relation.name){let c=n.record,l=(await this.controller.system.storage.findOne(this.relation.name,g.atom({key:"id",value:["=",c.id]}),void 0,this.relationAttributeQuery))[this.isSource?"target":"source"];l["&"]=c,!!this.callback.call(this.controller,l,i)===!0&&(s=await this.state.matchCount.set(e.record,s+1),await this.state.isItemMatch.set(c,!0)),o=await this.state.totalCount.set(e.record,o+1)}else if(n.type==="delete"&&n.recordName===this.relation.name){let c=n.record;!!await this.state.isItemMatch.get(c)===!0&&(s=await this.state.matchCount.set(e.record,s-1)),o=await this.state.totalCount.set(e.record,o-1)}else if(n.type==="update"&&(n.recordName===this.relation.name||n.recordName===this.relatedRecordName)){let c=e.oldRecord,u=e.relatedAttribute[1]===b?e.relatedAttribute.slice(2).concat("id").join("."):e.relatedAttribute.length===1?`${this.isSource?"target":"source"}.id`:`${this.isSource?"target":"source"}.${e.relatedAttribute.slice(1).concat("id").join(".")}`,l=g.atom({key:u,value:["=",n.oldRecord.id]}),d=await this.controller.system.storage.findOne(this.relation.name,l,void 0,this.relationAttributeQuery),h=d[this.isSource?"target":"source"];h["&"]=d;let f=!!await this.state.isItemMatch.get(d),I=!!this.callback.call(this.controller,h,i);f===!0&&I===!1?s=await this.state.matchCount.set(c,s-1):f===!1&&I===!0&&(s=await this.state.matchCount.set(c,s+1)),await this.state.isItemMatch.set(d,I),o=await this.state.totalCount.set(c,o)}else return _.fullRecompute("mutation is not caused by relation.");return s===o}},Ir=[gr,br];var xr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.callback=this.args.callback.bind(this.controller),this.dataDeps={main:{type:"records",source:this.args.record,attributeQuery:this.args.attributeQuery},...this.args.dataDeps||{}}}static{this.computationType=Kt}static{this.contextType="global"}createState(){return{matchCount:new J(0),isItemMatch:new P(!1,this.args.record.name)}}getDefaultValue(){return!1}async compute({main:t,...e}){let r=0;for(let i of t){let n=this.callback.call(this.controller,i,e);n&&r++,await this.state.isItemMatch.set(i,n)}return await this.state.matchCount.set(r),r>0}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataDeps.main.source.name||e.relatedAttribute?.length)return _.fullRecompute("mutationEvent.recordName not match");let n=await this.state.matchCount.get();if(e.type==="create"){let s=!!this.callback.call(this.controller,e.record,i);s===!0&&(n=await this.state.matchCount.set(n+1)),await this.state.isItemMatch.set(e.record,s)}else if(e.type==="delete")await this.state.isItemMatch.get(e.record)&&(n=await this.state.matchCount.set(n-1));else if(e.type==="update"){let s=await this.state.isItemMatch.get(e.oldRecord),o=await this.controller.system.storage.findOne(e.recordName,g.atom({key:"id",value:["=",e.record.id]}),void 0,this.args.attributeQuery),c=!!this.callback.call(this.controller,o,i),u=!!s;u===!0&&c===!1?n=await this.state.matchCount.set(n-1):u===!1&&c===!0&&(n=await this.state.matchCount.set(n+1)),await this.state.isItemMatch.set(o,c)}return n>0}},Rr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.callback=this.args.callback.bind(this.controller),this.relation=this.controller.relations.find(c=>c.source===r.host&&c.sourceProperty===this.args.property||c.target===r.host&&c.targetProperty===this.args.property),T(this.relation,`cannot find relation for property ${this.args.property} in "Any" computation`),this.isSource=this.args.direction?this.args.direction==="source":this.relation.source.name===r.host.name,T(this.isSource?this.relation.source===r.host:this.relation.target===r.host,"any computation relation direction error");let i=this.relation.baseRelation||this.relation;for(;i.baseRelation;)i=i.baseRelation;let n=i.type.split(":");T(n[this.isSource?1:0]==="n",`property-level Any computation argument must be an x:n relation. ${this.dataContext.host.name}.${this.args.property}" is a ${this.isSource?n.join(":"):n.slice().reverse().join(":")} relation`),this.relationAttr=this.isSource?this.relation.sourceProperty:this.relation.targetProperty,this.relatedRecordName=this.isSource?this.relation.target.name:this.relation.source.name,this.property=this.args.property,this.reverseProperty=this.isSource?this.relation.targetProperty:this.relation.sourceProperty;let s=this.args.attributeQuery||[];this.relatedAttributeQuery=this.args.attributeQuery?.filter(c=>c[0]!==b)||[];let o=(s.find(c=>c[0]===b)||[])[1]?.attributeQuery;this.relationAttributeQuery=[[this.isSource?"target":"source",{attributeQuery:this.relatedAttributeQuery}],...o||[]],this.dataDeps={_current:{type:"property",attributeQuery:[[this.property,{attributeQuery:this.args.attributeQuery}]]},...this.args.dataDeps||{}}}static{this.computationType=Kt}static{this.contextType="property"}createState(){return{matchCount:new P(0),isItemMatch:new P(!1,this.relation.name)}}getDefaultValue(){return!1}async compute({_current:t,...e}){let r=0;for(let i of t[this.relationAttr])this.callback.call(this.controller,i,e)?(r++,await this.state.isItemMatch.set(i,!0)):await this.state.isItemMatch.set(i,!1);return await this.state.matchCount.set(t,r),r>0}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataContext.host.name||!e.relatedAttribute||e.relatedAttribute.length===0||e.relatedAttribute.length>3||e.relatedAttribute[0]!==this.relationAttr||e.relatedAttribute[1]&&e.relatedAttribute[1]!=="&"||e.relatedAttribute[2]&&e.relatedAttribute[2]!==(this.isSource?"target":"source"))return _.fullRecompute("mutationEvent.recordName not match");let n=await this.state.matchCount.get(e.record),s=e.relatedMutationEvent;if(s.type==="create"&&s.recordName===this.relation.name){let o=s.record,u=(await this.controller.system.storage.findOne(this.relation.name,g.atom({key:"id",value:["=",o.id]}),void 0,this.relationAttributeQuery))[this.isSource?"target":"source"];u["&"]=o,!!this.callback.call(this.controller,u,i)===!0?(n=await this.state.matchCount.set(e.record,n+1),await this.state.isItemMatch.set(o,!0)):await this.state.isItemMatch.set(o,!1)}else if(s.type==="delete"&&s.recordName===this.relation.name){let o=s.record;!!await this.state.isItemMatch.get(o)===!0&&(n=await this.state.matchCount.set(e.record,n-1))}else if(s.type==="update"&&(s.recordName===this.relation.name||s.recordName===this.relatedRecordName)){let o=e.oldRecord,c=e.relatedAttribute[1]==="&"?e.relatedAttribute.slice(2).concat("id").join("."):e.relatedAttribute.length===1?`${this.isSource?"target":"source"}.id`:`${this.isSource?"target":"source"}.${e.relatedAttribute.slice(1).concat("id").join(".")}`,u=g.atom({key:c,value:["=",s.oldRecord.id]}),l=await this.controller.system.storage.findOne(this.relation.name,u,void 0,this.relationAttributeQuery),d=l[this.isSource?"target":"source"];d["&"]=l;let h=!!await this.state.isItemMatch.get(l),f=!!this.callback.call(this.controller,d,i);h===!0&&f===!1?n=await this.state.matchCount.set(o,n-1):h===!1&&f===!0&&(n=await this.state.matchCount.set(o,n+1)),await this.state.isItemMatch.set(l,f)}else return _.fullRecompute("mutation is not caused by relation.");return n>0}},Er=[xr,Rr];var vr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.record=this.args.record,this.callback=this.args.callback?.bind(this)||(()=>!0),this.dataDeps={main:{type:"records",source:this.record,attributeQuery:this.args.attributeQuery},...this.args.dataDeps||{}}}static{this.computationType=Nt}static{this.contextType="global"}createState(){return{count:new J(0),isItemMatch:new P(!1,this.record.name)}}getDefaultValue(){return 0}async compute({main:t,...e}){let r=0;for(let i of t){let n=this.callback.call(this.controller,i,e);n&&r++,await this.state.isItemMatch.set(i,n)}return await this.state.count.set(r),r}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataDeps.main.source.name||e.relatedAttribute?.length)return _.fullRecompute("mutationEvent.recordName not match");let n=await this.state.count.get()||t||0;if(e.type==="create"){let s=!!this.callback.call(this.controller,e.record,i);s&&(n=n+1),await this.state.isItemMatch.set(e.record,s)}else if(e.type==="delete")await this.state.isItemMatch.get(e.record)&&(n=n-1);else if(e.type==="update"){let s=await this.state.isItemMatch.get(e.oldRecord),o=!!this.callback.call(this.controller,e.record,i),c=!!s;c&&!o?n=n-1:!c&&o&&(n=n+1),await this.state.isItemMatch.set(e.record,o)}return n=Math.max(0,n),await this.state.count.set(n),n}},wr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.callback=this.args.callback?.bind(this.controller),this.args.property?this.relation=this.controller.relations.find(s=>s.source===r.host&&s.sourceProperty===this.args.property||s.target===r.host&&s.targetProperty===this.args.property):this.relation=this.args.record,this.isSource=this.args.direction?this.args.direction==="source":this.relation.source.name===r.host.name,T(this.isSource?this.relation.source===r.host:this.relation.target===r.host,"count computation relation direction error"),this.relationAttr=this.isSource?this.relation.sourceProperty:this.relation.targetProperty,this.relatedRecordName=this.isSource?this.relation.target.name:this.relation.source.name,this.property=this.args.property||this.relationAttr,this.reverseProperty=this.isSource?this.relation.targetProperty:this.relation.sourceProperty;let i=this.args.attributeQuery||[];this.relatedAttributeQuery=i.filter(s=>s&&s[0]!==b)||[];let n=(i.find(s=>s&&s[0]===b)||[])[1]?.attributeQuery;this.relationAttributeQuery=[[this.isSource?"target":"source",{attributeQuery:this.relatedAttributeQuery}],...n||[]],this.dataDeps={_current:{type:"property",attributeQuery:this.callback?[[this.relationAttr,{attributeQuery:i.length>0?i:["id"]}]]:[[this.relationAttr,{attributeQuery:["id"]}]]},...this.args.dataDeps||{}}}static{this.computationType=Nt}static{this.contextType="property"}createState(){return this.callback?{isItemMatchCount:new P(!1,this.relation.name)}:{}}getDefaultValue(){return 0}async compute({_current:t,...e}){let r=t[this.relationAttr]||[],i=0;if(this.callback)for(let n of r)this.callback.call(this.controller,n,e)?(await this.state.isItemMatchCount.set(n,!0),i++):await this.state.isItemMatchCount.set(n,!1);else i=r.length;return i}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataContext.host.name||!e.relatedAttribute||e.relatedAttribute.length===0||e.relatedAttribute.length>3||e.relatedAttribute[0]!==this.relationAttr||e.relatedAttribute[1]&&e.relatedAttribute[1]!=="&"||e.relatedAttribute[2]&&e.relatedAttribute[2]!==(this.isSource?"target":"source"))return _.fullRecompute("mutationEvent.recordName not match");let n=e.relatedMutationEvent,s=t||0;if(n.type==="create"&&n.recordName===this.relation.name)if(this.callback){let o=n.record,u=(await this.controller.system.storage.findOne(this.relation.name,g.atom({key:"id",value:["=",o.id]}),void 0,this.relationAttributeQuery))[this.isSource?"target":"source"];u["&"]=o,!!this.callback.call(this.controller,u,i)?(await this.state.isItemMatchCount.set(o,!0),s=s+1):await this.state.isItemMatchCount.set(o,!1)}else s=s+1;else if(n.type==="delete"&&n.recordName===this.relation.name)this.callback?await this.state.isItemMatchCount.get(n.oldRecord)&&(s=s-1):s=s-1;else if(n.type==="update"){if(this.callback){let o=e.relatedAttribute[1]===b?e.relatedAttribute.slice(2).concat("id").join("."):e.relatedAttribute.length===1?`${this.isSource?"target":"source"}.id`:`${this.isSource?"target":"source"}.${e.relatedAttribute.slice(1).concat("id").join(".")}`,c=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:o,value:["=",n.oldRecord.id]}),void 0,this.relationAttributeQuery),u=c[this.isSource?"target":"source"];u["&"]=c;let l=!!this.callback.call(this.controller,u,i),d=await this.state.isItemMatchCount.get(c);l!==d&&(s=l?s+1:s-1,await this.state.isItemMatchCount.set(c,l))}}else return _.fullRecompute(`unknown related mutation event for ${this.dataContext.host.name}.${this.dataContext.id.name}`);return s}},Ar=[vr,wr];var Cr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.transformCallback=this.args.callback.bind(this.controller),this.dataDeps={main:{type:"records",source:this.args.record,attributeQuery:this.args.attributeQuery||["*"]}}}static{this.computationType=bt}static{this.contextType=["entity","relation"]}createState(){return{sourceRecordId:new P(""),transformIndex:new P(0)}}getDefaultValue(){return[]}async compute({main:t}){let e=[];for(let r of t){let i=await this.transformCallback.call(this.controller,r);(Array.isArray(i)?i:[i]).forEach((s,o)=>{e.push({...s,[this.state.sourceRecordId.key]:r.id,[this.state.transformIndex.key]:o})})}return e}async incrementalPatchCompute(t,e){let r=this.dataContext,i=[];if(e.type==="create"){let n=g.atom({key:"id",value:["=",e.record.id]}),s=this.dataDeps.main,o=await this.controller.system.storage.findOne(s.source.name,n,void 0,s.attributeQuery),c=await this.transformCallback.call(this.controller,o);(Array.isArray(c)?c:[c]).forEach((l,d)=>{l&&i.push({type:"insert",data:{...l,[this.state.sourceRecordId.key]:e.record.id,[this.state.transformIndex.key]:d}})})}else{let n=e.oldRecord?.id??e.record.id,s=g.atom({key:this.state.sourceRecordId.key,value:["=",n]}),c=(await this.controller.system.storage.find(r.id.name,s,void 0,["*"])).reduce((l,d)=>(l[d[this.state.transformIndex.key]]=d,l),{}),u=[];if(e.type==="update"){let l=g.atom({key:"id",value:["=",n]}),d=await this.controller.system.storage.findOne(this.dataDeps.main.source.name,l,void 0,this.dataDeps.main.attributeQuery),h=await this.transformCallback.call(this.controller,d);u=Array.isArray(h)?h:[h]}u.forEach((l,d)=>{l&&(c[d]?(i.push({type:"update",data:{...l,[this.state.sourceRecordId.key]:n,[this.state.transformIndex.key]:d},affectedId:c[d].id}),delete c[d]):i.push({type:"insert",data:{...l,[this.state.sourceRecordId.key]:n,[this.state.transformIndex.key]:d}}))}),Object.values(c).forEach(l=>{i.push({type:"delete",affectedId:l.id})})}return i}},Sr=[Cr];var _t=class a{constructor(t){this.node=t}static number(t){return new a({type:"number",value:t})}static variable(t){return new a({type:"variable",variable:{id:t}})}add(t){let e=typeof t=="number"?{type:"number",value:t}:t.node;return new a({type:"operation",operation:"+",left:this.node,right:e})}subtract(t){let e=typeof t=="number"?{type:"number",value:t}:t.node;return new a({type:"operation",operation:"-",left:this.node,right:e})}multiply(t){let e=typeof t=="number"?{type:"number",value:t}:t.node;return new a({type:"operation",operation:"*",left:this.node,right:e})}divide(t){let e=typeof t=="number"?{type:"number",value:t}:t.node;return new a({type:"operation",operation:"/",left:this.node,right:e})}power(t){let e=typeof t=="number"?{type:"number",value:t}:t.node;return new a({type:"operation",operation:"^",left:this.node,right:e})}sqrt(){return new a({type:"operation",operation:"sqrt",left:this.node})}evaluate(t={}){return this.evaluateNode(this.node,t)}evaluateNode(t,e){switch(t.type){case"number":return t.value;case"variable":let r=t.variable.id;if(!(r in e))throw new Error(`Variable ${r} not found`);return e[r];case"operation":let i=t.left?this.evaluateNode(t.left,e):0,n=t.right?this.evaluateNode(t.right,e):0;switch(t.operation){case"+":return i+n;case"-":return i-n;case"*":return i*n;case"/":if(n===0)throw new Error("Division by zero");return i/n;case"^":return Math.pow(i,n);case"sqrt":return Math.sqrt(i);default:throw new Error(`Unknown operation: ${t.operation}`)}default:throw new Error(`Unknown node type: ${t.type}`)}}gt(t){return new ae(this,">",t)}lt(t){return new ae(this,"<",t)}eq(t){return new Ie(this,t)}getVariables(){let t=new Set;return this.collectVariables(this.node,t),Array.from(t)}collectVariables(t,e){t.type==="variable"?e.add(t.variable.id):t.type==="operation"&&(t.left&&this.collectVariables(t.left,e),t.right&&this.collectVariables(t.right,e))}clone(){return new a(this.cloneNode(this.node))}cloneNode(t){let e={type:t.type};return t.value!==void 0&&(e.value=t.value),t.variable&&(e.variable={...t.variable}),t.operation&&(e.operation=t.operation),t.left&&(e.left=this.cloneNode(t.left)),t.right&&(e.right=this.cloneNode(t.right)),e}getLinearForm(t){return this.extractLinearForm(this.node,t)}extractLinearForm(t,e){switch(t.type){case"number":return{coefficient:0,power:0,constant:t.value};case"variable":return t.variable.id===e?{coefficient:1,power:1,constant:0}:{coefficient:0,power:0,constant:0};case"operation":let r=t.left?this.extractLinearForm(t.left,e):{coefficient:0,power:0,constant:0},i=t.right?this.extractLinearForm(t.right,e):{coefficient:0,power:0,constant:0};switch(t.operation){case"+":return{coefficient:r.coefficient+i.coefficient,power:Math.max(r.power,i.power),constant:r.constant+i.constant};case"-":return{coefficient:r.coefficient-i.coefficient,power:Math.max(r.power,i.power),constant:r.constant-i.constant};case"*":if(r.coefficient===0)return{coefficient:r.constant*i.coefficient,power:i.power,constant:r.constant*i.constant};if(i.coefficient===0)return{coefficient:i.constant*r.coefficient,power:r.power,constant:r.constant*i.constant};throw new Error("Cannot solve equations with variable multiplication");case"/":if(i.coefficient===0&&i.constant!==0)return{coefficient:r.coefficient/i.constant,power:r.power,constant:r.constant/i.constant};throw new Error("Cannot solve equations with variable division");case"^":if(r.coefficient!==0&&i.coefficient===0){let n=i.constant;if(n===Math.floor(n)&&n>0)return{coefficient:r.coefficient===1?1:Math.pow(r.coefficient,n),power:r.power*n,constant:r.constant===0?0:Math.pow(r.constant,n)};throw new Error("Only positive integer powers are supported")}else throw new Error("Cannot solve equations with variable in exponent");case"sqrt":if(r.coefficient!==0){if(r.power===2)return{coefficient:r.coefficient,power:1,constant:Math.sqrt(r.constant)};throw new Error("Cannot solve square root of non-quadratic variable")}else return{coefficient:0,power:0,constant:Math.sqrt(r.constant)};default:throw new Error(`Unknown operation: ${t.operation}`)}default:throw new Error(`Unknown node type: ${t.type}`)}}},ae=class{constructor(t,e,r){this.left=t;this.operator=e;this.right=r}evaluate(t={}){let e=this.left.evaluate(t),r=typeof this.right=="number"?this.right:this.right.evaluate(t);return this.operator===">"?e>r:e<r}solve(){let t=typeof this.right=="number"?_t.number(this.right):this.right,e=this.left.getVariables(),r=t.getVariables(),i=[...new Set([...e,...r])];if(i.length!==1)throw new Error("Can only solve inequalities with exactly one variable");let n=i[0];return this.solveForVariable(n)}solveForVariable(t){try{let r=this.left.subtract(typeof this.right=="number"?this.right:this.right).getLinearForm(t);if(r.coefficient===0)return null;let i=-r.constant,n=r.coefficient,s=r.power;if(s===1)return i/n;if(s===2){let o=i/n;return o<0?null:Math.sqrt(o)}else{let o=i/n;return s%2===0&&o<0?null:Math.pow(Math.abs(o),1/s)*(o<0?-1:1)}}catch{return null}}},Ie=class{constructor(t,e){this.left=t;this.right=e}evaluate(t={}){let e=this.left.evaluate(t),r=typeof this.right=="number"?this.right:this.right.evaluate(t);return Math.abs(e-r)<1e-10}solve(){let t=typeof this.right=="number"?_t.number(this.right):this.right,e=this.left.getVariables(),r=t.getVariables(),i=[...new Set([...e,...r])];if(i.length!==1)throw new Error("Can only solve equations with exactly one variable");let n=i[0];return this.solveForVariable(n)}solveForVariable(t){try{let r=this.left.subtract(typeof this.right=="number"?this.right:this.right).getLinearForm(t);if(r.coefficient===0)return Math.abs(r.constant)<1e-10?0:null;let i=-r.constant,n=r.coefficient,s=r.power;if(s===1)return i/n;if(s===2){let o=i/n;return o<0?null:Math.sqrt(o)}else{let o=i/n;return s%2===0&&o<0?null:Math.pow(Math.abs(o),1/s)*(o<0?-1:1)}}catch{return null}}};var kr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!1;this.dataDeps=this.args.dataDeps??{},this.callback=(i,n)=>this.args.callback.call(this.controller,i,n),this.nextRecomputeTime=this.args.nextRecomputeTime?(i,n)=>this.args.nextRecomputeTime.call(this.controller,i,n):void 0}static{this.computationType=Xt}static{this.contextType="global"}createState(){return{lastRecomputeTime:new J(null),nextRecomputeTime:new J(null)}}getDefaultValue(){return null}async compute(t){let e=await this.args.callback(_t.variable("now"),t),r=Date.now(),i,n;if(e instanceof _t)i=e.evaluate({now:r}),n=r+this.nextRecomputeTime(r,t);else if(e instanceof ae||e instanceof Ie)i=e.evaluate({now:r}),n=e.solve();else throw new Error("Invalid result type");return await this.state.lastRecomputeTime.set(r),await this.state.nextRecomputeTime.set(n),i}},Dr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!1;this.dataDeps={_current:{type:"property",attributeQuery:this.args.attributeQuery},...this.args.dataDeps||{}},this.isResultNumber=this.dataContext.id.type==="number",this.callback=(i,n)=>this.args.callback.call(this.controller,i,n),this.nextRecomputeTime=this.args.nextRecomputeTime?(i,n)=>this.args.nextRecomputeTime.call(this.controller,i,n):void 0}static{this.computationType=Xt}static{this.contextType="property"}createState(){return{lastRecomputeTime:new P(null),nextRecomputeTime:new P(null)}}getDefaultValue(){return 0}async compute(t,e){let r=await this.args.callback(_t.variable("now"),t),i=Date.now(),n,s;if(r instanceof _t)n=r.evaluate({now:i}),s=i+this.nextRecomputeTime(i,t);else if(r instanceof ae||r instanceof Ie)n=r.evaluate({now:i}),s=r.solve();else throw new Error("Invalid result type");return await this.state.lastRecomputeTime.set(e,i),await this.state.nextRecomputeTime.set(e,s),n}},Tr=[kr,Dr];var Nr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};if(this.record=this.args.record,!this.args.attributeQuery||this.args.attributeQuery.length===0)throw new Error("Sum computation requires attributeQuery with at least one field");this.sumFieldPath=[];let i=this.args.attributeQuery;for(;i;)this.sumFieldPath.push(Array.isArray(i[0])?i[0][0]:i[0]),i=Array.isArray(i[0])?i[0][1].attributeQuery:null;this.dataDeps={main:{type:"records",source:this.record,attributeQuery:this.args.attributeQuery}}}static{this.computationType=zt}static{this.contextType="global"}createState(){return{itemValue:new P(0,this.record.name)}}getDefaultValue(){return 0}resolveSumField(t,e=this.sumFieldPath){let r=t;for(let i of e)if(r=r[i],r==null)return 0;return Number.isNaN(r)||!Number.isFinite(r)?0:r}async compute({main:t}){let e=0;for(let r of t){let i=this.resolveSumField(r)||0;e+=i,await this.state.itemValue.set(r,i)}return e}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataDeps.main.source.name||e.relatedAttribute?.length)return _.fullRecompute("mutationEvent.recordName not match");let n=t||0;if(e.type==="create"){let s=await this.controller.system.storage.findOne(this.record.name,g.atom({key:"id",value:["=",e.record.id]}),void 0,this.args.attributeQuery),o=this.resolveSumField(s);n+=o,await this.state.itemValue.set(s,o)}else if(e.type==="delete"){let s=await this.state.itemValue.get(e.record);n-=s}else if(e.type==="update"){let s=await this.controller.system.storage.findOne(this.record.name,g.atom({key:"id",value:["=",e.record.id]}),void 0,this.args.attributeQuery),o=this.resolveSumField(s),c=await this.state.itemValue.get(e.oldRecord);n+=o-c,await this.state.itemValue.set(s,o)}return n}},Pr=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.relation=this.controller.relations.find(o=>o.source===r.host&&o.sourceProperty===this.args.property||o.target===r.host&&o.targetProperty===this.args.property),T(this.relation,"summation computation must specify either property or record"),this.isSource=this.args.direction?this.args.direction==="source":this.relation.source.name===r.host.name,T(this.isSource?this.relation.source===r.host:this.relation.target===r.host,"summation computation relation direction error"),this.relationAttr=this.isSource?this.relation.sourceProperty:this.relation.targetProperty,this.relatedRecordName=this.isSource?this.relation.target.name:this.relation.source.name,this.property=this.args.property,this.reverseProperty=this.isSource?this.relation.targetProperty:this.relation.sourceProperty;let i=this.args.attributeQuery||[];this.relatedAttributeQuery=this.args.attributeQuery?.filter(o=>o[0]!==b)||[];let n=(i.find(o=>o[0]===b)||[])[1]?.attributeQuery;this.relationAttributeQuery=[[this.isSource?"target":"source",{attributeQuery:this.relatedAttributeQuery}],...n||[]],this.sumFieldPath=[];let s=i;for(;s;)this.sumFieldPath.push(Array.isArray(s[0])?s[0][0]:s[0]),s=Array.isArray(s[0])?s[0][1].attributeQuery:null;this.dataDeps={_current:{type:"property",attributeQuery:[[this.relationAttr,{attributeQuery:this.args.attributeQuery}]]}}}static{this.computationType=zt}static{this.contextType="property"}createState(){return{itemResult:new P(0,this.relation.name)}}getDefaultValue(){return 0}resolveSumField(t,e=this.sumFieldPath){let r=t;for(let i of e)if(r=r[i],r==null)return 0;return Number.isNaN(r)||!Number.isFinite(r)?0:r}async compute({_current:t}){let e=t[this.relationAttr]||[],r=0;for(let i of e){let n=this.resolveSumField(i,this.sumFieldPath)||0;r+=n,await this.state.itemResult.set(i,n)}return r}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataContext.host.name||!e.relatedAttribute||e.relatedAttribute.length===0||e.relatedAttribute.length>3||e.relatedAttribute[0]!==this.relationAttr||e.relatedAttribute[1]&&e.relatedAttribute[1]!=="&"||e.relatedAttribute[2]&&e.relatedAttribute[2]!==(this.isSource?"target":"source"))return _.fullRecompute("mutationEvent.recordName not match");let n=e.relatedMutationEvent;if(!n)return _.fullRecompute("No related mutation event");let s=t||0;if(n.type==="create"&&n.recordName===this.relation.name){let o=n.record,c=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:"id",value:["=",o.id]}),void 0,this.relationAttributeQuery),u=c[this.isSource?"target":"source"];u["&"]=c;let l=this.resolveSumField(u)||0;s+=l,await this.state.itemResult.set(c,l)}else if(n.type==="delete"&&n.recordName===this.relation.name){let o=await this.state.itemResult.get(n.record);s=s-o}else if(n.type==="update"){let o=e.relatedAttribute[1]===b?e.relatedAttribute.slice(2).concat("id").join("."):e.relatedAttribute.length===1?`${this.isSource?"target":"source"}.id`:`${this.isSource?"target":"source"}.${e.relatedAttribute.slice(1).concat("id").join(".")}`,c=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:o,value:["=",n.oldRecord.id]}),void 0,this.relationAttributeQuery),u=c[this.isSource?"target":"source"];u["&"]=c;let l=this.resolveSumField(u)||0,d=await this.state.itemResult.get(c)||0;await this.state.itemResult.set(c,l),s+=l-d}return s}},Mr=[Nr,Pr];var _r=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};if(this.record=this.args.record,!this.args.attributeQuery||this.args.attributeQuery.length===0)throw new Error("Average computation requires attributeQuery with at least one field");this.avgFieldPath=[];let i=this.args.attributeQuery;for(;i;)this.avgFieldPath.push(Array.isArray(i[0])?i[0][0]:i[0]),i=Array.isArray(i[0])?i[0][1].attributeQuery:null;this.dataDeps={main:{type:"records",source:this.record,attributeQuery:this.args.attributeQuery}}}static{this.computationType=Jt}static{this.contextType="global"}createState(){return{sum:new J(0),count:new J(0),itemValue:new P(0,this.record.name)}}getDefaultValue(){return 0}resolveAvgField(t,e=this.avgFieldPath){let r=t;for(let i of e)if(r=r[i],r==null)return null;return Number.isNaN(r)||!Number.isFinite(r)?null:r}async compute({main:t}){let e=0,r=0;for(let i of t){let n=this.resolveAvgField(i)||0;e+=n,r++,await this.state.itemValue.set(i,n)}return await this.state.sum.set(e),await this.state.count.set(r),r>0?e/r:0}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataDeps.main.source.name||e.relatedAttribute?.length)return _.fullRecompute("mutationEvent.recordName not match");let n=await this.state.count.get()||0,s=await this.state.sum.get()||0;if(e.type==="create"){let o=await this.controller.system.storage.findOne(this.record.name,g.atom({key:"id",value:["=",e.record.id]}),void 0,this.args.attributeQuery),c=this.resolveAvgField(o)||0;s+=c,n++,await this.state.itemValue.set(o,c)}else if(e.type==="delete"){let o=await this.state.itemValue.get(e.record)||0;s-=o,n--}else if(e.type==="update"){let o=await this.controller.system.storage.findOne(this.record.name,g.atom({key:"id",value:["=",e.record.id]}),void 0,this.args.attributeQuery),c=this.resolveAvgField(o)||0,u=await this.state.itemValue.get(e.oldRecord)||0;s+=c-u,await this.state.itemValue.set(o,c)}return await this.state.sum.set(s),await this.state.count.set(n),n>0?s/n:0}};var Br=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.useLastValue=!0;this.dataDeps={};this.relation=this.controller.relations.find(o=>o.source===r.host&&o.sourceProperty===this.args.property||o.target===r.host&&o.targetProperty===this.args.property),this.isSource=this.args.direction?this.args.direction==="source":this.relation.source.name===r.host.name,T(this.isSource?this.relation.source===r.host:this.relation.target===r.host,"average computation relation direction error"),this.relationAttr=this.isSource?this.relation.sourceProperty:this.relation.targetProperty,this.relatedRecordName=this.isSource?this.relation.target.name:this.relation.source.name,this.property=this.args.property||this.relationAttr,this.reverseProperty=this.isSource?this.relation.targetProperty:this.relation.sourceProperty;let i=this.args.attributeQuery||[];this.relatedAttributeQuery=i.filter(o=>o&&o[0]!==b)||[];let n=(i.find(o=>o&&o[0]===b)||[])[1]?.attributeQuery;this.relationAttributeQuery=[[this.isSource?"target":"source",{attributeQuery:this.relatedAttributeQuery}],...n||[]],this.avgFieldPath=[];let s=i;for(;s;)this.avgFieldPath.push(Array.isArray(s[0])?s[0][0]:s[0]),s=Array.isArray(s[0])?s[0][1].attributeQuery:null;this.dataDeps={_current:{type:"property",attributeQuery:[[this.relationAttr,{attributeQuery:this.args.attributeQuery}]]}}}static{this.computationType=Jt}static{this.contextType="property"}createState(){return{count:new P(0,this.dataContext.host.name),itemResult:new P(0,this.relation.name)}}getDefaultValue(){return 0}resolveAvgField(t,e=this.avgFieldPath){let r=t;for(let i of e)if(r=r[i],r==null)return null;return r}async compute({_current:t}){let e=t[this.relationAttr]||[],r=0,i=0;for(let n of e){let s=this.resolveAvgField(n,this.avgFieldPath)||0;r+=s,i++,await this.state.itemResult.set(n,s)}return await this.state.count.set(t,i),i>0?r/i:0}async incrementalCompute(t,e,r,i){if(e.recordName!==this.dataContext.host.name||!e.relatedAttribute||e.relatedAttribute.length===0||e.relatedAttribute.length>3||e.relatedAttribute[0]!==this.relationAttr||e.relatedAttribute[1]&&e.relatedAttribute[1]!=="&"||e.relatedAttribute[2]&&e.relatedAttribute[2]!==(this.isSource?"target":"source"))return _.fullRecompute("mutationEvent.recordName not match");let n=e.relatedMutationEvent;if(!n)return _.fullRecompute("No related mutation event");let s=await this.state.count.get(e.record)||0,o=(t||0)*s;if(n.type==="create"&&n.recordName===this.relation.name){let c=n.record,u=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:"id",value:["=",c.id]}),void 0,this.relationAttributeQuery),l=u[this.isSource?"target":"source"];l["&"]=u;let d=this.resolveAvgField(l)||0;o+=d,s++,await this.state.itemResult.set(u,d)}else if(n.type==="delete"&&n.recordName===this.relation.name){let c=await this.state.itemResult.get(n.record);o=o-c,s--}else if(n.type==="update"){let c=await this.controller.system.storage.findOne(this.relation.name,g.atom({key:e.relatedAttribute.slice(2).concat("id").join("."),value:["=",n.oldRecord.id]}),void 0,this.relationAttributeQuery),u=c[this.isSource?"target":"source"];u["&"]=c;let l=this.resolveAvgField(u)||0,d=await this.state.itemResult.get(c)||0;await this.state.itemResult.set(c,l),o+=l-d}return await this.state.count.set(e.record,s),s>0?o/s:0}},Vr=[_r,Br];var xe=class{constructor(t,e,r){this.controller=t;this.args=e;this.dataContext=r;this.state={};this.dataDeps={};this.useLastValue=e.useLastValue!==void 0?e.useLastValue:!0,e.dataDeps&&(this.dataDeps=e.dataDeps),e.compute&&(this.computeCallback=e.compute,this.compute=async(...i)=>{if(this.computeCallback){let[n,s]=i,o={controller:this.controller,state:this.state,getState:c=>this.state[c]};return await this.computeCallback.call(o,n,s)}}),e.incrementalCompute&&(this.incrementalComputeCallback=e.incrementalCompute,this.incrementalCompute=async(...i)=>{if(this.incrementalComputeCallback){let[n,s,o,c]=i,u={controller:this.controller,state:this.state,getState:l=>this.state[l]};return await this.incrementalComputeCallback.call(u,n,s,o,c)}return _.fullRecompute("No incrementalCompute defined")},this.incrementalComputeCallback=e.incrementalCompute),e.incrementalPatchCompute&&(this.incrementalPatchComputeCallback=e.incrementalPatchCompute,this.incrementalPatchCompute=async(...i)=>{if(this.incrementalPatchComputeCallback){let[n,s,o,c]=i,u={controller:this.controller,state:this.state,getState:l=>this.state[l]};return await this.incrementalPatchComputeCallback.call(u,n,s,o,c)}}),e.createState&&(this.createStateCallback=e.createState),e.getDefaultValue&&(this.getDefaultValueCallback=e.getDefaultValue),e.asyncReturn&&(this.asyncReturnCallback=e.asyncReturn,this.asyncReturn=async(...i)=>{if(this.asyncReturnCallback){let[n,s,o]=i,c={controller:this.controller,state:this.state,getState:u=>this.state[u]};return await this.asyncReturnCallback.call(c,n,s,o)}}),this.createStateCallback&&(this.state=this.createStateCallback.call(this.controller),Object.entries(this.state).forEach(([i,n])=>{n.key=i,n.controller=this.controller}))}static{this.computationType=le}createState(){if(this.createStateCallback){let t=this.createStateCallback.call(this.controller);return Object.entries(t).forEach(([e,r])=>{r.key=e,r.controller=this.controller}),t}return{}}getDefaultValue(){if(this.getDefaultValueCallback)return this.getDefaultValueCallback.call(this.controller)}async compute(...t){if(this.computeCallback){let[e,r]=t,i={controller:this.controller,state:this.state,getState:n=>this.state[n]};return await this.computeCallback.call(i,e,r)}return _.skip()}},Fr=class extends xe{static{this.contextType="global"}},Lr=class extends xe{static{this.contextType="entity"}},Or=class extends xe{static{this.contextType="relation"}},Qr=class extends xe{static{this.contextType="property"}constructor(t,e,r){if(e.dataDeps){let i=Object.keys(e.dataDeps).filter(n=>e.dataDeps[n].type==="records");T(i.length===0,`property-level custom computation dataDeps should not contain "records\u201D type dataDeps, but got ${i.join(", ")}
If you want to use related entity/relation as dataDeps, please use "property" type dataDeps with args: { type: "property", attributeQuery: [attributeQuery] }
If you want to use aggregated data from all records in the entity/relation, you should define a different dict value to store the aggregated data, and then use the dict value as dataDeps.
`)}super(t,e,r)}},$r=[Fr,Lr,Or,Qr];var ma=class{constructor(t){this.controller=t;this.sourceMaps=[];this.sourceMapTree={}}initialize(t){let e=[];for(let r of t)if(this.isDataBasedComputation(r)){if(e.push(...Object.entries(r.dataDeps).map(([i,n])=>this.convertDataDepToERMutationEventsSourceMap(i,n,r)).flat()),r.dataContext.type==="property"&&Object.values(r.dataDeps).some(i=>i.type==="global")){let i={type:"records",source:r.dataContext.host};e.push(...this.convertDataDepToERMutationEventsSourceMap("_self",i,r,"create"))}}else{let i={type:"records",source:Mt,attributeQuery:["*"]};e.push(...this.convertDataDepToERMutationEventsSourceMap("record",i,r,"create"))}this.sourceMaps=[...e],this.sourceMapTree=this.buildDataSourceMapTree(this.sourceMaps)}isDataBasedComputation(t){return t.compute!==void 0}addSourceMap(t){this.sourceMaps.push(t),this.addToTree(t)}addSourceMaps(t){this.sourceMaps.push(...t),t.forEach(e=>this.addToTree(e))}findSourceMapsForMutation(t){return this.sourceMapTree[t.recordName]?.[t.type]||[]}shouldTriggerUpdateComputation(t,e){return t.type!=="update"?!0:t.dataDep.type==="global"&&e.recordName===rt?e.record?.concept===ct&&e.record?.key===t.dataDep.source.name:!t.attributes.filter(i=>i!=="id").every(i=>!e.record.hasOwnProperty(i)||e.record[i]===e.oldRecord[i])}convertDataDepToERMutationEventsSourceMap(t,e,r,i,n=!1){let s=[];if(e.type==="records")(!i||i==="create")&&s.push({dataDep:e,type:"create",recordName:e.source.name,sourceRecordName:e.source.name,computation:r,isInitial:n}),(!i||i==="delete")&&s.push({dataDep:e,type:"delete",recordName:e.source.name,sourceRecordName:e.source.name,computation:r}),(!i||i==="update")&&e.attributeQuery&&s.push(...this.convertAttrsToERMutationEventsSourceMap(e,e.source.name,e.attributeQuery,[],r,!1));else if(e.type==="property"){let o=r.dataContext;e.attributeQuery&&s.push(...this.convertAttrsToERMutationEventsSourceMap(e,o.host.name,e.attributeQuery,[],r,!0))}else e.type==="global"&&((!i||i==="update")&&s.push({dataDep:e,type:"update",recordName:rt,sourceRecordName:rt,attributes:["value"],computation:r}),(!i||i==="create")&&s.push({dataDep:e,type:"create",recordName:rt,sourceRecordName:rt,computation:r}));return s}convertAttrsToERMutationEventsSourceMap(t,e,r,i,n,s=!1){let o=[],c=[],u=[];if(r.forEach(l=>{if(typeof l=="string"&&l!=="*")c.push(l);else if(l!=="*")if(Array.isArray(l))u.push(l);else throw new Error(`unknown attribute type: ${l}`)}),c.length>0){let l=e;i.length>0&&(i.at(-1)==="&"?l=this.controller.system.storage.getRelationName(e,i.slice(0,-1).join(".")):l=this.controller.system.storage.getEntityName(e,i.join("."))),s&&o.push({dataDep:t,type:"create",recordName:l,sourceRecordName:e,targetPath:i,computation:n}),o.push({dataDep:t,type:"update",recordName:l,sourceRecordName:e,targetPath:i,attributes:c,computation:n})}return u.forEach(([l,d])=>{o.push(...this.convertRelationAttrToERMutationEventsSourceMap(t,e,d.attributeQuery,i.concat(l),n))}),o}convertRelationAttrToERMutationEventsSourceMap(t,e,r,i,n){let s=[];if(i.at(-1)!=="&"){let o=this.controller.system.storage.getRelationName(e,i.join("."));s.push({dataDep:t,type:"create",recordName:o,sourceRecordName:e,isRelation:!0,targetPath:i,computation:n},{dataDep:t,type:"delete",recordName:o,sourceRecordName:e,isRelation:!0,targetPath:i,computation:n})}return r.length>0&&s.push(...this.convertAttrsToERMutationEventsSourceMap(t,e,r,i,n)),s}getAllSourceMaps(){return[...this.sourceMaps]}getSourceMapsByRecordName(t){return this.sourceMaps.filter(e=>e.recordName===t||e.sourceRecordName===t)}clear(){this.sourceMaps=[],this.sourceMapTree={}}getSourceMapTree(){let t={};for(let[e,r]of Object.entries(this.sourceMapTree)){t[e]={};for(let[i,n]of Object.entries(r))t[e][i]=[...n]}return t}buildDataSourceMapTree(t){let e={};return t.forEach(r=>{this.addToTree(r,e)}),e}addToTree(t,e){let r=e||this.sourceMapTree;r[t.recordName]||(r[t.recordName]={}),r[t.recordName][t.type]||(r[t.recordName][t.type]=[]),r[t.recordName][t.type].push(t)}};var qr="_ASYNC_TASK_",ya=class{constructor(t,e,r,i,n){this.controller=t;this.computations=new Set;this.computationHandleMap=new Map;this.erMutationEventSources=[];this.dataSourceMapTree={};this.sourceMapManager=new ma(this.controller),this.buildComputationHandleMap(n);let s=[];e.forEach(o=>{o.computation&&s.push({dataContext:{type:"entity",id:o},args:o.computation}),o.properties?.forEach(c=>{c.computation&&s.push({dataContext:{type:"property",host:o,id:c},args:c.computation})})}),r.forEach(o=>{let c=o;c.computation&&s.push({dataContext:{type:"relation",id:o},args:c.computation}),c.properties&&c.properties.forEach(u=>{u.computation&&s.push({dataContext:{type:"property",host:o,id:u},args:u.computation})})}),i.forEach(o=>{o.computation&&s.push({dataContext:{type:"global",id:o.name},args:o.computation})});for(let o of s){let c=o.dataContext,u=o.args,l=this.computationHandleMap.get(u.constructor);T(!!l,`cannot find Computation handle map for ${u.constructor.displayName||u.constructor.name}`);let d=l[c.type];T(!!d,`cannot find Computation handle for ${u.constructor.displayName||u.constructor.name} with context type ${c.type}`);let h=new d(this.controller,u,c);if(this.computations.add(h),this.isAsyncComputation(h)){if(h.dataContext.type==="property"){let f=Q.create({name:this.getAsyncTaskRecordKey(h),properties:[x.create({name:"status",type:"string"}),x.create({name:"args",type:"json"}),x.create({name:"result",type:"json"})]}),I=q.create({name:`${f.name}_${h.dataContext.host.name}_${h.dataContext.id.name}`,source:f,target:h.dataContext.host,sourceProperty:"record",targetProperty:`_${h.dataContext.id.name}_task`,type:"1:1"});e.push(f),r.push(I)}else if(h.dataContext.type==="global"){let f=Q.create({name:this.getAsyncTaskRecordKey(h),properties:[x.create({name:"status",type:"string"}),x.create({name:"args",type:"json"}),x.create({name:"result",type:"json"}),x.create({name:"globalKey",type:"string"})]});e.push(f)}else if(h.dataContext.type==="entity"){let f=h.dataContext,I=Q.create({name:this.getAsyncTaskRecordKey(h),properties:[x.create({name:"status",type:"string"}),x.create({name:"args",type:"json"}),x.create({name:"result",type:"json"}),x.create({name:"entityName",type:"string"})]});e.push(I)}else if(h.dataContext.type==="relation"){let f=h.dataContext,I=Q.create({name:this.getAsyncTaskRecordKey(h),properties:[x.create({name:"status",type:"string"}),x.create({name:"args",type:"json"}),x.create({name:"result",type:"json"}),x.create({name:"relationName",type:"string"})]});e.push(I)}}}}buildComputationHandleMap(t){for(let e of t){let r=e;if(r.computationType&&r.contextType){this.computationHandleMap.has(r.computationType)||this.computationHandleMap.set(r.computationType,{});let i=this.computationHandleMap.get(r.computationType);if(Array.isArray(r.contextType))for(let n of r.contextType)T(!i[n],`${n} for ${r.computationType.name} is already registered.`),i[n]=e;else i[r.contextType]=e}}}getBoundStateName(t,e,r){return`_${t.type==="property"?`${t.host.name}_${t.id.name}`:t.type==="entity"||t.type==="relation"?t.id.name:t.id}_bound_${e}`}createStates(){let t=[];for(let e of this.computations)if(e.createState){let r=e.createState();t.push({dataContext:e.dataContext,state:r}),e.state=r;for(let[i,n]of Object.entries(r))if(n.controller=this.controller,n.key=this.getBoundStateName(e.dataContext,i,n),n instanceof P&&!n.record)if(e.dataContext.type==="property")n.record=e.dataContext.host.name;else if(e.dataContext.type==="entity")n.record=e.dataContext.id.name;else if(e.dataContext.type==="relation")n.record=e.dataContext.id.name;else throw new Error(`global data context ${e.dataContext.id} must specify record name for RecordBoundState`)}return t}async setupDefaultValues(){for(let t of this.computations)if(t.getDefaultValue)if(t.dataContext.type==="global"||t.dataContext.type==="entity"||t.dataContext.type==="relation"){let e=await t.getDefaultValue();await this.controller.applyResult(t.dataContext,e)}else{let e=t.dataContext;T(!e.id.defaultValue,`${e.host.name}.${e.id.name} property shuold not has a defaultValue, because it will be overridden by computation`),this.controller.system.storage.listen(async r=>{for(let i of r)if(i.type==="create"&&i.recordName===e.host.name){let n=await t.getDefaultValue?.(i.record);n!==void 0&&await this.controller.applyResult(e,n,i.record)}})}}async setupStateDefaultValues(){for(let t of this.computations){let e=t;if(e.state)for(let r of Object.values(e.state))r instanceof J&&(r.controller=this.controller,await this.controller.system.storage.set(ct,r.key,r.defaultValue??null))}}async setupMutationListeners(){this.sourceMapManager.initialize(this.computations),this.dataSourceMapTree=this.sourceMapManager.getSourceMapTree(),this.controller.system.storage.listen(async t=>{for(let e of t){let r=this.sourceMapManager.findSourceMapsForMutation(e);if(r.length>0)for(let i of r)this.sourceMapManager.shouldTriggerUpdateComputation(i,e)&&await this.runDirtyRecordsComputation(i,e)}})}async computeDirtyDataDepRecords(t,e){if(!t.targetPath?.length)return[e.oldRecord??e.record];let r=[];if(!t.isRelation)T(t.type==="update","only support update event for entity"),r=await this.controller.system.storage.find(t.sourceRecordName,g.atom({key:t.targetPath.concat("id").join("."),value:["=",e.oldRecord.id]}),void 0);else{T(t.type==="create"||t.type==="delete","only support create/delete event for relation");let i=t.dataDep;if(t.type==="create")r=await this.controller.system.storage.find(t.sourceRecordName,g.atom({key:t.targetPath.concat(["&","id"]).join("."),value:["=",e.record.id]}),void 0);else{let n=this.controller.relations.find(o=>o.name===t.recordName);if(n.sourceProperty===n.targetProperty&&n.source===n.target)r=await this.controller.system.storage.find(t.sourceRecordName,g.atom({key:t.targetPath.slice(0,-1).concat("id").join("."),value:["in",[e.record.source.id,e.record.target.id]]}),void 0);else{let o=n?.sourceProperty===t.targetPath.at(-1);r=await this.controller.system.storage.find(t.sourceRecordName,g.atom({key:t.targetPath.slice(0,-1).concat("id").join("."),value:["=",e.record[o?"source":"target"].id]}),void 0)}}}return r}computeOldRecord(t,e,r){return e.targetPath?.length?{...t}:r.oldRecord}async computeDataBasedDirtyRecordsAndEvents(t,e){let r=[];if(t.dataDep.type==="global"&&e.recordName===rt)if(t.computation.dataContext.type==="property"){let i=t.computation.dataContext;r=(await this.controller.system.storage.find(i.host.name,g.atom({key:"id",value:["not",null]}),{},["*"])).map(s=>[s,{dataDep:t.dataDep,type:"update",recordName:i.host.name,record:s,oldRecord:s,relatedMutationEvent:e}])}else t.computation.dataContext.type==="global"&&(r=[[null,{dataDep:t.dataDep,...e}]]);else t.targetPath?.length?r=(await this.computeDirtyDataDepRecords(t,e)).map(n=>[n,{dataDep:t.dataDep,type:"update",recordName:t.sourceRecordName,record:n,oldRecord:this.computeOldRecord(n,t,e),relatedAttribute:t.targetPath,relatedMutationEvent:e}]):r=[[e.record,{dataDep:t.dataDep,...e}]];return r}async computeEventBasedDirtyRecordsAndEvents(t,e){let r=t.computation;if(r.computeDirtyRecords){let i=await r.computeDirtyRecords(e)||[];return i=Array.isArray(i)?i:[i],i.filter(Boolean).map(n=>[n,{dataDep:t.dataDep,...e}])}else return[[null,{dataDep:t.dataDep,...e}]]}isDataBasedComputation(t){return t.compute!==void 0}async runDirtyRecordsComputation(t,e){try{if(t.isInitial)await this.runComputation(t.computation,e,e.record,!0);else{let r=[];try{this.isDataBasedComputation(t.computation)?r=await this.computeDataBasedDirtyRecordsAndEvents(t,e):r=await this.computeEventBasedDirtyRecordsAndEvents(t,e)}catch(i){throw new K("Failed to compute dirty records and events",{handleName:t.computation.constructor.name,computationName:t.computation.args.constructor.displayName,dataContext:t.computation.dataContext,computationPhase:"dirty-records-computation",causedBy:i instanceof Error?i:new Error(String(i))})}for(let[i,n]of r)try{await this.runComputation(t.computation,n,i)}catch(s){throw new K("Failed to run computation for dirty record",{handleName:t.computation.constructor.name,computationName:t.computation.args.constructor.displayName,dataContext:t.computation.dataContext,computationPhase:"batch-computation",context:{recordId:i?.id},causedBy:s instanceof Error?s:new Error(String(s))})}}}catch(r){throw r instanceof K?r:new Et("Unexpected error in dirty records computation",{schedulingPhase:"dirty-records-processing",failedComputations:[t.computation.args.constructor.displayName],causedBy:r instanceof Error?r:new Error(String(r))})}}getAsyncTaskRecordKey(t){if(t.dataContext.type==="property"){let e=t.dataContext;return`${qr}_${e.host.name}_${e.id.name}`}else return t.dataContext.type==="global"?`${qr}_${t.dataContext.id}`:`${qr}_${t.dataContext.type}_${t.dataContext.id?.name||t.dataContext.id}`}async createAsyncTask(t,e,r,i){if(t.dataContext.type==="property")return this.controller.system.storage.create(this.getAsyncTaskRecordKey(t),{status:i===void 0?"pending":"success",args:e,record:r,result:i});if(t.dataContext.type==="global")return this.controller.system.storage.create(this.getAsyncTaskRecordKey(t),{status:i===void 0?"pending":"success",args:e,globalKey:t.dataContext.id,result:i});if(t.dataContext.type==="entity"){let n=t.dataContext;return this.controller.system.storage.create(this.getAsyncTaskRecordKey(t),{status:i===void 0?"pending":"success",args:e,entityName:n.id.name,result:i})}else if(t.dataContext.type==="relation"){let n=t.dataContext;return this.controller.system.storage.create(this.getAsyncTaskRecordKey(t),{status:i===void 0?"pending":"success",args:e,relationName:n.id.name,result:i})}else throw new Error(`Async computation for ${t.dataContext.type} is not implemented yet`)}async handleAsyncReturn(t,e){let r=t.dataContext.type==="property"?["*",["record",{attributeQuery:["id"]}]]:["*"],i=await this.controller.system.storage.findOne(this.getAsyncTaskRecordKey(t),g.atom({key:"id",value:["=",e.id]}),{},r);if(i.status==="success"){let n=await t.asyncReturn(i.result,i.args);t.dataContext.type==="global"?t.incrementalPatchCompute?await this.controller.applyResultPatch(t.dataContext,n):await this.controller.applyResult(t.dataContext,n):t.dataContext.type==="property"?t.incrementalPatchCompute?await this.controller.applyResultPatch(t.dataContext,n,i.record):await this.controller.applyResult(t.dataContext,n,i.record):(t.dataContext.type==="entity"||t.dataContext.type==="relation")&&(t.incrementalPatchCompute?await this.controller.applyResultPatch(t.dataContext,n):await this.controller.applyResult(t.dataContext,n))}}isAsyncComputation(t){return t.asyncReturn!==void 0}async runComputation(t,e,r,i=!1){try{let n,s={};try{s=t.dataDeps?await this.resolveDataDeps(t,r):{}}catch(o){throw new Rt("Failed to resolve computation data dependencies",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,causedBy:o instanceof Error?o:new Error(String(o))})}try{if(i||!t.incrementalCompute&&!t.incrementalPatchCompute)n=await t.compute(s,r);else{if(t.incrementalCompute){let o;if(t.useLastValue)try{o=await this.controller.retrieveLastValue(t.dataContext,r)}catch(c){throw new me("Failed to retrieve last value for incremental computation",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,causedBy:c instanceof Error?c:new Error(String(c))})}n=await t.incrementalCompute(o,e,r,s)}else if(t.incrementalPatchCompute){let o;if(t.useLastValue)try{o=await this.controller.retrieveLastValue(t.dataContext,r)}catch(c){throw new me("Failed to retrieve last value for incremental patch computation",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,causedBy:c instanceof Error?c:new Error(String(c))})}n=await t.incrementalPatchCompute(o,e,r,s)}else throw new K(`Unknown computation type: ${t.constructor.name}`,{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,computationPhase:"type-validation"});if(n instanceof _e){let o=t;if(!o.compute)throw new K("compute must be defined for computation when incrementalCompute returns ComputationResultFullRecompute",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,computationPhase:"fallback-compute"});n=await o.compute(s,r)}}}catch(o){throw o instanceof K?o:new K("Computation execution failed",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,computationPhase:"execution",causedBy:o instanceof Error?o:new Error(String(o))})}if(n instanceof Ot)return;if(n instanceof Be)try{return await this.createAsyncTask(t,n.args,r)}catch(o){throw new K("Failed to create async task",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,computationPhase:"async-task-creation",causedBy:o instanceof Error?o:new Error(String(o))})}try{let o=n instanceof Ve?await t.asyncReturn(n.result,n.args):n;t.incrementalPatchCompute?await this.controller.applyResultPatch(t.dataContext,o,r):await this.controller.applyResult(t.dataContext,o,r)}catch(o){throw new K("Failed to apply computation result",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,computationPhase:"result-application",causedBy:o instanceof Error?o:new Error(String(o))})}}catch(n){throw n instanceof K?n:new K("Unexpected error during computation execution",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,computationPhase:"top-level",causedBy:n instanceof Error?n:new Error(String(n))})}}async resolveDataDeps(t,e){if(t.dataDeps)try{let r=await Promise.all(Object.entries(t.dataDeps).map(async([i,n])=>{try{if(n.type==="records")return await this.controller.system.storage.find(n.source.name,void 0,{},n.attributeQuery);if(n.type==="property"){if(!e?.id)throw new Rt("Record ID is required for property data dependency",{depName:i,depType:n.type,missingData:!0,handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext});return this.controller.system.storage.findOne(t.dataContext.host.name,g.atom({key:"id",value:["=",e.id]}),{},n.attributeQuery)}else{if(n.type==="global")return await this.controller.system.storage.get(ct,n.source.name);throw new Rt(`Unknown data dependency type: ${n.type}`,{depName:i,depType:n.type,invalidData:!0,handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext})}}catch(s){throw s instanceof Rt?s:new Rt(`Failed to resolve data dependency '${i}'`,{depName:i,depType:n.type,handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,causedBy:s instanceof Error?s:new Error(String(s))})}}));return Object.fromEntries(Object.entries(t.dataDeps).map(([i],n)=>[i,r[n]]))}catch(r){throw r instanceof Rt?r:new Rt("Failed to resolve computation data dependencies",{handleName:t.constructor.name,computationName:t.args.constructor.displayName,dataContext:t.dataContext,causedBy:r instanceof Error?r:new Error(String(r))})}else return{}}async setupGlobalDict(){let t=this.controller.dict.filter(e=>e.defaultValue!==void 0);for(let e of t)await this.controller.system.storage.set(ct,e.name,e.defaultValue())}async setup(){try{try{await this.setupDefaultValues()}catch(t){throw new Et("Failed to setup computation default values",{schedulingPhase:"default-values-setup",causedBy:t instanceof Error?t:new Error(String(t))})}try{await this.setupStateDefaultValues()}catch(t){throw new Et("Failed to setup computation state default values",{schedulingPhase:"state-default-values-setup",causedBy:t instanceof Error?t:new Error(String(t))})}try{await this.setupMutationListeners()}catch(t){throw new Et("Failed to setup mutation listeners for computations",{schedulingPhase:"mutation-listeners-setup",causedBy:t instanceof Error?t:new Error(String(t))})}try{await this.setupGlobalDict()}catch(t){throw new Et("Failed to setup global dictionary",{schedulingPhase:"global-dict-setup",causedBy:t instanceof Error?t:new Error(String(t))})}}catch(t){throw t instanceof Et?t:new Et("Unexpected error during scheduler setup",{schedulingPhase:"top-level-setup",causedBy:t instanceof Error?t:new Error(String(t))})}}};var Ur="User",ee=class a{constructor(t){this.name=t.name,this.record=t.record,this.content=t.content}static create(t){return new a(t)}},ga=class{constructor(t){this.recordNameToSideEffects=new Map;this.globals={BoolExp:L,MatchExp:g};this.dict=[];this.recordMutationSideEffects=[];this.callbacks=new Map;let{system:e,entities:r=[],relations:i=[],activities:n=[],interactions:s=[],dict:o=[],recordMutationSideEffects:c=[],computations:u=[],ignorePermission:l=!1,forceThtrowInteractionError:d=!1}=t;this.system=e,this.ignorePermission=l,this.forceThtrowInteractionError=d,this.entities=[...r],this.relations=[...i],this.activities=[...n],this.interactions=[...s],this.dict=[...o],this.recordMutationSideEffects=[...c],this.activityManager=new fa(this,n,s);let h=[...Ar,...Sr,...Er,...Ir,...yr,...Mr,...Vr,...Tr,...hr,...$r,...u];this.scheduler=new ya(this,this.entities,this.relations,this.dict,h),c.forEach(f=>{let I=this.recordNameToSideEffects.get(f.record.name);I||this.recordNameToSideEffects.set(f.record.name,I=new Set),I.add(f)})}async setup(t){let e=this.scheduler.createStates();await this.system.setup(this.entities,this.relations,e,t),await this.scheduler.setup()}async applyResult(t,e,r){if(!(e instanceof Ot)){if(t.type==="global")return this.system.storage.set(ct,t.id,e);if(t.type==="entity"){if(e==null)return;let i=t;await this.system.storage.delete(i.id.name,L.atom({key:"id",value:["not",null]}));let n=Array.isArray(e)?e:[e];for(let s of n)await this.system.storage.create(i.id.name,s)}else if(t.type==="relation"){if(e==null)return;let i=t;await this.system.storage.delete(i.id.name,L.atom({key:"id",value:["not",null]}));let n=Array.isArray(e)?e:[e];for(let s of n)await this.system.storage.create(i.id.name,s)}else{let i=t;await this.system.storage.update(i.host.name,L.atom({key:"id",value:["=",r.id]}),{[i.id.name]:e})}}}async retrieveLastValue(t,e){if(t.type==="global")return this.system.storage.get(ct,t.id);if(t.type==="entity"||t.type==="relation")return this.system.storage.find(t.id.name,void 0,void 0,["*"]);{let r=t;return e[r.id.name]?e[r.id.name]:(await this.system.storage.findOne(r.host.name,L.atom({key:"id",value:["=",e.id]}),void 0,["*"]))[r.id.name]}}async applyResultPatch(t,e,r){if(e instanceof Ot||e===void 0)return;let i=Array.isArray(e)?e:[e];for(let n of i){if(t.type==="global")return this.system.storage.set(ct,t.id,n);if(t.type==="entity"||t.type==="relation"){let s=t;if(n.type==="insert")await this.system.storage.create(s.id.name,n.data);else if(n.type==="update"){let o=g.atom({key:"id",value:["=",n.affectedId]});await this.system.storage.update(s.id.name,o,n.data)}else if(n.type==="delete"){let o=g.atom({key:"id",value:["=",n.affectedId]});await this.system.storage.delete(s.id.name,o)}}else{let s=t;n.type==="insert"?await this.system.storage.update(s.host.name,L.atom({key:"id",value:["=",r.id]}),{[s.id.name]:n.data}):n.type==="update"?await this.system.storage.update(s.host.name,L.atom({key:"id",value:["=",r.id]}),{[s.id.name]:n.data}):n.type==="delete"&&await this.system.storage.update(s.host.name,L.atom({key:"id",value:["=",r.id]}),{[s.id.name]:null})}}}async callInteraction(t,e){try{let r=await this.activityManager.callInteraction(t,e);if(r.error&&this.forceThtrowInteractionError)throw r.error;return r}catch(r){throw new xt("Failed to call interaction",{interactionName:t,userId:e.user?.id,payload:e.payload,executionPhase:"callInteraction",causedBy:r instanceof Error?r:new Error(String(r))})}}async callActivityInteraction(t,e,r,i){try{let n=await this.activityManager.callActivityInteraction(t,e,r,i);if(n.error&&this.forceThtrowInteractionError)throw n.error;return n}catch(n){throw new xt("Failed to call activity interaction",{interactionName:e,userId:i.user?.id,payload:i.payload,executionPhase:"callActivityInteraction",context:{activityName:t,activityId:r},causedBy:n instanceof Error?n:new Error(String(n))})}}async runRecordChangeSideEffects(t,e){let r=t.effects;for(let i of r||[]){let n=this.recordNameToSideEffects.get(i.recordName);if(n)for(let s of n)try{if(s instanceof ee)t.sideEffects[s.name]={result:await s.content(i)};else{let o=s;o.name&&typeof o.content=="function"&&(t.sideEffects[o.name]={result:await o.content(i)})}}catch(o){let c="unknown";s instanceof ee?c=s.name:c=s.name||"unknown",e.error({label:"recordMutationSideEffect",message:c}),t.sideEffects[c]={error:o}}}}addEventListener(t,e){this.callbacks.has(t)||this.callbacks.set(t,new Set),this.callbacks.get(t).add(e)}};var un={};var ln={trace:console.trace,debug:console.debug,info:console.info,warn:console.warn,error:console.error,fatal:console.error,child:()=>ln,level:"info"},jr=()=>ln;jr.default=jr;var Re=jr;var Gr=class{constructor(t){this.db=t}setup(){return this.db.scheme("CREATE Table IF NOT EXISTS _IDS_ (last INTEGER, name TEXT)")}async getAutoId(t){let e=(await this.db.query(`SELECT last FROM _IDS_ WHERE name = '${t}'`,[],`finding last id of ${t}`))[0]?.last,r=(e||0)+1,i=`set last id for ${t}: ${r}`;return e===void 0?await this.db.scheme(`INSERT INTO _IDS_ (name, last) VALUES ('${t}', ${r})`,i):await this.db.update("UPDATE _IDS_ SET last = ? WHERE name = ?",[r,t],void 0,i),r}},ba=class{constructor(t=":memory:",e){this.file=t;this.options=e;this.idSystem=new Gr(this),this.logger=this.options?.logger||Re()}async open(){this.db=new un(this.file,this.options),await this.idSystem.setup()}async query(t,e=[],r=""){let i=st.getStore(),n=this.logger.child(i?.logContext||{}),s=e.map(o=>o===!1?0:o===!0?1:o);return n.info({type:"query",name:r,sql:t,params:s}),this.db.prepare(t).all(...s)}async update(t,e,r,i=""){let n=st.getStore(),s=this.logger.child(n?.logContext||{}),o=`${t} ${r?`RETURNING ${r} AS id`:""}`,c=e.map(u=>typeof u=="object"&&u!==null?JSON.stringify(u):u===!1?0:u===!0?1:u);return s.info({type:"update",name:i,sql:o,params:c}),this.db.prepare(o).run(...c)}async insert(t,e,r=""){let i=st.getStore(),n=this.logger.child(i?.logContext||{}),s=e.map(o=>typeof o=="object"&&o!==null?JSON.stringify(o):o===!1?0:o===!0?1:o);return n.info({type:"insert",name:r,sql:t,params:s}),this.db.prepare(`${t} RETURNING ${Pt}`).run(...s)}async delete(t,e,r=""){let i=st.getStore(),n=this.logger.child(i?.logContext||{}),s=e.map(o=>o===!1?0:o===!0?1:o);return n.info({type:"delete",name:r,sql:t,params:s}),this.db.prepare(t).run(...s)}async scheme(t,e=""){let r=st.getStore();return this.logger.child(r?.logContext||{}).info({type:"scheme",name:e,sql:t}),this.db.prepare(t).run()}async close(){return this.db.close()}async getAutoId(t){return this.idSystem.getAutoId(t)}parseMatchExpression(t,e,r,i,n,s,o){if(i==="JSON"&&e[0].toLowerCase()==="contains")return{fieldValue:`NOT NULL AND EXISTS (
    SELECT 1
    FROM json_each(${r})
    WHERE json_each.value = ${o()}
)`,fieldParams:[e[1]]}}mapToDBFieldType(t,e){return t==="pk"?"INTEGER PRIMARY KEY":t==="id"?"INT":e||t==="object"||t==="json"?"JSON":t==="string"?"TEXT":t==="boolean"?"INT(2)":t==="number"||t==="timestamp"?"INT":t}};function Ps(a){return encodeURI(JSON.stringify(a))}function Ms(a){return a===void 0?void 0:JSON.parse(decodeURI(a))}var Wr=class{constructor(t){this.db=t;this.callbacks=new Set}beginTransaction(t=""){return this.db.scheme("BEGIN",t)}commitTransaction(t=""){return this.db.scheme("COMMIT",t)}rollbackTransaction(t=""){return this.db.scheme("ROLLBACK",t)}async get(t,e,r){let i=g.atom({key:"key",value:["=",e]}).and({key:"concept",value:["=",t]}),n=(await this.queryHandle.findOne(rt,i,void 0,["value"]))?.value;return n===void 0?r:Ms(n)}async set(t,e,r,i){let n=g.atom({key:"key",value:["=",e]}).and({key:"concept",value:["=",t]});return await this.queryHandle.findOne(rt,n,void 0,["value"])?this.callWithEvents(this.queryHandle.update.bind(this.queryHandle),[rt,n,{concept:t,key:e.toString(),value:Ps(r)}],i):this.callWithEvents(this.queryHandle.create.bind(this.queryHandle),[rt,{concept:t,key:e.toString(),value:encodeURI(JSON.stringify(r))}],i)}async setup(t,e,r=!1){await this.db.open(r);let i=new la(t,e,this.db);r&&await i.createTables(),this.queryHandle=new ca(new ua(i.map),this.db),this.map=i.map}findOne(...t){return this.queryHandle.findOne(...t)}find(...t){return this.queryHandle.find(...t)}create(t,e,r){return this.callWithEvents(this.queryHandle.create.bind(this.queryHandle),[t,e],r)}update(t,e,r,i){return this.callWithEvents(this.queryHandle.update.bind(this.queryHandle),[t,e,r],i)}delete(t,e,r){return this.callWithEvents(this.queryHandle.delete.bind(this.queryHandle),[t,e],r)}async callWithEvents(t,e,r=[]){let i=await t(...e,r),n=await this.dispatch(r);return r.push(...n),i}findRelationByName(...t){return this.queryHandle.findRelationByName(...t)}findOneRelationByName(...t){return this.queryHandle.findOneRelationByName(...t)}updateRelationByName(t,e,r,i){return this.callWithEvents(this.queryHandle.updateRelationByName.bind(this.queryHandle),[t,e,r],i)}removeRelationByName(t,e,r){return this.callWithEvents(this.queryHandle.removeRelationByName.bind(this.queryHandle),[t,e],r)}addRelationByNameById(t,e,r,i={},n){return this.callWithEvents(this.queryHandle.addRelationByNameById.bind(this.queryHandle),[t,e,r,i],n)}getRelationName(...t){return this.queryHandle.getRelationName(...t)}getEntityName(...t){return this.queryHandle.getEntityName(...t)}listen(t){this.callbacks.add(t)}async dispatch(t){let e=[];for(let r of this.callbacks){let i=await r(t);i?.events&&e.push(...i.events)}return e}destroy(){return this.db.close()}};var zr=class a{constructor(t=0){this.level=t}info({type:t,name:e,sql:r,params:i}){this.level>=1&&console.log({type:t,name:e,sql:r,params:i})}error({type:t,name:e,sql:r,params:i,error:n}){this.level>=0&&console.error({type:t,name:e,sql:r,params:i,error:n})}child(){return new a(this.level)}};var Jr=class a{constructor(t=0){this.level=t}error({label:t,message:e,...r}){this.level>=0&&console.error(`[ERROR] ${t}: ${e}`,r)}info({label:t,message:e,...r}){this.level>=1&&console.info(`[INFO] ${t}: ${e}`,r)}debug({label:t,message:e,...r}){this.level>=2&&console.debug(`[DEBUG] ${t}: ${e}`,r)}child(t){return new a(this.level)}},UR=Re(),xa=new zr,_s=new Jr,Ia=class{constructor(t=new ba(void 0,{logger:xa}),e=_s){this.logger=e;this.conceptClass=new Map;this.storage=new Wr(t)}setup(t,e,r,i=!1){let n=new pe(t,e),{entities:s,relations:o}=n.getAll();return r.forEach(({dataContext:c,state:u})=>{Object.entries(u).forEach(([l,d])=>{if(d instanceof P){if(!d.record)return;let h=n.getEntityByName(d.record);if(h||(h=n.getRelationByName(d.record)),!h)throw new Error(`Entity or Relation not found: ${d.record}`);for(;h.baseEntity||h.baseRelation;)h=h.baseEntity||h.baseRelation;if(d.defaultValue instanceof x)d.defaultValue.name=d.key,h.properties.push(d.defaultValue);else{let f=typeof d.defaultValue;h.properties.push(x.create({name:d.key,type:f,collection:Array.isArray(d.defaultValue),defaultValue:()=>d.defaultValue}))}}})}),this.storage.setup([...s,tn],o,i)}destroy(){this.storage.destroy()}};var Hr=class{},Kr=class{},pn={Client:Hr,Pool:Kr};var{Client:rE}=pn;var Xr=class{constructor(t){this.db=t}setup(){return this.db.scheme("CREATE TABLE IF NOT EXISTS _IDS_ (last INTEGER, name TEXT)")}async getAutoId(t){let e=(await this.db.query(`SELECT last FROM _IDS_ WHERE name = '${t}'`,[],`finding last id of ${t}`))[0]?.last,r=(e||0)+1,i=`set last id for ${t}: ${r}`;return e===void 0?await this.db.insert("INSERT INTO _IDS_ (name, last) VALUES (?, ?)",[t,r],i):await this.db.update("UPDATE _IDS_ SET last = ? WHERE name = ?",[r,t],void 0,i),r}},Ra=class{constructor(t,e){this.d1=t;this.options=e;this.idSystem=new Xr(this),this.logger=this.options?.logger||xa}async checkSchemaVersionUpdate(){try{return!await this.d1.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='_System_' LIMIT 1").first()}catch{return!0}}async open(t){return t&&console.warn("forceDrop not supported in Cloudflare D1"),await this.idSystem.setup(),Promise.resolve()}async scheme(t,e){let r=this.logger;r.info({type:"scheme",name:e||"",sql:t});try{return await this.d1.prepare(t).run()}catch(i){throw r.error({type:"scheme",name:e||"",sql:t,error:String(i)}),i}}async query(t,e=[],r){let i=this.logger,n=e.map(s=>s===!1?0:s===!0?1:s);i.info({type:"query",name:r||"",sql:t,params:n});try{return(await(e.length>0?this.d1.prepare(t).bind(...n):this.d1.prepare(t)).all()).results}catch(s){throw i.error({type:"query",name:r||"",sql:t,params:n,error:String(s)}),s}}async delete(t,e,r){let i=this.logger,n=e.map(s=>s===!1?0:s===!0?1:s);i.info({type:"delete",name:r||"",sql:t,params:n});try{return await(e.length>0?this.d1.prepare(t).bind(...n):this.d1.prepare(t)).run()}catch(s){throw i.error({type:"delete",name:r||"",sql:t,params:n,error:String(s)}),s}}async insert(t,e,r){let i=this.logger,n=e.map(s=>typeof s=="object"&&s!==null?JSON.stringify(s):s===!1?0:s===!0?1:s);i.info({type:"insert",name:r||"",sql:t,params:n});try{let o=t.includes("_IDS_")?t:`${t} RETURNING ${Pt}`;return await(e.length>0?this.d1.prepare(o).bind(...n):this.d1.prepare(o)).run()}catch(s){throw i.error({type:"insert",name:r||"",sql:t,params:n,error:String(s)}),s}}async update(t,e,r,i){let n=this.logger,s=`${t} ${r?`RETURNING ${r} AS id`:""}`,o=e.map(c=>typeof c=="object"&&c!==null?JSON.stringify(c):c===!1?0:c===!0?1:c);n.info({type:"update",name:i||"",sql:s,params:o});try{return await(e.length>0?this.d1.prepare(s).bind(...o):this.d1.prepare(s)).run()}catch(c){throw n.error({type:"update",name:i||"",sql:s,params:o,error:String(c)}),c}}async getAutoId(t){return this.idSystem.getAutoId(t)}mapToDBFieldType(t,e){return t==="pk"?"INTEGER PRIMARY KEY":t==="id"?"INTEGER":e||t==="object"||t==="json"?"JSON":t==="string"?"TEXT":t==="boolean"||t==="number"||t==="timestamp"?"INTEGER":"TEXT"}parseMatchExpression(t,e,r,i,n,s,o){if(i==="JSON"&&e[0].toLowerCase()==="contains")return{fieldValue:`NOT NULL AND EXISTS (
    SELECT 1
    FROM json_each(${r})
    WHERE json_each.value = ${o()}
)`,fieldParams:[e[1]]}}async close(){return Promise.resolve()}};var ot=Q.create({name:"User",properties:[x.create({name:"id",type:"string"}),x.create({name:"username",type:"string"}),x.create({name:"password",type:"string"}),x.create({name:"email",type:"string"}),x.create({name:"name",type:"string"}),x.create({name:"points",type:"number"}),x.create({name:"role",type:"string"}),x.create({name:"createdAt",type:"number"}),x.create({name:"isDeleted",type:"boolean"})]}),mt=Q.create({name:"Dormitory",properties:[x.create({name:"id",type:"string"}),x.create({name:"name",type:"string"}),x.create({name:"capacity",type:"number"}),x.create({name:"floor",type:"number"}),x.create({name:"building",type:"string"}),x.create({name:"createdAt",type:"number",defaultValue:()=>Math.floor(Date.now()/1e3)}),x.create({name:"isDeleted",type:"boolean",defaultValue:()=>!1}),x.create({name:"occupiedBeds",type:"number",defaultValue:()=>0})]}),Fe=Q.create({name:"Bed",properties:[x.create({name:"id",type:"string"}),x.create({name:"bedNumber",type:"string"}),x.create({name:"isOccupied",type:"boolean",defaultValue:()=>!1}),x.create({name:"createdAt",type:"number",defaultValue:()=>Math.floor(Date.now()/1e3)})]}),ri=Q.create({name:"PointDeduction",properties:[x.create({name:"id",type:"string"}),x.create({name:"reason",type:"string"}),x.create({name:"points",type:"number"}),x.create({name:"description",type:"string"}),x.create({name:"createdAt",type:"number",defaultValue:()=>Math.floor(Date.now()/1e3)}),x.create({name:"createdBy",type:"string"})]}),$t=Q.create({name:"RemovalRequest",properties:[x.create({name:"id",type:"string"}),x.create({name:"reason",type:"string"}),x.create({name:"status",type:"string",defaultValue:()=>"pending"}),x.create({name:"createdAt",type:"number",defaultValue:()=>Math.floor(Date.now()/1e3)}),x.create({name:"processedAt",type:"number"}),x.create({name:"adminComment",type:"string"})]}),ei=q.create({name:"UserDormitoryLeaderRelation",source:ot,sourceProperty:"managedDormitory",target:mt,targetProperty:"dormitoryLeader",type:"1:1",properties:[x.create({name:"assignedAt",type:"number",defaultValue:()=>Math.floor(Date.now()/1e3)})]}),Bs=q.create({name:"DormitoryBedsRelation",source:mt,sourceProperty:"beds",target:Fe,targetProperty:"dormitory",type:"1:n",properties:[]}),ai=q.create({name:"UserBedRelation",source:ot,sourceProperty:"bed",target:Fe,targetProperty:"occupant",type:"1:1",properties:[x.create({name:"assignedAt",type:"number",defaultValue:()=>Math.floor(Date.now()/1e3)})]}),Vs=q.create({name:"UserPointDeductionsRelation",source:ot,sourceProperty:"pointDeductions",target:ri,targetProperty:"user",type:"1:n",properties:[]}),Fs=q.create({name:"UserRemovalRequestsRelation",source:ot,sourceProperty:"removalRequests",target:$t,targetProperty:"targetUser",type:"1:n",properties:[]}),Ls=q.create({name:"DormitoryLeaderRemovalRequestsRelation",source:ot,sourceProperty:"submittedRemovalRequests",target:$t,targetProperty:"requestedBy",type:"1:n",properties:[]}),Rv=vt.create({name:"totalUsers",type:"number",collection:!1}),Ev=vt.create({name:"totalDormitories",type:"number",collection:!1}),vv=vt.create({name:"totalOccupiedBeds",type:"number",collection:!1}),wv=vt.create({name:"totalAvailableBeds",type:"number",collection:!1}),Av=vt.create({name:"pendingRemovalRequests",type:"number",collection:!1}),Os=F.create({name:"CreateDormitory",action:V.create({name:"createDormitory"}),payload:O.create({items:[w.create({name:"name"}),w.create({name:"capacity"}),w.create({name:"floor"}),w.create({name:"building"})]})}),Va=F.create({name:"UpdateDormitory",action:V.create({name:"updateDormitory"}),payload:O.create({items:[w.create({name:"dormitoryId"}),w.create({name:"name",required:!1}),w.create({name:"floor",required:!1}),w.create({name:"building",required:!1})]})}),dn=F.create({name:"UpdateDormitoryCapacity",action:V.create({name:"updateDormitoryCapacity"}),payload:O.create({items:[w.create({name:"dormitoryId"}),w.create({name:"capacity"})]})}),hn=F.create({action:V.create({name:"deleteDormitory"}),name:"DeleteDormitory",payload:O.create({items:[w.create({name:"dormitoryId"})]})}),fn=F.create({action:V.create({name:"restoreDormitory"}),name:"RestoreDormitory",payload:O.create({items:[w.create({name:"dormitoryId"})]})}),ii=F.create({action:V.create({name:"assignDormitoryLeader"}),name:"AssignDormitoryLeader",payload:O.create({items:[w.create({name:"userId"}),w.create({name:"dormitoryId"})]})}),ni=F.create({action:V.create({name:"removeDormitoryLeader"}),name:"RemoveDormitoryLeader",payload:O.create({items:[w.create({name:"userId"})]})}),mn=F.create({action:V.create({name:"assignUserToBed"}),name:"AssignUserToBed",payload:O.create({items:[w.create({name:"userId"}),w.create({name:"bedId"})]})}),yn=F.create({action:V.create({name:"removeUserFromBed"}),name:"RemoveUserFromBed",payload:O.create({items:[w.create({name:"userId"})]})}),Fa=F.create({action:V.create({name:"processRemovalRequest"}),name:"ProcessRemovalRequest",payload:O.create({items:[w.create({name:"requestId"}),w.create({name:"decision"}),w.create({name:"adminComment",required:!1})]})}),gn=F.create({action:V.create({name:"deductPoints"}),name:"DeductPoints",payload:O.create({items:[w.create({name:"userId"}),w.create({name:"points"}),w.create({name:"reason"}),w.create({name:"description"})]})}),Qs=F.create({action:V.create({name:"createUser"}),name:"CreateUser",payload:O.create({items:[w.create({name:"username"}),w.create({name:"password"}),w.create({name:"email"}),w.create({name:"name"}),w.create({name:"role",required:!1})]})}),bn=F.create({action:V.create({name:"deleteUser"}),name:"DeleteUser",payload:O.create({items:[w.create({name:"userId"})]})}),$s=F.create({action:V.create({name:"submitRemovalRequest"}),name:"SubmitRemovalRequest",payload:O.create({items:[w.create({name:"userId"}),w.create({name:"reason"})]})}),In=F.create({action:V.create({name:"deductResidentPoints"}),name:"DeductResidentPoints",payload:O.create({items:[w.create({name:"userId"}),w.create({name:"points"}),w.create({name:"reason"}),w.create({name:"description"})]})}),qs=F.create({action:V.create({name:"viewMyDormitory"}),name:"ViewMyDormitory",payload:O.create({items:[]})}),Us=F.create({action:V.create({name:"viewMyPoints"}),name:"ViewMyPoints",payload:O.create({items:[]})}),si=F.create({action:V.create({name:"updateProfile"}),name:"UpdateProfile",payload:O.create({items:[w.create({name:"name",required:!1}),w.create({name:"email",required:!1})]})}),js=F.create({action:V.create({name:"login"}),name:"Login",payload:O.create({items:[w.create({name:"username"}),w.create({name:"password"})]})}),Gs=F.create({action:V.create({name:"registration"}),name:"Registration",payload:O.create({items:[w.create({name:"username"}),w.create({name:"password"}),w.create({name:"email"}),w.create({name:"name"})]})}),xn=F.create({action:V.create({name:"changePassword"}),name:"ChangePassword",payload:O.create({items:[w.create({name:"oldPassword"}),w.create({name:"newPassword"})]})}),Rn=F.create({action:V.create({name:"updateUsername"}),name:"UpdateUsername",payload:O.create({items:[w.create({name:"newUsername"})]})}),En=F.create({action:V.create({name:"restoreUser"}),name:"RestoreUser",payload:O.create({items:[w.create({name:"userId"})]})}),Ws=F.create({action:V.create({name:"getDormitories"}),name:"GetDormitories",payload:O.create({items:[w.create({name:"includeDeleted",required:!1})]})}),zs=F.create({action:V.create({name:"getDormitoryDetail"}),name:"GetDormitoryDetail",payload:O.create({items:[w.create({name:"dormitoryId"})]})}),Js=F.create({action:V.create({name:"getUsers"}),name:"GetUsers",payload:O.create({items:[w.create({name:"role",required:!1}),w.create({name:"dormitoryId",required:!1}),w.create({name:"includeDeleted",required:!1})]})}),Hs=F.create({action:V.create({name:"getRemovalRequests"}),name:"GetRemovalRequests",payload:O.create({items:[w.create({name:"status",required:!1}),w.create({name:"dormitoryId",required:!1})]})}),Ks=F.create({action:V.create({name:"getPointDeductions"}),name:"GetPointDeductions",payload:O.create({items:[w.create({name:"userId",required:!1}),w.create({name:"startDate",required:!1}),w.create({name:"endDate",required:!1})]})}),vn=F.create({action:V.create({name:"promoteToAdmin"}),name:"PromoteToAdmin",payload:O.create({items:[w.create({name:"userId"})]})}),wn=[ot,mt,Fe,ri,$t],An=[ei,Bs,ai,Vs,Fs,Ls];var Cn=[Os,Va,dn,hn,fn,ii,ni,mn,yn,Fa,gn,Qs,bn,En,vn,$s,In,qs,Us,si,js,Gs,xn,Rn,Ws,zs,Js,Hs,Ks];var Ea=G.create({name:"notExists",computeValue:()=>null}),Yr=G.create({name:"exists",computeValue:()=>({assignedAt:Math.floor(Date.now()/1e3)})});ei.computation=j.create({states:[Ea,Yr],transfers:[U.create({trigger:ii,current:Ea,next:Yr,computeTarget:function(a){return{source:{id:a.payload.userId},target:{id:a.payload.dormitoryId}}}}),U.create({trigger:ni,current:Yr,next:Ea,computeTarget:async function(a){return await this.system.storage.findOne(ei.name,g.atom({key:"source.id",value:["=",a.payload.userId]}),void 0,["id"])}})],defaultState:Ea});ot.computation=bt.create({record:Mt,callback:function(a){return a.interactionName==="CreateUser"?{username:a.payload.username,password:a.payload.password,email:a.payload.email,name:a.payload.name,points:100,role:a.payload.role||"resident",createdAt:Math.floor(Date.now()/1e3),isDeleted:!1}:a.interactionName==="Registration"?{username:a.payload.username,password:a.payload.password,email:a.payload.email,name:a.payload.name,points:100,role:"resident",createdAt:Math.floor(Date.now()/1e3),isDeleted:!1}:null}});mt.computation=bt.create({record:Mt,callback:function(a){if(a.interactionName==="CreateDormitory"){let t={name:a.payload.name,capacity:a.payload.capacity,floor:a.payload.floor,building:a.payload.building,createdAt:Math.floor(Date.now()/1e3),isDeleted:!1,occupiedBeds:0},e=[];for(let r=1;r<=a.payload.capacity;r++)e.push({bedNumber:`${r}`,isOccupied:!1,createdAt:Math.floor(Date.now()/1e3)});return{...t,beds:e}}return null}});ri.computation=bt.create({record:Mt,callback:function(a){return a.interactionName==="DeductPoints"||a.interactionName==="DeductResidentPoints"?{reason:a.payload.reason,points:a.payload.points,description:a.payload.description,createdAt:Math.floor(Date.now()/1e3),createdBy:a.user.id,user:{id:a.payload.userId}}:null}});$t.computation=bt.create({record:Mt,callback:function(a){return a.interactionName==="SubmitRemovalRequest"?{reason:a.payload.reason,status:"pending",createdAt:Math.floor(Date.now()/1e3),processedAt:null,adminComment:null,targetUser:{id:a.payload.userId},requestedBy:{id:a.user.id}}:null}});var va=G.create({name:"relationNotExists",computeValue:()=>null}),Zr=G.create({name:"relationExists",computeValue:()=>({assignedAt:Math.floor(Date.now()/1e3)})});ai.computation=j.create({states:[va,Zr],transfers:[U.create({trigger:mn,current:va,next:Zr,computeTarget:a=>({source:{id:a.payload.userId},target:{id:a.payload.bedId}})}),U.create({trigger:yn,current:Zr,next:va,computeTarget:async function(a){return await this.system.storage.findOne(ai.name,g.atom({key:"source.id",value:["=",a.payload.userId]}),void 0,["id"])}})],defaultState:va});var wa=G.create({name:"username",computeValue:(a,t)=>t?.interactionName==="UpdateUsername"?t.payload.newUsername:a});ot.properties.find(a=>a.name==="username").computation=j.create({states:[wa],transfers:[U.create({trigger:Rn,current:wa,next:wa,computeTarget:a=>({id:a.user.id})})],defaultState:wa});var Aa=G.create({name:"password",computeValue:(a,t)=>t?.interactionName==="ChangePassword"?t.payload.newPassword:a});ot.properties.find(a=>a.name==="password").computation=j.create({states:[Aa],transfers:[U.create({trigger:xn,current:Aa,next:Aa,computeTarget:a=>({id:a.user.id})})],defaultState:Aa});var Ca=G.create({name:"email",computeValue:(a,t)=>t?.interactionName==="UpdateProfile"&&t.payload.email?t.payload.email:a});ot.properties.find(a=>a.name==="email").computation=j.create({states:[Ca],transfers:[U.create({trigger:si,current:Ca,next:Ca,computeTarget:a=>({id:a.user.id})})],defaultState:Ca});var Sa=G.create({name:"name",computeValue:(a,t)=>t?.interactionName==="UpdateProfile"&&t.payload.name?t.payload.name:a});ot.properties.find(a=>a.name==="name").computation=j.create({states:[Sa],transfers:[U.create({trigger:si,current:Sa,next:Sa,computeTarget:a=>({id:a.user.id})})],defaultState:Sa});var Qt=G.create({name:"role",computeValue:(a,t)=>t?.interactionName==="AssignDormitoryLeader"?"dormitoryLeader":t?.interactionName==="RemoveDormitoryLeader"?"resident":t?.interactionName==="PromoteToAdmin"?"admin":a});ot.properties.find(a=>a.name==="role").computation=j.create({states:[Qt],transfers:[U.create({trigger:ii,current:Qt,next:Qt,computeTarget:a=>({id:a.payload.userId})}),U.create({trigger:ni,current:Qt,next:Qt,computeTarget:a=>({id:a.payload.userId})}),U.create({trigger:vn,current:Qt,next:Qt,computeTarget:a=>({id:a.payload.userId})})],defaultState:Qt});var Ee=G.create({name:"points",computeValue:(a,t)=>{if(t?.interactionName==="DeductPoints"||t?.interactionName==="DeductResidentPoints"){let e=typeof a=="number"?a:100,r=t.payload.points||0;return Math.max(0,e-r)}return typeof a=="number"?a:100}});ot.properties.find(a=>a.name==="points").computation=j.create({states:[Ee],transfers:[U.create({trigger:gn,current:Ee,next:Ee,computeTarget:a=>({id:a.payload.userId})}),U.create({trigger:In,current:Ee,next:Ee,computeTarget:a=>({id:a.payload.userId})})],defaultState:Ee});var ve=G.create({name:"isDeleted",computeValue:(a,t)=>t?.interactionName==="DeleteUser"?!0:t?.interactionName==="RestoreUser"?!1:typeof a=="boolean"?a:!1});ot.properties.find(a=>a.name==="isDeleted").computation=j.create({states:[ve],transfers:[U.create({trigger:bn,current:ve,next:ve,computeTarget:a=>({id:a.payload.userId})}),U.create({trigger:En,current:ve,next:ve,computeTarget:a=>({id:a.payload.userId})})],defaultState:ve});var ka=G.create({name:"building",computeValue:(a,t)=>t?.interactionName==="UpdateDormitory"&&t.payload.building?t.payload.building:a});mt.properties.find(a=>a.name==="building").computation=j.create({states:[ka],transfers:[U.create({trigger:Va,current:ka,next:ka,computeTarget:a=>({id:a.payload.dormitoryId})})],defaultState:ka});var Da=G.create({name:"capacity",computeValue:(a,t)=>{if(t?.interactionName==="UpdateDormitoryCapacity"&&t.payload.capacity){let e=t.payload.capacity;return e>=4&&e<=6?e:a}return a}});mt.properties.find(a=>a.name==="capacity").computation=j.create({states:[Da],transfers:[U.create({trigger:dn,current:Da,next:Da,computeTarget:a=>({id:a.payload.dormitoryId})})],defaultState:Da});var Ta=G.create({name:"floor",computeValue:(a,t)=>{if(t?.interactionName==="UpdateDormitory"&&t.payload.floor!==void 0){let e=t.payload.floor;if(typeof e=="number"&&e>0)return e}return a}});mt.properties.find(a=>a.name==="floor").computation=j.create({states:[Ta],transfers:[U.create({trigger:Va,current:Ta,next:Ta,computeTarget:a=>({id:a.payload.dormitoryId})})],defaultState:Ta});var Na=G.create({name:"name",computeValue:(a,t)=>t?.interactionName==="UpdateDormitory"&&t.payload.name?t.payload.name:a});mt.properties.find(a=>a.name==="name").computation=j.create({states:[Na],transfers:[U.create({trigger:Va,current:Na,next:Na,computeTarget:a=>({id:a.payload.dormitoryId})})],defaultState:Na});var Pa=G.create({name:"notDeleted",computeValue:()=>!1}),ti=G.create({name:"deleted",computeValue:()=>!0});mt.properties.find(a=>a.name==="isDeleted").defaultValue=void 0;mt.properties.find(a=>a.name==="isDeleted").computation=j.create({states:[Pa,ti],transfers:[U.create({trigger:hn,current:Pa,next:ti,computeTarget:a=>({id:a.payload.dormitoryId})}),U.create({trigger:fn,current:ti,next:Pa,computeTarget:a=>({id:a.payload.dormitoryId})})],defaultState:Pa});Fe.properties.find(a=>a.name==="isOccupied").defaultValue=void 0;Fe.properties.find(a=>a.name==="isOccupied").computation=le.create({name:"BedOccupancyChecker",dataDeps:{currentBed:{type:"property",attributeQuery:["id",["occupant",{attributeQuery:["id"]}]]}},compute:async function(a,t){return a.currentBed?.occupant!==void 0&&a.currentBed?.occupant!==null},getDefaultValue:function(){return!1}});mt.properties.find(a=>a.name==="occupiedBeds").defaultValue=void 0;mt.properties.find(a=>a.name==="occupiedBeds").computation=Nt.create({property:"beds",attributeQuery:["isOccupied"],callback:function(a){return a.isOccupied===!0}});$t.properties.find(a=>a.name==="status").defaultValue=void 0;var Ma=G.create({name:"status",computeValue:(a,t)=>{if(t?.interactionName==="ProcessRemovalRequest"){let e=t.payload.decision;if(e==="approve"||e==="approved")return"approved";if(e==="reject"||e==="rejected")return"rejected"}return a||"pending"}});$t.properties.find(a=>a.name==="status").computation=j.create({states:[Ma],transfers:[U.create({trigger:Fa,current:Ma,next:Ma,computeTarget:a=>({id:a.payload.requestId})})],defaultState:Ma});var _a=G.create({name:"processedAt",computeValue:(a,t)=>t?.interactionName==="ProcessRemovalRequest"?Math.floor(Date.now()/1e3):a||null});$t.properties.find(a=>a.name==="processedAt").computation=j.create({states:[_a],transfers:[U.create({trigger:Fa,current:_a,next:_a,computeTarget:a=>({id:a.payload.requestId})})],defaultState:_a});var Ba=G.create({name:"adminComment",computeValue:(a,t)=>t?.interactionName==="ProcessRemovalRequest"?t.payload.adminComment||null:a||null});$t.properties.find(a=>a.name==="adminComment").computation=j.create({states:[Ba],transfers:[U.create({trigger:Fa,current:Ba,next:Ba,computeTarget:a=>({id:a.payload.requestId})})],defaultState:Ba});var kn={};function Xs(a,t){if(!t.params)return a;if(t.useNamedParams){let e=t.params;return Object.fromEntries(Object.entries(a).map(([i,n])=>{let s=e[i];if(s===void 0)return[i,n];if(typeof s=="string"||n===void 0||n===null)return[i,n];if(typeof s=="function"){if(!s.fromValue)throw new Error("Invalid Class param type, missing fromValue");return[i,s.fromValue(n)]}else throw new Error("Invalid param type")}))}else{let e=t.params;return a.map((i,n)=>{let s=e[n];if(s===void 0||typeof s=="string"||i===void 0||i===null)return i;if(typeof s=="function"){if(!s.fromValue)throw new Error("Invalid Class param type, missing fromValue");return s.fromValue(i)}else throw new Error("Invalid param type")})}}function Bv(a,t={}){T(!a.params,"handle seems to be already an API");let{params:e,allowAnonymous:r=!1,useNamedParams:i=!1}=t;if(!i){let s=e||[];T(a.length<(s.length||0)+2,`Invalid params length, handle length: ${a.length}, params length: ${s.length}`)}let n=a;return n.params=e,n.allowAnonymous=r,n.useNamedParams=i,n}function Vv(a,t){kn[a]=t}async function Ys(a){let t=new Ra(a.DB),e=new ga({system:new Ia(t),entities:wn,relations:An,activities:[],interactions:Cn,dict:[],recordMutationSideEffects:[]});return await e.setup(await t.checkSchemaVersionUpdate()),e}var Le={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, x-user-id"};function Sn(a){return async(t,e)=>{let r={reqId:crypto.randomUUID()},i;return await st.run(r,async()=>{i=await a(t,e)}),i}}var Fv={async fetch(a,t){let{pathname:e}=new URL(a.url),{method:r,headers:i}=a;if(r==="OPTIONS")return new Response(null,{headers:Le});try{let n=await Ys(t);if(e==="/api/health"&&r==="GET")return Response.json({message:"ok"},{headers:Le});if(e==="/api/interaction"&&r==="POST"){let o=await Sn(async(c,u)=>{let l=await c.json(),{activity:d,activityId:h,interaction:f,payload:I,query:k}=l,E=i.get("x-user-id");if(!E)throw{statusCode:401,message:"Unauthorized"};let N=await u.system.storage.findOne(Ur,g.atom({key:"id",value:["=",E]}),void 0,["*"]);if(!N)throw{statusCode:500,message:"User not synced"};let X={user:N,payload:I,query:k},Bt;if(d){let re=u.activityManager.activityCallsByName.get(d)?.activity.uuid,La=u.activityManager.activityCallsByName.get(d).interactionCallByName.get(f)?.interaction.uuid;Bt=await u.activityManager.callActivityInteraction(re,La,h,X)}else{let re=u.activityManager.interactionCallsByName.get(f)?.interaction.uuid;Bt=await u.callInteraction(re,X)}if(Bt.error)throw{statusCode:400,body:Bt};return Bt})(a,n);return Response.json(o,{headers:Le})}if(e.startsWith("/api/")&&r==="POST"){let s=e.replace("/api/",""),o=kn[s];if(!o)throw{statusCode:404,message:`api ${s} not found`};let u=await Sn(async(l,d)=>{let h=null;if(!o.allowAnonymous){let E=i.get("x-user-id");if(!E)throw{statusCode:401,message:"Unauthorized"};if(h=await d.system.storage.findOne(Ur,g.atom({key:"id",value:["=",E]}),void 0,["*"]),!h)throw{statusCode:500,message:"User not synced"}}let f=await l.json(),I=Xs(f,o),k;return o.useNamedParams?k=await o.call(d,{user:h},I):k=await o.call(d,{user:h},...I),k})(a,n);return Response.json(u,{headers:Le})}throw{statusCode:404,message:"Not Found"}}catch(n){return Response.json(n.body||{error:n.message||"Internal Server Error"},{status:n.statusCode||500,headers:Le})}}};export{Bv as createDataAPI,Fv as default,Vv as registerAPI};
